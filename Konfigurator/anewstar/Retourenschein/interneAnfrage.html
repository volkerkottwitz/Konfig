<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interne Anfrage</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="interneAnfrage.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>
       .search-highlight {
      background-color: rgba(0, 0, 0, 0.2);
      font-weight: bold;
      border-radius: 3px;
      padding: 0 2px;
    }
    .header-right .buttons {
      display: flex;
      gap: 10px;
    }
    .form-section-container {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin: 25px auto;
      background-color: #fdfdfd;
      max-width: 900px;
    }
    .form-section-container h3 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 25px;
      padding-bottom: 10px;
      color: #00a1e1;
      font-size: 1.3em;
    }
    .centered-form-layout {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    .centered-form-layout > * {
      width: 100%;
      max-width: 500px;
    }
    
    /* Stile f√ºr die Suchleiste & Ergebnisse */
    #kundenSuche {
        width: 100%;
        height: 45px;
        padding: 0 20px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
        transition: all 0.2s ease-in-out;
    }
    #kundenSuche:focus {
        outline: none;
        border-color: #00a1e1;
        box-shadow: 0 0 0 3px rgba(0, 161, 225, 0.25);
    }
    #suchErgebnisse {
        position: relative; 
        width: 100%;
        max-width: 500px;
        margin-top: -10px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .ergebnis-item {
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    .ergebnis-item:last-child {
        border-bottom: none;
    }
    .ergebnis-item.active, 
    .ergebnis-item:hover {
        background-color: #46a1f0; 
    }
    .ergebnis-item.no-results {
        cursor: default;
        color: #888;
    }
    .ergebnis-item.no-results:hover {
        background-color: white;
    }

    /* --- Kunden-Ergebnisse nach PLZ-Lookup --- */
    #kundenErgebnisse { display: none; position: relative; width: 100%; max-width: 500px; margin-top: -10px; background-color: white; border: 1px solid #ddd; border-radius: 8px; z-index: 1000; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

    /* --- EINHEITLICHE STILE F√úR NORMALE EINGABEFELDER (text, tel, date) --- */
    .centered-form-layout input[type="text"],
    .centered-form-layout input[type="tel"],
    .centered-form-layout input[type="date"] {
        height: 45px;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 0 20px;
        font-size: 16px;
        box-sizing: border-box;
        transition: all 0.2s ease-in-out;
        width: 100%;
        max-width: 500px;
        font-family: 'Roboto', sans-serif;
        color: #333;
    }

    /* --- DER "NUKLEARE RESET" F√úR SELECT2-DROPDOWNS --- */

    /* Schritt A: Select2-Standarddesign komplett entfernen */
    .select2-container--default .select2-selection--single {
        background-color: transparent !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        height: auto !important;
    }

    /* Schritt B: Unser Design auf den √§u√üeren Select2-Container anwenden */
    .centered-form-layout .select2-container {
        height: 45px;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 0 20px;
        font-size: 16px;
        box-sizing: border-box;
        transition: all 0.2s ease-in-out;
        width: 100%;
        max-width: 500px;
        font-family: 'Roboto', sans-serif;
        color: #333;
        display: flex;
        align-items: center;
        background-color: white;
        position: relative;
    }

    /* Schritt C: Den Text im Inneren sauber positionieren */
    .centered-form-layout .select2-container .select2-selection__rendered {
        padding: 0 !important;
        color: #333 !important;
        margin-top: 1px;
    }

    /* Schritt D: Den Pfeil rechts positionieren */
    .centered-form-layout .select2-container--default .select2-selection__arrow {
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        height: auto !important;
        width: auto !important;
    }

    /* ======================================================================== */
    /* ===== H√§sslichen Standard-Fokus-Rahmen in Select2 entfernen          ===== */
    /* ======================================================================== */
    .select2-container *:focus {
        outline: none !important;
    }

    /* --- EINHEITLICHER FOKUS-EFFEKT F√úR ALLE FELDER --- */
    .centered-form-layout input[type="text"]:focus,
    .centered-form-layout input[type="text"]:focus-visible,
    .centered-form-layout input[type="tel"]:focus,
    .centered-form-layout input[type="tel"]:focus-visible,
    .centered-form-layout input[type="date"]:focus,
    .centered-form-layout input[type="date"]:focus-visible,
    .centered-form-layout .select2-container.select2-container--open,
    .centered-form-layout .select2-container:focus-within {
        outline: none !important;
        border-color: #00a1e1 !important;
        box-shadow: 0 0 0 3px rgba(0, 161, 225, 0.25) !important;
    }

    /* ======================================================================== */
    /* ===== Markenkonforme Farbe f√ºr markierten Text (Selection)            ===== */
    /* ======================================================================== */
    ::selection {
        background-color: #00a1e1;
        color: #ffffff;
    }

  </style>
</head>
<body>
  <header id="header">
    <div class="header-left">
      <img src="https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png" alt="Firmenlogo">
    </div>
    <div class="header-content">
      <input type="text" id="mainTitleInput" value="Interne Anfrage" class="editable-title">
      <div class="header-date" id="heute"></div>
    </div>
    <div class="header-right">
      <div class="buttons">
        <button onclick="window.close( )" class="btn btn-secondary">üîô Zur√ºck</button>
        <button onclick="generateAngebotsanfragePDF()" class="btn btn-primary">PDF erzeugen</button>
      </div>
    </div>
  </header>

  <section class="form-section-container">
    <h3>Kundendaten</h3>
    <div id="kundenDetails" class="centered-form-layout">
      <input type="text" id="kundenSuche" placeholder="üîç Firma oder Adresse suchen..." autocomplete="off">
      
      <input type="text" id="name" placeholder="Name" autocomplete="new-password">
      <div id="kundenErgebnisse"></div>
      <input type="text" id="firma" placeholder="Firma" autocomplete="new-password">
      <input type="text" id="strasse" placeholder="Stra√üe" autocomplete="new-password">
      <input type="text" id="plz" placeholder="PLZ" autocomplete="new-password">
      <input type="text" id="ort" placeholder="Ort" autocomplete="new-password">
      <input type="text" id="land" placeholder="Land" autocomplete="new-password">
      <input type="text" id="email" placeholder="E-Mail" autocomplete="new-password">
      <input type="text" id="telefon" placeholder="Telefon" autocomplete="new-password">
      <input type="text" id="kundennummer" placeholder="Kundennummer (optional)" autocomplete="new-password">

    </div>
  </section>

  <section class="form-section-container">
    <h3>Bearbeitung</h3>
    <div class="centered-form-layout">
      <select id="sachbearbeiterDropdown">
        <option value="">-- Innendienst ausw√§hlen --</option>
        <option value="Denise Otto">Denise Otto</option>
        <option value="Diana Kahlert">Diana Kahlert</option>
        <option value="Sascha Heusel">Sascha Heusel</option>
        <option value="Nadine Suhr">Nadine Suhr</option>
        <option value="Nils Vokuhl">Nils Vokuhl</option>
        <option value="Claudia Batke">Claudia Batke</option>
        <option value="Karsten Walter">Karsten Walter</option>
        <option value="manuell">-- Manuelle Eingabe --</option>
      </select>
      <input type="text" id="sachbearbeiterManuell" placeholder="Sachbearbeiter (manuell)" style="display: none;">
      <select id="aussendienstDropdown">
        <option value="">-- Au√üendienstmitarbeiter ausw√§hlen --</option>
        <option value="Rafael Furtw√§ngler">Rafael Furtw√§ngler</option>
        <option value="Christof M√ºnster">Christof M√ºnster</option>
        <option value="Sascha Heusel">Sascha Heusel</option>
        <option value="Bernhard Kneissl">Bernhard Kneissl</option>
        <option value="Christopher-Sean Haus">Christopher-Sean Haus</option>
        <option value="Sascha Barkowsky">Sascha Barkowsky</option>
        <option value="Volker Kottwitz">Volker Kottwitz</option>
        <option value="Volker Oesterwind">Volker Oesterwind</option>
        <option value="Thomas Sch√∂nf√º√ü">Thomas Sch√∂nf√º√ü</option>
        <option value="Thomas Wendt">Thomas Wendt</option>
        <option value="Harald Natzke">Harald Natzke</option>
        <option value="Lukas Pfeil">Lukas Pfeil</option>
        <option value="Nancy Ullbricht">Nancy Ullbricht</option>
        <option value="Heiner Birkholz">Heiner Birkholz</option>
        <option value="Helmut W√∂lfel">Helmut W√∂lfel</option>
        <option value="manuell">-- Manuelle Eingabe --</option>
      </select>
      <input type="text" id="aussendienstManuell" placeholder="Au√üendienstmitarbeiter (manuell)" style="display: none;">
    </div>
  </section>

  <!-- Der Rest des HTML bleibt unver√§ndert -->
  <section id="artikelListe" class="search-container">
    <h3>Artikel f√ºr das PDF</h3>
    <div id="artikelInhalt">
      <p>Keine Artikel in der Merkliste gefunden. Bitte verwenden Sie den PDF-Viewer, um Artikel zur Merkliste hinzuzuf√ºgen.</p>
    </div>
  </section>
  <section id="manuelleArtikelSection" class="search-container">
    <h3>Artikel manuell hinzuf√ºgen</h3>
    <div id="manuelleArtikelContainer"></div>
    <div class="button-container">
      <button type="button" id="weiterenartikelBtn" class="btn btn-secondary">+ Weiteren Artikel hinzuf√ºgen</button>
      <button type="button" id="artikelHinzufuegenBtn" class="btn btn-primary">Artikel zur Liste hinzuf√ºgen</button>
    </div>
  </section>
  <section id="briefingSection" class="search-container">
    <h3>Mitteilung f√ºr den Innendienst</h3>
    <div class="briefing-grid">
      <div class="briefing-field">
        <label for="hintergrund">Hintergrund:</label>
        <textarea id="hintergrund" placeholder="Kontext des Kundengespr√§chs..."></textarea>
      </div>
      <div class="briefing-field">
        <label for="fokus">Fokus :</label>
        <textarea id="fokus" placeholder="Was soll besonders hervorgehoben werden?..."></textarea>
      </div>
      <div class="briefing-field">
        <label for="preisgestaltung">Preisgestaltung:</label>
        <textarea id="preisgestaltung" placeholder="Vereinbarte Rabatte, Sonderkonditionen..."></textarea>
      </div>
    </div>
  </section>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Globale Kundendatenbank (aus verschluesselter CSV geladen)
    let kundenDatenbank = [];

    // Referenzen auf die HTML-Elemente
    const sachbearbeiterDropdown = document.getElementById("sachbearbeiterDropdown" );
    const sachbearbeiterManuellInput = document.getElementById("sachbearbeiterManuell");
    const aussendienstDropdown = document.getElementById("aussendienstDropdown");
    const aussendienstManuellInput = document.getElementById("aussendienstManuell");
    const inputs = {
      name: document.getElementById("name"),
      firma: document.getElementById("firma"),
      telefon: document.getElementById("telefon"),
      email: document.getElementById("email"),
      strasse: document.getElementById("strasse"),
      ort: document.getElementById("ort"),
      plz: document.getElementById("plz"),
      land: document.getElementById("land")
    };
    const briefingInputs = {
      hintergrund: document.getElementById("hintergrund"),
      fokus: document.getElementById("fokus"),
      preisgestaltung: document.getElementById("preisgestaltung")
    };

    // GOOGLE PLACES ADRESSSUCHE
    window.initGooglePlaces = function() {
      const input = document.getElementById('kundenSuche');
      const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['establishment'],
        componentRestrictions: { country: ['de', 'at', 'ch'] },
        fields: ['name', 'address_components']
      });
      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.address_components) return;
        document.getElementById('firma').value = place.name || '';
        let strasse = '', hausnummer = '', plz = '', ort = '', land = '';
        place.address_components.forEach(c => {
          if (c.types.includes('route')) strasse = c.long_name;
          if (c.types.includes('street_number')) hausnummer = c.long_name;
          if (c.types.includes('postal_code')) plz = c.long_name;
          if (c.types.includes('locality')) ort = c.long_name;
          if (c.types.includes('country')) land = c.long_name;
        });
        document.getElementById('strasse').value = hausnummer ? `${strasse} ${hausnummer}` : strasse;
        document.getElementById('plz').value = plz;
        document.getElementById('ort').value = ort;
        document.getElementById('land').value = land;
        input.value = '';
        if (kundenDatenbank.length > 0) showKundenByPLZ(plz);
      });
    };

// ========================================================================
// ===== PLZ-KUNDEN-LOOKUP (Envelope Encryption + Web Crypto API) =========
// ========================================================================

async function loadKundenDatenbank() {
    const password = localStorage.getItem('customerDataPassword') || sessionStorage.getItem('customerDataPassword');
    if (!password) {
        console.log('Kein Passwort gesetzt - Kunden-Lookup deaktiviert.');
        return;
    }

    try {
        // 1. keys.json laden
        const keysResponse = await fetch('keys.json');
        if (!keysResponse.ok) { console.log('keys.json nicht gefunden.'); return; }
        const keysData = await keysResponse.json();

        // 2. Master-Key mit User-Passwort entschluesseln
        let masterKeyRaw = null;
        for (const userEntry of keysData.users) {
            try {
                const salt = Uint8Array.from(atob(userEntry.salt), c => c.charCodeAt(0));
                const nonce = Uint8Array.from(atob(userEntry.nonce), c => c.charCodeAt(0));
                const encryptedKey = Uint8Array.from(atob(userEntry.key), c => c.charCodeAt(0));

                const keyMaterial = await crypto.subtle.importKey(
                    'raw', new TextEncoder().encode(password), 'PBKDF2', false, ['deriveKey']
                );
                const derivedKey = await crypto.subtle.deriveKey(
                    { name: 'PBKDF2', salt: salt, iterations: 480000, hash: 'SHA-256' },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 }, false, ['decrypt']
                );
                masterKeyRaw = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: nonce }, derivedKey, encryptedKey
                );
                console.log('Authentifiziert als: ' + userEntry.id);
                break;
            } catch (e) { continue; }
        }

        if (!masterKeyRaw) { console.log('Passwort stimmt mit keinem User ueberein.'); return; }

        // 3. namplzkdn.enc laden und mit Master-Key entschluesseln
        const encResponse = await fetch('namplzkdn.enc');
        if (!encResponse.ok) { console.log('namplzkdn.enc nicht gefunden.'); return; }
        const encData = await encResponse.arrayBuffer();

        const encNonce = encData.slice(0, 12);
        const ciphertext = encData.slice(12);

        const masterCryptoKey = await crypto.subtle.importKey(
            'raw', masterKeyRaw, { name: 'AES-GCM' }, false, ['decrypt']
        );
        const decrypted = await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv: encNonce }, masterCryptoKey, ciphertext
        );

        // 4. CSV parsen
        const csvText = new TextDecoder().decode(decrypted);
        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        kundenDatenbank = parsed.data;
        console.log(kundenDatenbank.length + ' Kunden geladen.');

    } catch (error) {
        console.log('Fehler beim Laden der Kundendatenbank:', error);
    }
}

function showKundenByPLZ(plz) {
    const container = document.getElementById('kundenErgebnisse');
    if (!container) return;

    if (!plz || plz.length < 4 || kundenDatenbank.length === 0) {
        container.innerHTML = '';
        container.style.display = 'none';
        return;
    }

    const treffer = kundenDatenbank.filter(k => k.PLZ === plz);

    if (treffer.length === 0) {
        container.innerHTML = '';
        container.style.display = 'none';
        return;
    }

    container.innerHTML = '';
    treffer.forEach(kunde => {
        const div = document.createElement('div');
        div.className = 'ergebnis-item';
        div.textContent = kunde.Name + ' \u2014 ' + kunde.Kundennummer;
        div.addEventListener('click', () => {
            document.getElementById('name').value = kunde.Name;
            document.getElementById('kundennummer').value = kunde.Kundennummer;
            container.innerHTML = '';
            container.style.display = 'none';
        });
        container.appendChild(div);
    });
    container.style.display = 'block';
}

// Dropdown schliessen bei Klick ausserhalb
document.addEventListener('click', function(e) {
    const container = document.getElementById('kundenErgebnisse');
    if (container && !container.contains(e.target) && e.target.id !== 'plz' && e.target.id !== 'kundennummer') {
        container.innerHTML = '';
        container.style.display = 'none';
    }
});

    // Initialisierung der anderen Dropdowns
    $(document).ready(function() {
        $("#sachbearbeiterDropdown").select2({ placeholder: "-- Innendienst ausw√§hlen --", allowClear: true });
        $("#aussendienstDropdown").select2({ placeholder: "-- Au√üendienstmitarbeiter ausw√§hlen --", allowClear: true });
    });

    // Event-Listener f√ºr Sachbearbeiter- & Au√üendienst-Dropdowns
    $("#sachbearbeiterDropdown").on("change", function () {
      sachbearbeiterManuellInput.style.display = this.value === "manuell" ? "block" : "none";
      if(this.value === "manuell") sachbearbeiterManuellInput.focus(); else sachbearbeiterManuellInput.value = "";
    });
    $("#aussendienstDropdown").on("change", function () {
      aussendienstManuellInput.style.display = this.value === "manuell" ? "block" : "none";
      if(this.value === "manuell") aussendienstManuellInput.focus(); else aussendienstManuellInput.value = "";
    });



       let manuelleArtikelCounter = 0;
    // --- Der Rest Ihres Skripts bleibt unver√§ndert ---

    // Merkliste aus localStorage laden
    function ladeMerklisteAusLocalStorage() {
      try {
        const merklisteData = localStorage.getItem("merklisteForRetourenschein");
        if (merklisteData) {
          const merkliste = JSON.parse(merklisteData);
          
          window.merklisteItems = merkliste.map(item => ({
            nummer: item.nummer || item.artikelnummer || "",
            name: item.name || item.bezeichnung || "Unbekannter Artikel",
            bezeichnung: item.name || item.bezeichnung || "Unbekannter Artikel",
            artikelnummer: item.nummer || item.artikelnummer || "",
            menge: item.menge || 1,
            preis: item.preis || "0,00 ‚Ç¨"
          }));
          
          updateArtikelListe();
          localStorage.removeItem("merklisteForRetourenschein");
          console.log("Merkliste erfolgreich geladen:", merkliste.length, "Artikel");
        }
      } catch (error) {
        console.error("Fehler beim Laden der Merkliste:", error);
      }
    }

    // Funktion zum Entfernen eines Artikels
    function removeArtikel(index) {
      if (confirm("M√∂chten Sie diesen Artikel wirklich entfernen?")) {
        window.merklisteItems.splice(index, 1);
        updateArtikelListe();
      }
    }

    // Merkliste-Artikel anzeigen
    function updateArtikelListe() {
      const artikelInhalt = document.getElementById("artikelInhalt");
      
      if (window.merklisteItems && window.merklisteItems.length > 0) {
        let cardsHtml = "<div class=\"artikel-karten-container\">";
        
        window.merklisteItems.forEach((artikel, index) => {
          cardsHtml += `
            <div class=\"artikel-karte\">
              <div class=\"artikel-info\">
                <div class=\"artikel-name\">${artikel.name || artikel.bezeichnung || "Unbekannter Artikel"}</div>
                <div class=\"artikel-details\">
                  <p><strong>Artikelnummer:</strong> ${artikel.nummer || artikel.artikelnummer || "N/A"}</p>
                  <p><strong>Menge:</strong> <input type=\"number\" value=\"${artikel.menge}\" min=\"1\" onchange=\"window.merklisteItems[${index}].menge = parseInt(this.value)\"></p>
                  <p><strong>Preis:</strong> ${artikel.preis}</p>
                </div>
              </div>
              <div class=\"artikel-aktionen\">
                <div class=\"grund-steuerung\">
                  <label for=\"grund-${index}\">Spezifikation / Notiz:</label>
                  <textarea id=\"grund-${index}\" class=\"artikel-grund\" placeholder=\"Zus√§tzliche Spezifikationen oder Notizen\" onchange=\"window.merklisteItems[${index}].spezifikation = this.value\"></textarea>
                </div>
                <button class=\"entfernen-btn\" onclick=\"removeArtikel(${index})\">Artikel entfernen</button>
              </div>
            </div>
          `;
        });
        cardsHtml += "</div>";
        artikelInhalt.innerHTML = cardsHtml;
      } else {
        artikelInhalt.innerHTML = "<p>Keine Artikel in der Merkliste gefunden. Bitte verwenden Sie den PDF-Viewer, um Artikel zur Merkliste hinzuzuf√ºgen.</p>";
      }
    }

    // Manuelle Artikel-Eingabe
    function addManuelleArtikelSection() {
      const container = document.getElementById("manuelleArtikelContainer");
      const newIndex = manuelleArtikelCounter++;
      const html = `
        <div class=\"manueller-artikel\" id=\"manuellerArtikel-${newIndex}\">
          <div class=\"artikel-header\">
            <h4>Manueller Artikel ${newIndex + 1}</h4>
            <button type=\"button\" class=\"remove-artikel-btn\" onclick=\"removeManuelleArtikel(${newIndex})\">&times;</button>
          </div>
          <div class=\"artikel-eingabe-grid\">
            <div class=\"eingabe-feld\">
              <label for=\"manuellArtikelNummer-${newIndex}\">Artikelnummer:</label>
              <input type=\"text\" id=\"manuellArtikelNummer-${newIndex}\" placeholder=\"Artikelnummer\">
            </div>
            <div class=\"eingabe-feld\">
              <label for=\"manuellArtikelName-${newIndex}\">Bezeichnung:</label>
              <input type=\"text\" id=\"manuellArtikelName-${newIndex}\" placeholder=\"Bezeichnung\">
            </div>
            <div class=\"eingabe-feld\">
              <label for=\"manuellArtikelMenge-${newIndex}\">Menge:</label>
              <input type=\"number\" id=\"manuellArtikelMenge-${newIndex}\" value=\"1\" min=\"1\">
            </div>
            <div class=\"eingabe-feld\">
              <label for=\"manuellArtikelSpezifikation-${newIndex}\">Spezifikation / Notiz:</label>
              <textarea id=\"manuellArtikelSpezifikation-${newIndex}\" placeholder=\"Zus√§tzliche Spezifikationen oder Notizen\"></textarea>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML("beforeend", html);
    }

    function removeManuelleArtikel(index) {
      if (confirm("M√∂chten Sie diesen manuellen Artikel wirklich entfernen?")) {
        const element = document.getElementById(`manuellerArtikel-${index}`);
        if (element) {
          element.remove();
        }
      }
    }

    document.getElementById("weiterenartikelBtn").addEventListener("click", addManuelleArtikelSection);

    document.getElementById("artikelHinzufuegenBtn").addEventListener("click", function() {
      const manuelleArtikel = [];
      for (let i = 0; i < manuelleArtikelCounter; i++) {
        const artikelElement = document.getElementById(`manuellerArtikel-${i}`);
        if (artikelElement) {
          const nummer = document.getElementById(`manuellArtikelNummer-${i}`).value;
          const name = document.getElementById(`manuellArtikelName-${i}`).value;
          const menge = parseInt(document.getElementById(`manuellArtikelMenge-${i}`).value);
          const spezifikation = document.getElementById(`manuellArtikelSpezifikation-${i}`).value;

          if (name && menge > 0) {
            manuelleArtikel.push({
              nummer: nummer,
              name: name,
              menge: menge,
              spezifikation: spezifikation
            });
          }
        }
      }

      if (manuelleArtikel.length > 0) {
        if (!window.merklisteItems) {
          window.merklisteItems = [];
        }
        window.merklisteItems = window.merklisteItems.concat(manuelleArtikel);
        updateArtikelListe();

        document.getElementById("manuelleArtikelContainer").innerHTML = "";
        manuelleArtikelCounter = 0;
        addManuelleArtikelSection();
      } else {
        alert("Bitte geben Sie mindestens einen manuellen Artikel mit Bezeichnung und Menge ein.");
      }
    });

    // Datum im Header anzeigen
    function displayCurrentDate() {
      const today = new Date();
      const options = { year: "numeric", month: "long", day: "numeric" };
      document.getElementById("heute").textContent = today.toLocaleDateString("de-DE", options);
    }

    // Hilfsfunktionen f√ºr Mitarbeiter-Werte
    function getSachbearbeiterValue() {
      const dropdown = document.getElementById("sachbearbeiterDropdown");
      const manualInput = document.getElementById("sachbearbeiterManuell");
      return dropdown.value === "manuell" ? manualInput.value || "" : dropdown.value || "";
    }
    
    function getAussendienstmitarbeiterValue() {
      const dropdown = document.getElementById("aussendienstDropdown");
      const manualInput = document.getElementById("aussendienstManuell");
      return dropdown.value === "manuell" ? manualInput.value || "" : dropdown.value || "";
    }

// ========================================================================
// ===== NEU: Funktion zum Wiederherstellen der Anfrage-Formulardaten =====
// ========================================================================
function restoreAnfrageFormData() {
    try {
        const savedDataJSON = localStorage.getItem('anfrageFormData');
        if (!savedDataJSON) return; // Keine Daten gefunden, nichts tun.

        const savedData = JSON.parse(savedDataJSON);

        // Haupttitel
        document.getElementById('mainTitleInput').value = savedData.mainTitle || 'Interne Anfrage';

        // Kundendaten
        document.getElementById('name').value = savedData.name || '';
        document.getElementById('firma').value = savedData.firma || '';
        document.getElementById('strasse').value = savedData.strasse || '';
        document.getElementById('plz').value = savedData.plz || '';
        document.getElementById('ort').value = savedData.ort || '';
        document.getElementById('land').value = savedData.land || '';
        document.getElementById('email').value = savedData.email || '';
        document.getElementById('telefon').value = savedData.telefon || '';
        document.getElementById('kundennummer').value = savedData.kundennummer || '';

        // Bearbeitung (Dropdowns mit Select2)
        $('#sachbearbeiterDropdown').val(savedData.sachbearbeiter).trigger('change');
        document.getElementById('sachbearbeiterManuell').value = savedData.sachbearbeiterManuell || '';
        $('#aussendienstDropdown').val(savedData.aussendienst).trigger('change');
        document.getElementById('aussendienstManuell').value = savedData.aussendienstManuell || '';

        // Artikel wiederherstellen und Liste neu zeichnen
        window.merklisteItems = savedData.artikel || [];
        updateArtikelListe();

        // Mitteilung f√ºr den Innendienst
        document.getElementById('hintergrund').value = savedData.hintergrund || '';
        document.getElementById('fokus').value = savedData.fokus || '';
        document.getElementById('preisgestaltung').value = savedData.preisgestaltung || '';

        // Sichtbarkeit der manuellen Felder korrekt setzen
        if (savedData.sachbearbeiter === 'manuell') {
            document.getElementById('sachbearbeiterManuell').style.display = 'block';
        }
        if (savedData.aussendienst === 'manuell') {
            document.getElementById('aussendienstManuell').style.display = 'block';
        }

        // Nach erfolgreicher Wiederherstellung die Daten l√∂schen
        localStorage.removeItem('anfrageFormData');
        console.log("Anfrage-Formulardaten erfolgreich wiederhergestellt.");

    } catch (error) {
        console.error("Fehler beim Wiederherstellen der Anfrage-Formulardaten:", error);
        localStorage.removeItem('anfrageFormData');
    }
}


    // PDF Generierung - Professionelle Implementierung
    async function generateAngebotsanfragePDF() {
          // ========================================================================
    // ===== DATEN IM LOCALSTORAGE SPEICHERN =====
    // ========================================================================
    try {
        const formData = {
            // Haupttitel
            mainTitle: document.getElementById('mainTitleInput').value,

            // Kundendaten
            name: document.getElementById('name').value,
            firma: document.getElementById('firma').value,
            strasse: document.getElementById('strasse').value,
            plz: document.getElementById('plz').value,
            ort: document.getElementById('ort').value,
            land: document.getElementById('land').value,
            email: document.getElementById('email').value,
            telefon: document.getElementById('telefon').value,
            kundennummer: document.getElementById('kundennummer').value,

            // Bearbeitung (Dropdowns)
            sachbearbeiter: $('#sachbearbeiterDropdown').val(),
            sachbearbeiterManuell: document.getElementById('sachbearbeiterManuell').value,
            aussendienst: $('#aussendienstDropdown').val(),
            aussendienstManuell: document.getElementById('aussendienstManuell').value,

            // Artikel (globale Variable)
            artikel: window.merklisteItems || [],

            // Mitteilung f√ºr den Innendienst
            hintergrund: document.getElementById('hintergrund').value,
            fokus: document.getElementById('fokus').value,
            preisgestaltung: document.getElementById('preisgestaltung').value
        };
        localStorage.setItem('anfrageFormData', JSON.stringify(formData));
        console.log('Anfrage-Formulardaten erfolgreich im localStorage gesichert.');
    } catch (error) {
        console.error("Fehler beim Sichern der Anfrage-Formulardaten:", error);
    }
    // ========================================================================
    // ===== ENDE DES SPEICHER-BLOCKS =====
    // ========================================================================

      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Firmenlogo laden (falls verf√ºgbar)
        const logoUrl = "https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png";
        let logoImg = null;
        try {
          logoImg = await loadImageAsBase64(logoUrl);
        } catch (error) {
          console.warn("Logo konnte nicht geladen werden:", error);
        }
        
        // Seitenr√§nder und Positionen definieren
        const margin = 20;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const contentHeight = pageHeight - 2 * margin;
        let yPosition = margin;
        let currentPage = 1;
        
        // Funktion f√ºr blaue Designbalken (links)
        function addBlueDesignBars() {
          // Drei blaue Balken links wie im Referenz-PDF
          doc.setFillColor(0, 161, 225); // EWE Blau
          doc.rect(0, 40, 4, 20, 'F'); // Erster Balken
          doc.rect(0, 65, 4, 20, 'F'); // Zweiter Balken  
          doc.rect(0, 90, 4, 20, 'F'); // Dritter Balken
        }
        
        // Funktion f√ºr Header auf jeder Seite
        function addPageHeader(pageNum, totalPages) {
          // Blaue Designbalken hinzuf√ºgen
          addBlueDesignBars();
          
          // Logo (vergr√∂√üert um 5px in der H√∂he)
          if (logoImg) {
            const logoWidth = 35;
            const logoHeight = 25; // Von 20 auf 25 erh√∂ht (+5px)
            doc.addImage(logoImg, "PNG", margin, margin, logoWidth, logoHeight, undefined, 'FAST');
          }
          
          // Datum und Seitenangabe rechts oben
          const heute = new Date();
          const datumString = heute.toLocaleDateString("de-DE", { 
            year: "numeric", 
            month: "long", 
            day: "numeric" 
          });
          
          doc.setFontSize(10);
          doc.setTextColor(100, 100, 100);
          doc.text(datumString, pageWidth - margin, margin + 10, { align: "right" });
          
          // Seitenangabe nur bei mehrseitigen PDFs
          if (totalPages > 1) {
            doc.text(`Seite ${pageNum} von ${totalPages}`, pageWidth - margin, margin + 20, { align: "right" });
          }
          
          // Editierbare √úberschrift (klein, unter Datum)
          const mainTitle = document.getElementById("mainTitleInput").value || "INTERNE ANGEBOTSANFORDERUNG";
          doc.setFontSize(8);
          doc.setTextColor(100, 100, 100);
          doc.text(mainTitle.toUpperCase(), pageWidth - margin, margin + 30, { align: "right" });
        }
        
// --- NEUER CODE ---

// --- NEUER CODE (Version 2) ---

// Funktion f√ºr Fu√üzeile auf jeder Seite
function addPageFooter(pageNum, totalPages) {
  const footerY = pageHeight - 15; // Position der Fu√üzeile (15mm vom unteren Rand)
  const mainTitle = document.getElementById("mainTitleInput").value || "Interne Anfrage";
  
  // Kundennamen holen (Firma hat Vorrang, sonst Name)
  const kundenName = inputs.firma.value || inputs.name.value || "";

  // Trennlinie √ºber der Fu√üzeile
  doc.setDrawColor(200, 200, 200);
  doc.line(margin, footerY - 5, pageWidth - margin, footerY - 5);

  doc.setFontSize(8);
  doc.setTextColor(100, 100, 100);

  // Titel links in der Fu√üzeile
  doc.text(mainTitle, margin, footerY);

  // Kundenname zentriert in der Fu√üzeile
  if (kundenName) {
    doc.text(kundenName, pageWidth / 2, footerY, { align: "center" });
  }

  // Seitenzahl rechts in der Fu√üzeile
  const pageString = `Seite ${pageNum} von ${totalPages}`;
  doc.text(pageString, pageWidth - margin, footerY, { align: "right" });
}



        // Funktion f√ºr neue Seite
        function addNewPage() {
          doc.addPage();
          currentPage++;
          yPosition = margin + 50; // Platz f√ºr Header lassen
        }
        
        // Funktion um zu pr√ºfen, ob neue Seite ben√∂tigt wird
        function checkPageBreak(neededSpace) {
          if (yPosition + neededSpace > pageHeight - margin) {
            addNewPage();
            return true;
          }
          return false;
        }
        
        // Erste Seite Header
        addPageHeader(1, 1); // Wird sp√§ter mit korrekter Seitenzahl aktualisiert
        
        yPosition += 50; // Platz f√ºr Header
        
        // Haupttitel
        const mainTitle = document.getElementById("mainTitleInput").value || "INTERNE ANGEBOTSANFORDERUNG";
        doc.setFontSize(20);
        doc.setTextColor(0, 0, 0);
        doc.setFont("helvetica", "bold");
        doc.text(mainTitle.toUpperCase(), pageWidth / 2, yPosition, { align: "center" });
        
        yPosition += 20;
        
        // Mitarbeiter-Informationen
        const sachbearbeiter = getSachbearbeiterValue();
        const aussendienstmitarbeiter = getAussendienstmitarbeiterValue();
        
        if (sachbearbeiter || aussendienstmitarbeiter) {
          checkPageBreak(40);
          
          doc.setFontSize(14);
          doc.setFont("helvetica", "bold");
          doc.setTextColor(0, 161, 225); // Firmenfarbe
          doc.text("BEARBEITUNG", margin, yPosition);
          
          yPosition += 10;
          
          doc.setFontSize(10);
          doc.setFont("helvetica", "normal");
          doc.setTextColor(0, 0, 0); // Schwarz
          
          if (sachbearbeiter) {
            doc.setFont("helvetica", "bold");
            doc.text("Innendienst:", margin, yPosition);
            doc.setFont("helvetica", "normal");
            doc.text(sachbearbeiter, margin + 35, yPosition);
            yPosition += 6;
          }
          
          if (aussendienstmitarbeiter) {
            doc.setFont("helvetica", "bold");
            doc.text("ausgestellt von:", margin, yPosition);
            doc.setFont("helvetica", "normal");
            doc.text(aussendienstmitarbeiter, margin + 35, yPosition);
            yPosition += 6;
          }
          
          yPosition += 10;
        }
        
        // Kundendaten-Sektion
        checkPageBreak(50);
        
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(0, 161, 225); // Firmenfarbe
        doc.text("KUNDENDATEN", margin, yPosition);
        
        yPosition += 10;
        
        // Kundendaten sammeln
        const kundenDaten = {
          firma: inputs.firma.value || "Nicht angegeben",
          name: inputs.name.value || "Nicht angegeben",
          strasse: inputs.strasse.value || "Nicht angegeben",
          plz: inputs.plz.value || "",
          ort: inputs.ort.value || "",
          email: inputs.email.value || "Nicht angegeben",
          telefon: inputs.telefon.value || "Nicht angegeben"
        };
        
        // Adresse zusammensetzen
        const adresse = `${kundenDaten.strasse}, ${kundenDaten.plz} ${kundenDaten.ort}`.trim();
        
                // ===== NEU: Kundennummer auslesen und die Tabelle anpassen =====
        const kundennummerValue = document.getElementById("kundennummer").value;

        // Kundendaten-Tabelle
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(0, 0, 0); // Schwarz
        

        const kundenInfos = [
        
         
          ["Firma:", kundenDaten.firma],
          ["Ansprechpartner:", kundenDaten.name],
          ["Adresse:", adresse || "Nicht angegeben"],
          ["E-Mail:", kundenDaten.email],
          ["Telefon:", kundenDaten.telefon]
        ];
                if (kundennummerValue) {
            kundenInfos.push(["Kundennummer:", kundennummerValue]);
        }

        
        kundenInfos.forEach(([label, value]) => {
          checkPageBreak(8);
          doc.setFont("helvetica", "bold");
          doc.text(label, margin, yPosition);
          doc.setFont("helvetica", "normal");
          doc.text(value, margin + 35, yPosition);
          yPosition += 6;
        });
        
        yPosition += 10;
        
        // Briefing-Sektion
        checkPageBreak(30);
        
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(0, 161, 225);
        doc.text("MITTEILUNG F√úR DEN INNENDIENST", margin, yPosition);
        
        yPosition += 10;
        
        // Briefing-Daten sammeln
        const briefingDaten = {
          hintergrund: briefingInputs.hintergrund.value || "Nicht angegeben",
          fokus: briefingInputs.fokus.value || "Nicht angegeben",
          preisgestaltung: briefingInputs.preisgestaltung.value || "Nicht angegeben"
        };
        
        // Briefing-Felder
        const briefingFelder = [
          ["Hintergrund:", briefingDaten.hintergrund],
          ["Fokus :", briefingDaten.fokus],
          ["Preisgestaltung:", briefingDaten.preisgestaltung]
        ];
        
        doc.setFontSize(10);
        briefingFelder.forEach(([label, value]) => {
          const splitText = doc.splitTextToSize(value, pageWidth - 2 * margin);
          const neededSpace = 6 + splitText.length * 4 + 6;
          checkPageBreak(neededSpace);
          
          doc.setFont("helvetica", "bold");
          doc.setTextColor(0, 0, 0); // Schwarz
          doc.text(label, margin, yPosition);
          yPosition += 6;
          
          doc.setFont("helvetica", "normal");
          doc.setTextColor(0, 0, 0); // Schwarz f√ºr Briefing-Text
          doc.text(splitText, margin, yPosition);
          yPosition += splitText.length * 4 + 6;
        });
        
        yPosition += 5;
        
// --- NEUER CODE ---

// Artikel-Sektion (Dynamische √úberschrift)
const angebotsdetailsTitle = document.getElementById("mainTitleInput").value || "Angebotsdetails";
const titleHeight = 15; // Ungef√§hre H√∂he f√ºr die √úberschrift + Abstand

// Pr√ºfen, ob die √úberschrift UND der Tabellen-Header auf die Seite passen
checkPageBreak(titleHeight + 30); // 30 ist der Platz f√ºr den Tabellen-Header

doc.setFontSize(14);
doc.setFont("helvetica", "bold");
doc.setTextColor(0, 161, 225);
doc.text(angebotsdetailsTitle.toUpperCase(), margin, yPosition); // <-- Dynamischer Text

yPosition += 15;

        
        // Artikel sammeln
        const alleArtikel = [];
        
        // Artikel aus Merkliste
        if (window.merklisteItems && window.merklisteItems.length > 0) {
          window.merklisteItems.forEach(artikel => {
            alleArtikel.push({
              nummer: artikel.nummer || artikel.artikelnummer || "N/A",
              bezeichnung: artikel.name || artikel.bezeichnung || "Unbekannter Artikel",
              menge: artikel.menge || 1,
              spezifikation: artikel.spezifikation || "Keine Angabe"
            });
          });
        }
        
        // Artikel-Tabelle erstellen
        if (alleArtikel.length > 0) {
          
          // Funktion f√ºr Tabellen-Header
          function drawTableHeader() {
            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(0, 0, 0); // Schwarz
            
            // Header-Zeile
            doc.text("Pos", margin, yPosition);
            doc.text("Menge", margin + 20, yPosition);
            doc.text("Artikel", margin + 40, yPosition);
            doc.text("Spezifikation", margin + 120, yPosition);
            
            yPosition += 8;
            
            // Trennlinie
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 8; // Abstand nach der Trennlinie
          }
          
          // Ersten Tabellen-Header zeichnen
          checkPageBreak(30); // Mindestens 30mm f√ºr Header + ersten Artikel
          drawTableHeader();
          
          // Artikel-Zeilen
          alleArtikel.forEach((artikel, index) => {
            // Platz f√ºr Artikel berechnen (Artikelnummer + Bezeichnung + Spezifikation)
            const artikelBezeichnungLines = doc.splitTextToSize(artikel.bezeichnung, 75);
            const spezifikationLines = doc.splitTextToSize(artikel.spezifikation, 65);
            const maxLines = Math.max(artikelBezeichnungLines.length, spezifikationLines.length);
            const artikelHoehe = Math.max(16, 8 + maxLines * 4); // Mindestens 16px H√∂he
            
            // Pr√ºfen ob genug Platz f√ºr den Artikel vorhanden ist
            if (yPosition + artikelHoehe > pageHeight - margin) {
              // Neue Seite beginnen
              doc.addPage();
              currentPage++;
              yPosition = margin + 30; // Platz f√ºr Header lassen
              
              // Header auf neuer Seite wiederholen
              addPageHeader(currentPage, currentPage); // Wird sp√§ter korrigiert
              yPosition += 20;
              drawTableHeader();
            }
            
            const startY = yPosition;
            
            doc.setFont("helvetica", "normal");
            doc.setTextColor(0, 0, 0); // Schwarz
            
            // Position
            doc.text((index + 1).toString(), margin, startY);
            
            // Menge
            doc.text(artikel.menge.toString() + " Stk", margin + 20, startY);
            
            // Artikelnummer (fett)
            doc.setFont("helvetica", "bold");
            doc.text(artikel.nummer, margin + 40, startY);
            
            // Artikelbezeichnung (normal, kann 2 Zeilen einnehmen)
            doc.setFont("helvetica", "normal");
            doc.text(artikelBezeichnungLines, margin + 40, startY + 6);
            
            // Spezifikation
            doc.text(spezifikationLines, margin + 120, startY);
            
            yPosition += artikelHoehe;
            
            // Trennlinie nach jedem Artikel (au√üer dem letzten)
            if (index < alleArtikel.length - 1) {
              doc.setDrawColor(230, 230, 230);
              doc.line(margin, yPosition, pageWidth - margin, yPosition);
              yPosition += 5; // Abstand nach der Trennlinie
            }
          });
        } else {
          checkPageBreak(15);
          doc.setFontSize(10);
          doc.setFont("helvetica", "italic");
          doc.setTextColor(100, 100, 100);
          doc.text("Keine Artikel angegeben.", margin, yPosition);
        }
        
// --- NEUER CODE ---

// Header und Footer auf allen Seiten finalisieren
const totalPages = doc.internal.getNumberOfPages();
for (let i = 1; i <= totalPages; i++) {
  doc.setPage(i); // Zur Seite i wechseln

  // Header aktualisieren (besonders f√ºr die Seitenzahl "Seite X von Y")
  addPageHeader(i, totalPages);
  
  // Neue Fu√üzeile hinzuf√ºgen
  addPageFooter(i, totalPages);
}

        
// NEUER CODE (√úberschrift_Firma_Ansprechpartner_Ort_Datum):

// 1. Alle ben√∂tigten Werte aus den Feldern holen.
const ueberschrift = document.getElementById("mainTitleInput").value || "Interne Anfrage";
const firma = document.getElementById("firma").value || "";
const ansprechpartner = document.getElementById("name").value || "";
const ort = document.getElementById("ort").value || "";
const datum = new Date().toISOString().split('T')[0];

// 2. Alle Teile in der NEUEN REIHENFOLGE zu einem Array zusammenf√ºgen.
const filenameParts = [ueberschrift, firma, ansprechpartner, ort, datum].filter(part => part);

// 3. Jeden Teil bereinigen (Sonderzeichen entfernen, Leerzeichen am Rand weg) und mit "_" verbinden.
const cleanFilename = filenameParts.map(part => 
    part.replace(/[^a-zA-Z0-9√§√∂√º√Ñ√ñ√ú√ü\s]/g, "").trim()
).join("_");

// 4. PDF mit dem neuen, sauberen Dateinamen speichern.
doc.save(`${cleanFilename}.pdf`);



        // NEUE, KORREKTE ZEILE:
console.log(`PDF erfolgreich erstellt: ${cleanFilename}.pdf`);

        
      } catch (error) {
        console.error("Fehler bei der PDF-Erstellung:", error);
        alert("Fehler bei der PDF-Erstellung. Bitte versuchen Sie es erneut.");
      }
    }

    // Hilfsfunktion zum Laden von Bildern als Base64
    function loadImageAsBase64(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          const dataURL = canvas.toDataURL("image/png");
          resolve(dataURL);
        };
        img.onerror = reject;
        img.src = url;
      });
    }


    // ========================================================================
// ===== NEU: DER EINZIGE UND KORREKTE STARTPUNKT DER SEITE         =====
// ========================================================================

// ========================================================================
// ===== NEU: KORREKTER STARTPUNKT DER SEITE (Version 2) =====
// ========================================================================
document.addEventListener("DOMContentLoaded", async () => {
  
    // --- SCHRITT 1: Seite mit Standardwerten initialisieren ---
    displayCurrentDate();
    ladeMerklisteAusLocalStorage();
    addManuelleArtikelSection();
    
    $(document).ready(function() {
        $("#sachbearbeiterDropdown").select2({ placeholder: "-- Innendienst ausw√§hlen --", allowClear: true });
        $("#aussendienstDropdown").select2({ placeholder: "-- Au√üendienstmitarbeiter ausw√§hlen --", allowClear: true });
    });

    // --- SCHRITT 2: Versuchen, die Standardwerte mit gespeicherten Daten zu √ºberschreiben ---
    restoreAnfrageFormData();

    // --- SCHRITT 3: Kundendatenbank laden (Envelope Encryption) ---
    loadKundenDatenbank();

    // --- SCHRITT 4: PLZ-Feld Event-Listener fuer manuelle Eingabe ---
    document.getElementById('plz').addEventListener('input', function() {
        if (this.value.length >= 4) {
            showKundenByPLZ(this.value.trim());
        } else {
            const container = document.getElementById('kundenErgebnisse');
            if (container) { container.innerHTML = ''; container.style.display = 'none'; }
        }
    });

});


  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBN4cAc4nq9je0of0cb_0wEUb1yCz54r7k&libraries=places&callback=initGooglePlaces" async defer></script>
    <section class="form-section-container" style="text-align: center; box-shadow: none; border: none; background: none;">
  <button onclick="generateAngebotsanfragePDF()" class="btn btn-primary" style="padding: 15px 30px; font-size: 1.2rem;">
    PDF erzeugen
  </button>
</body>
</html>