<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interne Anfrage</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="interneAnfrage.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
       .search-highlight {
      background-color: rgba(0, 0, 0, 0.2);
      font-weight: bold;
      border-radius: 3px;
      padding: 0 2px;
    }
    .header-right .buttons {
      display: flex;
      gap: 10px;
    }
    .form-section-container {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin: 25px auto;
      background-color: #fdfdfd;
      max-width: 900px;
    }
    .form-section-container h3 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 25px;
      padding-bottom: 10px;
      color: #00a1e1;
      font-size: 1.3em;
    }
    .centered-form-layout {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    .centered-form-layout > * {
      width: 100%;
      max-width: 500px;
    }
    
    /* Stile für die Suchleiste & Ergebnisse */
    #kundenSuche {
        width: 100%;
        height: 45px;
        padding: 0 20px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
        transition: all 0.2s ease-in-out;
    }
    #kundenSuche:focus {
        outline: none;
        border-color: #00a1e1;
        box-shadow: 0 0 0 3px rgba(0, 161, 225, 0.25);
    }
    #suchErgebnisse {
        position: relative; 
        width: 100%;
        max-width: 500px;
        margin-top: -10px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .ergebnis-item {
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    .ergebnis-item:last-child {
        border-bottom: none;
    }
    .ergebnis-item.active, 
    .ergebnis-item:hover {
        background-color: #46a1f0; 
    }
    .ergebnis-item.no-results {
        cursor: default;
        color: #888;
    }
    .ergebnis-item.no-results:hover {
        background-color: white;
    }

    /* --- Kunden-Ergebnisse nach PLZ-Lookup --- */
    #kundenErgebnisse { display: none; position: relative; width: 100%; max-width: 500px; margin-top: -10px; background-color: white; border: 1px solid #ddd; border-radius: 8px; z-index: 1000; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

    /* --- EINHEITLICHE STILE FÜR NORMALE EINGABEFELDER (text, tel, date) --- */
    .centered-form-layout input[type="text"],
    .centered-form-layout input[type="tel"],
    .centered-form-layout input[type="date"] {
        height: 45px;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 0 20px;
        font-size: 16px;
        box-sizing: border-box;
        transition: all 0.2s ease-in-out;
        width: 100%;
        max-width: 500px;
        font-family: 'Roboto', sans-serif;
        color: #333;
    }

    /* --- DER "NUKLEARE RESET" FÜR SELECT2-DROPDOWNS --- */

    /* Schritt A: Select2-Standarddesign komplett entfernen */
    .select2-container--default .select2-selection--single {
        background-color: transparent !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        height: auto !important;
    }

    /* Schritt B: Unser Design auf den äußeren Select2-Container anwenden */
    .centered-form-layout .select2-container {
        height: 45px;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 0 20px;
        font-size: 16px;
        box-sizing: border-box;
        transition: all 0.2s ease-in-out;
        width: 100%;
        max-width: 500px;
        font-family: 'Roboto', sans-serif;
        color: #333;
        display: flex;
        align-items: center;
        background-color: white;
        position: relative;
    }

    /* Schritt C: Den Text im Inneren sauber positionieren */
    .centered-form-layout .select2-container .select2-selection__rendered {
        padding: 0 !important;
        color: #333 !important;
        margin-top: 1px;
    }

    /* Schritt D: Den Pfeil rechts positionieren */
    .centered-form-layout .select2-container--default .select2-selection__arrow {
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        height: auto !important;
        width: auto !important;
    }

    /* ======================================================================== */
    /* ===== Hässlichen Standard-Fokus-Rahmen in Select2 entfernen          ===== */
    /* ======================================================================== */
    .select2-container *:focus {
        outline: none !important;
    }

    /* --- EINHEITLICHER FOKUS-EFFEKT FÜR ALLE FELDER --- */
    .centered-form-layout input[type="text"]:focus,
    .centered-form-layout input[type="text"]:focus-visible,
    .centered-form-layout input[type="tel"]:focus,
    .centered-form-layout input[type="tel"]:focus-visible,
    .centered-form-layout input[type="date"]:focus,
    .centered-form-layout input[type="date"]:focus-visible,
    .centered-form-layout .select2-container.select2-container--open,
    .centered-form-layout .select2-container:focus-within {
        outline: none !important;
        border-color: #00a1e1 !important;
        box-shadow: 0 0 0 3px rgba(0, 161, 225, 0.25) !important;
    }

    /* ======================================================================== */
    /* ===== Markenkonforme Farbe für markierten Text (Selection)            ===== */
    /* ======================================================================== */
    ::selection {
        background-color: #00a1e1;
        color: #ffffff;
    }

  </style>
</head>
<body>
  <header id="header">
    <div class="header-left">
      <img src="https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png" alt="Firmenlogo">
    </div>
    <div class="header-content">
      <input type="text" id="mainTitleInput" value="Interne Anfrage" class="editable-title">
      <div class="header-date" id="heute"></div>
    </div>
    <div class="header-right">
      <div class="buttons">
        <button onclick="window.close( )" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Zurück</button>
        <button onclick="generateAngebotsanfragePDF()" class="btn btn-primary"><i class="bi bi-file-earmark-pdf"></i> PDF erzeugen</button>
      </div>
    </div>
  </header>

  <section class="form-section-container">
    <h3>Kundendaten</h3>
    <div id="kundenDetails" class="centered-form-layout">
      <input type="text" id="kundenSuche" placeholder="Firma oder Adresse suchen..." autocomplete="off">
      
      <input type="text" id="name" placeholder="Name" autocomplete="new-password">
      <div id="kundenErgebnisse"></div>
      <input type="text" id="firma" placeholder="Firma" autocomplete="new-password">
      <input type="text" id="strasse" placeholder="Straße" autocomplete="new-password">
      <input type="text" id="plz" placeholder="PLZ" autocomplete="new-password">
      <input type="text" id="ort" placeholder="Ort" autocomplete="new-password">
      <input type="text" id="land" placeholder="Land" autocomplete="new-password">
      <input type="text" id="email" placeholder="E-Mail" autocomplete="new-password">
      <input type="text" id="telefon" placeholder="Telefon" autocomplete="new-password">
      <input type="text" id="kundennummer" placeholder="Kundennummer (optional)" autocomplete="new-password">
      <button type="button" id="kundenSpeichernBtn" style="display:none; margin-top:6px; background:linear-gradient(135deg,#005A8C,#00a1e1); color:white; border:none; height:44px; border-radius:8px; font-family:'Roboto Condensed',sans-serif; font-size:0.9rem; font-weight:600; cursor:pointer; max-width:500px; width:100%;">
        <i class="bi bi-cloud-plus"></i> Neuen Kunden speichern
      </button>

    </div>
  </section>

  <section class="form-section-container">
    <h3>Bearbeitung</h3>
    <div class="centered-form-layout">
      <select id="sachbearbeiterDropdown">
        <option value="">-- Innendienst auswählen --</option>
        <option value="Denise Otto">Denise Otto</option>
        <option value="Diana Kahlert">Diana Kahlert</option>
        <option value="Sascha Heusel">Sascha Heusel</option>
        <option value="Nadine Suhr">Nadine Suhr</option>
        <option value="Nils Vokuhl">Nils Vokuhl</option>
        <option value="Claudia Batke">Claudia Batke</option>
        <option value="Karsten Walter">Karsten Walter</option>
        <option value="manuell">-- Manuelle Eingabe --</option>
      </select>
      <input type="text" id="sachbearbeiterManuell" placeholder="Sachbearbeiter (manuell)" style="display: none;">
      <select id="aussendienstDropdown">
        <option value="">-- Außendienstmitarbeiter auswählen --</option>
        <option value="Rafael Furtwängler">Rafael Furtwängler</option>
        <option value="Christof Münster">Christof Münster</option>
        <option value="Sascha Heusel">Sascha Heusel</option>
        <option value="Bernhard Kneissl">Bernhard Kneissl</option>
        <option value="Christopher-Sean Haus">Christopher-Sean Haus</option>
        <option value="Sascha Barkowsky">Sascha Barkowsky</option>
        <option value="Volker Kottwitz">Volker Kottwitz</option>
        <option value="Volker Oesterwind">Volker Oesterwind</option>
        <option value="Thomas Schönfüß">Thomas Schönfüß</option>
        <option value="Thomas Wendt">Thomas Wendt</option>
        <option value="Harald Natzke">Harald Natzke</option>
        <option value="Lukas Pfeil">Lukas Pfeil</option>
        <option value="Nancy Ullbricht">Nancy Ullbricht</option>
        <option value="Heiner Birkholz">Heiner Birkholz</option>
        <option value="Helmut Wölfel">Helmut Wölfel</option>
        <option value="manuell">-- Manuelle Eingabe --</option>
      </select>
      <input type="text" id="aussendienstManuell" placeholder="Außendienstmitarbeiter (manuell)" style="display: none;">
    </div>
  </section>

  <!-- Der Rest des HTML bleibt unverändert -->
  <section id="artikelListe" class="search-container">
    <h3>Artikel für das PDF</h3>
    <div id="artikelInhalt">
      <p>Keine Artikel in der Merkliste gefunden. Bitte verwenden Sie den PDF-Viewer, um Artikel zur Merkliste hinzuzufügen.</p>
    </div>
  </section>
  <section id="manuelleArtikelSection" class="search-container">
    <h3>Artikel manuell hinzufügen</h3>
    <div id="manuelleArtikelContainer"></div>
    <div class="button-container">
      <button type="button" id="weiterenartikelBtn" class="btn btn-secondary">+ Weiteren Artikel hinzufügen</button>
      <button type="button" id="artikelHinzufuegenBtn" class="btn btn-primary">Artikel zur Liste hinzufügen</button>
    </div>
  </section>
  <section id="briefingSection" class="search-container">
    <h3>Mitteilung für den Innendienst</h3>
    <p class="briefing-hint">Aktivieren Sie die gewünschten Felder per Checkbox. Nur aktivierte Felder erscheinen im PDF. Überschriften sind editierbar.</p>
    <div class="briefing-grid">
      <div class="briefing-field" data-field-id="hintergrund">
        <div class="field-toggle-row">
          <input type="checkbox" id="toggle-hintergrund" class="field-toggle" checked>
          <input type="text" class="field-label-edit" value="Hintergrund" data-default="Hintergrund">
        </div>
        <textarea id="hintergrund" placeholder="Kontext des Kundengesprächs..."></textarea>
      </div>
      <div class="briefing-field" data-field-id="fokus">
        <div class="field-toggle-row">
          <input type="checkbox" id="toggle-fokus" class="field-toggle" checked>
          <input type="text" class="field-label-edit" value="Fokus" data-default="Fokus">
        </div>
        <textarea id="fokus" placeholder="Was soll besonders hervorgehoben werden?..."></textarea>
      </div>
      <div class="briefing-field" data-field-id="preisgestaltung">
        <div class="field-toggle-row">
          <input type="checkbox" id="toggle-preisgestaltung" class="field-toggle" checked>
          <input type="text" class="field-label-edit" value="Preisgestaltung" data-default="Preisgestaltung">
        </div>
        <textarea id="preisgestaltung" placeholder="Vereinbarte Rabatte, Sonderkonditionen..."></textarea>
      </div>
      <div class="briefing-field inactive" data-field-id="bericht">
        <div class="field-toggle-row">
          <input type="checkbox" id="toggle-bericht" class="field-toggle">
          <input type="text" class="field-label-edit" value="Bericht" data-default="Bericht">
        </div>
        <textarea id="bericht" placeholder="Besuchsbericht, Gesprächsnotizen..."></textarea>
      </div>
      <div class="briefing-field inactive" data-field-id="aufgaben">
        <div class="field-toggle-row">
          <input type="checkbox" id="toggle-aufgaben" class="field-toggle">
          <input type="text" class="field-label-edit" value="Zu erledigende Aufgaben" data-default="Zu erledigende Aufgaben">
        </div>
        <textarea id="aufgaben" placeholder="Aufgaben, Follow-ups, nächste Schritte..."></textarea>
      </div>
    </div>
  </section>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    // Globale Kundendatenbank (aus verschluesselter CSV geladen)
    let kundenDatenbank = [];

    // Supabase-Client fuer Kunden-Speicherung
    const supabaseClient = window.supabase ? window.supabase.createClient(
      'https://majbsrgcrvlwjpzlalxf.supabase.co',
      'sb_publishable_lodqq8_fd-FOPy3g8dhOtw_ipkKLcut'
    ) : null;
    let supabaseKunden = [];

    // Referenzen auf die HTML-Elemente
    const sachbearbeiterDropdown = document.getElementById("sachbearbeiterDropdown" );
    const sachbearbeiterManuellInput = document.getElementById("sachbearbeiterManuell");
    const aussendienstDropdown = document.getElementById("aussendienstDropdown");
    const aussendienstManuellInput = document.getElementById("aussendienstManuell");
    const inputs = {
      name: document.getElementById("name"),
      firma: document.getElementById("firma"),
      telefon: document.getElementById("telefon"),
      email: document.getElementById("email"),
      strasse: document.getElementById("strasse"),
      ort: document.getElementById("ort"),
      plz: document.getElementById("plz"),
      land: document.getElementById("land")
    };
    const briefingInputs = {
      hintergrund: document.getElementById("hintergrund"),
      fokus: document.getElementById("fokus"),
      preisgestaltung: document.getElementById("preisgestaltung"),
      bericht: document.getElementById("bericht"),
      aufgaben: document.getElementById("aufgaben")
    };

    // GOOGLE PLACES ADRESSSUCHE
    window.initGooglePlaces = function() {
      const input = document.getElementById('kundenSuche');
      const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['establishment'],
        componentRestrictions: { country: ['de', 'at', 'ch'] },
        fields: ['name', 'address_components']
      });
      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.address_components) return;
        document.getElementById('firma').value = place.name || '';
        let strasse = '', hausnummer = '', plz = '', ort = '', land = '';
        place.address_components.forEach(c => {
          if (c.types.includes('route')) strasse = c.long_name;
          if (c.types.includes('street_number')) hausnummer = c.long_name;
          if (c.types.includes('postal_code')) plz = c.long_name;
          if (c.types.includes('locality')) ort = c.long_name;
          if (c.types.includes('country')) land = c.long_name;
        });
        document.getElementById('strasse').value = hausnummer ? `${strasse} ${hausnummer}` : strasse;
        document.getElementById('plz').value = plz;
        document.getElementById('ort').value = ort;
        document.getElementById('land').value = land;
        input.value = '';
        if (kundenDatenbank.length > 0) showKundenByPLZ(plz);
      });
    };

// ========================================================================
// ===== PLZ-KUNDEN-LOOKUP (Envelope Encryption + Web Crypto API) =========
// ========================================================================

async function loadKundenDatenbank() {
    const password = localStorage.getItem('customerDataPassword') || sessionStorage.getItem('customerDataPassword');
    if (!password) {
        console.log('Kein Passwort gesetzt - Kunden-Lookup deaktiviert.');
        return;
    }

    try {
        // 1. keys.json laden
        const keysResponse = await fetch('keys.json');
        if (!keysResponse.ok) { console.log('keys.json nicht gefunden.'); return; }
        const keysData = await keysResponse.json();

        // 2. Master-Key mit User-Passwort entschluesseln
        let masterKeyRaw = null;
        for (const userEntry of keysData.users) {
            try {
                const salt = Uint8Array.from(atob(userEntry.salt), c => c.charCodeAt(0));
                const nonce = Uint8Array.from(atob(userEntry.nonce), c => c.charCodeAt(0));
                const encryptedKey = Uint8Array.from(atob(userEntry.key), c => c.charCodeAt(0));

                const keyMaterial = await crypto.subtle.importKey(
                    'raw', new TextEncoder().encode(password), 'PBKDF2', false, ['deriveKey']
                );
                const derivedKey = await crypto.subtle.deriveKey(
                    { name: 'PBKDF2', salt: salt, iterations: 480000, hash: 'SHA-256' },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 }, false, ['decrypt']
                );
                masterKeyRaw = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: nonce }, derivedKey, encryptedKey
                );
                console.log('Authentifiziert als: ' + userEntry.id);
                break;
            } catch (e) { continue; }
        }

        if (!masterKeyRaw) { console.log('Passwort stimmt mit keinem User ueberein.'); return; }

        // 3. namplzkdn.enc laden und mit Master-Key entschluesseln
        const encResponse = await fetch('namplzkdn.enc');
        if (!encResponse.ok) { console.log('namplzkdn.enc nicht gefunden.'); return; }
        const encData = await encResponse.arrayBuffer();

        const encNonce = encData.slice(0, 12);
        const ciphertext = encData.slice(12);

        const masterCryptoKey = await crypto.subtle.importKey(
            'raw', masterKeyRaw, { name: 'AES-GCM' }, false, ['decrypt']
        );
        const decrypted = await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv: encNonce }, masterCryptoKey, ciphertext
        );

        // 4. CSV parsen
        const csvText = new TextDecoder().decode(decrypted);
        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        kundenDatenbank = parsed.data;
        console.log(kundenDatenbank.length + ' Kunden geladen.');

    } catch (error) {
        console.log('Fehler beim Laden der Kundendatenbank:', error);
    }
}

async function showKundenByPLZ(plz) {
    const container = document.getElementById('kundenErgebnisse');
    if (!container) return;

    if (!plz || plz.length < 4) {
        container.innerHTML = '';
        container.style.display = 'none';
        updateSpeichernButton();
        return;
    }

    // 1. Treffer aus verschluesselter Datenbank
    const encTreffer = kundenDatenbank.filter(k => k.PLZ === plz);

    // 2. Treffer aus Supabase (async)
    supabaseKunden = await loadSupabaseKundenByPLZ(plz);

    if (encTreffer.length === 0 && supabaseKunden.length === 0) {
        container.innerHTML = '';
        container.style.display = 'none';
        updateSpeichernButton();
        return;
    }

    container.innerHTML = '';

    // Stammkunden anzeigen (Lock-Icon)
    encTreffer.forEach(kunde => {
        const div = document.createElement('div');
        div.className = 'ergebnis-item';
        div.innerHTML = '<i class="bi bi-lock" style="opacity:0.4; margin-right:6px;" title="Stammkunde"></i>' +
            kunde.Name + ' \u2014 ' + kunde.Kundennummer;
        div.addEventListener('click', () => {
            document.getElementById('name').value = kunde.Name;
            document.getElementById('kundennummer').value = kunde.Kundennummer;
            container.innerHTML = '';
            container.style.display = 'none';
            document.getElementById('kundenSpeichernBtn').style.display = 'none';
        });
        container.appendChild(div);
    });

    // Supabase-Kunden anzeigen (Cloud-Icon, blauer Rand, Loeschen-Button)
    supabaseKunden.forEach(kunde => {
        const div = document.createElement('div');
        div.className = 'ergebnis-item';
        div.style.borderLeft = '3px solid #00a1e1';
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        div.style.alignItems = 'center';

        const textSpan = document.createElement('span');
        textSpan.style.cursor = 'pointer';
        textSpan.style.flex = '1';
        textSpan.innerHTML = '<i class="bi bi-cloud" style="color:#00a1e1; margin-right:6px;" title="Gespeicherter Kunde"></i>' +
            (kunde.name || '') +
            (kunde.firma ? ' (' + kunde.firma + ')' : '') +
            (kunde.kundennummer ? ' \u2014 ' + kunde.kundennummer : '');
        textSpan.addEventListener('click', () => {
            document.getElementById('name').value = kunde.name || '';
            document.getElementById('firma').value = kunde.firma || '';
            document.getElementById('strasse').value = kunde.strasse || '';
            document.getElementById('plz').value = kunde.plz || '';
            document.getElementById('ort').value = kunde.ort || '';
            document.getElementById('land').value = kunde.land || '';
            document.getElementById('email').value = kunde.email || '';
            document.getElementById('telefon').value = kunde.telefon || '';
            document.getElementById('kundennummer').value = kunde.kundennummer || '';
            container.innerHTML = '';
            container.style.display = 'none';
            document.getElementById('kundenSpeichernBtn').style.display = 'none';
        });
        div.appendChild(textSpan);

        const delBtn = document.createElement('button');
        delBtn.innerHTML = '<i class="bi bi-x"></i>';
        delBtn.title = 'Kunde loeschen';
        delBtn.style.cssText = 'background:none; border:none; color:#999; cursor:pointer; padding:4px 8px; font-size:1rem;';
        delBtn.addEventListener('mouseenter', () => { delBtn.style.color = '#dc3545'; });
        delBtn.addEventListener('mouseleave', () => { delBtn.style.color = '#999'; });
        delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteSupabaseKunde(kunde.id);
        });
        div.appendChild(delBtn);

        container.appendChild(div);
    });

    container.style.display = 'block';
    updateSpeichernButton();
}

// Supabase-Kunden nach PLZ laden
async function loadSupabaseKundenByPLZ(plz) {
    if (!supabaseClient || !plz || plz.length < 4) return [];
    try {
        const { data, error } = await supabaseClient
            .from('kunden')
            .select('*')
            .eq('plz', plz.trim());
        if (error) { console.error('Supabase-Fehler:', error.message); return []; }
        return data || [];
    } catch (err) {
        console.error('Supabase-Verbindungsfehler:', err);
        return [];
    }
}

// Neuen Kunden in Supabase speichern
async function saveKundeToSupabase() {
    if (!supabaseClient) {
        zeigeToast('<i class="bi bi-x-circle"></i> Supabase nicht verfuegbar.', 'undo');
        return;
    }
    const name = document.getElementById('name').value.trim();
    const plz = document.getElementById('plz').value.trim();
    if (!name || !plz) {
        zeigeToast('<i class="bi bi-exclamation-triangle"></i> Bitte Name und PLZ eingeben.', 'info');
        return;
    }

    const kundeData = {
        name: name,
        firma: document.getElementById('firma').value.trim() || null,
        strasse: document.getElementById('strasse').value.trim() || null,
        plz: plz,
        ort: document.getElementById('ort').value.trim() || null,
        land: document.getElementById('land').value.trim() || 'Deutschland',
        email: document.getElementById('email').value.trim() || null,
        telefon: document.getElementById('telefon').value.trim() || null,
        kundennummer: document.getElementById('kundennummer').value.trim() || null
    };

    try {
        const { data, error } = await supabaseClient
            .from('kunden')
            .insert(kundeData)
            .select();

        if (error) {
            if (error.code === '23505') {
                zeigeToast('<i class="bi bi-info-circle"></i> Dieser Kunde existiert bereits.', 'success');
            } else {
                console.error('Supabase-Speicherfehler:', error);
                zeigeToast('<i class="bi bi-x-circle"></i> Fehler: ' + error.message, 'undo');
            }
            return;
        }

        zeigeToast('<i class="bi bi-check-circle"></i> Kunde gespeichert!', 'success');
        document.getElementById('kundenSpeichernBtn').style.display = 'none';
    } catch (err) {
        console.error('Speicherfehler:', err);
        zeigeToast('<i class="bi bi-x-circle"></i> Verbindungsfehler.', 'undo');
    }
}

// Supabase-Kunden loeschen
async function deleteSupabaseKunde(id) {
    if (!supabaseClient) return;
    try {
        const { error } = await supabaseClient.from('kunden').delete().eq('id', id);
        if (error) {
            zeigeToast('<i class="bi bi-x-circle"></i> Fehler beim Loeschen.', 'undo');
            return;
        }
        supabaseKunden = supabaseKunden.filter(k => k.id !== id);
        const plz = document.getElementById('plz').value.trim();
        if (plz) showKundenByPLZ(plz);
        zeigeToast('<i class="bi bi-trash"></i> Kunde geloescht.', 'undo');
    } catch (err) {
        console.error('Loeschfehler:', err);
    }
}

// Speichern-Button anzeigen wenn Name + PLZ vorhanden
function updateSpeichernButton() {
    const btn = document.getElementById('kundenSpeichernBtn');
    if (!btn || !supabaseClient) return;
    const name = document.getElementById('name').value.trim();
    const plz = document.getElementById('plz').value.trim();
    btn.style.display = (name && plz) ? 'block' : 'none';
}

// Dropdown schliessen bei Klick ausserhalb
document.addEventListener('click', function(e) {
    const container = document.getElementById('kundenErgebnisse');
    if (container && !container.contains(e.target) && e.target.id !== 'plz' && e.target.id !== 'kundennummer') {
        container.innerHTML = '';
        container.style.display = 'none';
    }
});

    // Initialisierung der anderen Dropdowns
    $(document).ready(function() {
        $("#sachbearbeiterDropdown").select2({ placeholder: "-- Innendienst auswählen --", allowClear: true });
        $("#aussendienstDropdown").select2({ placeholder: "-- Außendienstmitarbeiter auswählen --", allowClear: true });
    });

    // Event-Listener für Sachbearbeiter- & Außendienst-Dropdowns
    $("#sachbearbeiterDropdown").on("change", function () {
      sachbearbeiterManuellInput.style.display = this.value === "manuell" ? "block" : "none";
      if(this.value === "manuell") sachbearbeiterManuellInput.focus(); else sachbearbeiterManuellInput.value = "";
    });
    $("#aussendienstDropdown").on("change", function () {
      aussendienstManuellInput.style.display = this.value === "manuell" ? "block" : "none";
      if(this.value === "manuell") aussendienstManuellInput.focus(); else aussendienstManuellInput.value = "";
    });



       let manuelleArtikelCounter = 0;
    // --- Der Rest Ihres Skripts bleibt unverändert ---

    // Merkliste aus localStorage laden
    function ladeMerklisteAusLocalStorage() {
      try {
        const merklisteData = localStorage.getItem("merklisteForRetourenschein");
        if (merklisteData) {
          const merkliste = JSON.parse(merklisteData);
          
          window.merklisteItems = merkliste.map(item => ({
            nummer: item.nummer || item.artikelnummer || "",
            name: item.name || item.bezeichnung || "Unbekannter Artikel",
            bezeichnung: item.name || item.bezeichnung || "Unbekannter Artikel",
            artikelnummer: item.nummer || item.artikelnummer || "",
            menge: item.menge || 1,
            preis: item.preis || "0,00 €"
          }));
          
          updateArtikelListe();
          localStorage.removeItem("merklisteForRetourenschein");
          console.log("Merkliste erfolgreich geladen:", merkliste.length, "Artikel");
        }
      } catch (error) {
        console.error("Fehler beim Laden der Merkliste:", error);
      }
    }

    // Toast-Nachricht anzeigen (wie auf der Hauptseite)
    function zeigeToast(text, type = 'info') {
      const old = document.getElementById('toast-nachricht');
      if (old) old.remove();
      const toast = document.createElement('div');
      toast.id = 'toast-nachricht';
      const bg = type === 'success' ? 'linear-gradient(135deg,#005A8C,#00a1e1)'
               : type === 'undo'    ? 'linear-gradient(135deg,#c62828,#e53935)'
               : 'linear-gradient(135deg,#005A8C,#00a1e1)';
      toast.style.cssText = `position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:${bg}; color:white; padding:10px 22px; border-radius:8px; font-family:'Roboto Condensed',sans-serif; font-size:0.9rem; font-weight:600; box-shadow:0 4px 16px rgba(0,0,0,0.2); z-index:10000; display:flex; align-items:center; gap:12px; animation:toastIn 0.3s ease;`;
      toast.innerHTML = text;
      document.body.appendChild(toast);
      setTimeout(() => { if (toast.parentNode) toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s ease'; setTimeout(() => toast.remove(), 300); }, 3000);
    }

    // Funktion zum Entfernen eines Artikels (mit Undo)
    function removeArtikel(index) {
      const entfernterArtikel = window.merklisteItems[index];
      const name = entfernterArtikel.name || entfernterArtikel.bezeichnung || 'Artikel';
      window.merklisteItems.splice(index, 1);
      updateArtikelListe();
      zeigeToast(`<i class="bi bi-trash"></i> ${name} entfernt <button onclick="undoRemoveArtikel(${index}, ${JSON.stringify(JSON.stringify(entfernterArtikel))})" style="background:rgba(255,255,255,0.25); border:none; color:white; border-radius:6px; padding:4px 10px; cursor:pointer; font-size:0.8rem; font-family:'Roboto Condensed',sans-serif; margin-left:4px;">Rückgängig</button>`, 'undo');
    }

    // Undo-Funktion fuer entfernte Artikel
    function undoRemoveArtikel(index, artikelJson) {
      const artikel = JSON.parse(artikelJson);
      window.merklisteItems.splice(index, 0, artikel);
      updateArtikelListe();
      const old = document.getElementById('toast-nachricht');
      if (old) old.remove();
      zeigeToast('<i class="bi bi-arrow-counterclockwise"></i> Artikel wiederhergestellt', 'success');
    }

    // Merkliste-Artikel anzeigen
    function updateArtikelListe() {
      const artikelInhalt = document.getElementById("artikelInhalt");
      
      if (window.merklisteItems && window.merklisteItems.length > 0) {
        let cardsHtml = "<div class=\"artikel-karten-container\">";
        
        window.merklisteItems.forEach((artikel, index) => {
          cardsHtml += `
            <div class=\"artikel-karte\">
              <div class=\"artikel-info\">
                <div class=\"artikel-name\">${artikel.name || artikel.bezeichnung || "Unbekannter Artikel"}</div>
                <div class=\"artikel-details\">
                  <p><strong>Artikelnummer:</strong> ${artikel.nummer || artikel.artikelnummer || "N/A"}</p>
                  <p><strong>Menge:</strong> <input type=\"number\" value=\"${artikel.menge}\" min=\"1\" onchange=\"window.merklisteItems[${index}].menge = parseInt(this.value)\"></p>
                  <p><strong>Preis:</strong> ${artikel.preis}</p>
                </div>
              </div>
              <div class=\"artikel-aktionen\">
                <div class=\"grund-steuerung\">
                  <label for=\"grund-${index}\">Spezifikation / Notiz:</label>
                  <textarea id=\"grund-${index}\" class=\"artikel-grund\" placeholder=\"Zusätzliche Spezifikationen oder Notizen\" onchange=\"window.merklisteItems[${index}].spezifikation = this.value\"></textarea>
                </div>
                <button class=\"entfernen-btn\" onclick=\"removeArtikel(${index})\">Artikel entfernen</button>
              </div>
            </div>
          `;
        });
        cardsHtml += "</div>";
        artikelInhalt.innerHTML = cardsHtml;
      } else {
        artikelInhalt.innerHTML = "<p>Keine Artikel in der Merkliste gefunden. Bitte verwenden Sie den PDF-Viewer, um Artikel zur Merkliste hinzuzufügen.</p>";
      }
    }

    // Manuelle Artikel-Eingabe
    function addManuelleArtikelSection() {
      const container = document.getElementById("manuelleArtikelContainer");
      const newIndex = manuelleArtikelCounter++;
      const html = `
        <div class=\"manueller-artikel\" id=\"manuellerArtikel-${newIndex}\">
          <div class=\"artikel-header\">
            <h4>Manueller Artikel ${newIndex + 1}</h4>
            <button type=\"button\" class=\"remove-artikel-btn\" onclick=\"removeManuelleArtikel(${newIndex})\">&times;</button>
          </div>
          <div class=\"artikel-eingabe-grid\">
            <div class=\"eingabe-feld\">
              <label for=\"manuellArtikelNummer-${newIndex}\">Artikelnummer:</label>
              <input type=\"text\" id=\"manuellArtikelNummer-${newIndex}\" placeholder=\"Artikelnummer\">
            </div>
            <div class=\"eingabe-feld\">
              <label for=\"manuellArtikelName-${newIndex}\">Bezeichnung:</label>
              <input type=\"text\" id=\"manuellArtikelName-${newIndex}\" placeholder=\"Bezeichnung\">
            </div>
            <div class=\"eingabe-feld\">
              <label for=\"manuellArtikelMenge-${newIndex}\">Menge:</label>
              <input type=\"number\" id=\"manuellArtikelMenge-${newIndex}\" value=\"1\" min=\"1\">
            </div>
            <div class=\"eingabe-feld\">
              <label for=\"manuellArtikelSpezifikation-${newIndex}\">Spezifikation / Notiz:</label>
              <textarea id=\"manuellArtikelSpezifikation-${newIndex}\" placeholder=\"Zusätzliche Spezifikationen oder Notizen\"></textarea>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML("beforeend", html);
    }

    function removeManuelleArtikel(index) {
      const element = document.getElementById(`manuellerArtikel-${index}`);
      if (element) {
        element.remove();
        zeigeToast('<i class="bi bi-trash"></i> Manueller Artikel entfernt', 'undo');
      }
    }

    document.getElementById("weiterenartikelBtn").addEventListener("click", addManuelleArtikelSection);

    document.getElementById("artikelHinzufuegenBtn").addEventListener("click", function() {
      const manuelleArtikel = [];
      for (let i = 0; i < manuelleArtikelCounter; i++) {
        const artikelElement = document.getElementById(`manuellerArtikel-${i}`);
        if (artikelElement) {
          const nummer = document.getElementById(`manuellArtikelNummer-${i}`).value;
          const name = document.getElementById(`manuellArtikelName-${i}`).value;
          const menge = parseInt(document.getElementById(`manuellArtikelMenge-${i}`).value);
          const spezifikation = document.getElementById(`manuellArtikelSpezifikation-${i}`).value;

          if (name && menge > 0) {
            manuelleArtikel.push({
              nummer: nummer,
              name: name,
              menge: menge,
              spezifikation: spezifikation
            });
          }
        }
      }

      if (manuelleArtikel.length > 0) {
        if (!window.merklisteItems) {
          window.merklisteItems = [];
        }
        window.merklisteItems = window.merklisteItems.concat(manuelleArtikel);
        updateArtikelListe();

        document.getElementById("manuelleArtikelContainer").innerHTML = "";
        manuelleArtikelCounter = 0;
        addManuelleArtikelSection();
      } else {
        alert("Bitte geben Sie mindestens einen manuellen Artikel mit Bezeichnung und Menge ein.");
      }
    });

    // Datum im Header anzeigen
    function displayCurrentDate() {
      const today = new Date();
      const options = { year: "numeric", month: "long", day: "numeric" };
      document.getElementById("heute").textContent = today.toLocaleDateString("de-DE", options);
    }

    // Hilfsfunktionen für Mitarbeiter-Werte
    function getSachbearbeiterValue() {
      const dropdown = document.getElementById("sachbearbeiterDropdown");
      const manualInput = document.getElementById("sachbearbeiterManuell");
      return dropdown.value === "manuell" ? manualInput.value || "" : dropdown.value || "";
    }
    
    function getAussendienstmitarbeiterValue() {
      const dropdown = document.getElementById("aussendienstDropdown");
      const manualInput = document.getElementById("aussendienstManuell");
      return dropdown.value === "manuell" ? manualInput.value || "" : dropdown.value || "";
    }

// ========================================================================
// ===== NEU: Funktion zum Wiederherstellen der Anfrage-Formulardaten =====
// ========================================================================
function restoreAnfrageFormData() {
    try {
        const savedDataJSON = localStorage.getItem('anfrageFormData');
        if (!savedDataJSON) return; // Keine Daten gefunden, nichts tun.

        const savedData = JSON.parse(savedDataJSON);

        // Haupttitel
        document.getElementById('mainTitleInput').value = savedData.mainTitle || 'Interne Anfrage';

        // Kundendaten
        document.getElementById('name').value = savedData.name || '';
        document.getElementById('firma').value = savedData.firma || '';
        document.getElementById('strasse').value = savedData.strasse || '';
        document.getElementById('plz').value = savedData.plz || '';
        document.getElementById('ort').value = savedData.ort || '';
        document.getElementById('land').value = savedData.land || '';
        document.getElementById('email').value = savedData.email || '';
        document.getElementById('telefon').value = savedData.telefon || '';
        document.getElementById('kundennummer').value = savedData.kundennummer || '';

        // Bearbeitung (Dropdowns mit Select2)
        $('#sachbearbeiterDropdown').val(savedData.sachbearbeiter).trigger('change');
        document.getElementById('sachbearbeiterManuell').value = savedData.sachbearbeiterManuell || '';
        $('#aussendienstDropdown').val(savedData.aussendienst).trigger('change');
        document.getElementById('aussendienstManuell').value = savedData.aussendienstManuell || '';

        // Artikel wiederherstellen und Liste neu zeichnen
        window.merklisteItems = savedData.artikel || [];
        updateArtikelListe();

        // Mitteilung für den Innendienst
        document.getElementById('hintergrund').value = savedData.hintergrund || '';
        document.getElementById('fokus').value = savedData.fokus || '';
        document.getElementById('preisgestaltung').value = savedData.preisgestaltung || '';
        document.getElementById('bericht').value = savedData.bericht || '';
        document.getElementById('aufgaben').value = savedData.aufgaben || '';

        // Toggle-States wiederherstellen
        if (savedData.toggleStates) {
          Object.entries(savedData.toggleStates).forEach(([id, checked]) => {
            const cb = document.getElementById('toggle-' + id);
            if (cb) {
              cb.checked = checked;
              cb.closest('.briefing-field').classList.toggle('inactive', !checked);
            }
          });
        }
        // Editierbare Labels wiederherstellen
        if (savedData.fieldLabels) {
          Object.entries(savedData.fieldLabels).forEach(([id, label]) => {
            const field = document.querySelector(`.briefing-field[data-field-id="${id}"] .field-label-edit`);
            if (field) field.value = label;
          });
        }

        // Sichtbarkeit der manuellen Felder korrekt setzen
        if (savedData.sachbearbeiter === 'manuell') {
            document.getElementById('sachbearbeiterManuell').style.display = 'block';
        }
        if (savedData.aussendienst === 'manuell') {
            document.getElementById('aussendienstManuell').style.display = 'block';
        }

        // Nach erfolgreicher Wiederherstellung die Daten löschen
        localStorage.removeItem('anfrageFormData');
        console.log("Anfrage-Formulardaten erfolgreich wiederhergestellt.");

    } catch (error) {
        console.error("Fehler beim Wiederherstellen der Anfrage-Formulardaten:", error);
        localStorage.removeItem('anfrageFormData');
    }
}


    // PDF-Generierung
    async function generateAngebotsanfragePDF() {
      // Formulardaten im localStorage sichern
      try {
        const formData = {
          mainTitle: document.getElementById('mainTitleInput').value,
          name: document.getElementById('name').value,
          firma: document.getElementById('firma').value,
          strasse: document.getElementById('strasse').value,
          plz: document.getElementById('plz').value,
          ort: document.getElementById('ort').value,
          land: document.getElementById('land').value,
          email: document.getElementById('email').value,
          telefon: document.getElementById('telefon').value,
          kundennummer: document.getElementById('kundennummer').value,
          sachbearbeiter: $('#sachbearbeiterDropdown').val(),
          sachbearbeiterManuell: document.getElementById('sachbearbeiterManuell').value,
          aussendienst: $('#aussendienstDropdown').val(),
          aussendienstManuell: document.getElementById('aussendienstManuell').value,
          artikel: window.merklisteItems || [],
          hintergrund: document.getElementById('hintergrund').value,
          fokus: document.getElementById('fokus').value,
          preisgestaltung: document.getElementById('preisgestaltung').value,
          bericht: document.getElementById('bericht').value,
          aufgaben: document.getElementById('aufgaben').value,
          toggleStates: Object.fromEntries(
            [...document.querySelectorAll('.field-toggle')].map(cb => [
              cb.id.replace('toggle-', ''), cb.checked
            ])
          ),
          fieldLabels: Object.fromEntries(
            [...document.querySelectorAll('.briefing-field[data-field-id]')].map(f => [
              f.dataset.fieldId,
              f.querySelector('.field-label-edit').value
            ])
          )
        };
        localStorage.setItem('anfrageFormData', JSON.stringify(formData));
      } catch (error) {
        console.error("Fehler beim Sichern der Formulardaten:", error);
      }

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Logo laden
        const logoUrl = "https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png";
        let logoImg = null;
        try {
          logoImg = await loadImageAsBase64(logoUrl);
        } catch (error) {
          console.warn("Logo konnte nicht geladen werden:", error);
        }

        // Layout-Konstanten
        const margin = 20;
        const labelCol = margin;
        const valueCol = margin + 38;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const contentWidth = pageWidth - 2 * margin;
        let yPosition = margin;
        let currentPage = 1;

        // === Hilfsfunktionen ===

        function addBlueDesignBars() {
          doc.setFillColor(0, 161, 225);
          doc.rect(0, 40, 4, 20, 'F');
          doc.rect(0, 65, 4, 20, 'F');
          doc.rect(0, 90, 4, 20, 'F');
        }

        function addPageHeader(pageNum, totalPages) {
          addBlueDesignBars();
          if (logoImg) {
            doc.addImage(logoImg, "PNG", margin, margin, 25, 25, undefined, 'FAST');
          }
          const heute = new Date();
          const datumString = heute.toLocaleDateString("de-DE", { year: "numeric", month: "long", day: "numeric" });
          doc.setFontSize(10);
          doc.setTextColor(100, 100, 100);
          doc.text(datumString, pageWidth - margin, margin + 10, { align: "right" });
          if (totalPages > 1) {
            doc.text(`Seite ${pageNum} von ${totalPages}`, pageWidth - margin, margin + 20, { align: "right" });
          }
          // Innendienst / Aussendienst rechts oben
          doc.setFontSize(8);
          const sbVal = getSachbearbeiterValue();
          const adVal = getAussendienstmitarbeiterValue();
          let headerY = margin + 26;
          if (sbVal) {
            doc.text(`Innendienst: ${sbVal}`, pageWidth - margin, headerY, { align: "right" });
            headerY += 5;
          }
          if (adVal) {
            doc.text(adVal, pageWidth - margin, headerY, { align: "right" });
          }
        }

        function addPageFooter(pageNum, totalPages) {
          const footerY = pageHeight - 15;
          const mainTitle = document.getElementById("mainTitleInput").value || "Interne Anfrage";
          const kundenName = inputs.firma.value || inputs.name.value || "";
          doc.setDrawColor(200, 200, 200);
          doc.line(margin, footerY - 5, pageWidth - margin, footerY - 5);
          doc.setFontSize(8);
          doc.setTextColor(100, 100, 100);
          doc.text(mainTitle, margin, footerY);
          if (kundenName) {
            doc.text(kundenName, pageWidth / 2, footerY, { align: "center" });
          }
          doc.text(`Seite ${pageNum} von ${totalPages}`, pageWidth - margin, footerY, { align: "right" });
        }

        function addNewPage() {
          doc.addPage();
          currentPage++;
          yPosition = margin + 50;
        }

        function checkPageBreak(neededSpace) {
          if (yPosition + neededSpace > pageHeight - 30) {
            addNewPage();
            return true;
          }
          return false;
        }

        // Sektions-Ueberschrift mit Trennlinie
        function addSectionHeader(title) {
          checkPageBreak(25);
          doc.setDrawColor(0, 161, 225);
          doc.setLineWidth(0.5);
          doc.line(margin, yPosition, pageWidth - margin, yPosition);
          doc.setLineWidth(0.2);
          yPosition += 8;
          doc.setFontSize(11);
          doc.setFont("helvetica", "bold");
          doc.setTextColor(0, 161, 225);
          doc.text(title.toUpperCase(), margin, yPosition);
          yPosition += 8;
        }

        // Label-Value Zeile (nur wenn Value vorhanden)
        function addLabelValue(label, value) {
          if (!value || value === "Nicht angegeben") return;
          checkPageBreak(7);
          doc.setFontSize(10);
          doc.setFont("helvetica", "bold");
          doc.setTextColor(80, 80, 80);
          doc.text(label, labelCol, yPosition);
          doc.setFont("helvetica", "normal");
          doc.setTextColor(0, 0, 0);
          doc.text(value, valueCol, yPosition);
          yPosition += 6;
        }

        // === Seite 1: Header ===
        addPageHeader(1, 1);
        yPosition += 50;

        // Haupttitel (Schrift passt sich an Breite an)
        const mainTitle = document.getElementById("mainTitleInput").value || "INTERNE ANGEBOTSANFORDERUNG";
        const titleText = mainTitle.toUpperCase();
        doc.setFont("helvetica", "bold");
        doc.setTextColor(0, 0, 0);
        let titleSize = 18;
        doc.setFontSize(titleSize);
        while (titleSize > 10 && doc.getTextWidth(titleText) > contentWidth) {
          titleSize -= 1;
          doc.setFontSize(titleSize);
        }
        doc.text(titleText, pageWidth / 2, yPosition, { align: "center" });
        yPosition += 15;

        // === BEARBEITUNG ===
        const sachbearbeiter = getSachbearbeiterValue();
        const aussendienstmitarbeiter = getAussendienstmitarbeiterValue();

        if (sachbearbeiter || aussendienstmitarbeiter) {
          addSectionHeader("Bearbeitung");
          addLabelValue("Innendienst:", sachbearbeiter);
          addLabelValue("Ausgestellt von:", aussendienstmitarbeiter);
          yPosition += 6;
        }

        // === KUNDENDATEN ===
        const kundenFirma = inputs.firma.value.trim();
        const kundenName = inputs.name.value.trim();
        const kundenStrasse = inputs.strasse.value.trim();
        const kundenPlz = inputs.plz.value.trim();
        const kundenOrt = inputs.ort.value.trim();
        const kundenEmail = inputs.email.value.trim();
        const kundenTelefon = inputs.telefon.value.trim();
        const kundennummerValue = document.getElementById("kundennummer").value.trim();

        const hatKundendaten = kundenFirma || kundenName || kundenStrasse || kundenEmail || kundenTelefon;
        if (hatKundendaten) {
          addSectionHeader("Kundendaten");
          addLabelValue("Firma:", kundenFirma);
          addLabelValue("Ansprechpartner:", kundenName);
          const adresse = [kundenStrasse, [kundenPlz, kundenOrt].filter(Boolean).join(' ')].filter(Boolean).join(', ');
          addLabelValue("Adresse:", adresse);
          addLabelValue("E-Mail:", kundenEmail);
          addLabelValue("Telefon:", kundenTelefon);
          addLabelValue("Kundennummer:", kundennummerValue);
          yPosition += 6;
        }

        // === BRIEFING ===
        const briefingFelder = [];
        document.querySelectorAll('.briefing-field[data-field-id]').forEach(field => {
          const fieldId = field.dataset.fieldId;
          const toggle = document.getElementById('toggle-' + fieldId);
          if (toggle && toggle.checked) {
            const label = field.querySelector('.field-label-edit').value || field.querySelector('.field-label-edit').dataset.default;
            const textarea = document.getElementById(fieldId);
            const value = textarea ? textarea.value.trim() : '';
            if (value) {
              briefingFelder.push([label, value]);
            }
          }
        });

        if (briefingFelder.length > 0) {
          addSectionHeader("Mitteilung");
          doc.setFontSize(10);
          briefingFelder.forEach(([label, value]) => {
            const splitText = doc.splitTextToSize(value, contentWidth);
            const neededSpace = 8 + splitText.length * 5 + 4;
            checkPageBreak(neededSpace);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(80, 80, 80);
            doc.text(label + ":", labelCol, yPosition);
            yPosition += 6;
            doc.setFont("helvetica", "normal");
            doc.setTextColor(0, 0, 0);
            doc.text(splitText, labelCol, yPosition);
            yPosition += splitText.length * 5 + 4;
          });
          yPosition += 4;
        }

        // === ARTIKEL (nur wenn vorhanden) ===
        const alleArtikel = [];
        if (window.merklisteItems && window.merklisteItems.length > 0) {
          window.merklisteItems.forEach(artikel => {
            alleArtikel.push({
              nummer: artikel.nummer || artikel.artikelnummer || "N/A",
              bezeichnung: artikel.name || artikel.bezeichnung || "Unbekannter Artikel",
              menge: artikel.menge || 1,
              spezifikation: artikel.spezifikation || ""
            });
          });
        }

        if (alleArtikel.length > 0) {
          addSectionHeader("Artikel");

          // Tabellen-Header Funktion
          function drawTableHeader() {
            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(80, 80, 80);
            doc.text("Pos", margin, yPosition);
            doc.text("Menge", margin + 15, yPosition);
            doc.text("Art.-Nr.", margin + 35, yPosition);
            doc.text("Bezeichnung", margin + 65, yPosition);
            doc.text("Spezifikation", margin + 120, yPosition);
            yPosition += 4;
            doc.setDrawColor(180, 180, 180);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 5;
          }

          checkPageBreak(30);
          drawTableHeader();

          alleArtikel.forEach((artikel, index) => {
            const bezeichnungLines = doc.splitTextToSize(artikel.bezeichnung, 50);
            const spezLines = artikel.spezifikation ? doc.splitTextToSize(artikel.spezifikation, 55) : [];
            const maxLines = Math.max(bezeichnungLines.length, spezLines.length, 1);
            const artikelHoehe = Math.max(10, maxLines * 5 + 2);

            if (yPosition + artikelHoehe > pageHeight - 30) {
              doc.addPage();
              currentPage++;
              yPosition = margin + 30;
              addPageHeader(currentPage, currentPage);
              yPosition += 20;
              drawTableHeader();
            }

            // Zebra-Hintergrund fuer gerade Zeilen
            if (index % 2 === 0) {
              doc.setFillColor(245, 247, 250);
              doc.rect(margin, yPosition - 4, contentWidth, artikelHoehe + 2, 'F');
            }

            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(0, 0, 0);

            const startY = yPosition;
            doc.text((index + 1).toString(), margin + 3, startY);
            doc.text(artikel.menge.toString(), margin + 18, startY);
            doc.setFont("helvetica", "bold");
            doc.text(artikel.nummer, margin + 35, startY);
            doc.setFont("helvetica", "normal");
            doc.text(bezeichnungLines, margin + 65, startY);
            if (spezLines.length > 0) {
              doc.setTextColor(80, 80, 80);
              doc.text(spezLines, margin + 120, startY);
              doc.setTextColor(0, 0, 0);
            }

            yPosition += artikelHoehe;
          });
        }
        // Kein "Keine Artikel" Text — Sektion wird komplett weggelassen

        // Header und Footer auf allen Seiten finalisieren
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);
          addPageHeader(i, totalPages);
          addPageFooter(i, totalPages);
        }

        // Dateiname zusammensetzen
        const ueberschrift = document.getElementById("mainTitleInput").value || "Interne Anfrage";
        const firma = document.getElementById("firma").value || "";
        const ansprechpartner = document.getElementById("name").value || "";
        const ort = document.getElementById("ort").value || "";
        const datum = new Date().toISOString().split('T')[0];
        const filenameParts = [ueberschrift, firma, ansprechpartner, ort, datum].filter(part => part);
        const cleanFilename = filenameParts.map(part =>
          part.replace(/[^a-zA-Z0-9äöüÄÖÜß\s]/g, "").trim()
        ).join("_");

        doc.save(`${cleanFilename}.pdf`);
        console.log(`PDF erstellt: ${cleanFilename}.pdf`);

      } catch (error) {
        console.error("Fehler bei der PDF-Erstellung:", error);
        alert("Fehler bei der PDF-Erstellung. Bitte versuchen Sie es erneut.");
      }
    }

    // Hilfsfunktion zum Laden von Bildern als Base64
    function loadImageAsBase64(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          const dataURL = canvas.toDataURL("image/png");
          resolve(dataURL);
        };
        img.onerror = reject;
        img.src = url;
      });
    }


    // ========================================================================
// ===== NEU: DER EINZIGE UND KORREKTE STARTPUNKT DER SEITE         =====
// ========================================================================

// ========================================================================
// ===== NEU: KORREKTER STARTPUNKT DER SEITE (Version 2) =====
// ========================================================================
document.addEventListener("DOMContentLoaded", async () => {
  
    // --- SCHRITT 0: Briefing-Feld-Toggles initialisieren ---
    document.querySelectorAll('.field-toggle').forEach(cb => {
      cb.addEventListener('change', function() {
        const field = this.closest('.briefing-field');
        field.classList.toggle('inactive', !this.checked);
      });
    });

    // --- SCHRITT 0b: Titel-Input fokussieren, selektieren + Auto-Resize ---
    const titleInput = document.getElementById('mainTitleInput');
    const measureCtx = document.createElement('canvas').getContext('2d');
    function fitTitleFont() {
      const maxSize = window.innerWidth <= 768 ? 24 : 32;
      const availWidth = titleInput.clientWidth - 12;
      let size = maxSize;
      measureCtx.font = `bold ${size}px 'Roboto Condensed', Arial, sans-serif`;
      while (size > 14 && measureCtx.measureText(titleInput.value || titleInput.placeholder).width > availWidth) {
        size -= 1;
        measureCtx.font = `bold ${size}px 'Roboto Condensed', Arial, sans-serif`;
      }
      titleInput.style.fontSize = size + 'px';
    }
    titleInput.addEventListener('input', fitTitleFont);
    window.addEventListener('resize', fitTitleFont);
    setTimeout(() => {
      fitTitleFont();
      titleInput.focus();
      titleInput.select();
    }, 300);

    // --- SCHRITT 1: Seite mit Standardwerten initialisieren ---
    displayCurrentDate();
    ladeMerklisteAusLocalStorage();
    addManuelleArtikelSection();
    
    $(document).ready(function() {
        $("#sachbearbeiterDropdown").select2({ placeholder: "-- Innendienst auswählen --", allowClear: true });
        $("#aussendienstDropdown").select2({ placeholder: "-- Außendienstmitarbeiter auswählen --", allowClear: true });
    });

    // --- SCHRITT 2: Versuchen, die Standardwerte mit gespeicherten Daten zu überschreiben ---
    restoreAnfrageFormData();

    // --- SCHRITT 3: Kundendatenbank laden (Envelope Encryption) ---
    loadKundenDatenbank();

    // --- SCHRITT 4: PLZ-Feld Event-Listener fuer manuelle Eingabe ---
    document.getElementById('plz').addEventListener('input', function() {
        if (this.value.length >= 4) {
            showKundenByPLZ(this.value.trim());
        } else {
            const container = document.getElementById('kundenErgebnisse');
            if (container) { container.innerHTML = ''; container.style.display = 'none'; }
        }
    });

    // --- SCHRITT 4b: PLZ-Feld auch bei Fokus Dropdown anzeigen ---
    document.getElementById('plz').addEventListener('focus', function() {
        if (this.value.trim().length >= 4) showKundenByPLZ(this.value.trim());
    });

    // --- SCHRITT 5: Kunde-speichern Event-Listener ---
    document.getElementById('kundenSpeichernBtn').addEventListener('click', saveKundeToSupabase);
    document.getElementById('name').addEventListener('input', updateSpeichernButton);

});


  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBN4cAc4nq9je0of0cb_0wEUb1yCz54r7k&libraries=places&callback=initGooglePlaces" async defer></script>
    <section class="form-section-container" style="text-align: center; box-shadow: none; border: none; background: none;">
  <button onclick="generateAngebotsanfragePDF()" class="btn btn-primary">
    <i class="bi bi-file-earmark-pdf"></i> PDF erzeugen
  </button>
</body>
</html>