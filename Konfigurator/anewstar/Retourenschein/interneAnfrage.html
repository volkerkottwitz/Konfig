<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interne Anfrage</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="interneAnfrage.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>
       .search-highlight {
      background-color: rgba(0, 0, 0, 0.2);
      font-weight: bold;
      border-radius: 3px;
      padding: 0 2px;
    }
    .header-right .buttons {
      display: flex;
      gap: 10px;
    }
    .form-section-container {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin: 25px auto;
      background-color: #fdfdfd;
      max-width: 900px;
    }
    .form-section-container h3 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 25px;
      padding-bottom: 10px;
      color: #00a1e1;
      font-size: 1.3em;
    }
    .centered-form-layout {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    .centered-form-layout > * {
      width: 100%;
      max-width: 500px;
    }
    
    /* Stile f√ºr die Suchleiste & Ergebnisse */
    #kundenSuche {
        width: 100%;
        padding: 12px 20px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 25px;
        box-sizing: border-box;
        transition: all 0.2s ease-in-out;
    }
    #kundenSuche:focus {
        outline: none;
        border-color: #00a1e1;
        box-shadow: 0 0 0 3px rgba(0, 161, 225, 0.25);
    }
    #suchErgebnisse {
        position: relative; 
        width: 100%;
        max-width: 500px;
        margin-top: -10px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .ergebnis-item {
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    .ergebnis-item:last-child {
        border-bottom: none;
    }
    .ergebnis-item.active, 
    .ergebnis-item:hover {
        background-color: #46a1f0; 
    }
    .ergebnis-item.no-results {
        cursor: default;
        color: #888;
    }
    .ergebnis-item.no-results:hover {
        background-color: white;
    }

    /* ================================================================= */
    /* ===== KONSISTENTE STILE F√úR ALLE SELECT2-DROPDOWNS ===== */
    /* ================================================================= */

/* KORREKTUR: Die problematische padding-Regel wurde entfernt.
   Der Text richtet sich jetzt standardm√§√üig links aus. */
.select2-container .select2-selection--single .select2-selection__rendered {
    /* padding-left: 20px !important; <-- ENTFERNT */
    line-height: 43px; /* Zentriert den Text vertikal in der Box */
    padding-left: 10px; /* Beh√§lt einen kleinen Abstand zum Rand bei */
    padding-right: 20px; /* Verhindert, dass Text unter den Pfeil rutscht */
}

/* 2. H√∂he und Rahmen anpassen */
.select2-container .select2-selection--single {
    height: 45px !important;
    border-radius: 25px !important;
    border: 1px solid #ccc !important;
    display: flex;
    align-items: center;
}

/* 3. Rahmenfarbe bei Fokus anpassen */
.select2-container--default.select2-container--open .select2-selection--single,
.select2-container--default .select2-selection--single:focus {
    border-color: #00a1e1 !important;
    box-shadow: 0 0 0 3px rgba(0, 161, 225, 0.25) !important;
}

/* 4. Pfeil-Icon vertikal zentrieren */
.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 43px !important;
}
  </style>
</head>
<body>
  <header id="header">
    <div class="header-left">
      <img src="https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png" alt="Firmenlogo">
    </div>
    <div class="header-content">
      <input type="text" id="mainTitleInput" value="Interne Anfrage" class="editable-title">
      <div class="header-date" id="heute"></div>
    </div>
    <div class="header-right">
      <div class="buttons">
        <button onclick="window.close( )" class="btn btn-secondary">üîô Zur√ºck</button>
        <button onclick="generateAngebotsanfragePDF()" class="btn btn-primary">PDF erzeugen</button>
      </div>
    </div>
  </header>

  <section class="form-section-container">
    <h3>Kundendaten</h3>
    <div id="kundenDetails" class="centered-form-layout">
      <!-- ===== HTML-√ÑNDERUNG: Wrapper entfernt, Suchleiste direkt im Layout ===== -->
      <input type="text" id="kundenSuche" placeholder="Lade Kundenliste..." disabled>
      <div id="suchErgebnisse" style="display: none;"></div>
      
      <input type="text" id="name" placeholder="Name">
      <input type="text" id="firma" placeholder="Firma">
      <input type="text" id="strasse" placeholder="Stra√üe">
      <input type="text" id="plz" placeholder="PLZ">
      <input type="text" id="ort" placeholder="Ort">
      <input type="text" id="land" placeholder="Land">
      <input type="text" id="email" placeholder="E-Mail">
      <input type="text" id="telefon" placeholder="Telefon">
    </div>
  </section>

  <section class="form-section-container">
    <h3>Bearbeitung</h3>
    <div class="centered-form-layout">
      <select id="sachbearbeiterDropdown">
        <option value="">-- Innendienst ausw√§hlen --</option>
        <option value="Denise Otto">Denise Otto</option>
        <option value="Sascha Heusel">Sascha Heusel</option>
        <option value="Nadine Suhr">Nadine Suhr</option>
        <option value="Nils Vokuhl">Nils Vokuhl</option>
        <option value="Claudia Batke">Claudia Batke</option>
        <option value="Karsten Walter">Karsten Walter</option>
        <option value="manuell">-- Manuelle Eingabe --</option>
      </select>
      <input type="text" id="sachbearbeiterManuell" placeholder="Sachbearbeiter (manuell)" style="display: none;">
      <select id="aussendienstDropdown">
        <option value="">-- Au√üendienstmitarbeiter ausw√§hlen --</option>
        <option value="Rafael Furtw√§ngler">Rafael Furtw√§ngler</option>
        <option value="Christof M√ºnster">Christof M√ºnster</option>
        <option value="Sascha Heusel">Sascha Heusel</option>
        <option value="Bernhard Kneissl">Bernhard Kneissl</option>
        <option value="Christopher-Sean Haus">Christopher-Sean Haus</option>
        <option value="Sascha Barkowsky">Sascha Barkowsky</option>
        <option value="Volker Kottwitz">Volker Kottwitz</option>
        <option value="Volker Oesterwind">Volker Oesterwind</option>
        <option value="Thomas Sch√∂nf√º√ü">Thomas Sch√∂nf√º√ü</option>
        <option value="Thomas Wendt">Thomas Wendt</option>
        <option value="Harald Natzke">Harald Natzke</option>
        <option value="Lukas Pfeil">Lukas Pfeil</option>
        <option value="Nancy Ullbricht">Nancy Ullbricht</option>
        <option value="Heiner Birkholz">Heiner Birkholz</option>
        <option value="Helmut W√∂lfel">Helmut W√∂lfel</option>
        <option value="manuell">-- Manuelle Eingabe --</option>
      </select>
      <input type="text" id="aussendienstManuell" placeholder="Au√üendienstmitarbeiter (manuell)" style="display: none;">
    </div>
  </section>

  <!-- Der Rest des HTML bleibt unver√§ndert -->
  <section id="artikelListe" class="search-container">
    <h3>Artikel f√ºr das Angebot</h3>
    <div id="artikelInhalt">
      <p>Keine Artikel in der Merkliste gefunden. Bitte verwenden Sie den PDF-Viewer, um Artikel zur Merkliste hinzuzuf√ºgen.</p>
    </div>
  </section>
  <section id="manuelleArtikelSection" class="search-container">
    <h3>Artikel manuell hinzuf√ºgen</h3>
    <div id="manuelleArtikelContainer"></div>
    <div class="button-container">
      <button type="button" id="weiterenartikelBtn" class="btn btn-secondary">+ Weiteren Artikel hinzuf√ºgen</button>
      <button type="button" id="artikelHinzufuegenBtn" class="btn btn-primary">Artikel zur Liste hinzuf√ºgen</button>
    </div>
  </section>
  <section id="briefingSection" class="search-container">
    <h3>Mitteilung f√ºr den Innendienst</h3>
    <div class="briefing-grid">
      <div class="briefing-field">
        <label for="hintergrund">Hintergrund:</label>
        <textarea id="hintergrund" placeholder="Kontext des Kundengespr√§chs..."></textarea>
      </div>
      <div class="briefing-field">
        <label for="fokus">Fokus im Angebot:</label>
        <textarea id="fokus" placeholder="Was soll besonders hervorgehoben werden?..."></textarea>
      </div>
      <div class="briefing-field">
        <label for="preisgestaltung">Preisgestaltung:</label>
        <textarea id="preisgestaltung" placeholder="Vereinbarte Rabatte, Sonderkonditionen..."></textarea>
      </div>
    </div>
  </section>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Referenzen auf die HTML-Elemente
    const sachbearbeiterDropdown = document.getElementById("sachbearbeiterDropdown" );
    const sachbearbeiterManuellInput = document.getElementById("sachbearbeiterManuell");
    const aussendienstDropdown = document.getElementById("aussendienstDropdown");
    const aussendienstManuellInput = document.getElementById("aussendienstManuell");
    const inputs = {
      name: document.getElementById("name"),
      firma: document.getElementById("firma"),
      telefon: document.getElementById("telefon"),
      email: document.getElementById("email"),
      strasse: document.getElementById("strasse"),
      ort: document.getElementById("ort"),
      plz: document.getElementById("plz"),
      land: document.getElementById("land")
    };
    const briefingInputs = {
      hintergrund: document.getElementById("hintergrund"),
      fokus: document.getElementById("fokus"),
      preisgestaltung: document.getElementById("preisgestaltung")
    };

    // LOGIK F√úR DIE INTELLIGENTE SUCHLEISTE
    let kunden = [];
    let activeResultIndex = -1;
    const kundenSucheInput = document.getElementById('kundenSuche');
    const suchErgebnisseContainer = document.getElementById('suchErgebnisse');

// ========================================================================
// ===== ANGEPASSTE VERSION: UNIVERSALER DATENSCHUTZ- & LADE-CODE     =====
// ========================================================================

async function loadProtectedData() {
    // 1. Versuche, das Passwort aus dem aktuellen localStorage zu lesen
    let password = localStorage.getItem('customerDataPassword');

    // 2. Wenn nicht gefunden, pr√ºfe, ob es im URL-Hash √ºbergeben wurde
    if (!password && window.location.hash.includes('password=')) {
        const urlHash = window.location.hash.substring(1);
        const params = new URLSearchParams(urlHash);
        password = params.get('password');
        
        if (password) {
            localStorage.setItem('customerDataPassword', password);
            history.replaceState(null, '', window.location.pathname + window.location.search);
        }
    }

    // Hilfsfunktion, um das Suchfeld zu deaktivieren und die Nachricht anzuzeigen
    function disableSearch(message) {
        const kundenSucheInput = document.getElementById('kundenSuche');
        if (kundenSucheInput) {
            kundenSucheInput.disabled = true;
            kundenSucheInput.placeholder = message;
        }
    }

    // 3. FINALE PR√úFUNG: Wenn wir jetzt immer noch kein Passwort haben...
    if (!password) {
        console.log("Kein Passwort gefunden. Kundensuche wird deaktiviert.");
        disableSearch("F√ºr Kundensuche bitte anmelden"); // <-- ANGEPASST: Keine Weiterleitung
        return false; // Beendet die Funktion, die Seite l√§uft normal weiter.
    }

    // 4. Wenn wir hier ankommen, haben wir ein Passwort. Lade und entschl√ºssele die Daten.
    try {
        const kundenSucheInput = document.getElementById('kundenSuche');
        if(kundenSucheInput) kundenSucheInput.placeholder = "Entschl√ºssele Kundendaten...";

        const encryptedFilePath = 'https://volkerkottwitz.github.io/Konfig/Konfigurator/anewstar/Retourenschein/kundenstamm.enc';
        const response = await fetch(encryptedFilePath + '?t=' + new Date( ).getTime());
        
        if (!response.ok) throw new Error('Kundendatei nicht gefunden.');
        
        const encryptedArrayBuffer = await response.arrayBuffer();
        const decryptedCsvText = await decryptData(encryptedArrayBuffer, password);
        
        kunden = Papa.parse(decryptedCsvText, { header: true, skipEmptyLines: true, bom: true }).data;
        
        return true;

    } catch (error) {
        // Wenn die Entschl√ºsselung fehlschl√§gt (z.B. falsches Passwort)
        console.error("Fehler bei der Datenentschl√ºsselung:", error);
        localStorage.removeItem('customerDataPassword'); // Altes, falsches Passwort entfernen
        disableSearch("Anmeldung fehlgeschlagen. Bitte neu anmelden."); // <-- ANGEPASST: Keine Weiterleitung
        return false;
        // Kein Alert oder Redirect mehr, nur die Nachricht im Feld.
    }
}




// Hilfsfunktion, die die eigentliche Entschl√ºsselung durchf√ºhrt
async function decryptData(encryptedArrayBuffer, password) {
    const ITERATIONS = 480000;
    const SALT_SIZE_BYTES = 16;
    const NONCE_SIZE_BYTES = 12;

    // Daten aus der Datei extrahieren
    const salt = encryptedArrayBuffer.slice(0, SALT_SIZE_BYTES);
    const nonce = encryptedArrayBuffer.slice(SALT_SIZE_BYTES, SALT_SIZE_BYTES + NONCE_SIZE_BYTES);
    const data = encryptedArrayBuffer.slice(SALT_SIZE_BYTES + NONCE_SIZE_BYTES);

    // Passwort in einen Basisschl√ºssel umwandeln
    const passwordKey = await window.crypto.subtle.importKey(
        'raw', new TextEncoder().encode(password), { name: 'PBKDF2' }, false, ['deriveKey']
    );

    // Starken AES-Schl√ºssel ableiten
    const aesKey = await window.crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt: salt, iterations: ITERATIONS, hash: 'SHA-256' },
        passwordKey, { name: 'AES-GCM', length: 256 }, true, ['decrypt']
    );

    // Daten entschl√ºsseln
    const decryptedData = await window.crypto.subtle.decrypt(
        { name: 'AES-GCM', iv: nonce }, aesKey, data
    );

    // Entschl√ºsselte Daten in Text umwandeln
    return new TextDecoder().decode(decryptedData);
}



function initializeCustomerSearchListeners() {
    kundenSucheInput.addEventListener('input', function() {
        activeResultIndex = -1; // Reset bei neuer Eingabe
        const suchbegriff = this.value.toLowerCase();
        if (suchbegriff.length < 2) {
            suchErgebnisseContainer.style.display = 'none';
            return;
        }
        const suchbegriffe = suchbegriff.split(' ').filter(Boolean);
        const treffer = kunden.filter(kunde => {
            const adresseTeile = kunde.Adresse ? kunde.Adresse.split(",").map(x => x.trim()) : [];
            const ort = adresseTeile[1] || '';
            const plz = adresseTeile[2] || '';
            const suchString = `${kunde.Name || ''} ${kunde.Firma || ''} ${plz} ${ort}`.toLowerCase();
            return suchbegriffe.every(term => suchString.includes(term));
        }).slice(0, 50);
        zeigeSuchErgebnisse(treffer, suchbegriffe);
    });

    kundenSucheInput.addEventListener('keydown', function(e) {
        const ergebnisse = suchErgebnisseContainer.querySelectorAll('.ergebnis-item:not(.no-results)');
        if (ergebnisse.length === 0) return;

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                activeResultIndex = (activeResultIndex + 1) % ergebnisse.length;
                updateActiveResult(ergebnisse);
                break;
            case 'ArrowUp':
                e.preventDefault();
                activeResultIndex = (activeResultIndex - 1 + ergebnisse.length) % ergebnisse.length;
                updateActiveResult(ergebnisse);
                break;
            case 'Enter':
                e.preventDefault();
                if (activeResultIndex > -1) {
                    ergebnisse[activeResultIndex].click();
                } else if (ergebnisse.length === 1) {
                    ergebnisse[0].click();
                }
                break;
            case 'Escape':
                suchErgebnisseContainer.style.display = 'none';
                break;
        }
    });


    suchErgebnisseContainer.addEventListener('click', function(e) {
        const ergebnisItem = e.target.closest('.ergebnis-item');
        if (ergebnisItem && ergebnisItem.dataset.index) {
            const index = ergebnisItem.dataset.index;
            const kunde = kunden[index];
            const adresseTeile = kunde.Adresse ? kunde.Adresse.split(",").map(x => x.trim()) : ["", "", "", ""];
            inputs.name.value = kunde.Name || "";
            inputs.firma.value = kunde.Firma || "";
            inputs.telefon.value = kunde.Telefon || "";
            inputs.email.value = kunde["E-Mail"] || "";
            inputs.strasse.value = adresseTeile[0] || "";
            inputs.ort.value = adresseTeile[1] || "";
            inputs.plz.value = adresseTeile[2] || "";
            inputs.land.value = adresseTeile[3] || "";
            kundenSucheInput.value = '';
            suchErgebnisseContainer.style.display = 'none';
        }
    });
    
    document.addEventListener('click', function(e) {
        if (!kundenSucheInput.contains(e.target) && !suchErgebnisseContainer.contains(e.target)) {
            suchErgebnisseContainer.style.display = 'none';
        }
    });

    }

        function updateActiveResult(ergebnisse) {
        ergebnisse.forEach(item => item.classList.remove('active'));
        if (activeResultIndex > -1) {
            const activeItem = ergebnisse[activeResultIndex];
            activeItem.classList.add('active');
            activeItem.scrollIntoView({ block: 'nearest' });
        }
    }

    function zeigeSuchErgebnisse(treffer, suchbegriffe) {
        if (treffer.length === 0) {
            suchErgebnisseContainer.innerHTML = '<div class="ergebnis-item no-results">Keine Treffer gefunden</div>';
        } else {
            let html = '';
            treffer.forEach(kunde => {
                const originalIndex = kunden.indexOf(kunde);
                const adresseTeile = kunde.Adresse ? kunde.Adresse.split(",").map(x => x.trim()) : [];
                const ort = adresseTeile[1] || '';
                const plz = adresseTeile[2] || '';
                const nameTeil = kunde.Name ? `${kunde.Name.trim()} ‚Äì ` : '';
                const firmaTeil = kunde.Firma ? kunde.Firma.trim() : 'Unbekannte Firma';
                let ortsTeil = (plz && ort) ? ` (${plz} ${ort})` : (ort ? ` (${ort})` : (plz ? ` (${plz})` : ''));
                let label = `${nameTeil}${firmaTeil}${ortsTeil}`;
                suchbegriffe.forEach(term => {
                    const regex = new RegExp(term, 'gi');
                    label = label.replace(regex, match => `<span class="search-highlight">${match}</span>`);
                });
                html += `<div class="ergebnis-item" data-index="${originalIndex}">${label}</div>`;
            });
            suchErgebnisseContainer.innerHTML = html;
        }
        suchErgebnisseContainer.style.display = 'block';
    }


    // Initialisierung der anderen Dropdowns
    $(document).ready(function() {
        $("#sachbearbeiterDropdown").select2({ placeholder: "-- Innendienst ausw√§hlen --", allowClear: true });
        $("#aussendienstDropdown").select2({ placeholder: "-- Au√üendienstmitarbeiter ausw√§hlen --", allowClear: true });
    });

    // Event-Listener f√ºr Sachbearbeiter- & Au√üendienst-Dropdowns
    $("#sachbearbeiterDropdown").on("change", function () {
      sachbearbeiterManuellInput.style.display = this.value === "manuell" ? "block" : "none";
      if(this.value === "manuell") sachbearbeiterManuellInput.focus(); else sachbearbeiterManuellInput.value = "";
    });
    $("#aussendienstDropdown").on("change", function () {
      aussendienstManuellInput.style.display = this.value === "manuell" ? "block" : "none";
      if(this.value === "manuell") aussendienstManuellInput.focus(); else aussendienstManuellInput.value = "";
    });



       let manuelleArtikelCounter = 0;
    // --- Der Rest Ihres Skripts bleibt unver√§ndert ---

    // Merkliste aus localStorage laden
    function ladeMerklisteAusLocalStorage() {
      try {
        const merklisteData = localStorage.getItem("merklisteForRetourenschein");
        if (merklisteData) {
          const merkliste = JSON.parse(merklisteData);
          
          window.merklisteItems = merkliste.map(item => ({
            nummer: item.nummer || item.artikelnummer || "",
            name: item.name || item.bezeichnung || "Unbekannter Artikel",
            bezeichnung: item.name || item.bezeichnung || "Unbekannter Artikel",
            artikelnummer: item.nummer || item.artikelnummer || "",
            menge: item.menge || 1,
            preis: item.preis || "0,00 ‚Ç¨"
          }));
          
          updateArtikelListe();
          localStorage.removeItem("merklisteForRetourenschein");
          console.log("Merkliste erfolgreich geladen:", merkliste.length, "Artikel");
        }
      } catch (error) {
        console.error("Fehler beim Laden der Merkliste:", error);
      }
    }

    // Funktion zum Entfernen eines Artikels
    function removeArtikel(index) {
      if (confirm("M√∂chten Sie diesen Artikel wirklich entfernen?")) {
        window.merklisteItems.splice(index, 1);
        updateArtikelListe();
      }
    }

    // Merkliste-Artikel anzeigen
    function updateArtikelListe() {
      const artikelInhalt = document.getElementById("artikelInhalt");
      
      if (window.merklisteItems && window.merklisteItems.length > 0) {
        let cardsHtml = "<div class=\"artikel-karten-container\">";
        
        window.merklisteItems.forEach((artikel, index) => {
          cardsHtml += `
            <div class=\"artikel-karte\">
              <div class=\"artikel-info\">
                <div class=\"artikel-name\">${artikel.name || artikel.bezeichnung || "Unbekannter Artikel"}</div>
                <div class=\"artikel-details\">
                  <p><strong>Artikelnummer:</strong> ${artikel.nummer || artikel.artikelnummer || "N/A"}</p>
                  <p><strong>Menge:</strong> <input type=\"number\" value=\"${artikel.menge}\" min=\"1\" onchange=\"window.merklisteItems[${index}].menge = parseInt(this.value)\"></p>
                  <p><strong>Preis:</strong> ${artikel.preis}</p>
                </div>
              </div>
              <div class=\"artikel-aktionen\">
                <div class=\"grund-steuerung\">
                  <label for=\"grund-${index}\">Spezifikation / Notiz:</label>
                  <textarea id=\"grund-${index}\" class=\"artikel-grund\" placeholder=\"Zus√§tzliche Spezifikationen oder Notizen\" onchange=\"window.merklisteItems[${index}].spezifikation = this.value\"></textarea>
                </div>
                <button class=\"entfernen-btn\" onclick=\"removeArtikel(${index})\">Artikel entfernen</button>
              </div>
            </div>
          `;
        });
        cardsHtml += "</div>";
        artikelInhalt.innerHTML = cardsHtml;
      } else {
        artikelInhalt.innerHTML = "<p>Keine Artikel in der Merkliste gefunden. Bitte verwenden Sie den PDF-Viewer, um Artikel zur Merkliste hinzuzuf√ºgen.</p>";
      }
    }

    // Manuelle Artikel-Eingabe
    function addManuelleArtikelSection() {
      const container = document.getElementById("manuelleArtikelContainer");
      const newIndex = manuelleArtikelCounter++;
      const html = `
        <div class=\"manueller-artikel\" id=\"manuellerArtikel-${newIndex}\">
          <div class=\"artikel-header\">
            <h4>Manueller Artikel ${newIndex + 1}</h4>
            <button type=\"button\" class=\"remove-artikel-btn\" onclick=\"removeManuelleArtikel(${newIndex})\">&times;</button>
          </div>
          <div class=\"artikel-eingabe-grid\">
            <div class=\"eingabe-feld\">
              <label for=\"manuellArtikelNummer-${newIndex}\">Artikelnummer:</label>
              <input type=\"text\" id=\"manuellArtikelNummer-${newIndex}\" placeholder=\"Artikelnummer\">
            </div>
            <div class=\"eingabe-feld\">
              <label for=\"manuellArtikelName-${newIndex}\">Bezeichnung:</label>
              <input type=\"text\" id=\"manuellArtikelName-${newIndex}\" placeholder=\"Bezeichnung\">
            </div>
            <div class=\"eingabe-feld\">
              <label for=\"manuellArtikelMenge-${newIndex}\">Menge:</label>
              <input type=\"number\" id=\"manuellArtikelMenge-${newIndex}\" value=\"1\" min=\"1\">
            </div>
            <div class=\"eingabe-feld\">
              <label for=\"manuellArtikelSpezifikation-${newIndex}\">Spezifikation / Notiz:</label>
              <textarea id=\"manuellArtikelSpezifikation-${newIndex}\" placeholder=\"Zus√§tzliche Spezifikationen oder Notizen\"></textarea>
            </div>
          </div>
        </div>
      `;
      container.insertAdjacentHTML("beforeend", html);
    }

    function removeManuelleArtikel(index) {
      if (confirm("M√∂chten Sie diesen manuellen Artikel wirklich entfernen?")) {
        const element = document.getElementById(`manuellerArtikel-${index}`);
        if (element) {
          element.remove();
        }
      }
    }

    document.getElementById("weiterenartikelBtn").addEventListener("click", addManuelleArtikelSection);

    document.getElementById("artikelHinzufuegenBtn").addEventListener("click", function() {
      const manuelleArtikel = [];
      for (let i = 0; i < manuelleArtikelCounter; i++) {
        const artikelElement = document.getElementById(`manuellerArtikel-${i}`);
        if (artikelElement) {
          const nummer = document.getElementById(`manuellArtikelNummer-${i}`).value;
          const name = document.getElementById(`manuellArtikelName-${i}`).value;
          const menge = parseInt(document.getElementById(`manuellArtikelMenge-${i}`).value);
          const spezifikation = document.getElementById(`manuellArtikelSpezifikation-${i}`).value;

          if (name && menge > 0) {
            manuelleArtikel.push({
              nummer: nummer,
              name: name,
              menge: menge,
              spezifikation: spezifikation
            });
          }
        }
      }

      if (manuelleArtikel.length > 0) {
        if (!window.merklisteItems) {
          window.merklisteItems = [];
        }
        window.merklisteItems = window.merklisteItems.concat(manuelleArtikel);
        updateArtikelListe();

        document.getElementById("manuelleArtikelContainer").innerHTML = "";
        manuelleArtikelCounter = 0;
        addManuelleArtikelSection();
      } else {
        alert("Bitte geben Sie mindestens einen manuellen Artikel mit Bezeichnung und Menge ein.");
      }
    });

    // Datum im Header anzeigen
    function displayCurrentDate() {
      const today = new Date();
      const options = { year: "numeric", month: "long", day: "numeric" };
      document.getElementById("heute").textContent = today.toLocaleDateString("de-DE", options);
    }

    // Hilfsfunktionen f√ºr Mitarbeiter-Werte
    function getSachbearbeiterValue() {
      const dropdown = document.getElementById("sachbearbeiterDropdown");
      const manualInput = document.getElementById("sachbearbeiterManuell");
      return dropdown.value === "manuell" ? manualInput.value || "" : dropdown.value || "";
    }
    
    function getAussendienstmitarbeiterValue() {
      const dropdown = document.getElementById("aussendienstDropdown");
      const manualInput = document.getElementById("aussendienstManuell");
      return dropdown.value === "manuell" ? manualInput.value || "" : dropdown.value || "";
    }

    // PDF Generierung - Professionelle Implementierung
    async function generateAngebotsanfragePDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Firmenlogo laden (falls verf√ºgbar)
        const logoUrl = "https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png";
        let logoImg = null;
        try {
          logoImg = await loadImageAsBase64(logoUrl);
        } catch (error) {
          console.warn("Logo konnte nicht geladen werden:", error);
        }
        
        // Seitenr√§nder und Positionen definieren
        const margin = 20;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const contentHeight = pageHeight - 2 * margin;
        let yPosition = margin;
        let currentPage = 1;
        
        // Funktion f√ºr blaue Designbalken (links)
        function addBlueDesignBars() {
          // Drei blaue Balken links wie im Referenz-PDF
          doc.setFillColor(0, 161, 225); // EWE Blau
          doc.rect(0, 40, 4, 20, 'F'); // Erster Balken
          doc.rect(0, 65, 4, 20, 'F'); // Zweiter Balken  
          doc.rect(0, 90, 4, 20, 'F'); // Dritter Balken
        }
        
        // Funktion f√ºr Header auf jeder Seite
        function addPageHeader(pageNum, totalPages) {
          // Blaue Designbalken hinzuf√ºgen
          addBlueDesignBars();
          
          // Logo (vergr√∂√üert um 5px in der H√∂he)
          if (logoImg) {
            const logoWidth = 35;
            const logoHeight = 25; // Von 20 auf 25 erh√∂ht (+5px)
            doc.addImage(logoImg, "PNG", margin, margin, logoWidth, logoHeight, undefined, 'FAST');
          }
          
          // Datum und Seitenangabe rechts oben
          const heute = new Date();
          const datumString = heute.toLocaleDateString("de-DE", { 
            year: "numeric", 
            month: "long", 
            day: "numeric" 
          });
          
          doc.setFontSize(10);
          doc.setTextColor(100, 100, 100);
          doc.text(datumString, pageWidth - margin, margin + 10, { align: "right" });
          
          // Seitenangabe nur bei mehrseitigen PDFs
          if (totalPages > 1) {
            doc.text(`Seite ${pageNum} von ${totalPages}`, pageWidth - margin, margin + 20, { align: "right" });
          }
          
          // Editierbare √úberschrift (klein, unter Datum)
          const mainTitle = document.getElementById("mainTitleInput").value || "INTERNE ANGEBOTSANFORDERUNG";
          doc.setFontSize(8);
          doc.setTextColor(100, 100, 100);
          doc.text(mainTitle.toUpperCase(), pageWidth - margin, margin + 30, { align: "right" });
        }
        
// --- NEUER CODE ---

// --- NEUER CODE (Version 2) ---

// Funktion f√ºr Fu√üzeile auf jeder Seite
function addPageFooter(pageNum, totalPages) {
  const footerY = pageHeight - 15; // Position der Fu√üzeile (15mm vom unteren Rand)
  const mainTitle = document.getElementById("mainTitleInput").value || "Interne Anfrage";
  
  // Kundennamen holen (Firma hat Vorrang, sonst Name)
  const kundenName = inputs.firma.value || inputs.name.value || "";

  // Trennlinie √ºber der Fu√üzeile
  doc.setDrawColor(200, 200, 200);
  doc.line(margin, footerY - 5, pageWidth - margin, footerY - 5);

  doc.setFontSize(8);
  doc.setTextColor(100, 100, 100);

  // Titel links in der Fu√üzeile
  doc.text(mainTitle, margin, footerY);

  // Kundenname zentriert in der Fu√üzeile
  if (kundenName) {
    doc.text(kundenName, pageWidth / 2, footerY, { align: "center" });
  }

  // Seitenzahl rechts in der Fu√üzeile
  const pageString = `Seite ${pageNum} von ${totalPages}`;
  doc.text(pageString, pageWidth - margin, footerY, { align: "right" });
}



        // Funktion f√ºr neue Seite
        function addNewPage() {
          doc.addPage();
          currentPage++;
          yPosition = margin + 50; // Platz f√ºr Header lassen
        }
        
        // Funktion um zu pr√ºfen, ob neue Seite ben√∂tigt wird
        function checkPageBreak(neededSpace) {
          if (yPosition + neededSpace > pageHeight - margin) {
            addNewPage();
            return true;
          }
          return false;
        }
        
        // Erste Seite Header
        addPageHeader(1, 1); // Wird sp√§ter mit korrekter Seitenzahl aktualisiert
        
        yPosition += 50; // Platz f√ºr Header
        
        // Haupttitel
        const mainTitle = document.getElementById("mainTitleInput").value || "INTERNE ANGEBOTSANFORDERUNG";
        doc.setFontSize(20);
        doc.setTextColor(0, 0, 0);
        doc.setFont("helvetica", "bold");
        doc.text(mainTitle.toUpperCase(), pageWidth / 2, yPosition, { align: "center" });
        
        yPosition += 20;
        
        // Mitarbeiter-Informationen
        const sachbearbeiter = getSachbearbeiterValue();
        const aussendienstmitarbeiter = getAussendienstmitarbeiterValue();
        
        if (sachbearbeiter || aussendienstmitarbeiter) {
          checkPageBreak(40);
          
          doc.setFontSize(14);
          doc.setFont("helvetica", "bold");
          doc.setTextColor(0, 161, 225); // Firmenfarbe
          doc.text("BEARBEITUNG", margin, yPosition);
          
          yPosition += 10;
          
          doc.setFontSize(10);
          doc.setFont("helvetica", "normal");
          doc.setTextColor(0, 0, 0); // Schwarz
          
          if (sachbearbeiter) {
            doc.setFont("helvetica", "bold");
            doc.text("Innendienst:", margin, yPosition);
            doc.setFont("helvetica", "normal");
            doc.text(sachbearbeiter, margin + 35, yPosition);
            yPosition += 6;
          }
          
          if (aussendienstmitarbeiter) {
            doc.setFont("helvetica", "bold");
            doc.text("ausgestellt von:", margin, yPosition);
            doc.setFont("helvetica", "normal");
            doc.text(aussendienstmitarbeiter, margin + 35, yPosition);
            yPosition += 6;
          }
          
          yPosition += 10;
        }
        
        // Kundendaten-Sektion
        checkPageBreak(50);
        
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(0, 161, 225); // Firmenfarbe
        doc.text("KUNDENDATEN", margin, yPosition);
        
        yPosition += 10;
        
        // Kundendaten sammeln
        const kundenDaten = {
          firma: inputs.firma.value || "Nicht angegeben",
          name: inputs.name.value || "Nicht angegeben",
          strasse: inputs.strasse.value || "Nicht angegeben",
          plz: inputs.plz.value || "",
          ort: inputs.ort.value || "",
          email: inputs.email.value || "Nicht angegeben",
          telefon: inputs.telefon.value || "Nicht angegeben"
        };
        
        // Adresse zusammensetzen
        const adresse = `${kundenDaten.strasse}, ${kundenDaten.plz} ${kundenDaten.ort}`.trim();
        
        // Kundendaten-Tabelle
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(0, 0, 0); // Schwarz
        
        const kundenInfos = [
          ["Firma:", kundenDaten.firma],
          ["Ansprechpartner:", kundenDaten.name],
          ["Adresse:", adresse || "Nicht angegeben"],
          ["E-Mail:", kundenDaten.email],
          ["Telefon:", kundenDaten.telefon]
        ];
        
        kundenInfos.forEach(([label, value]) => {
          checkPageBreak(8);
          doc.setFont("helvetica", "bold");
          doc.text(label, margin, yPosition);
          doc.setFont("helvetica", "normal");
          doc.text(value, margin + 35, yPosition);
          yPosition += 6;
        });
        
        yPosition += 10;
        
        // Briefing-Sektion
        checkPageBreak(30);
        
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(0, 161, 225);
        doc.text("MITTEILUNG F√úR DEN INNENDIENST", margin, yPosition);
        
        yPosition += 10;
        
        // Briefing-Daten sammeln
        const briefingDaten = {
          hintergrund: briefingInputs.hintergrund.value || "Nicht angegeben",
          fokus: briefingInputs.fokus.value || "Nicht angegeben",
          preisgestaltung: briefingInputs.preisgestaltung.value || "Nicht angegeben"
        };
        
        // Briefing-Felder
        const briefingFelder = [
          ["Hintergrund:", briefingDaten.hintergrund],
          ["Fokus im Angebot:", briefingDaten.fokus],
          ["Preisgestaltung:", briefingDaten.preisgestaltung]
        ];
        
        doc.setFontSize(10);
        briefingFelder.forEach(([label, value]) => {
          const splitText = doc.splitTextToSize(value, pageWidth - 2 * margin);
          const neededSpace = 6 + splitText.length * 4 + 6;
          checkPageBreak(neededSpace);
          
          doc.setFont("helvetica", "bold");
          doc.setTextColor(0, 0, 0); // Schwarz
          doc.text(label, margin, yPosition);
          yPosition += 6;
          
          doc.setFont("helvetica", "normal");
          doc.setTextColor(0, 0, 0); // Schwarz f√ºr Briefing-Text
          doc.text(splitText, margin, yPosition);
          yPosition += splitText.length * 4 + 6;
        });
        
        yPosition += 5;
        
// --- NEUER CODE ---

// Artikel-Sektion (Dynamische √úberschrift)
const angebotsdetailsTitle = document.getElementById("mainTitleInput").value || "Angebotsdetails";
const titleHeight = 15; // Ungef√§hre H√∂he f√ºr die √úberschrift + Abstand

// Pr√ºfen, ob die √úberschrift UND der Tabellen-Header auf die Seite passen
checkPageBreak(titleHeight + 30); // 30 ist der Platz f√ºr den Tabellen-Header

doc.setFontSize(14);
doc.setFont("helvetica", "bold");
doc.setTextColor(0, 161, 225);
doc.text(angebotsdetailsTitle.toUpperCase(), margin, yPosition); // <-- Dynamischer Text

yPosition += 15;

        
        // Artikel sammeln
        const alleArtikel = [];
        
        // Artikel aus Merkliste
        if (window.merklisteItems && window.merklisteItems.length > 0) {
          window.merklisteItems.forEach(artikel => {
            alleArtikel.push({
              nummer: artikel.nummer || artikel.artikelnummer || "N/A",
              bezeichnung: artikel.name || artikel.bezeichnung || "Unbekannter Artikel",
              menge: artikel.menge || 1,
              spezifikation: artikel.spezifikation || "Keine Angabe"
            });
          });
        }
        
        // Artikel-Tabelle erstellen
        if (alleArtikel.length > 0) {
          
          // Funktion f√ºr Tabellen-Header
          function drawTableHeader() {
            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(0, 0, 0); // Schwarz
            
            // Header-Zeile
            doc.text("Pos", margin, yPosition);
            doc.text("Menge", margin + 20, yPosition);
            doc.text("Artikel", margin + 40, yPosition);
            doc.text("Spezifikation", margin + 120, yPosition);
            
            yPosition += 8;
            
            // Trennlinie
            doc.setDrawColor(200, 200, 200);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 8; // Abstand nach der Trennlinie
          }
          
          // Ersten Tabellen-Header zeichnen
          checkPageBreak(30); // Mindestens 30mm f√ºr Header + ersten Artikel
          drawTableHeader();
          
          // Artikel-Zeilen
          alleArtikel.forEach((artikel, index) => {
            // Platz f√ºr Artikel berechnen (Artikelnummer + Bezeichnung + Spezifikation)
            const artikelBezeichnungLines = doc.splitTextToSize(artikel.bezeichnung, 75);
            const spezifikationLines = doc.splitTextToSize(artikel.spezifikation, 65);
            const maxLines = Math.max(artikelBezeichnungLines.length, spezifikationLines.length);
            const artikelHoehe = Math.max(16, 8 + maxLines * 4); // Mindestens 16px H√∂he
            
            // Pr√ºfen ob genug Platz f√ºr den Artikel vorhanden ist
            if (yPosition + artikelHoehe > pageHeight - margin) {
              // Neue Seite beginnen
              doc.addPage();
              currentPage++;
              yPosition = margin + 30; // Platz f√ºr Header lassen
              
              // Header auf neuer Seite wiederholen
              addPageHeader(currentPage, currentPage); // Wird sp√§ter korrigiert
              yPosition += 20;
              drawTableHeader();
            }
            
            const startY = yPosition;
            
            doc.setFont("helvetica", "normal");
            doc.setTextColor(0, 0, 0); // Schwarz
            
            // Position
            doc.text((index + 1).toString(), margin, startY);
            
            // Menge
            doc.text(artikel.menge.toString() + " Stk", margin + 20, startY);
            
            // Artikelnummer (fett)
            doc.setFont("helvetica", "bold");
            doc.text(artikel.nummer, margin + 40, startY);
            
            // Artikelbezeichnung (normal, kann 2 Zeilen einnehmen)
            doc.setFont("helvetica", "normal");
            doc.text(artikelBezeichnungLines, margin + 40, startY + 6);
            
            // Spezifikation
            doc.text(spezifikationLines, margin + 120, startY);
            
            yPosition += artikelHoehe;
            
            // Trennlinie nach jedem Artikel (au√üer dem letzten)
            if (index < alleArtikel.length - 1) {
              doc.setDrawColor(230, 230, 230);
              doc.line(margin, yPosition, pageWidth - margin, yPosition);
              yPosition += 5; // Abstand nach der Trennlinie
            }
          });
        } else {
          checkPageBreak(15);
          doc.setFontSize(10);
          doc.setFont("helvetica", "italic");
          doc.setTextColor(100, 100, 100);
          doc.text("Keine Artikel angegeben.", margin, yPosition);
        }
        
// --- NEUER CODE ---

// Header und Footer auf allen Seiten finalisieren
const totalPages = doc.internal.getNumberOfPages();
for (let i = 1; i <= totalPages; i++) {
  doc.setPage(i); // Zur Seite i wechseln

  // Header aktualisieren (besonders f√ºr die Seitenzahl "Seite X von Y")
  addPageHeader(i, totalPages);
  
  // Neue Fu√üzeile hinzuf√ºgen
  addPageFooter(i, totalPages);
}

        
        // Dateiname generieren
        const firmaName = inputs.firma.value || "Unbekannt";
        const cleanFirmaName = firmaName.replace(/[^a-zA-Z0-9√§√∂√º√Ñ√ñ√ú√ü\-]/g, "-");
        const heute = new Date();
        const datumForFilename = heute.toISOString().split('T')[0];
        const filename = `Angebotsanforderung_${cleanFirmaName}_${datumForFilename}.pdf`;
        
        // PDF speichern
        doc.save(filename);
        console.log(`PDF erfolgreich erstellt: ${filename}`);
        
      } catch (error) {
        console.error("Fehler bei der PDF-Erstellung:", error);
        alert("Fehler bei der PDF-Erstellung. Bitte versuchen Sie es erneut.");
      }
    }

    // Hilfsfunktion zum Laden von Bildern als Base64
    function loadImageAsBase64(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          const dataURL = canvas.toDataURL("image/png");
          resolve(dataURL);
        };
        img.onerror = reject;
        img.src = url;
      });
    }


    // ========================================================================
// ===== NEU: DER EINZIGE UND KORREKTE STARTPUNKT DER SEITE         =====
// ========================================================================

document.addEventListener("DOMContentLoaded", async () => {
    // 1. Unabh√§ngige UI-Elemente sofort initialisieren
    displayCurrentDate();
    ladeMerklisteAusLocalStorage();
    addManuelleArtikelSection();
    
    // 2. jQuery-abh√§ngige Initialisierungen
    $(document).ready(function() {
        $("#sachbearbeiterDropdown").select2({ placeholder: "-- Innendienst ausw√§hlen --", allowClear: true });
        $("#aussendienstDropdown").select2({ placeholder: "-- Au√üendienstmitarbeiter ausw√§hlen --", allowClear: true });
    });

    try {
        // 3. Authentifizierung pr√ºfen und auf Daten warten
        const isLoginSuccessful = await loadProtectedData(); // Ergebnis speichern

        // 4. NUR bei erfolgreicher Anmeldung die Suche aktivieren
        if (isLoginSuccessful) {
            console.log(`Schutzpr√ºfung bestanden. ${kunden.length} Kunden geladen.`);

            // Diese Zeilen werden jetzt nur noch bei Erfolg ausgef√ºhrt
            const kundenSucheInput = document.getElementById('kundenSuche');
            kundenSucheInput.disabled = false;
            kundenSucheInput.placeholder = "üîç Kunde, Firma, PLZ oder Ort suchen...";

            // Event-Listener f√ºr die Suche aktivieren
            initializeCustomerSearchListeners();
        }

    } catch (error) {
        console.error("Ein schwerwiegender Fehler ist beim Seitenaufbau aufgetreten:", error);
        document.body.innerHTML = "<h2>Ein kritischer Fehler ist aufgetreten. Bitte laden Sie die Seite neu.</h2>";
    }
});

  </script>
    <section class="form-section-container" style="text-align: center; box-shadow: none; border: none; background: none;">
  <button onclick="generateAngebotsanfragePDF()" class="btn btn-primary" style="padding: 15px 30px; font-size: 1.2rem;">
    PDF erzeugen
  </button>
</body>
</html>