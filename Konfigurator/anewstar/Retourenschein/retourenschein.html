<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retourenschein PDF Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="retourenschein.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- PapaParse-Bibliothek f√ºr die CSV-Verarbeitung -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  
  <!-- jQuery (wird von Select2 ben√∂tigt ) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>
<body>
  <header id="header">
    <div class="header-left">
      <img src="https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png" alt="EWE Logo">
    </div>
    <div class="header-content">
      <h1>Retourenschein</h1>
      <div class="header-date" id="heute"></div>
    </div>
    <div class="header-right">
      <div class="buttons">
        <button onclick="generateRetourenscheinPDF( )">PDF erzeugen</button>
      </div>
    </div>
  </header>

  <!-- Kundenauswahl -->
  <section class="search-container">
    <select id="kundenDropdown">
      <option value="">-- Kunde ausw√§hlen --</option>
      <!-- Kundenoptionen werden dynamisch per JavaScript geladen -->
    </select>
  </section>

  <!-- Kundendaten -->
  <section id="kundenDetails" class="search-container">
    <input type="text" id="name" placeholder="Name">
    <input type="text" id="firma" placeholder="Firma">
    <input type="text" id="strasse" placeholder="Stra√üe">
    <input type="text" id="plz" placeholder="PLZ">
    <input type="text" id="ort" placeholder="Ort">
    <input type="text" id="land" placeholder="Land">
    <input type="text" id="email" placeholder="E-Mail">
    <input type="text" id="telefon" placeholder="Telefon">
  </section>

  <!-- Neue Felder f√ºr Retourenschein -->
  <section id="retourenDetails" class="search-container">
    <h3>Retourendetails</h3>
    
    <!-- Bearbeiter Dropdown -->
    <select id="bearbeiterDropdown">
      <option value="">-- Bearbeiter ausw√§hlen --</option>
      <option value="Rafael Furtw√§ngler">Rafael Furtw√§ngler</option>
      <option value="Christof M√ºnster">Christof M√ºnster</option>
      <option value="Sascha Heusel">Sascha Heusel</option>
      <option value="Bernhard Kneissl">Bernhard Kneissl</option>
      <option value="Christopher-Sean Haus">Christopher-Sean Haus</option>
      <option value="Sascha Barkowsky">Sascha Barkowsky</option>
      <option value="Volker Kottwitz">Volker Kottwitz</option>
      <option value="Volker Oesterwind">Volker Oesterwind</option>
      <option value="Thomas Sch√∂nf√º√ü">Thomas Sch√∂nf√º√ü</option>
      <option value="Thomas Wendt">Thomas Wendt</option>
      <option value="Harald Natzke">Harald Natzke</option>
      <option value="Lukas Pfeil">Lukas Pfeil</option>
      <option value="Nancy Ullbricht">Nancy Ullbricht</option>
      <option value="Heiner Birkholz">Heiner Birkholz</option>
      <option value="Helmut W√∂lfel">Helmut W√∂lfel</option>
      <option value="manuell">-- Manuelle Eingabe --</option>
    </select>
    
    <!-- Manuelles Bearbeiter-Eingabefeld (initial versteckt) -->
    <input type="text" id="bearbeiterManuell" placeholder="Bearbeiter (manuell)" style="display: none;">
    
    <!-- Anlieferung Dropdown -->
    <select id="anlieferungDropdown">
      <option value="">-- Anlieferung ausw√§hlen --</option>
      <option value="PKW Au√üendienst">PKW Au√üendienst</option>
      <option value="EWE-LW">EWE-LW</option>
      <option value="Paketdienst">Paketdienst</option>
      <option value="Spedition">Spedition</option>
      <option value="Sonstiges">Sonstiges</option>
    </select>
    
    <!-- Abholdatum mit Vor/Zur√ºck-Pfeilen -->
    <div id="abholdatumContainer">
      <label for="abholdatum">Abholdatum:</label>
      <div class="date-picker-container">
        <button type="button" id="datumZurueck" class="date-arrow">‚óÄ</button>
        <input type="date" id="abholdatum">
        <button type="button" id="datumVor" class="date-arrow">‚ñ∂</button>
      </div>
    </div>
  </section>

  <!-- Artikel aus Merkliste (wird dynamisch gef√ºllt) -->
  <section id="artikelListe" class="search-container">
    <h3>Artikel zur R√ºcksendung</h3>
    <div id="artikelInhalt">
      <p>Keine Artikel in der Merkliste gefunden. Bitte verwende den PDF-Viewer, um Artikel zur Merkliste hinzuzuf√ºgen.</p>
    </div>
  </section>

  <!-- Manueller Artikel-Eingabebereich (wird nur angezeigt, wenn keine Artikel vorhanden sind) -->
  <section id="manuelleArtikelSection" class="search-container" style="display: none;">
    <h3>Artikel manuell hinzuf√ºgen</h3>
    <div id="manuelleArtikelContainer">
      <!-- Wird dynamisch mit JavaScript gef√ºllt -->
    </div>
    <div class="button-container">
      <button type="button" id="artikelHinzufuegenBtn" class="btn btn-primary">Artikel hinzuf√ºgen</button>
    </div>
  </section>

  <!-- NEU: Bemerkungen-Feld -->
  <section id="bemerkungenSection" class="search-container">
    <h3>Bemerkungen</h3>
    <textarea id="bemerkungen" placeholder="Zus√§tzliche Informationen oder Notizen hier eingeben..."></textarea>
  </section>

    <!-- NEU: Reklamations-Optionen -->
  <section id="reklamationSection" class="search-container">
    <h3>Interne Vermerke</h3>
    <div class="reklamation-grid">
      <div class="reklamation-option">
        <input type="checkbox" id="checkReklamation">
        <label for="checkReklamation">Reklamation</label>
      </div>
      <div class="reklamation-option">
        <input type="checkbox" id="checkReparatur">
        <label for="checkReparatur">Reparatur - Kostenvoranschlag</label>
      </div>
      <div class="reklamation-option">
        <input type="checkbox" id="checkNeuware">
        <label for="checkNeuware">Neuware. Einlagern und zubuchen</label>
      </div>
      <div class="reklamation-option">
        <input type="checkbox" id="checkWeiterleitung">
        <label for="checkWeiterleitung">Weiterleitung an:</label>
      </div>
      <div class="reklamation-option">
        <input type="checkbox" id="checkRuecksendung">
        <label for="checkRuecksendung">R√ºcksendung an den Kunden</label>
      </div>
      <!-- Dieses Textfeld wird per JS gesteuert -->
      <input type="text" id="weiterleitungAnName" placeholder="Name eintragen" style="display: none;">
    </div>
  </section>

  <script>
    // Referenzen auf die HTML-Elemente
    const dropdown = document.getElementById("kundenDropdown");
    const inputs = {
      name: document.getElementById("name"),
      firma: document.getElementById("firma"),
      telefon: document.getElementById("telefon"),
      email: document.getElementById("email"),
      strasse: document.getElementById("strasse"),
      ort: document.getElementById("ort"),
      plz: document.getElementById("plz"),
      land: document.getElementById("land")
    };

    // Neue Felder
    const retourenInputs = {
      bearbeiter: document.getElementById("bearbeiterDropdown"),
      bearbeiterManuell: document.getElementById("bearbeiterManuell"),
      anlieferung: document.getElementById("anlieferungDropdown"),
      abholdatum: document.getElementById("abholdatum"),
      bemerkungen: document.getElementById("bemerkungen"), 
      checkReklamation: document.getElementById("checkReklamation"),
      checkNeuware: document.getElementById("checkNeuware"),
      checkRuecksendung: document.getElementById("checkRuecksendung"),
      checkReparatur: document.getElementById("checkReparatur"),
      checkWeiterleitung: document.getElementById("checkWeiterleitung"),
      weiterleitungAnName: document.getElementById("weiterleitungAnName")
    };

    // Variable, um die geladenen Kundendaten zu speichern
    let kunden = [];

    // CSV-Datei laden und verarbeiten
    fetch("https://volkerkottwitz.github.io/Konfig/Konfigurator/anewstar/Retourenschein/kundenstamm.csv" )
      .then(response => {
        if (!response.ok) {
          throw new Error("Netzwerkantwort war nicht in Ordnung.");
        }
        return response.text();
      })
      .then(csvText => {
        // PapaParse verwenden, um den CSV-Text zu parsen
        const results = Papa.parse(csvText, {
          header: true,          // Die erste Zeile als Spalten√ºberschrift verwenden
          skipEmptyLines: true,  // Leere Zeilen √ºberspringen
          bom: true              // Das BOM-Zeichen am Dateianfang ignorieren (wichtig!)
        });
        kunden = results.data;

        // Das Dropdown-Men√º mit den geladenen Daten f√ºllen
        kunden.forEach((kunde, index) => {
          // Label erstellen: "Name ‚Äì Firma" oder nur "Firma", wenn kein Name vorhanden ist
          const label = kunde.Name ? `${kunde.Name.trim()} ‚Äì ${kunde.Firma.trim()}` : kunde.Firma.trim();
          const opt = document.createElement("option");
          opt.value = index; // Den Array-Index als Wert verwenden
          opt.textContent = label;
          dropdown.appendChild(opt);
        });

        // Option f√ºr manuelle Eingabe am Ende hinzuf√ºgen
        const manualOpt = document.createElement("option");
        manualOpt.value = "manuell";
        manualOpt.textContent = "-- Manuelle Eingabe --";
        dropdown.appendChild(manualOpt);

        // Select2 initialisieren
        $(document).ready(function() {
            $('#kundenDropdown').select2({
                placeholder: "-- Kunde ausw√§hlen --",
                allowClear: true
            });
            
            // Auch f√ºr Bearbeiter-Dropdown
            $('#bearbeiterDropdown').select2({
                placeholder: "-- Bearbeiter ausw√§hlen --",
                allowClear: true
            });
            
            // Und f√ºr Anlieferung-Dropdown
            $('#anlieferungDropdown').select2({
                placeholder: "-- Anlieferung ausw√§hlen --",
                allowClear: true
            });
        });
      })
      .catch(error => {
        console.error("Fehler beim Laden oder Verarbeiten der CSV-Datei:", error);
        // Fallback, falls das Laden fehlschl√§gt
        const manualOpt = document.createElement("option");
        manualOpt.value = "manuell";
        manualOpt.textContent = "-- Manuelle Eingabe (Fehler beim Laden der Kundenliste) --";
        dropdown.appendChild(manualOpt);
      });

    // Event-Listener f√ºr das Kunden-Dropdown-Men√º
    $('#kundenDropdown').on('change', function () {
      const selectedIndex = this.value;

      // Felder leeren bei "Kunde ausw√§hlen" oder "Manuelle Eingabe"
      if (selectedIndex === "" || selectedIndex === "manuell") {
        Object.values(inputs).forEach(input => (input.value = ""));
        return;
      }

      // Den ausgew√§hlten Kunden aus dem Array holen
      const kunde = kunden[selectedIndex];
      if (!kunde) return;

      // Die Adresse in ihre Bestandteile aufteilen
      const adresseTeile = kunde.Adresse ? kunde.Adresse.split(",").map(x => x.trim()) : ["", "", "", ""];
      
      // Die Formularfelder mit den Kundendaten f√ºllen
      inputs.name.value = kunde.Name || "";
      inputs.firma.value = kunde.Firma || "";
      inputs.telefon.value = kunde.Telefon || "";
      inputs.email.value = kunde['E-Mail'] || ""; // Zugriff mit Klammern wegen des Bindestrichs
      inputs.strasse.value = adresseTeile[0] || "";
      inputs.ort.value = adresseTeile[1] || "";
      inputs.plz.value = adresseTeile[2] || "";
      inputs.land.value = adresseTeile[3] || "";
    });

    // Event-Listener f√ºr Bearbeiter-Dropdown
    $('#bearbeiterDropdown').on('change', function () {
      const selectedValue = this.value;
      const manuellesEingabefeld = retourenInputs.bearbeiterManuell;
      
      if (selectedValue === "manuell") {
        manuellesEingabefeld.style.display = "block";
        manuellesEingabefeld.focus();
      } else {
        manuellesEingabefeld.style.display = "none";
        manuellesEingabefeld.value = "";
      }
    });

    // Datepicker-Funktionalit√§t
    function initializeDatePicker() {
      const abholdatumInput = retourenInputs.abholdatum;
      const datumZurueckBtn = document.getElementById("datumZurueck");
      const datumVorBtn = document.getElementById("datumVor");
      
      // Aktuelles Datum als Standard setzen
      const heute = new Date();
      abholdatumInput.value = heute.toISOString().split('T')[0];
      
      // Event-Listener f√ºr Vor/Zur√ºck-Buttons
      datumZurueckBtn.addEventListener('click', function() {
        const currentDate = new Date(abholdatumInput.value);
        currentDate.setDate(currentDate.getDate() - 1);
        abholdatumInput.value = currentDate.toISOString().split('T')[0];
      });
      
      datumVorBtn.addEventListener('click', function() {
        const currentDate = new Date(abholdatumInput.value);
        currentDate.setDate(currentDate.getDate() + 1);
        abholdatumInput.value = currentDate.toISOString().split('T')[0];
      });
    }

    // Merkliste aus localStorage laden
    function ladeMerklisteAusLocalStorage() {
      try {
        const merklisteData = localStorage.getItem('merklisteForRetourenschein');
        if (merklisteData) {
          const merkliste = JSON.parse(merklisteData);
          
          // Merkliste als globale Variable setzen
          window.merklisteItems = merkliste.map(item => ({
            nummer: item.nummer || item.artikelnummer || '',
            name: item.name || item.bezeichnung || 'Unbekannter Artikel',
            bezeichnung: item.name || item.bezeichnung || 'Unbekannter Artikel',
            artikelnummer: item.nummer || item.artikelnummer || '',
            menge: item.menge || 1,
            preis: item.preis || '0,00 ‚Ç¨'
          }));
          
          // Artikel-Liste sofort aktualisieren
          updateArtikelListe();
          
          // LocalStorage nach dem Laden l√∂schen (optional)
          localStorage.removeItem('merklisteForRetourenschein');
          
          console.log('Merkliste erfolgreich geladen:', merkliste.length, 'Artikel');
        } else {
          // Keine Merkliste vorhanden, manuelle Eingabe anzeigen
          showManuelleArtikelEingabe();
        }
      } catch (error) {
        console.error('Fehler beim Laden der Merkliste:', error);
        showManuelleArtikelEingabe();
      }
    }

    // NEU: Event-Listener f√ºr die "Weiterleitung an"-Checkbox
    retourenInputs.checkWeiterleitung.addEventListener('change', function() {
      if (this.checked) {
        retourenInputs.weiterleitungAnName.style.display = 'block';
        retourenInputs.weiterleitungAnName.focus();
      } else {
        retourenInputs.weiterleitungAnName.style.display = 'none';
        retourenInputs.weiterleitungAnName.value = ''; // Feld leeren, wenn Checkbox deaktiviert wird
      }
    });

    // Funktion zum Entfernen eines Artikels
    function removeArtikel(index) {
      if (confirm('M√∂chten Sie diesen Artikel wirklich entfernen?')) {
        window.merklisteItems.splice(index, 1);
        updateArtikelListe();
      }
    }

    // Merkliste-Artikel anzeigen (falls vorhanden) - VERBESSERTE VERSION
    function updateArtikelListe() {
      const artikelInhalt = document.getElementById("artikelInhalt");
      const manuelleArtikelSection = document.getElementById("manuelleArtikelSection");
      
      // Pr√ºfen, ob window.merklisteItems existiert und Artikel vorhanden sind
      if (window.merklisteItems && window.merklisteItems.length > 0) {
        // Manuelle Eingabe verstecken, wenn Artikel vorhanden sind
        manuelleArtikelSection.style.display = 'none';
        
        // Artikel-Karten erstellen (neues Design)
        let cardsHtml = '<div class="artikel-karten-container">';
        
        window.merklisteItems.forEach((artikel, index) => {
          cardsHtml += `
            <div class="artikel-karte">
              <div class="artikel-info">
                <div class="artikel-name">${artikel.name || artikel.bezeichnung || 'Unbekannter Artikel'}</div>
                <div class="artikel-details">
                  <p><strong>Artikelnummer:</strong> ${artikel.nummer || artikel.artikelnummer || 'N/A'}</p>
                  <p><strong>Preis:</strong> ${artikel.preis || '0,00 ‚Ç¨'}</p>
                </div>
              </div>
              <div class="artikel-aktionen">
                <div class="mengen-steuerung">
                  <label for="menge_${index}">Menge:</label>
                  <input type="number" id="menge_${index}" class="quantity-input" min="1" value="${artikel.menge || 1}">
                </div>
                <div class="grund-steuerung">
                  <label for="grund_${index}">Retourengrund:</label>
                  <select id="grund_${index}" class="artikel-grund">
                    <option value="">-- Grund ausw√§hlen --</option>
                    <option value="Artikel passt nicht / falsche Gr√∂√üe">Artikel passt nicht / falsche Gr√∂√üe</option>
                    <option value="Artikel gef√§llt nicht">Artikel gef√§llt nicht</option>
                    <option value="Artikel besch√§digt / defekt">Artikel besch√§digt / defekt</option>
                    <option value="Falscher Artikel geliefert">Falscher Artikel geliefert</option>
                    <option value="Doppelt bestellt">Doppelt bestellt</option>
                    <option value="Sonstiges">Sonstiges</option>
                  </select>
                </div>
                <button class="entfernen-btn" onclick="removeArtikel(${index})" title="Artikel entfernen">
                  üóëÔ∏è Entfernen
                </button>
              </div>
            </div>`;
        });
        
        cardsHtml += '</div>';
        artikelInhalt.innerHTML = cardsHtml;

        // Event-Listener f√ºr Mengen-√Ñnderungen hinzuf√ºgen
        window.merklisteItems.forEach((artikel, index) => {
          const mengeInput = document.getElementById(`menge_${index}`);
          if (mengeInput) {
            mengeInput.addEventListener('input', function() {
              window.merklisteItems[index].menge = parseInt(this.value) || 1;
            });
          }
        });

        // Select2 auf die neu erstellten Dropdowns anwenden
        $('.artikel-grund').select2({
            placeholder: "-- Grund ausw√§hlen --",
            allowClear: true,
            minimumResultsForSearch: Infinity // Versteckt das Suchfeld
        });

      } else {
        // Keine Artikel vorhanden, manuelle Eingabe anzeigen
        artikelInhalt.innerHTML = '<div class="empty-state">Keine Artikel in der Merkliste gefunden. Sie k√∂nnen unten manuell Artikel hinzuf√ºgen.</div>';
        showManuelleArtikelEingabe();
      }
    }

    // NEU: Manuelle Artikel-Eingabe anzeigen
    function showManuelleArtikelEingabe() {
      const manuelleArtikelSection = document.getElementById("manuelleArtikelSection");
      const manuelleArtikelContainer = document.getElementById("manuelleArtikelContainer");
      
      manuelleArtikelSection.style.display = 'block';
      
      // Bis zu 5 Eingabefelder f√ºr manuelle Artikel erstellen
      let manuelleHtml = '';
      for (let i = 0; i < 5; i++) {
        manuelleHtml += `
          <div class="manueller-artikel" id="manuellerArtikel_${i}">
            <h4>Artikel ${i + 1}</h4>
            <div class="artikel-eingabe-grid">
              <div class="eingabe-feld">
                <label for="manuellerName_${i}">Artikelname:</label>
                <input type="text" id="manuellerName_${i}" placeholder="Artikelname eingeben">
              </div>
              <div class="eingabe-feld">
                <label for="manuelleNummer_${i}">Artikelnummer:</label>
                <input type="text" id="manuelleNummer_${i}" placeholder="Artikelnummer eingeben">
              </div>
              <div class="eingabe-feld">
                <label for="manuelleMenge_${i}">St√ºckzahl:</label>
                <input type="number" id="manuelleMenge_${i}" min="1" value="1">
              </div>
              <div class="eingabe-feld">
                <label for="manuellerGrund_${i}">R√ºckgabegrund:</label>
                <select id="manuellerGrund_${i}" class="artikel-grund">
                  <option value="">-- Grund ausw√§hlen --</option>
                  <option value="Artikel passt nicht / falsche Gr√∂√üe">Artikel passt nicht / falsche Gr√∂√üe</option>
                  <option value="Artikel gef√§llt nicht">Artikel gef√§llt nicht</option>
                  <option value="Artikel besch√§digt / defekt">Artikel besch√§digt / defekt</option>
                  <option value="Falscher Artikel geliefert">Falscher Artikel geliefert</option>
                  <option value="Doppelt bestellt">Doppelt bestellt</option>
                  <option value="Sonstiges">Sonstiges</option>
                </select>
              </div>
            </div>
          </div>`;
      }
      
      manuelleArtikelContainer.innerHTML = manuelleHtml;
      
      // Select2 auf die manuellen Dropdowns anwenden
      $('.artikel-grund').select2({
          placeholder: "-- Grund ausw√§hlen --",
          allowClear: true,
          minimumResultsForSearch: Infinity
      });
    }

    // NEU: Manuell hinzugef√ºgte Artikel zur Merkliste hinzuf√ºgen
    function addManuelleArtikel() {
      if (!window.merklisteItems) {
        window.merklisteItems = [];
      }
      
      let hinzugefuegt = 0;
      
      for (let i = 0; i < 5; i++) {
        const name = document.getElementById(`manuellerName_${i}`).value.trim();
        const nummer = document.getElementById(`manuelleNummer_${i}`).value.trim();
        const menge = parseInt(document.getElementById(`manuelleMenge_${i}`).value) || 1;
        const grund = document.getElementById(`manuellerGrund_${i}`).value;
        
        // Nur hinzuf√ºgen, wenn mindestens Name oder Nummer ausgef√ºllt ist
        if (name || nummer) {
          const neuerArtikel = {
            name: name || 'Manuell hinzugef√ºgter Artikel',
            nummer: nummer || 'N/A',
            bezeichnung: name || 'Manuell hinzugef√ºgter Artikel',
            artikelnummer: nummer || 'N/A',
            menge: menge,
            preis: '0,00 ‚Ç¨',
            grund: grund
          };
          
          window.merklisteItems.push(neuerArtikel);
          hinzugefuegt++;
        }
      }
      
      if (hinzugefuegt > 0) {
        updateArtikelListe();
        alert(`${hinzugefuegt} Artikel wurden hinzugef√ºgt.`);
      } else {
        alert('Bitte f√ºllen Sie mindestens den Namen oder die Artikelnummer f√ºr einen Artikel aus.');
      }
    }

    // Event-Listener f√ºr den "Artikel hinzuf√ºgen"-Button
    document.getElementById('artikelHinzufuegenBtn').addEventListener('click', addManuelleArtikel);

    // Heutiges Datum setzen
    document.getElementById("heute").textContent = new Date().toLocaleDateString('de-DE');

    // Initialisierung
    document.addEventListener('DOMContentLoaded', function() {
      initializeDatePicker();
      ladeMerklisteAusLocalStorage(); // Merkliste aus localStorage laden
    });

    // PDF-Generierungsfunktion (erweitert)
/**
 * Erzeugt einen Retourenschein im EWE-Design als PDF.
 * Finale, polierte Version mit allen Detail-Korrekturen.
 *
 * ANLEITUNG:
 * 1. Ersetzen Sie die alte `generateRetourenscheinPDF`-Funktion durch diese.
 * 2. Passen Sie die `logoUrl`-Variable an, sodass sie auf Ihr Logo zeigt.
 */
async function generateRetourenscheinPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    // --- Hilfsfunktion zum Laden eines Bildes ---
    const loadImage = (url) => new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = () => resolve(img);
        img.onerror = (err) => reject(err);
        img.src = url;
    });

    // --- Globale Einstellungen ---
    const page_margin = 5;
    const page_width = doc.internal.pageSize.getWidth();
    const content_width = page_width - (2 * page_margin);
    const fieldBackgroundColor = [230, 245, 255];

    // --- Hilfsfunktionen zum Zeichnen ---
    const drawTextField = (x, y, label, value, width = 85, height = 6, useBgColor = true) => {
        if (useBgColor) {
            doc.setFillColor(...fieldBackgroundColor).rect(x, y + 1, width, height, 'F');
        }
        doc.setFontSize(7).setFont("helvetica", "bold").text(label, x, y);
        doc.setFont("helvetica", "normal").setFontSize(10);
        const textY = (label === "Name") ? y + 6.5 : y + 5.5;
        doc.text(value || '', x + 1, textY, { maxWidth: width - 2, lineHeightFactor: 1.15 });
        doc.setDrawColor(0).line(x, y + height + 1, x + width, y + height + 1);
    };

    const drawCheckBox = (x, y, label) => {
        doc.setFontSize(10).setFont("helvetica", "normal");
        doc.rect(x, y, 4, 4);
        doc.text(label, x + 6, y + 3.5);
    };

    // --- 1. Header ---
    let y = page_margin;
    const logoUrl = 'https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png';
    let logoHeight = 15;
    try {
        const logoImg = await loadImage(logoUrl );
        const logoWidth = 40;
        logoHeight = logoWidth * (logoImg.height / logoImg.width);
        doc.addImage(logoImg, 'PNG', page_width - page_margin - logoWidth, y, logoWidth, logoHeight);
    } catch (error) {
        console.error("Fehler beim Laden des Logos:", error);
        doc.setFontSize(16).setFont("helvetica", "bold").text("EWE ARMATUREN", page_width - page_margin - 50, y + 5);
    }

    doc.setFontSize(30).setFont("helvetica", "bold").text("Retourenschein", page_margin, y + 25);
    const introTextY = Math.max(y + 10, y + logoHeight + 3);
    doc.setFontSize(9).setFont("helvetica", "normal").text("Bitte Retourenschein ausf√ºllen, als Begleitdokument der Ware beilegen und per E-Mail an den zust√§ndigen EWE-Innendienst schicken.", page_margin, introTextY, { maxWidth: content_width });
    y = introTextY + 5;

    // --- 2. Kunden- und Auftragsdaten ---
    doc.setFontSize(10).setFont("helvetica", "bold").text("Kundenangaben", page_margin + 2, y + 5);
    y += 7;
    const kundenBoxY = y;
    const kundenBoxHeight = 58;
    doc.rect(page_margin, kundenBoxY, content_width, kundenBoxHeight-1);
    const today = new Date().toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const abholDatum = retourenInputs.abholdatum.value ? new Date(retourenInputs.abholdatum.value).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
    const firma = inputs.firma.value ? `${inputs.firma.value}\n` : '';
    const nameValue = `${firma}${inputs.name.value}`;
    drawTextField(page_margin + 5, kundenBoxY + 5, "Firma", inputs.firma.value, 85, 12); 
    drawTextField(page_width / 2 + 5, kundenBoxY + 5, "Ansprechpartner", inputs.name.value);
    drawTextField(page_width / 2 + 5, kundenBoxY + 20.5, "Datum", today);
    const bearbeiterWert = retourenInputs.bearbeiter.value === "manuell" ? retourenInputs.bearbeiterManuell.value : retourenInputs.bearbeiter.value;
    drawTextField(page_width / 2 + 5, kundenBoxY + 30, "Bearbeiter", bearbeiterWert);
    drawTextField(page_margin + 5, kundenBoxY + 20.5, "Adresse", inputs.strasse.value);
    drawTextField(page_margin + 5, kundenBoxY + 30, "PLZ / Ort", `${inputs.plz.value} ${inputs.ort.value}`);
    const separatorY = kundenBoxY + 42;
    doc.line(page_margin, separatorY-2, page_width - page_margin, separatorY-2);
    drawTextField(page_margin + 5, separatorY + 3, "Anlieferung", retourenInputs.anlieferung.value);
    drawTextField(page_width / 2 + 5, separatorY + 3, "Abholung Datum", abholDatum);
    y = kundenBoxY + kundenBoxHeight;

    // --- 3. Artikeltabelle ---
    y += 3;
    doc.setFontSize(9).setFont("helvetica", "bold").text("Bitte beachten Sie, dass die Ware ordnungsgem√§√ü sowie transportgerecht zur Abholung verpackt werden muss!", page_margin + 2, y + 5);
    y += 5; // Artikel um 2px nach oben
    const tableStartY = y;
    const rowHeight = 10, maxRows = 5, tableHeaderHeight = 7;
    const tableBodyHeight = maxRows * rowHeight;
    const tableTotalHeight = tableHeaderHeight + tableBodyHeight;
    doc.rect(page_margin, tableStartY, content_width, tableTotalHeight);
    doc.text("Menge", page_margin + 3, tableStartY + 5);
    doc.text("Artikelbezeichnung", page_margin + 25, tableStartY + 5);
    doc.text("EWE-Artikelnummer", page_margin + 105, tableStartY + 5);
    doc.text("Art der R√ºcklieferung", page_margin + 150, tableStartY + 5);
    for (let i = 0; i < maxRows; i++) {
        const rowY = tableStartY + tableHeaderHeight + (i * rowHeight);
        doc.setFillColor(...fieldBackgroundColor).rect(page_margin + 1, rowY + 1, content_width - 2, rowHeight - 1, 'F');
        const item = (window.merklisteItems || [])[i];
        if (item) {
            const menge = document.getElementById(`menge_${i}`)?.value || item.menge || 1;
            let grund = '';
            const grundElement = document.getElementById(`grund_${i}`);
            if (grundElement) {
                grund = grundElement.value;
            } else if (item.grund) {
                grund = item.grund;
            }
            doc.setFont("helvetica", "normal").setFontSize(9);
            doc.text(menge.toString(), page_margin + 3, rowY + 5);
            doc.text(item.name || item.bezeichnung || '', page_margin + 25, rowY + 5, { maxWidth: 75 });
            doc.text(item.nummer || item.artikelnummer || '', page_margin + 105, rowY + 5, { maxWidth: 43 });
            doc.text(grund, page_margin + 150, rowY + 5, { maxWidth: 30 });
        }
        doc.rect(page_margin + content_width - 10, rowY + (rowHeight - 4) / 2, 4, 4);
        if (i < maxRows - 1) doc.line(page_margin, rowY + rowHeight, page_width - page_margin, rowY + rowHeight);
    }
    doc.line(page_margin + 22, tableStartY + tableHeaderHeight, page_margin + 22, tableStartY + tableTotalHeight);
    doc.line(page_margin + 103, tableStartY + tableHeaderHeight, page_margin + 103, tableStartY + tableTotalHeight);
    doc.line(page_margin + 148, tableStartY + tableHeaderHeight, page_margin + 148, tableStartY + tableTotalHeight);
    doc.line(page_margin + content_width - 12, tableStartY + tableHeaderHeight, page_margin + content_width - 12, tableStartY + tableTotalHeight);
    y = tableStartY + tableTotalHeight;

    // --- 4. Interner Vermerk-Block ---
    y += 7;
    const internBoxY = y;
    const internBoxHeight = 29;
    doc.rect(page_margin, internBoxY, content_width, internBoxHeight);
    drawTextField(page_margin + 5, internBoxY + 3, "Wareneingangsdatum", "", 85, 6, true);
    drawTextField(page_margin + 5, internBoxY + 12.5, "Auftragsnummer", "", 85, 6, true);
    drawTextField(page_margin + 5, internBoxY + 22, "Reklamationsnummer", "", 85, 6, true);
    drawTextField(page_width / 2 + 5, internBoxY + 3, "Kundennummer", "", 85, 6, true);
    drawTextField(page_width / 2 + 5, internBoxY + 12.5, "Bezug zu Rechnungsnummer", "", 85, 6, true);
    drawTextField(page_width / 2 + 5, internBoxY + 22, "Gutschrift", "", 85, 6, true);
    y += internBoxHeight;

    // --- 5. Reklamations-Block ---
    y += 5;
    const reklBoxHeight = 22;
    doc.rect(page_margin, y, content_width, reklBoxHeight);

    if (retourenInputs.checkReklamation.checked) {
        doc.setFont("helvetica", "bold").text('X', page_margin + 6, y + 5.5);
    }
    drawCheckBox(page_margin + 5, y + 2, "Reklamation");

    if (retourenInputs.checkNeuware.checked) {
        doc.setFont("helvetica", "bold").text('X', page_margin + 6, y + 12.5);
    }
    drawCheckBox(page_margin + 5, y + 9, "Neuware. Einlagern und zubuchen");

    if (retourenInputs.checkRuecksendung.checked) {
        doc.setFont("helvetica", "bold").text('X', page_margin + 6, y + 19.5);
    }
    drawCheckBox(page_margin + 5, y + 16, "R√ºcksendung an den Kunden");

    if (retourenInputs.checkReparatur.checked) {
        doc.setFont("helvetica", "bold").text('X', page_width / 2 + 6, y + 5.5);
    }
    drawCheckBox(page_width / 2 + 5, y + 2, "Reparatur - Kostenvoranschlag");

    if (retourenInputs.checkWeiterleitung.checked) {
        doc.setFont("helvetica", "bold").text('X', page_width / 2 + 6, y + 12.5);
        doc.setFont("helvetica", "normal").setFontSize(9).text(retourenInputs.weiterleitungAnName.value, page_width / 2 + 55, y + 12.5, { maxWidth: 35 });
    }
    drawCheckBox(page_width / 2 + 5, y + 9, "Weiterleitung an");
    
    y += reklBoxHeight;

    // --- 6. Notiz-Block ---
    y += 3;
    
    doc.setFontSize(10).setFont("helvetica", "bold").text("Notizen", page_margin + 2, y + 5);
    y += 7;
    const notizBoxHeight = 20;
    doc.rect(page_margin, y, content_width, notizBoxHeight);
    doc.setFont("helvetica", "normal").setFontSize(9).text(retourenInputs.bemerkungen.value, page_margin + 2, y + 5, { maxWidth: content_width - 4 });

    y += notizBoxHeight;
    // --- 7. Footer ---
    const finalY = doc.internal.pageSize.getHeight() - 4;
    doc.setFontSize(7).setFont("helvetica", "normal");
    doc.text("VK-11 Retourenschein (Stand 05/2020)", page_margin, finalY);
    doc.text("Wilhelm Ewe GmbH & Co. KG - Volkmaroder Stra√üe 19 - 38104 Braunschweig", page_width / 2, finalY, { align: 'center' });
    doc.text("Seite 1 von 1", page_width - page_margin, finalY, { align: 'right' });

    // --- PDF Speichern ---
    const filename = `Retourenschein_${inputs.name.value.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(filename);
}

  </script>
</body>
</html>

