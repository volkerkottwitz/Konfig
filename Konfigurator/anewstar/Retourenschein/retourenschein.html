<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retourenschein PDF Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="retourenschein.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <!-- Stile f√ºr die Anwendung (√ºbernommen von interneAnfrage.html ) -->
  <style>

    /* ===================================================================== */
    /* ===== FINALER, AUFGER√ÑUMTER & KONSISTENTER CSS-BLOCK (v9) ===== */
    /* ===================================================================== */

    /* --- 1. Grundlegende Layout-Stile (unver√§ndert) --- */
    .search-highlight { background-color: rgba(0, 0, 0, 0.2); font-weight: bold; border-radius: 3px; padding: 0 2px; }
    .header-right .buttons { display: flex; gap: 10px; }
    .form-section-container { border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin: 25px auto; background-color: #fdfdfd; max-width: 900px; }
    .form-section-container h3 { text-align: center; margin-top: 0; margin-bottom: 25px; padding-bottom: 10px; color: #00a1e1; font-size: 1.3em; }
    .centered-form-layout { display: flex; flex-direction: column; align-items: center; gap: 15px; }
    .centered-form-layout > * { width: 100%; max-width: 500px; }

    /* --- 2. Suchergebnisse f√ºr Kunden (unver√§ndert) --- */
    #suchErgebnisse { position: relative; width: 100%; max-width: 500px; margin-top: -10px; background-color: white; border: 1px solid #ddd; border-radius: 8px; z-index: 1000; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .ergebnis-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #eee; }
    .ergebnis-item:last-child { border-bottom: none; }
    .ergebnis-item.active, .ergebnis-item:hover { background-color: #46a1f0; }
    .ergebnis-item.no-results { cursor: default; color: #888; }
    .ergebnis-item.no-results:hover { background-color: white; }

    /* --- 3. EINHEITLICHE STILE F√úR NORMALE EINGABEFELDER (text, tel, date) --- */
    .centered-form-layout input[type="text"],
    .centered-form-layout input[type="tel"],
    .centered-form-layout input[type="date"] {
        height: 45px;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 0 20px;
        font-size: 16px;
        box-sizing: border-box;
        transition: all 0.2s ease-in-out;
        width: 100%;
        max-width: 500px;
        font-family: 'Roboto', sans-serif;
        color: #333;
    }

    /* --- 4. DER "NUKLEARE RESET" F√úR SELECT2-DROPDOWNS --- */
    
    /* Schritt A: Select2-Standarddesign komplett entfernen */
    .select2-container--default .select2-selection--single {
        background-color: transparent !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        height: auto !important;
    }

/* Schritt B: Unser Design auf den √§u√üeren Select2-Container anwenden (FINALE BREITEN-KORREKTUR) */
.centered-form-layout .select2-container {
    height: 45px; /* !important ist hier nicht mehr n√∂tig */
    border-radius: 8px;
    border: 1px solid #ccc;
    padding: 0 20px;
    font-size: 16px;
    box-sizing: border-box; /* Wichtig! */
    transition: all 0.2s ease-in-out;
    width: 100%; /* Breite wird vom Elternelement gesteuert */
    max-width: 500px; /* Breite wird vom Elternelement gesteuert */
    font-family: 'Roboto', sans-serif;
    color: #333;
    display: flex;
    align-items: center;
    background-color: white;
    position: relative;
}


/* Schritt C: Den Text im Inneren sauber positionieren (FINALE VERSION) */
.centered-form-layout .select2-container .select2-selection__rendered {
    padding: 0 !important;
    color: #333 !important;
    margin-top: 1px; /* Ein winziger Pixel nach unten f√ºr die perfekte optische Mitte */
}


    /* Schritt D: Den Pfeil rechts positionieren */
    .centered-form-layout .select2-container--default .select2-selection__arrow {
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        height: auto !important;
        width: auto !important;
    }

/* ======================================================================== */
/* ===== FINAL: H√§sslichen Standard-Fokus-Rahmen in Select2 entfernen (Aggressive Methode) ===== */
/* ======================================================================== */
.select2-container *:focus {
    outline: none !important;
}



/* --- 5. EINHEITLICHER FOKUS-EFFEKT F√úR ALLE FELDER (ROBUSTE VERSION) --- */
.centered-form-layout input[type="text"]:focus,
.centered-form-layout input[type="text"]:focus-visible, /* NEU */
.centered-form-layout input[type="tel"]:focus,
.centered-form-layout input[type="tel"]:focus-visible, /* NEU */
.centered-form-layout input[type="date"]:focus,
.centered-form-layout input[type="date"]:focus-visible, /* NEU */
.centered-form-layout .select2-container.select2-container--open,
.centered-form-layout .select2-container:focus-within {
    outline: none !important;
    border-color: #00a1e1 !important;
    box-shadow: 0 0 0 3px rgba(0, 161, 225, 0.25) !important;
}

    /* --- 6. STYLING F√úR DATUMSFELDER (VERHALTEN & ICON) --- */
    .centered-form-layout input[type="date"] {
        width: 100% !important;
        max-width: 200px !important;
        box-sizing: border-box;
        text-align: left;
        position: relative;
    }
    .centered-form-layout input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        padding: 5px;
        cursor: pointer;
    }

    /* --- 7. SONSTIGE STILE (Trennlinie, Artikel-Dropdown etc.) --- */
    .form-divider {
        border: none;
        border-top: 1px solid #e0e0e0;
        margin: 15px 0;
    }
    .grund-steuerung .select2-container {
        width: 100% !important;
        max-width: 250px;
    }

    /* ======================================================================== */
/* ===== FINAL: Markenkonforme Farbe f√ºr markierten Text (Selection) ===== */
/* ======================================================================== */
::selection {
    background-color: #00a1e1; /* Unser sch√∂nes EWE-Blau */
    color: #ffffff;           /* Wei√üer Text f√ºr besten Kontrast */
}

    /* --- 8. MOBILE OPTIMIERUNG --- */
    @media (max-width: 768px) {
      .form-section-container {
        margin-left: 10px;
        margin-right: 10px;
      }
    }


  </style>
</head>
<body>
  <header id="header">
    <div class="header-left">
      <img src="https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png" alt="EWE Logo">
    </div>
    <div class="header-content">
      <h1>Retourenschein</h1>
      <div class="header-date" id="heute"></div>
    </div>
    <div class="header-right">
      <div class="buttons">
        <button onclick="window.close( )" class="btn btn-secondary">üîô Zur√ºck</button>
        <button onclick="generateRetourenscheinPDF()" class="btn btn-primary">PDF erzeugen</button>
      </div>
    </div>
  </header>

  <section class="form-section-container">
    <h3>Kundendaten</h3>
    <div id="kundenDetails" class="centered-form-layout">
      <!-- ===== HIER IST DIE NEUE SUCHLEISTE ===== -->
      <input type="text" id="kundenSuche" placeholder="Lade Kundenliste..." disabled autocomplete="new-password">
      <div id="suchErgebnisse" style="display: none;"></div>
      
      <input type="text" id="name" placeholder="Name" autocomplete="new-password">
      <input type="text" id="firma" placeholder="Firma" autocomplete="new-password">
      <input type="text" id="strasse" placeholder="Stra√üe" autocomplete="new-password">
      <input type="text" id="plz" placeholder="PLZ" autocomplete="new-password">
      <input type="text" id="ort" placeholder="Ort" autocomplete="new-password">
      <input type="text" id="land" placeholder="Land" autocomplete="new-password">
      <input type="text" id="email" placeholder="E-Mail" autocomplete="new-password">
      <input type="text" id="telefon" placeholder="Telefon" autocomplete="new-password">
      <input type="text" id="kundennummer" placeholder="Kundennummer (optional)" autocomplete="new-password">


    </div>
  </section>

<!-- ===== FINALE, EINHEITLICHE RETOURENDETAILS START ===== -->
<section class="form-section-container">
    <h3>Retourendetails</h3>
    <div id="retourenDetails" class="centered-form-layout">
      
      <!-- Dropdowns und Textfelder bleiben wie gehabt -->
      <select id="bearbeiterDropdown">
        <option value="">-- Bearbeiter ausw√§hlen --</option>
        <option value="Rafael Furtw√§ngler">Rafael Furtw√§ngler</option>
        <option value="Christof M√ºnster">Christof M√ºnster</option>
        <option value="Thorben Buttschaft">Thorben Buttschaft</option>
        <option value="Sascha Heusel">Sascha Heusel</option>
        <option value="Bernhard Kneissl">Bernhard Kneissl</option>
        <option value="Christopher-Sean Haus">Christopher-Sean Haus</option>
        <option value="Sascha Barkowsky">Sascha Barkowsky</option>
        <option value="Volker Kottwitz">Volker Kottwitz</option>
        <option value="Volker Oesterwind">Volker Oesterwind</option>
        <option value="Thomas Sch√∂nf√º√ü">Thomas Sch√∂nf√º√ü</option>
        <option value="Thomas Wendt">Thomas Wendt</option>
        <option value="Harald Natzke">Harald Natzke</option>
        <option value="Lukas Pfeil">Lukas Pfeil</option>
        <option value="Nancy Ullbricht">Nancy Ullbricht</option>
        <option value="Heiner Birkholz">Heiner Birkholz</option>
        <option value="Helmut W√∂lfel">Helmut W√∂lfel</option>
        <option value="manuell">-- Manuelle Eingabe --</option>
      </select>
      <input type="text" id="bearbeiterManuell" placeholder="Bearbeiter (manuell)" style="display: none;">
      
      <select id="anlieferungDropdown">
        <option value="">-- Anlieferung ausw√§hlen --</option>
        <option value="PKW Au√üendienst">PKW Au√üendienst</option>
        <option value="EWE-LKW">EWE-LKW</option>
        <option value="Paketdienst">Paketdienst</option>
        <option value="Spedition">Spedition</option>
        <option value="Sonstiges">Sonstiges</option>
      </select>

      <input type="text" id="auftragsnummer" placeholder="Auftragsnummer" autocomplete="new-password">
      <input type="text" id="rechnungsnummer" placeholder="Bezug zu Rechnungsnummer" autocomplete="new-password">
      <input type="text" id="reklamationsnummer" placeholder="Reklamationsnummer" autocomplete="new-password">

      <!-- ===== HIER KOMMT DIE NEUE TRENNLINIE ===== -->
      <hr class="form-divider">

      <!-- ===== FINALE, GEKLONTE & KORRIGIERTE DATUMSFELDER ===== -->
      <input type="text" id="abholdatum" placeholder="Abholdatum" 
             onfocus="this.type='date'" 
             onblur="formatDate(this, 'Abholdatum')">
      
      <input type="text" id="wareneingang_datum" placeholder="Wareneingangsdatum" 
             onfocus="this.type='date'" 
             onblur="formatDate(this, 'Wareneingangsdatum')">

    </div>
  </section>

  <!-- Der Rest des HTML bleibt unver√§ndert -->
  <section id="artikelListe" class="search-container">
    <h3>Artikel zur R√ºcksendung</h3>
    <div id="artikelInhalt"></div>
  </section>
  <section id="manuelleArtikelSection" class="search-container">
    <h3>Artikel manuell hinzuf√ºgen</h3>
    <div id="manuelleArtikelContainer"></div>
    <div class="button-container">
      <button type="button" id="weiterenartikelBtn" class="btn btn-secondary">+ Weiteren Artikel hinzuf√ºgen</button>
      <button type="button" id="artikelHinzufuegenBtn" class="btn btn-primary">Artikel zur Liste hinzuf√ºgen</button>
    </div>
  </section>
  <section id="bemerkungenSection" class="search-container">
    <h3>Bemerkungen</h3>
    <textarea id="bemerkungen" placeholder="..."></textarea>
  </section>
  <section id="reklamationSection" class="search-container">
    <h3>Interne Vermerke</h3>
    <div class="reklamation-grid">
      <div class="reklamation-option">
        <input type="checkbox" id="checkReklamation">
        <label for="checkReklamation">Reklamation</label>
      </div>
      <div class="reklamation-option">
        <input type="checkbox" id="checkReparatur">
        <label for="checkReparatur">Reparatur - Kostenvoranschlag</label>
      </div>
      <div class="reklamation-option">
        <input type="checkbox" id="checkNeuware">
        <label for="checkNeuware">Neuware. Einlagern und zubuchen</label>
      </div>
      <div class="reklamation-option">
        <input type="checkbox" id="checkWeiterleitung">
        <label for="checkWeiterleitung">Weiterleitung an:</label>
      </div>
      <div class="reklamation-option">
        <input type="checkbox" id="checkRuecksendung">
        <label for="checkRuecksendung">R√ºcksendung an den Kunden</label>
      </div>
      <input type="text" id="weiterleitungAnName" placeholder="Name eintragen" style="display: none;">
    </div>
  </section>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Referenzen auf die HTML-Elemente
    const inputs = {
      name: document.getElementById("name" ),
      firma: document.getElementById("firma"),
      telefon: document.getElementById("telefon"),
      email: document.getElementById("email"),
      strasse: document.getElementById("strasse"),
      ort: document.getElementById("ort"),
      plz: document.getElementById("plz"),
      land: document.getElementById("land")
    };
    const retourenInputs = {
      bearbeiter: document.getElementById("bearbeiterDropdown"),
      bearbeiterManuell: document.getElementById("bearbeiterManuell"),
      anlieferung: document.getElementById("anlieferungDropdown"),
      bemerkungen: document.getElementById("bemerkungen"), 
      checkReklamation: document.getElementById("checkReklamation"),
      checkNeuware: document.getElementById("checkNeuware"),
      checkRuecksendung: document.getElementById("checkRuecksendung"),
      checkReparatur: document.getElementById("checkReparatur"),
      checkWeiterleitung: document.getElementById("checkWeiterleitung"),
      weiterleitungAnName: document.getElementById("weiterleitungAnName")
    };


    // LOGIK F√úR DIE INTELLIGENTE SUCHLEISTE
    let kunden = [];
    let activeResultIndex = -1;
    const kundenSucheInput = document.getElementById('kundenSuche');
    const suchErgebnisseContainer = document.getElementById('suchErgebnisse');

// ========================================================================
// ===== NEU: UNIVERSALER DATENSCHUTZ- & LADE-CODE                  =====
// ========================================================================

async function loadProtectedData() {
    // 1. Versuche, das Passwort aus dem localStorage zu lesen (konsistent mit anderen Seiten)
    let password = localStorage.getItem('customerDataPassword');

    // 2. Wenn nicht gefunden, pr√ºfe, ob es im URL-Hash √ºbergeben wurde
    if (!password && window.location.hash.includes('password=')) {
        const urlHash = window.location.hash.substring(1);
        const params = new URLSearchParams(urlHash);
        password = params.get('password');
        
        if (password) {
            localStorage.setItem('customerDataPassword', password);
            history.replaceState(null, '', window.location.pathname + window.location.search);
        }
    }

    // Hilfsfunktion, um das Suchfeld zu deaktivieren und die Nachricht anzuzeigen
    function disableSearch(message) {
        const kundenSucheInput = document.getElementById('kundenSuche');
        if (kundenSucheInput) {
            kundenSucheInput.disabled = true;
            kundenSucheInput.placeholder = message;
        }
    }

    // 3. FINALE PR√úFUNG: Wenn wir jetzt immer noch kein Passwort haben...
    if (!password) {
        console.log("Kein Passwort gefunden. Kundensuche wird deaktiviert.");
        disableSearch("F√ºr Kundensuche bitte anmelden");
        return false; // <-- WICHTIG: Signal f√ºr Fehlschlag zur√ºckgeben
    }

    // 4. Wenn wir hier ankommen, haben wir ein Passwort. Lade und entschl√ºssele die Daten.
    try {
        const kundenSucheInput = document.getElementById('kundenSuche');
        if(kundenSucheInput) kundenSucheInput.placeholder = "Entschl√ºssele Kundendaten...";

        const encryptedFilePath = 'https://volkerkottwitz.github.io/Konfig/Konfigurator/anewstar/Retourenschein/kundenstamm.enc';
        const response = await fetch(encryptedFilePath + '?t=' + new Date( ).getTime());
        
        if (!response.ok) throw new Error('Kundendatei nicht gefunden.');
        
        const encryptedArrayBuffer = await response.arrayBuffer();
        const decryptedCsvText = await decryptData(encryptedArrayBuffer, password);
        
        kunden = Papa.parse(decryptedCsvText, { header: true, skipEmptyLines: true, bom: true }).data;
        
        return true; // <-- WICHTIG: Signal f√ºr Erfolg zur√ºckgeben

    } catch (error) {
        console.error("Fehler bei der Datenentschl√ºsselung:", error);
        localStorage.removeItem('customerDataPassword');
        disableSearch("Anmeldung fehlgeschlagen. Bitte neu anmelden.");
        return false; // <-- WICHTIG: Signal f√ºr Fehlschlag zur√ºckgeben
    }
}


// Hilfsfunktion, die die eigentliche Entschl√ºsselung durchf√ºhrt
async function decryptData(encryptedArrayBuffer, password) {
    const ITERATIONS = 480000;
    const SALT_SIZE_BYTES = 16;
    const NONCE_SIZE_BYTES = 12;

    // Daten aus der Datei extrahieren
    const salt = encryptedArrayBuffer.slice(0, SALT_SIZE_BYTES);
    const nonce = encryptedArrayBuffer.slice(SALT_SIZE_BYTES, SALT_SIZE_BYTES + NONCE_SIZE_BYTES);
    const data = encryptedArrayBuffer.slice(SALT_SIZE_BYTES + NONCE_SIZE_BYTES);

    // Passwort in einen Basisschl√ºssel umwandeln
    const passwordKey = await window.crypto.subtle.importKey(
        'raw', new TextEncoder().encode(password), { name: 'PBKDF2' }, false, ['deriveKey']
    );

    // Starken AES-Schl√ºssel ableiten
    const aesKey = await window.crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt: salt, iterations: ITERATIONS, hash: 'SHA-256' },
        passwordKey, { name: 'AES-GCM', length: 256 }, true, ['decrypt']
    );

    // Daten entschl√ºsseln
    const decryptedData = await window.crypto.subtle.decrypt(
        { name: 'AES-GCM', iv: nonce }, aesKey, data
    );

    // Entschl√ºsselte Daten in Text umwandeln
    return new TextDecoder().decode(decryptedData);
}

function initializeCustomerSearchListeners() {
    kundenSucheInput.addEventListener('input', function() {
        activeResultIndex = -1;
        const suchbegriff = this.value.toLowerCase();
        if (suchbegriff.length < 2) {
            suchErgebnisseContainer.style.display = 'none';
            return;
        }
        const suchbegriffe = suchbegriff.split(' ').filter(Boolean);
        const treffer = kunden.filter(kunde => {
            const adresseTeile = kunde.Adresse ? kunde.Adresse.split(",").map(x => x.trim()) : [];
            const ort = adresseTeile[1] || '';
            const plz = adresseTeile[2] || '';
            const suchString = `${kunde.Name || ''} ${kunde.Firma || ''} ${plz} ${ort}`.toLowerCase();
            return suchbegriffe.every(term => suchString.includes(term));
        }).slice(0, 50);
        zeigeSuchErgebnisse(treffer, suchbegriffe);
    });

    kundenSucheInput.addEventListener('keydown', function(e) {
        const ergebnisse = suchErgebnisseContainer.querySelectorAll('.ergebnis-item:not(.no-results)');
        if (ergebnisse.length === 0) return;
        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                activeResultIndex = (activeResultIndex + 1) % ergebnisse.length;
                updateActiveResult(ergebnisse);
                break;
            case 'ArrowUp':
                e.preventDefault();
                activeResultIndex = (activeResultIndex - 1 + ergebnisse.length) % ergebnisse.length;
                updateActiveResult(ergebnisse);
                break;
            case 'Enter':
                e.preventDefault();
                if (activeResultIndex > -1) {
                    ergebnisse[activeResultIndex].click();
                } else if (ergebnisse.length === 1) {
                    ergebnisse[0].click();
                }
                break;
            case 'Escape':
                suchErgebnisseContainer.style.display = 'none';
                break;
        }
    });

   
suchErgebnisseContainer.addEventListener('click', function(e) {
    const ergebnisItem = e.target.closest('.ergebnis-item');
    if (ergebnisItem && ergebnisItem.dataset.index) {
        const index = ergebnisItem.dataset.index;
        const kunde = kunden[index];
        const adresseTeile = kunde.Adresse ? kunde.Adresse.split(",").map(x => x.trim()) : ["", "", "", ""];
        
        // Bestehende Felder bef√ºllen
        inputs.name.value = kunde.Name || "";
        inputs.firma.value = kunde.Firma || "";
        inputs.telefon.value = kunde.Telefon || "";
        inputs.email.value = kunde['E-Mail'] || "";
        inputs.strasse.value = adresseTeile[0] || "";
        inputs.ort.value = adresseTeile[1] || "";
        inputs.plz.value = adresseTeile[2] || "";
        inputs.land.value = adresseTeile[3] || "";

        // ===== NEU & FINAL: Kundennummer in das unsichtbare Feld eintragen =====
        // Das Feld 'Kundennummer' kommt jetzt aus unserer neuen, kombinierten CSV-Datei.
        // Es wird gef√ºllt, wenn eine Nummer vorhanden ist (auch mit '?'), ansonsten bleibt es leer.
        document.getElementById("kundennummer").value = kunde.Kundennummer || ""; 

        // Rest der Funktion
        kundenSucheInput.value = '';
        suchErgebnisseContainer.style.display = 'none';
    }
});

    
    document.addEventListener('click', function(e) {
        if (!kundenSucheInput.contains(e.target) && !suchErgebnisseContainer.contains(e.target)) {
            suchErgebnisseContainer.style.display = 'none';
        }
    });

    } 


     function updateActiveResult(ergebnisse) {
        ergebnisse.forEach(item => item.classList.remove('active'));
        if (activeResultIndex > -1) {
            const activeItem = ergebnisse[activeResultIndex];
            activeItem.classList.add('active');
            activeItem.scrollIntoView({ block: 'nearest' });
        }
    }

    function zeigeSuchErgebnisse(treffer, suchbegriffe) {
        if (treffer.length === 0) {
            suchErgebnisseContainer.innerHTML = '<div class="ergebnis-item no-results">Keine Treffer gefunden</div>';
        } else {
            let html = '';
            treffer.forEach(kunde => {
                const originalIndex = kunden.indexOf(kunde);
                const adresseTeile = kunde.Adresse ? kunde.Adresse.split(",").map(x => x.trim()) : [];
                const ort = adresseTeile[1] || '';
                const plz = adresseTeile[2] || '';
                const nameTeil = kunde.Name ? `${kunde.Name.trim()} ‚Äì ` : '';
                const firmaTeil = kunde.Firma ? kunde.Firma.trim() : 'Unbekannte Firma';
                let ortsTeil = (plz && ort) ? ` (${plz} ${ort})` : (ort ? ` (${ort})` : (plz ? ` (${plz})` : ''));
                let label = `${nameTeil}${firmaTeil}${ortsTeil}`;
                suchbegriffe.forEach(term => {
                    const regex = new RegExp(term, 'gi');
                    label = label.replace(regex, match => `<span class="search-highlight">${match}</span>`);
                });
                html += `<div class="ergebnis-item" data-index="${originalIndex}">${label}</div>`;
            });
            suchErgebnisseContainer.innerHTML = html;
        }
        suchErgebnisseContainer.style.display = 'block';
    }


    // Initialisierung der anderen Dropdowns
    $(document).ready(function() {
        $('#bearbeiterDropdown').select2({ placeholder: "-- Bearbeiter ausw√§hlen --", allowClear: true });
        $('#anlieferungDropdown').select2({ placeholder: "-- Anlieferung ausw√§hlen --", allowClear: true });
    });

    // Event-Listener f√ºr Bearbeiter-Dropdown
    $('#bearbeiterDropdown').on('change', function () {
      const selectedValue = this.value;
      const manuellesEingabefeld = retourenInputs.bearbeiterManuell;
      if (selectedValue === "manuell") {
        manuellesEingabefeld.style.display = "block";
        manuellesEingabefeld.focus();
      } else {
        manuellesEingabefeld.style.display = "none";
        manuellesEingabefeld.value = "";
      }
    });



// ========================================================================
// ===== NEU: Funktion zur Formatierung des Datums nach der Auswahl =====
// ========================================================================

function formatDate(inputElement, labelText) {
  // Zuerst den Typ auf Text zur√ºcksetzen, damit wir den Wert manipulieren k√∂nnen
  inputElement.type = 'text';
  
  const isoDate = inputElement.value; // z.B. "2025-10-09"
  
  // Nur formatieren, wenn ein g√ºltiges Datum im ISO-Format vorhanden ist
  if (isoDate && isoDate.includes('-')) {
    const parts = isoDate.split('-'); // Ergibt: ["2025", "10", "09"]
    const year = parts[0];
    const month = parts[1];
    const day = parts[2];
    
    // Das gew√ºnschte Format "Label: TT.MM.JJJJ" erstellen und ins Feld schreiben
    // Wir verwenden absichtlich den 'labelText' und nicht den 'placeholder',
    // da der placeholder verschwindet, sobald ein Wert im Feld steht.
    inputElement.value = `${labelText}: ${day}.${month}.${year}`;
  } else {
    // Wenn kein Datum ausgew√§hlt wurde oder der Wert ung√ºltig ist,
    // leeren wir das Feld, damit der urspr√ºngliche Platzhalter wieder sichtbar wird.
    inputElement.value = ''; 
  }
}

// ========================================================================
// ===== NEU: Hilfsfunktion zum Erzeugen des heutigen Datums im TT.MM.JJJJ-Format =====
// ========================================================================
function getTodayGermanDate() {
  const today = new Date();
  const day = String(today.getDate()).padStart(2, '0'); // Stellt sicher, dass der Tag zweistellig ist (z.B. 09)
  const month = String(today.getMonth() + 1).padStart(2, '0'); // Monat ist 0-basiert, daher +1. Auch zweistellig.
  const year = today.getFullYear();
  return `${day}.${month}.${year}`; // Gibt z.B. "09.10.2025" zur√ºck
}

    // Merkliste aus localStorage laden
    function ladeMerklisteAusLocalStorage() {
      try {
        const merklisteData = localStorage.getItem('merklisteForRetourenschein');
        if (merklisteData) {
          const merkliste = JSON.parse(merklisteData);
          
          // Merkliste als globale Variable setzen
          window.merklisteItems = merkliste.map(item => ({
            nummer: item.nummer || item.artikelnummer || '',
            name: item.name || item.bezeichnung || 'Unbekannter Artikel',
            bezeichnung: item.name || item.bezeichnung || 'Unbekannter Artikel',
            artikelnummer: item.nummer || item.artikelnummer || '',
            menge: item.menge || 1,
            preis: item.preis || '0,00 ‚Ç¨'
          }));
          
          // Artikel-Liste sofort aktualisieren
          updateArtikelListe();
          
          // LocalStorage nach dem Laden l√∂schen (optional)
          localStorage.removeItem('merklisteForRetourenschein');
          
          console.log('Merkliste erfolgreich geladen:', merkliste.length, 'Artikel');
        }
      } catch (error) {
        console.error('Fehler beim Laden der Merkliste:', error);
      }
    }

    // NEU: Event-Listener f√ºr die "Weiterleitung an"-Checkbox
    retourenInputs.checkWeiterleitung.addEventListener('change', function() {
      if (this.checked) {
        retourenInputs.weiterleitungAnName.style.display = 'block';
        retourenInputs.weiterleitungAnName.focus();
      } else {
        retourenInputs.weiterleitungAnName.style.display = 'none';
        retourenInputs.weiterleitungAnName.value = ''; // Feld leeren, wenn Checkbox deaktiviert wird
      }
    });

    // Funktion zum Entfernen eines Artikels
    function removeArtikel(index) {
      if (confirm('M√∂chten Sie diesen Artikel wirklich entfernen?')) {
        window.merklisteItems.splice(index, 1);
        updateArtikelListe();
      }
    }

    // Merkliste-Artikel anzeigen (falls vorhanden) - VERBESSERTE VERSION
    function updateArtikelListe() {
      const artikelInhalt = document.getElementById("artikelInhalt");
      
      // Pr√ºfen, ob window.merklisteItems existiert und Artikel vorhanden sind
      if (window.merklisteItems && window.merklisteItems.length > 0) {
        // Artikel-Karten erstellen (neues Design)
        let cardsHtml = '<div class="artikel-karten-container">';
        
        window.merklisteItems.forEach((artikel, index) => {
          cardsHtml += `
            <div class="artikel-karte">
              <div class="artikel-info">
                <div class="artikel-name">${artikel.name || artikel.bezeichnung || 'Unbekannter Artikel'}</div>
                <div class="artikel-details">
                  <p><strong>Artikelnummer:</strong> ${artikel.nummer || artikel.artikelnummer || 'N/A'}</p>
                  <p><strong>Preis:</strong> ${artikel.preis || '0,00 ‚Ç¨'}</p>
                </div>
              </div>
              <div class="artikel-aktionen">
                <div class="mengen-steuerung">
                  <label for="menge_${index}">Menge:</label>
                  <input type="number" id="menge_${index}" class="quantity-input" min="1" value="${artikel.menge || 1}">
                </div>
                <div class="grund-steuerung">
                  <label for="grund_${index}">Retourengrund:</label>
                  <select id="grund_${index}" class="artikel-grund">
                    <option value="">-- Grund ausw√§hlen --</option>
                    <option value="Artikel passt nicht / falsche Gr√∂√üe">Artikel passt nicht / falsche Gr√∂√üe</option>
                    <option value="Artikel gef√§llt nicht">Artikel gef√§llt nicht</option>
                    <option value="Artikel besch√§digt / defekt">Artikel besch√§digt / defekt</option>
                    <option value="Falscher Artikel geliefert">Falscher Artikel geliefert</option>
                    <option value="Doppelt bestellt">Doppelt bestellt</option>
                    <option value="Neuware / Einlagern">Neuware / Einlagern</option>
                    <option value="Sonstiges">Sonstiges</option>
                  </select>
                </div>
                <button class="entfernen-btn" onclick="removeArtikel(${index})" title="Artikel entfernen">
                  üóëÔ∏è Entfernen
                </button>
              </div>
            </div>`;
        });
        
        cardsHtml += '</div>';
        artikelInhalt.innerHTML = cardsHtml;

        // Event-Listener f√ºr Mengen-√Ñnderungen hinzuf√ºgen
        window.merklisteItems.forEach((artikel, index) => {
          const mengeInput = document.getElementById(`menge_${index}`);
          if (mengeInput) {
            mengeInput.addEventListener('input', function() {
              window.merklisteItems[index].menge = parseInt(this.value) || 1;
            });
          }
        });

        // Select2 auf die neu erstellten Dropdowns anwenden
        $('.artikel-grund').select2({
            placeholder: "-- Grund ausw√§hlen --",
            allowClear: true,
            minimumResultsForSearch: Infinity // Versteckt das Suchfeld
        });

      } else {
        // Keine Artikel vorhanden
        artikelInhalt.innerHTML = '<div class="empty-state">Keine Artikel in der Merkliste gefunden. Sie k√∂nnen unten manuell Artikel hinzuf√ºgen.</div>';
      }
    }

    // NEU: Einzelnes manuelles Eingabefeld erstellen
    function createManuelleArtikelField(index) {
      return `
        <div class="manueller-artikel" id="manuellerArtikel_${index}">
          <div class="artikel-header">
            <h4>Artikel ${index + 1}</h4>
            ${index > 0 ? `<button type="button" class="remove-artikel-btn" onclick="removeManuelleArtikelField(${index})">‚úï</button>` : ''}
          </div>
          <div class="artikel-eingabe-grid">
            <div class="eingabe-feld">
              <label for="manuellerName_${index}">Artikelname:</label>
              <input type="text" id="manuellerName_${index}" placeholder="Artikelname eingeben">
            </div>
            <div class="eingabe-feld">
              <label for="manuelleNummer_${index}">Artikelnummer:</label>
              <input type="text" id="manuelleNummer_${index}" placeholder="Artikelnummer eingeben">
            </div>
            <div class="eingabe-feld">
              <label for="manuelleMenge_${index}">St√ºckzahl:</label>
              <input type="number" id="manuelleMenge_${index}" min="1" value="1">
            </div>
            <div class="eingabe-feld">
              <label for="manuellerGrund_${index}">R√ºckgabegrund:</label>
              <select id="manuellerGrund_${index}" class="artikel-grund">
                <option value="">-- Grund ausw√§hlen --</option>
                <option value="Artikel passt nicht / falsche Gr√∂√üe">Artikel passt nicht / falsche Gr√∂√üe</option>
                <option value="Artikel gef√§llt nicht">Artikel gef√§llt nicht</option>
                <option value="Artikel besch√§digt / defekt">Artikel besch√§digt / defekt</option>
                <option value="Falscher Artikel geliefert">Falscher Artikel geliefert</option>
                <option value="Doppelt bestellt">Doppelt bestellt</option>
                <option value="Neuware / Einlagern">Neuware / Einlagern</option>
                <option value="Sonstiges">Sonstiges</option>
              </select>
            </div>
          </div>
        </div>`;
    }

    // NEU: Manuelle Artikel-Eingabe initialisieren (immer sichtbar)
    function initManuelleArtikelEingabe() {
      const manuelleArtikelContainer = document.getElementById("manuelleArtikelContainer");
      
      // Erstes Eingabefeld erstellen
      manuelleArtikelCounter = 1;
      manuelleArtikelContainer.innerHTML = createManuelleArtikelField(0);
      
      // Select2 auf das erste Dropdown anwenden
      $(`#manuellerGrund_0`).select2({
          placeholder: "-- Grund ausw√§hlen --",
          allowClear: true,
          minimumResultsForSearch: Infinity
      });
    }

    // NEU: Weiteres manuelles Eingabefeld hinzuf√ºgen
    function addManuelleArtikelField() {
      const manuelleArtikelContainer = document.getElementById("manuelleArtikelContainer");
      
      // Neues Feld hinzuf√ºgen
      const newFieldHtml = createManuelleArtikelField(manuelleArtikelCounter);
      manuelleArtikelContainer.insertAdjacentHTML('beforeend', newFieldHtml);
      
      // Select2 auf das neue Dropdown anwenden
      $(`#manuellerGrund_${manuelleArtikelCounter}`).select2({
          placeholder: "-- Grund ausw√§hlen --",
          allowClear: true,
          minimumResultsForSearch: Infinity
      });
      
      manuelleArtikelCounter++;
    }

    // NEU: Manuelles Eingabefeld entfernen
    function removeManuelleArtikelField(index) {
      const fieldToRemove = document.getElementById(`manuellerArtikel_${index}`);
      if (fieldToRemove) {
        fieldToRemove.remove();
        
        // Nummerierung der verbleibenden Felder aktualisieren
        updateManuelleArtikelNummering();
      }
    }

    // NEU: Nummerierung der manuellen Artikel aktualisieren
    function updateManuelleArtikelNummering() {
      const manuelleArtikel = document.querySelectorAll('.manueller-artikel');
      manuelleArtikel.forEach((artikel, index) => {
        const header = artikel.querySelector('h4');
        if (header) {
          header.textContent = `Artikel ${index + 1}`;
        }
      });
    }

    // NEU: Manuell hinzugef√ºgte Artikel zur Merkliste hinzuf√ºgen
    function addManuelleArtikel() {
      if (!window.merklisteItems) {
        window.merklisteItems = [];
      }
      
      let hinzugefuegt = 0;
      const manuelleArtikel = document.querySelectorAll('.manueller-artikel');
      
      manuelleArtikel.forEach((artikel, index) => {
        const nameInput = artikel.querySelector(`input[id*="manuellerName"]`);
        const nummerInput = artikel.querySelector(`input[id*="manuelleNummer"]`);
        const mengeInput = artikel.querySelector(`input[id*="manuelleMenge"]`);
        const grundSelect = artikel.querySelector(`select[id*="manuellerGrund"]`);
        
        if (nameInput && nummerInput && mengeInput && grundSelect) {
          const name = nameInput.value.trim();
          const nummer = nummerInput.value.trim();
          const menge = parseInt(mengeInput.value) || 1;
          const grund = grundSelect.value;
          
          // Nur hinzuf√ºgen, wenn mindestens Name oder Nummer ausgef√ºllt ist
          if (name || nummer) {
            const neuerArtikel = {
              name: name || 'Manuell hinzugef√ºgter Artikel',
              nummer: nummer || 'N/A',
              bezeichnung: name || 'Manuell hinzugef√ºgter Artikel',
              artikelnummer: nummer || 'N/A',
              menge: menge,
              preis: '0,00 ‚Ç¨',
              grund: grund
            };
            
            window.merklisteItems.push(neuerArtikel);
            hinzugefuegt++;
            
            // Felder nach dem Hinzuf√ºgen leeren
            nameInput.value = '';
            nummerInput.value = '';
            mengeInput.value = '1';
            $(grundSelect).val('').trigger('change');
          }
        }
      });
      
if (hinzugefuegt > 0) {
    updateArtikelListe();
    // alert(`${hinzugefuegt} Artikel wurden zur Liste hinzugef√ºgt.`); // <-- Auskommentiert oder gel√∂scht
} else {
    alert('Bitte f√ºllen Sie mindestens den Namen oder die Artikelnummer f√ºr einen Artikel aus.');
}
    }

    // Event-Listener f√ºr die Buttons
    document.getElementById('weiterenartikelBtn').addEventListener('click', addManuelleArtikelField);
    document.getElementById('artikelHinzufuegenBtn').addEventListener('click', addManuelleArtikel);

    // Heutiges Datum setzen
    document.getElementById("heute").textContent = new Date().toLocaleDateString('de-DE');

// PDF-Generierungsfunktion (erweitert)
/**
 * Erzeugt einen Retourenschein im EWE-Design als PDF.
 * Finale, polierte Version mit allen Detail-Korrekturen.
 *
 * ANLEITUNG:
 * 1. Ersetzen Sie die alte `generateRetourenscheinPDF`-Funktion durch diese.
 * 2. Passen Sie die `logoUrl`-Variable an, sodass sie auf Ihr Logo zeigt.
 */
async function generateRetourenscheinPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    // --- Hilfsfunktion zum Laden eines Bildes ---
    const loadImage = (url) => new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = () => resolve(img);
        img.onerror = (err) => reject(err);
        img.src = url;
    });

    // --- Globale Einstellungen ---
    const page_margin = 5;
    const page_width = doc.internal.pageSize.getWidth();
    const content_width = page_width - (2 * page_margin);
    const fieldBackgroundColor = [230, 245, 255];

    // --- Hilfsfunktionen zum Zeichnen ---
    const drawTextField = (x, y, label, value, width = 85, height = 6, useBgColor = true) => {
        if (useBgColor) {
            doc.setFillColor(...fieldBackgroundColor).rect(x, y + 1, width, height, 'F');
        }
        doc.setFontSize(7).setFont("helvetica", "bold").text(label, x, y);
        doc.setFont("helvetica", "normal").setFontSize(10);
        const textY = (label === "Name") ? y + 6.5 : y + 5.5;
        doc.text(value || '', x + 1, textY, { maxWidth: width - 2, lineHeightFactor: 1.15 });
        doc.setDrawColor(0).line(x, y + height + 1, x + width, y + height + 1);
    };

    const drawCheckBox = (x, y, label) => {
        doc.setFontSize(10).setFont("helvetica", "normal");
        doc.rect(x, y, 4, 4);
        doc.text(label, x + 6, y + 3.5);
    };

    // ========================================================================
    // ===== DATEN F√úR PDF SAMMELN (ROBUSTE VERSION) =====
    // ========================================================================

    // Hilfsfunktion, um das Datum sicher zu extrahieren und zu formatieren
    const getFormattedDate = (elementId) => {
        const input = document.getElementById(elementId);
        if (!input || !input.value) return '';
        
        // Pr√ºft, ob das Datum bereits im Anzeigeformat "Label: TT.MM.JJJJ" vorliegt
        if (input.value.includes(':')) {
            return input.value.split(': ')[1]; // Extrahiert "TT.MM.JJJJ"
        }
        // Falls das Feld noch im `type="date"`-Zustand ist, wird der ISO-Wert formatiert
        if (input.value.includes('-')) {
            const parts = input.value.split('-');
            return `${parts[2]}.${parts[1]}.${parts[0]}`;
        }
        return ''; // Fallback
    };
    
    // Alle Werte sicher auslesen
    const abholDatumValue = getFormattedDate("abholdatum");
    const wareneingangsdatumValue = getFormattedDate("wareneingang_datum");
    const auftragsnummerValue = document.getElementById("auftragsnummer").value;
    const reklamationsnummerValue = document.getElementById("reklamationsnummer").value;
    const rechnungsnummerValue = document.getElementById("rechnungsnummer").value;
    const kundennummerValue = document.getElementById("kundennummer").value;
    const bearbeiterWert = retourenInputs.bearbeiter.value === "manuell" 
        ? retourenInputs.bearbeiterManuell.value 
        : retourenInputs.bearbeiter.value;


    // --- 1. Header ---
    let y = page_margin;
    const logoUrl = 'https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png';
    let logoHeight = 15;
    try {
        const logoImg = await loadImage(logoUrl );
        const logoWidth = 40;
        logoHeight = logoWidth * (logoImg.height / logoImg.width);
        doc.addImage(logoImg, 'PNG', page_width - page_margin - logoWidth, y, logoWidth, logoHeight);
    } catch (error) {
        console.error("Fehler beim Laden des Logos:", error);
        doc.setFontSize(16).setFont("helvetica", "bold").text("EWE ARMATUREN", page_width - page_margin - 50, y + 5);
    }

    doc.setFontSize(30).setFont("helvetica", "bold").text("Retourenschein", page_margin, y + 25);
    const introTextY = Math.max(y + 10, y + logoHeight + 3);
    doc.setFontSize(9).setFont("helvetica", "normal").text("Bitte Retourenschein ausf√ºllen, als Begleitdokument der Ware beilegen und per E-Mail an den zust√§ndigen EWE-Innendienst schicken.", page_margin, introTextY, { maxWidth: content_width });
    y = introTextY + 5;

    // --- 2. Kunden- und Auftragsdaten ---
    doc.setFontSize(10).setFont("helvetica", "bold").text("Kundenangaben", page_margin + 2, y + 5);
    y += 7;
    const kundenBoxY = y;
    const kundenBoxHeight = 58;
    doc.rect(page_margin, kundenBoxY, content_width, kundenBoxHeight-1);
    const today = new Date().toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
    
    drawTextField(page_margin + 5, kundenBoxY + 5, "Firma", inputs.firma.value, 85, 12); 
    drawTextField(page_width / 2 + 5, kundenBoxY + 5, "Ansprechpartner", inputs.name.value);
    drawTextField(page_width / 2 + 5, kundenBoxY + 20.5, "Datum", today);
    drawTextField(page_width / 2 + 5, kundenBoxY + 30, "Bearbeiter", bearbeiterWert);
    drawTextField(page_margin + 5, kundenBoxY + 20.5, "Adresse", inputs.strasse.value);
    drawTextField(page_margin + 5, kundenBoxY + 30, "PLZ / Ort", `${inputs.plz.value} ${inputs.ort.value}`);
    const separatorY = kundenBoxY + 42;
    doc.line(page_margin, separatorY-2, page_width - page_margin, separatorY-2);
    drawTextField(page_margin + 5, separatorY + 3, "Anlieferung", retourenInputs.anlieferung.value);
    drawTextField(page_width / 2 + 5, separatorY + 3, "Abholung Datum", abholDatumValue); // <-- KORRIGIERT
    y = kundenBoxY + kundenBoxHeight;

    // --- 3. Artikeltabelle (unver√§ndert) ---
    // ... (Ihr Code f√ºr die Artikeltabelle bleibt hier)
    y += 3;
    doc.setFontSize(9).setFont("helvetica", "bold").text("Bitte beachten Sie, dass die Ware ordnungsgem√§√ü sowie transportgerecht zur Abholung verpackt werden muss!", page_margin + 2, y + 5);
    y += 5;
    const tableStartY = y;
    const rowHeight = 10, maxRows = 5, tableHeaderHeight = 7;
    const tableBodyHeight = maxRows * rowHeight;
    const tableTotalHeight = tableHeaderHeight + tableBodyHeight;
    doc.rect(page_margin, tableStartY, content_width, tableTotalHeight);
    doc.text("Menge", page_margin + 3, tableStartY + 5);
    doc.text("Artikelbezeichnung", page_margin + 25, tableStartY + 5);
    doc.text("EWE-Artikelnummer", page_margin + 105, tableStartY + 5);
    doc.text("Art der R√ºcklieferung", page_margin + 150, tableStartY + 5);
    for (let i = 0; i < maxRows; i++) {
        const rowY = tableStartY + tableHeaderHeight + (i * rowHeight);
        doc.setFillColor(...fieldBackgroundColor).rect(page_margin + 1, rowY + 1, content_width - 2, rowHeight - 1, 'F');
        const item = (window.merklisteItems || [])[i];
        if (item) {
            const menge = document.getElementById(`menge_${i}`)?.value || item.menge || 1;
            let grund = '';
            const grundElement = document.getElementById(`grund_${i}`);
            if (grundElement) {
                grund = grundElement.value;
            } else if (item.grund) {
                grund = item.grund;
            }
            doc.setFont("helvetica", "normal").setFontSize(9);
            doc.text(menge.toString(), page_margin + 3, rowY + 5);
            doc.text(item.name || item.bezeichnung || '', page_margin + 25, rowY + 5, { maxWidth: 75 });
            doc.text(item.nummer || item.artikelnummer || '', page_margin + 105, rowY + 5, { maxWidth: 43 });
            doc.text(grund, page_margin + 150, rowY + 5, { maxWidth: 30 });
        }
        doc.rect(page_margin + content_width - 10, rowY + (rowHeight - 4) / 2, 4, 4);
        if (i < maxRows - 1) doc.line(page_margin, rowY + rowHeight, page_width - page_margin, rowY + rowHeight);
    }
    doc.line(page_margin + 22, tableStartY + tableHeaderHeight, page_margin + 22, tableStartY + tableTotalHeight);
    doc.line(page_margin + 103, tableStartY + tableHeaderHeight, page_margin + 103, tableStartY + tableTotalHeight);
    doc.line(page_margin + 148, tableStartY + tableHeaderHeight, page_margin + 148, tableStartY + tableTotalHeight);
    doc.line(page_margin + content_width - 12, tableStartY + tableHeaderHeight, page_margin + content_width - 12, tableStartY + tableTotalHeight);
    y = tableStartY + tableTotalHeight;


    // --- 4. Interner Vermerk-Block ---
    y += 7;
    const internBoxY = y;
    const internBoxHeight = 29;
    doc.rect(page_margin, internBoxY, content_width, internBoxHeight);
    
    drawTextField(page_margin + 5, internBoxY + 3, "Wareneingangsdatum", wareneingangsdatumValue, 85, 6, true); // <-- KORRIGIERT
    drawTextField(page_margin + 5, internBoxY + 12.5, "Auftragsnummer", auftragsnummerValue, 85, 6, true);
    drawTextField(page_margin + 5, internBoxY + 22, "Reklamationsnummer", reklamationsnummerValue, 85, 6, true);
    
    drawTextField(page_width / 2 + 5, internBoxY + 3, "Kundennummer", kundennummerValue, 85, 6, true);
    drawTextField(page_width / 2 + 5, internBoxY + 12.5, "Bezug zu Rechnungsnummer", rechnungsnummerValue, 85, 6, true);
    drawTextField(page_width / 2 + 5, internBoxY + 22, "Gutschrift", "", 85, 6, true);
    y += internBoxHeight;

    // --- 5. Reklamations-Block (unver√§ndert) ---
    // ... (Ihr Code f√ºr den Reklamations-Block bleibt hier)
    y += 5;
    const reklBoxHeight = 22;
    doc.rect(page_margin, y, content_width, reklBoxHeight);

    if (retourenInputs.checkReklamation.checked) {
        doc.setFont("helvetica", "bold").text('X', page_margin + 6, y + 5.5);
    }
    drawCheckBox(page_margin + 5, y + 2, "Reklamation");

    if (retourenInputs.checkNeuware.checked) {
        doc.setFont("helvetica", "bold").text('X', page_margin + 6, y + 12.5);
    }
    drawCheckBox(page_margin + 5, y + 9, "Neuware. Einlagern und zubuchen");

    if (retourenInputs.checkRuecksendung.checked) {
        doc.setFont("helvetica", "bold").text('X', page_margin + 6, y + 19.5);
    }
    drawCheckBox(page_margin + 5, y + 16, "R√ºcksendung an den Kunden");

    if (retourenInputs.checkReparatur.checked) {
        doc.setFont("helvetica", "bold").text('X', page_width / 2 + 6, y + 5.5);
    }
    drawCheckBox(page_width / 2 + 5, y + 2, "Reparatur - Kostenvoranschlag");

    if (retourenInputs.checkWeiterleitung.checked) {
        doc.setFont("helvetica", "bold").text('X', page_width / 2 + 6, y + 12.5);
        doc.setFont("helvetica", "normal").setFontSize(9).text(retourenInputs.weiterleitungAnName.value, page_width / 2 + 55, y + 12.5, { maxWidth: 35 });
    }
    drawCheckBox(page_width / 2 + 5, y + 9, "Weiterleitung an");
    
    y += reklBoxHeight;


    // --- 6. Notiz-Block (unver√§ndert) ---
    // ... (Ihr Code f√ºr den Notiz-Block bleibt hier)
    y += 3;
    
    doc.setFontSize(10).setFont("helvetica", "bold").text("Notizen", page_margin + 2, y + 5);
    y += 7;
    const notizBoxHeight = 20;
    doc.rect(page_margin, y, content_width, notizBoxHeight);
    doc.setFont("helvetica", "normal").setFontSize(9).text(retourenInputs.bemerkungen.value, page_margin + 2, y + 5, { maxWidth: content_width - 4 });

    y += notizBoxHeight;


    // --- 7. Footer (unver√§ndert) ---
    const finalY = doc.internal.pageSize.getHeight() - 4;
    doc.setFontSize(7).setFont("helvetica", "normal");
    doc.text("VK-11 Retourenschein (Stand 10/2025)", page_margin, finalY);
    doc.text("Wilhelm Ewe GmbH & Co. KG - Volkmaroder Stra√üe 19 - 38104 Braunschweig", page_width / 2, finalY, { align: 'center' });
    doc.text("Seite 1 von 1", page_width - page_margin, finalY, { align: 'right' });

    // --- PDF Speichern ---
    const filename = `Retourenschein_${inputs.name.value.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(filename);
}


// ========================================================================
// ===== NEU: DER EINZIGE UND KORREKTE STARTPUNKT DER SEITE         =====
// ========================================================================

document.addEventListener("DOMContentLoaded", async () => {
      // ========================================================================
    // ===== HIER DIE NEUEN ZEILEN EINF√úGEN =====
    // ========================================================================
    const todayGerman = getTodayGermanDate();
    document.getElementById('abholdatum').value = `Abholdatum: ${todayGerman}`;
    document.getElementById('wareneingang_datum').value = `Wareneingangsdatum: ${todayGerman}`;
    // =================  
  
  // 1. Unabh√§ngige UI-Elemente sofort initialisieren
    
    initManuelleArtikelEingabe();
    ladeMerklisteAusLocalStorage();
    
    // 2. jQuery-abh√§ngige Initialisierungen
    $(document).ready(function() {
        $('#bearbeiterDropdown').select2({ placeholder: "-- Bearbeiter ausw√§hlen --", allowClear: true });
        $('#anlieferungDropdown').select2({ placeholder: "-- Anlieferung ausw√§hlen --", allowClear: true });
    });

    try {
        // 3. Authentifizierung pr√ºfen und auf das Ergebnis warten
        const isLoginSuccessful = await loadProtectedData();

        // 4. NUR bei erfolgreicher Anmeldung die Suche aktivieren
        if (isLoginSuccessful) {
            console.log(`retourenschein.html: Schutzpr√ºfung bestanden. ${kunden.length} Kunden geladen.`);

            // UI-Elemente aktivieren, die von den Daten abh√§ngen
            const kundenSucheInput = document.getElementById('kundenSuche');
            kundenSucheInput.disabled = false;
            kundenSucheInput.placeholder = "üîç Kunde, Firma, PLZ oder Ort suchen...";

            kundenSucheInput.focus();

            // Event-Listener f√ºr die Suche aktivieren
            initializeCustomerSearchListeners();
        }
        // Wenn die Anmeldung fehlschl√§gt, bleibt die Suche deaktiviert.

    } catch (error) {
        console.error("Ein schwerwiegender Fehler ist beim Seitenaufbau aufgetreten:", error);
        document.body.innerHTML = "<h2>Ein kritischer Fehler ist aufgetreten. Bitte laden Sie die Seite neu.</h2>";
    }
});


  </script>
    <section class="form-section-container" style="text-align: center; box-shadow: none; border: none; background: none;">
  <button onclick="generateRetourenscheinPDF()" class="btn btn-primary" style="padding: 15px 30px; font-size: 1.2rem;">
    PDF erzeugen
  </button>
</body>
</html>

