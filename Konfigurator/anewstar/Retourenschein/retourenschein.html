<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retourenschein PDF Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="retourenschein.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <!-- Stile für die Anwendung (übernommen von interneAnfrage.html ) -->
  <style>

    /* ===================================================================== */
    /* ===== FINALER, AUFGERÄUMTER & KONSISTENTER CSS-BLOCK (v9) ===== */
    /* ===================================================================== */

    /* --- 1. Grundlegende Layout-Stile (unverändert) --- */
    .search-highlight { background-color: rgba(0, 0, 0, 0.2); font-weight: bold; border-radius: 3px; padding: 0 2px; }
    .header-right .buttons { display: flex; gap: 10px; }
    .form-section-container { border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin: 25px auto; background-color: #fdfdfd; max-width: 900px; }
    .form-section-container h3 { text-align: center; margin-top: 0; margin-bottom: 25px; padding-bottom: 10px; color: #00a1e1; font-size: 1.3em; }
    .centered-form-layout { display: flex; flex-direction: column; align-items: center; gap: 15px; }
    .centered-form-layout > * { width: 100%; max-width: 500px; }

    /* --- 2. Suchergebnisse für Kunden (unverändert) --- */
    #suchErgebnisse { position: relative; width: 100%; max-width: 500px; margin-top: -10px; background-color: white; border: 1px solid #ddd; border-radius: 8px; z-index: 1000; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .ergebnis-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #eee; }
    .ergebnis-item:last-child { border-bottom: none; }
    .ergebnis-item.active, .ergebnis-item:hover { background-color: #46a1f0; }
    .ergebnis-item.no-results { cursor: default; color: #888; }
    .ergebnis-item.no-results:hover { background-color: white; }

    /* --- 2b. Kunden-Ergebnisse nach PLZ-Lookup --- */
    #kundenErgebnisse { display: none; position: relative; width: 100%; max-width: 500px; margin-top: -10px; background-color: white; border: 1px solid #ddd; border-radius: 8px; z-index: 1000; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

    /* --- 3. EINHEITLICHE STILE FÜR NORMALE EINGABEFELDER (text, tel, date) --- */
    .centered-form-layout input[type="text"],
    .centered-form-layout input[type="tel"],
    .centered-form-layout input[type="date"] {
        height: 45px;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 0 20px;
        font-size: 16px;
        box-sizing: border-box;
        transition: all 0.2s ease-in-out;
        width: 100%;
        max-width: 500px;
        font-family: 'Roboto', sans-serif;
        color: #333;
    }

    /* --- 4. DER "NUKLEARE RESET" FÜR SELECT2-DROPDOWNS --- */
    
    /* Schritt A: Select2-Standarddesign komplett entfernen */
    .select2-container--default .select2-selection--single {
        background-color: transparent !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        height: auto !important;
    }

/* Schritt B: Unser Design auf den äußeren Select2-Container anwenden (FINALE BREITEN-KORREKTUR) */
.centered-form-layout .select2-container {
    height: 45px; /* !important ist hier nicht mehr nötig */
    border-radius: 8px;
    border: 1px solid #ccc;
    padding: 0 20px;
    font-size: 16px;
    box-sizing: border-box; /* Wichtig! */
    transition: all 0.2s ease-in-out;
    width: 100%; /* Breite wird vom Elternelement gesteuert */
    max-width: 500px; /* Breite wird vom Elternelement gesteuert */
    font-family: 'Roboto', sans-serif;
    color: #333;
    display: flex;
    align-items: center;
    background-color: white;
    position: relative;
}


/* Schritt C: Den Text im Inneren sauber positionieren (FINALE VERSION) */
.centered-form-layout .select2-container .select2-selection__rendered {
    padding: 0 !important;
    color: #333 !important;
    margin-top: 1px; /* Ein winziger Pixel nach unten für die perfekte optische Mitte */
}


    /* Schritt D: Den Pfeil rechts positionieren */
    .centered-form-layout .select2-container--default .select2-selection__arrow {
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        height: auto !important;
        width: auto !important;
    }

/* ======================================================================== */
/* ===== FINAL: Hässlichen Standard-Fokus-Rahmen in Select2 entfernen (Aggressive Methode) ===== */
/* ======================================================================== */
.select2-container *:focus {
    outline: none !important;
}



/* --- 5. EINHEITLICHER FOKUS-EFFEKT FÜR ALLE FELDER (ROBUSTE VERSION) --- */
.centered-form-layout input[type="text"]:focus,
.centered-form-layout input[type="text"]:focus-visible, /* NEU */
.centered-form-layout input[type="tel"]:focus,
.centered-form-layout input[type="tel"]:focus-visible, /* NEU */
.centered-form-layout input[type="date"]:focus,
.centered-form-layout input[type="date"]:focus-visible, /* NEU */
.centered-form-layout .select2-container.select2-container--open,
.centered-form-layout .select2-container:focus-within {
    outline: none !important;
    border-color: #00a1e1 !important;
    box-shadow: 0 0 0 3px rgba(0, 161, 225, 0.25) !important;
}

    /* --- 6. STYLING FÜR DATUMSFELDER (VERHALTEN & ICON) --- */
    .centered-form-layout input[type="date"] {
        width: 100% !important;
        max-width: 200px !important;
        box-sizing: border-box;
        text-align: left;
        position: relative;
    }
    .centered-form-layout input[type="date"]::-webkit-calendar-picker-indicator {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        padding: 5px;
        cursor: pointer;
    }

    /* --- 7. SONSTIGE STILE (Trennlinie, Artikel-Dropdown etc.) --- */
    .form-divider {
        border: none;
        border-top: 1px solid #e0e0e0;
        margin: 15px 0;
    }
    .grund-steuerung .select2-container {
        width: 100% !important;
        max-width: 250px;
    }

    /* ======================================================================== */
/* ===== FINAL: Markenkonforme Farbe für markierten Text (Selection) ===== */
/* ======================================================================== */
::selection {
    background-color: #00a1e1; /* Unser schönes EWE-Blau */
    color: #ffffff;           /* Weißer Text für besten Kontrast */
}

    /* --- 8. MOBILE OPTIMIERUNG --- */
    @media (max-width: 768px) {
      .form-section-container {
        margin-left: 10px;
        margin-right: 10px;
      }
    }


  </style>
</head>
<body>
  <header id="header">
    <div class="header-left">
      <img src="https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png" alt="EWE Logo">
    </div>
    <div class="header-content">
      <h1>Retourenschein</h1>
      <div class="header-date" id="heute"></div>
    </div>
    <div class="header-right">
      <div class="buttons">
        <button onclick="window.close( )" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Zurück</button>
        <button onclick="generateRetourenscheinPDF()" class="btn btn-primary"><i class="bi bi-file-earmark-pdf"></i> PDF erzeugen</button>
      </div>
    </div>
  </header>

  <section class="form-section-container">
    <h3>Kundendaten</h3>
    <div id="kundenDetails" class="centered-form-layout">
      <input type="text" id="kundenSuche" placeholder="Firma oder Adresse suchen..." autocomplete="off">
      
      <input type="text" id="name" placeholder="Name" autocomplete="new-password">
      <div id="kundenErgebnisse"></div>
      <input type="text" id="firma" placeholder="Firma" autocomplete="new-password">
      <input type="text" id="strasse" placeholder="Straße" autocomplete="new-password">
      <input type="text" id="plz" placeholder="PLZ" autocomplete="new-password">
      <input type="text" id="ort" placeholder="Ort" autocomplete="new-password">
      <input type="text" id="land" placeholder="Land" autocomplete="new-password">
      <input type="text" id="email" placeholder="E-Mail" autocomplete="new-password">
      <input type="text" id="telefon" placeholder="Telefon" autocomplete="new-password">
      <input type="text" id="kundennummer" placeholder="Kundennummer (optional)" autocomplete="new-password">
      <button type="button" id="kundenSpeichernBtn" style="display:none; margin-top:6px; background:linear-gradient(135deg,#005A8C,#00a1e1); color:white; border:none; height:44px; border-radius:8px; font-family:'Roboto Condensed',sans-serif; font-size:0.9rem; font-weight:600; cursor:pointer; max-width:500px; width:100%;">
        <i class="bi bi-cloud-plus"></i> Neuen Kunden speichern
      </button>

    </div>
  </section>

<!-- ===== FINALE, EINHEITLICHE RETOURENDETAILS START ===== -->
<section class="form-section-container">
    <h3>Retourendetails</h3>
    <div id="retourenDetails" class="centered-form-layout">
      
      <!-- Dropdowns und Textfelder bleiben wie gehabt -->
      <select id="bearbeiterDropdown">
        <option value="">-- Bearbeiter auswählen --</option>
        <option value="Karsten Walter">Karsten Walter</option>
        <option value="Christian Künnecke">Christian Künnecke</option>
        <option value="Diana Kahlert">Diana Kahlert</option>
        <option value="Denise Otto">Denise Otto</option>
        <option value="Nadine Suhr">Nadine Suhr</option>
        <option value="Claudia Batke">Claudia Batke</option>
        <option value="Nils Vokuhl">Nils Vokuhl</option>
        <option value="Denny Altmann">Denny Altmann</option>
        <option value="Rafael Furtwängler">Rafael Furtwängler</option>
        <option value="Christof Münster">Christof Münster</option>
        <option value="Thorben Buttschaft">Thorben Buttschaft</option>
        <option value="Sascha Heusel">Sascha Heusel</option>
        <option value="Bernhard Kneissl">Bernhard Kneissl</option>
        <option value="Christopher-Sean Haus">Christopher-Sean Haus</option>
        <option value="Sascha Barkowsky">Sascha Barkowsky</option>
        <option value="Volker Kottwitz">Volker Kottwitz</option>
        <option value="Volker Oesterwind">Volker Oesterwind</option>
        <option value="Thomas Schönfüß">Thomas Schönfüß</option>
        <option value="Thomas Wendt">Thomas Wendt</option>
        <option value="Harald Natzke">Harald Natzke</option>
        <option value="Lukas Pfeil">Lukas Pfeil</option>
        <option value="Nancy Ullbricht">Nancy Ullbricht</option>
        <option value="Heiner Birkholz">Heiner Birkholz</option>
        <option value="Helmut Wölfel">Helmut Wölfel</option>
        <option value="Jan-Peter Ewe">Jan-Peter Ewe</option>
        <option value="manuell">-- Manuelle Eingabe --</option>
      </select>
      <input type="text" id="bearbeiterManuell" placeholder="Bearbeiter (manuell)" style="display: none;">
      
      <select id="anlieferungDropdown">
        <option value="">-- Anlieferung auswählen --</option>
        <option value="Selbstanlieferung">Selbstanlieferung</option>
        <option value="Paketlieferung">Paketlieferung</option>
        <option value="Speditionslieferung">Speditionslieferung</option>
        <option value="PKW Außendienst">PKW Außendienst</option>
        <option value="EWE-LKW">EWE-LKW</option>
        <option value="Paketdienst">Paketdienst</option>
        <option value="Spedition">Spedition</option>
        <option value="Sonstiges">Sonstiges</option>
      </select>
      <input type="text" id="anlieferungManuell" placeholder="Anlieferung (Freitext)" style="display: none;">

      <input type="text" id="auftragsnummer" placeholder="Auftragsnummer" autocomplete="new-password">
      <input type="text" id="rechnungsnummer" placeholder="Bezug zu Rechnungsnummer" autocomplete="new-password">
      <input type="text" id="reklamationsnummer" placeholder="Reklamationsnummer" autocomplete="new-password">

      <!-- ===== HIER KOMMT DIE NEUE TRENNLINIE ===== -->
      <hr class="form-divider">

      <!-- ===== FINALE, GEKLONTE & KORRIGIERTE DATUMSFELDER ===== -->
      <input type="text" id="abholdatum" placeholder="Abholdatum" 
             onfocus="this.type='date'" 
             onblur="formatDate(this, 'Abholdatum')">
      
      <input type="text" id="wareneingang_datum" placeholder="Wareneingangsdatum" 
             onfocus="this.type='date'" 
             onblur="formatDate(this, 'Wareneingangsdatum')">

    </div>
  </section>

  <!-- Der Rest des HTML bleibt unverändert -->
  <section id="artikelListe" class="search-container">
    <h3>Artikel zur Rücksendung</h3>
    <div id="artikelInhalt"></div>
  </section>
  <section id="manuelleArtikelSection" class="search-container">
    <h3>Artikel manuell hinzufügen</h3>
    <div id="manuelleArtikelContainer"></div>
    <div class="button-container">
      <button type="button" id="weiterenartikelBtn" class="btn btn-secondary">+ Weiteren Artikel hinzufügen</button>
      <button type="button" id="artikelHinzufuegenBtn" class="btn btn-primary">Artikel zur Liste hinzufügen</button>
    </div>
  </section>
  <section id="bemerkungenSection" class="search-container">
    <h3>Bemerkungen</h3>
    <textarea id="bemerkungen" placeholder="..."></textarea>
  </section>
  <section id="reklamationSection" class="search-container">
    <h3>Interne Vermerke</h3>
    <div class="reklamation-grid">
      <div class="reklamation-option">
        <input type="checkbox" id="checkReklamation">
        <label for="checkReklamation">Reklamation</label>
      </div>
      <div class="reklamation-option">
        <input type="checkbox" id="checkReparatur">
        <label for="checkReparatur">Reparatur - Kostenvoranschlag</label>
      </div>
      <div class="reklamation-option">
        <input type="checkbox" id="checkNeuware">
        <label for="checkNeuware">Neuware. Einlagern und zubuchen</label>
      </div>
      <div class="reklamation-option">
        <input type="checkbox" id="checkWeiterleitung">
        <label for="checkWeiterleitung">Weiterleitung an:</label>
      </div>
      <div class="reklamation-option">
        <input type="checkbox" id="checkRuecksendung">
        <label for="checkRuecksendung">Rücksendung an den Kunden</label>
      </div>
      <input type="text" id="weiterleitungAnName" placeholder="Name eintragen" style="display: none;">
    </div>
  </section>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <script>
    // Globale Kundendatenbank (aus verschluesselter CSV geladen)
    let kundenDatenbank = [];

    // Supabase-Client fuer Kunden-Speicherung
    const supabaseClient = window.supabase ? window.supabase.createClient(
      'https://majbsrgcrvlwjpzlalxf.supabase.co',
      'sb_publishable_lodqq8_fd-FOPy3g8dhOtw_ipkKLcut'
    ) : null;
    let supabaseKunden = [];

    // Referenzen auf die HTML-Elemente
    const inputs = {
      name: document.getElementById("name" ),
      firma: document.getElementById("firma"),
      telefon: document.getElementById("telefon"),
      email: document.getElementById("email"),
      strasse: document.getElementById("strasse"),
      ort: document.getElementById("ort"),
      plz: document.getElementById("plz"),
      land: document.getElementById("land")
    };
    const retourenInputs = {
      bearbeiter: document.getElementById("bearbeiterDropdown"),
      bearbeiterManuell: document.getElementById("bearbeiterManuell"),
      anlieferung: document.getElementById("anlieferungDropdown"),
      anlieferungManuell: document.getElementById("anlieferungManuell"),
      bemerkungen: document.getElementById("bemerkungen"), 
      checkReklamation: document.getElementById("checkReklamation"),
      checkNeuware: document.getElementById("checkNeuware"),
      checkRuecksendung: document.getElementById("checkRuecksendung"),
      checkReparatur: document.getElementById("checkReparatur"),
      checkWeiterleitung: document.getElementById("checkWeiterleitung"),
      weiterleitungAnName: document.getElementById("weiterleitungAnName")
    };


    // GOOGLE PLACES ADRESSSUCHE
    window.initGooglePlaces = function() {
      const input = document.getElementById('kundenSuche');
      const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['establishment'],
        componentRestrictions: { country: ['de', 'at', 'ch'] },
        fields: ['name', 'address_components']
      });
      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.address_components) return;
        document.getElementById('firma').value = place.name || '';
        let strasse = '', hausnummer = '', plz = '', ort = '', land = '';
        place.address_components.forEach(c => {
          if (c.types.includes('route')) strasse = c.long_name;
          if (c.types.includes('street_number')) hausnummer = c.long_name;
          if (c.types.includes('postal_code')) plz = c.long_name;
          if (c.types.includes('locality')) ort = c.long_name;
          if (c.types.includes('country')) land = c.long_name;
        });
        document.getElementById('strasse').value = hausnummer ? `${strasse} ${hausnummer}` : strasse;
        document.getElementById('plz').value = plz;
        document.getElementById('ort').value = ort;
        document.getElementById('land').value = land;
        input.value = '';
        if (kundenDatenbank.length > 0) showKundenByPLZ(plz);
      });
    };

// ========================================================================
// ===== PLZ-KUNDEN-LOOKUP (Envelope Encryption + Web Crypto API) =========
// ========================================================================

async function loadKundenDatenbank() {
    const password = localStorage.getItem('customerDataPassword') || sessionStorage.getItem('customerDataPassword');
    if (!password) {
        console.log('Kein Passwort gesetzt - Kunden-Lookup deaktiviert.');
        return;
    }

    try {
        // 1. keys.json laden
        const keysResponse = await fetch('keys.json');
        if (!keysResponse.ok) { console.log('keys.json nicht gefunden.'); return; }
        const keysData = await keysResponse.json();

        // 2. Master-Key mit User-Passwort entschluesseln
        let masterKeyRaw = null;
        for (const userEntry of keysData.users) {
            try {
                const salt = Uint8Array.from(atob(userEntry.salt), c => c.charCodeAt(0));
                const nonce = Uint8Array.from(atob(userEntry.nonce), c => c.charCodeAt(0));
                const encryptedKey = Uint8Array.from(atob(userEntry.key), c => c.charCodeAt(0));

                const keyMaterial = await crypto.subtle.importKey(
                    'raw', new TextEncoder().encode(password), 'PBKDF2', false, ['deriveKey']
                );
                const derivedKey = await crypto.subtle.deriveKey(
                    { name: 'PBKDF2', salt: salt, iterations: 480000, hash: 'SHA-256' },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 }, false, ['decrypt']
                );
                masterKeyRaw = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: nonce }, derivedKey, encryptedKey
                );
                console.log('Authentifiziert als: ' + userEntry.id);
                break;
            } catch (e) { continue; }
        }

        if (!masterKeyRaw) { console.log('Passwort stimmt mit keinem User ueberein.'); return; }

        // 3. namplzkdn.enc laden und mit Master-Key entschluesseln
        const encResponse = await fetch('namplzkdn.enc');
        if (!encResponse.ok) { console.log('namplzkdn.enc nicht gefunden.'); return; }
        const encData = await encResponse.arrayBuffer();

        const encNonce = encData.slice(0, 12);
        const ciphertext = encData.slice(12);

        const masterCryptoKey = await crypto.subtle.importKey(
            'raw', masterKeyRaw, { name: 'AES-GCM' }, false, ['decrypt']
        );
        const decrypted = await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv: encNonce }, masterCryptoKey, ciphertext
        );

        // 4. CSV parsen
        const csvText = new TextDecoder().decode(decrypted);
        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        kundenDatenbank = parsed.data;
        console.log(kundenDatenbank.length + ' Kunden geladen.');

    } catch (error) {
        console.log('Fehler beim Laden der Kundendatenbank:', error);
    }
}

async function showKundenByPLZ(plz) {
    const container = document.getElementById('kundenErgebnisse');
    if (!container) return;

    if (!plz || plz.length < 4) {
        container.innerHTML = '';
        container.style.display = 'none';
        updateSpeichernButton();
        return;
    }

    // 1. Treffer aus verschluesselter Datenbank
    const encTreffer = kundenDatenbank.filter(k => k.PLZ === plz);

    // 2. Treffer aus Supabase (async)
    supabaseKunden = await loadSupabaseKundenByPLZ(plz);

    if (encTreffer.length === 0 && supabaseKunden.length === 0) {
        container.innerHTML = '';
        container.style.display = 'none';
        updateSpeichernButton();
        return;
    }

    container.innerHTML = '';

    // Stammkunden anzeigen (Lock-Icon)
    encTreffer.forEach(kunde => {
        const div = document.createElement('div');
        div.className = 'ergebnis-item';
        div.innerHTML = '<i class="bi bi-lock" style="opacity:0.4; margin-right:6px;" title="Stammkunde"></i>' +
            kunde.Name + ' \u2014 ' + kunde.Kundennummer;
        div.addEventListener('click', () => {
            document.getElementById('name').value = kunde.Name;
            document.getElementById('kundennummer').value = kunde.Kundennummer;
            container.innerHTML = '';
            container.style.display = 'none';
            document.getElementById('kundenSpeichernBtn').style.display = 'none';
        });
        container.appendChild(div);
    });

    // Supabase-Kunden anzeigen (Cloud-Icon, blauer Rand, Loeschen-Button)
    supabaseKunden.forEach(kunde => {
        const div = document.createElement('div');
        div.className = 'ergebnis-item';
        div.style.borderLeft = '3px solid #00a1e1';
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        div.style.alignItems = 'center';

        const textSpan = document.createElement('span');
        textSpan.style.cursor = 'pointer';
        textSpan.style.flex = '1';
        textSpan.innerHTML = '<i class="bi bi-cloud" style="color:#00a1e1; margin-right:6px;" title="Gespeicherter Kunde"></i>' +
            (kunde.name || '') +
            (kunde.firma ? ' (' + kunde.firma + ')' : '') +
            (kunde.kundennummer ? ' \u2014 ' + kunde.kundennummer : '');
        textSpan.addEventListener('click', () => {
            document.getElementById('name').value = kunde.name || '';
            document.getElementById('firma').value = kunde.firma || '';
            document.getElementById('strasse').value = kunde.strasse || '';
            document.getElementById('plz').value = kunde.plz || '';
            document.getElementById('ort').value = kunde.ort || '';
            document.getElementById('land').value = kunde.land || '';
            document.getElementById('email').value = kunde.email || '';
            document.getElementById('telefon').value = kunde.telefon || '';
            document.getElementById('kundennummer').value = kunde.kundennummer || '';
            container.innerHTML = '';
            container.style.display = 'none';
            document.getElementById('kundenSpeichernBtn').style.display = 'none';
        });
        div.appendChild(textSpan);

        const delBtn = document.createElement('button');
        delBtn.innerHTML = '<i class="bi bi-x"></i>';
        delBtn.title = 'Kunde loeschen';
        delBtn.style.cssText = 'background:none; border:none; color:#999; cursor:pointer; padding:4px 8px; font-size:1rem;';
        delBtn.addEventListener('mouseenter', () => { delBtn.style.color = '#dc3545'; });
        delBtn.addEventListener('mouseleave', () => { delBtn.style.color = '#999'; });
        delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteSupabaseKunde(kunde.id);
        });
        div.appendChild(delBtn);

        container.appendChild(div);
    });

    container.style.display = 'block';
    updateSpeichernButton();
}

// Supabase-Kunden nach PLZ laden
async function loadSupabaseKundenByPLZ(plz) {
    if (!supabaseClient || !plz || plz.length < 4) return [];
    try {
        const { data, error } = await supabaseClient
            .from('kunden')
            .select('*')
            .eq('plz', plz.trim());
        if (error) { console.error('Supabase-Fehler:', error.message); return []; }
        return data || [];
    } catch (err) {
        console.error('Supabase-Verbindungsfehler:', err);
        return [];
    }
}

// Neuen Kunden in Supabase speichern
async function saveKundeToSupabase() {
    if (!supabaseClient) {
        zeigeToast('<i class="bi bi-x-circle"></i> Supabase nicht verfuegbar.', 'undo');
        return;
    }
    const name = document.getElementById('name').value.trim();
    const plz = document.getElementById('plz').value.trim();
    if (!name || !plz) {
        zeigeToast('<i class="bi bi-exclamation-triangle"></i> Bitte Name und PLZ eingeben.', 'info');
        return;
    }

    const kundeData = {
        name: name,
        firma: document.getElementById('firma').value.trim() || null,
        strasse: document.getElementById('strasse').value.trim() || null,
        plz: plz,
        ort: document.getElementById('ort').value.trim() || null,
        land: document.getElementById('land').value.trim() || 'Deutschland',
        email: document.getElementById('email').value.trim() || null,
        telefon: document.getElementById('telefon').value.trim() || null,
        kundennummer: document.getElementById('kundennummer').value.trim() || null
    };

    try {
        const { data, error } = await supabaseClient
            .from('kunden')
            .insert(kundeData)
            .select();

        if (error) {
            if (error.code === '23505') {
                zeigeToast('<i class="bi bi-info-circle"></i> Dieser Kunde existiert bereits.', 'success');
            } else {
                console.error('Supabase-Speicherfehler:', error);
                zeigeToast('<i class="bi bi-x-circle"></i> Fehler: ' + error.message, 'undo');
            }
            return;
        }

        zeigeToast('<i class="bi bi-check-circle"></i> Kunde gespeichert!', 'success');
        document.getElementById('kundenSpeichernBtn').style.display = 'none';
    } catch (err) {
        console.error('Speicherfehler:', err);
        zeigeToast('<i class="bi bi-x-circle"></i> Verbindungsfehler.', 'undo');
    }
}

// Supabase-Kunden loeschen
async function deleteSupabaseKunde(id) {
    if (!supabaseClient) return;
    try {
        const { error } = await supabaseClient.from('kunden').delete().eq('id', id);
        if (error) {
            zeigeToast('<i class="bi bi-x-circle"></i> Fehler beim Loeschen.', 'undo');
            return;
        }
        supabaseKunden = supabaseKunden.filter(k => k.id !== id);
        const plz = document.getElementById('plz').value.trim();
        if (plz) showKundenByPLZ(plz);
        zeigeToast('<i class="bi bi-trash"></i> Kunde geloescht.', 'undo');
    } catch (err) {
        console.error('Loeschfehler:', err);
    }
}

// Speichern-Button anzeigen wenn Name + PLZ vorhanden
function updateSpeichernButton() {
    const btn = document.getElementById('kundenSpeichernBtn');
    if (!btn || !supabaseClient) return;
    const name = document.getElementById('name').value.trim();
    const plz = document.getElementById('plz').value.trim();
    btn.style.display = (name && plz) ? 'block' : 'none';
}

// Dropdown schliessen bei Klick ausserhalb
document.addEventListener('click', function(e) {
    const container = document.getElementById('kundenErgebnisse');
    if (container && !container.contains(e.target) && e.target.id !== 'plz' && e.target.id !== 'kundennummer') {
        container.innerHTML = '';
        container.style.display = 'none';
    }
});



    // Initialisierung der anderen Dropdowns
    $(document).ready(function() {
        $('#bearbeiterDropdown').select2({ placeholder: "-- Bearbeiter auswählen --", allowClear: true });
        $('#anlieferungDropdown').select2({ placeholder: "-- Anlieferung auswählen --", allowClear: true });
    });

    // Event-Listener für Bearbeiter-Dropdown
    $('#bearbeiterDropdown').on('change', function () {
      const selectedValue = this.value;
      const manuellesEingabefeld = retourenInputs.bearbeiterManuell;
      if (selectedValue === "manuell") {
        manuellesEingabefeld.style.display = "block";
        manuellesEingabefeld.focus();
      } else {
        manuellesEingabefeld.style.display = "none";
        manuellesEingabefeld.value = "";
      }
    });

    // Event-Listener für Anlieferung-Dropdown
    $('#anlieferungDropdown').on('change', function () {
      const selectedValue = this.value;
      const manuellesEingabefeld = retourenInputs.anlieferungManuell;
      if (selectedValue === "Sonstiges") {
        manuellesEingabefeld.style.display = "block";
        manuellesEingabefeld.focus();
      } else {
        manuellesEingabefeld.style.display = "none";
        manuellesEingabefeld.value = "";
      }
    });

// ========================================================================
// ===== NEU: Funktion zur Formatierung des Datums nach der Auswahl =====
// ========================================================================

function formatDate(inputElement, labelText) {
  // Zuerst den Typ auf Text zurücksetzen, damit wir den Wert manipulieren können
  inputElement.type = 'text';
  
  const isoDate = inputElement.value; // z.B. "2025-10-09"
  
  // Nur formatieren, wenn ein gültiges Datum im ISO-Format vorhanden ist
  if (isoDate && isoDate.includes('-')) {
    const parts = isoDate.split('-'); // Ergibt: ["2025", "10", "09"]
    const year = parts[0];
    const month = parts[1];
    const day = parts[2];
    
    // Das gewünschte Format "Label: TT.MM.JJJJ" erstellen und ins Feld schreiben
    // Wir verwenden absichtlich den 'labelText' und nicht den 'placeholder',
    // da der placeholder verschwindet, sobald ein Wert im Feld steht.
    inputElement.value = `${labelText}: ${day}.${month}.${year}`;
  } else {
    // Wenn kein Datum ausgewählt wurde oder der Wert ungültig ist,
    // leeren wir das Feld, damit der ursprüngliche Platzhalter wieder sichtbar wird.
    inputElement.value = ''; 
  }
}

// ========================================================================
// ===== NEU: Hilfsfunktion zum Erzeugen des heutigen Datums im TT.MM.JJJJ-Format =====
// ========================================================================
function getTodayGermanDate() {
  const today = new Date();
  const day = String(today.getDate()).padStart(2, '0'); // Stellt sicher, dass der Tag zweistellig ist (z.B. 09)
  const month = String(today.getMonth() + 1).padStart(2, '0'); // Monat ist 0-basiert, daher +1. Auch zweistellig.
  const year = today.getFullYear();
  return `${day}.${month}.${year}`; // Gibt z.B. "09.10.2025" zurück
}

    // Merkliste aus localStorage laden
    function ladeMerklisteAusLocalStorage() {
      try {
        const merklisteData = localStorage.getItem('merklisteForRetourenschein');
        if (merklisteData) {
          const merkliste = JSON.parse(merklisteData);
          
          // Merkliste als globale Variable setzen
          window.merklisteItems = merkliste.map(item => ({
            nummer: item.nummer || item.artikelnummer || '',
            name: item.name || item.bezeichnung || 'Unbekannter Artikel',
            bezeichnung: item.name || item.bezeichnung || 'Unbekannter Artikel',
            artikelnummer: item.nummer || item.artikelnummer || '',
            menge: item.menge || 1,
            preis: item.preis || '0,00 €'
          }));
          
          // Artikel-Liste sofort aktualisieren
          updateArtikelListe();
          
          // LocalStorage nach dem Laden löschen (optional)
          localStorage.removeItem('merklisteForRetourenschein');
          
          console.log('Merkliste erfolgreich geladen:', merkliste.length, 'Artikel');
        }
      } catch (error) {
        console.error('Fehler beim Laden der Merkliste:', error);
      }
    }

    // NEU: Event-Listener für die "Weiterleitung an"-Checkbox
    retourenInputs.checkWeiterleitung.addEventListener('change', function() {
      if (this.checked) {
        retourenInputs.weiterleitungAnName.style.display = 'block';
        retourenInputs.weiterleitungAnName.focus();
      } else {
        retourenInputs.weiterleitungAnName.style.display = 'none';
        retourenInputs.weiterleitungAnName.value = ''; // Feld leeren, wenn Checkbox deaktiviert wird
      }
    });

    // Toast-Nachricht anzeigen
    function zeigeToast(text, type) {
      const old = document.getElementById('toast-nachricht');
      if (old) old.remove();
      const toast = document.createElement('div');
      toast.id = 'toast-nachricht';
      const bg = type === 'success' ? 'linear-gradient(135deg,#005A8C,#00a1e1)'
               : type === 'undo'    ? 'linear-gradient(135deg,#c62828,#e53935)'
               : 'linear-gradient(135deg,#005A8C,#00a1e1)';
      toast.style.cssText = `position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:${bg}; color:white; padding:10px 22px; border-radius:8px; font-family:'Roboto Condensed',sans-serif; font-size:0.9rem; font-weight:600; box-shadow:0 4px 16px rgba(0,0,0,0.2); z-index:10000; display:flex; align-items:center; gap:12px; animation:toastIn 0.3s ease;`;
      toast.innerHTML = text;
      document.body.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s ease'; setTimeout(() => toast.remove(), 300); }, 3000);
    }

    // Funktion zum Entfernen eines Artikels (mit Undo)
    function removeArtikel(index) {
      const entfernterArtikel = window.merklisteItems[index];
      const name = entfernterArtikel.name || entfernterArtikel.bezeichnung || 'Artikel';
      window.merklisteItems.splice(index, 1);
      updateArtikelListe();
      zeigeToast(`<i class="bi bi-trash"></i> ${name} entfernt <button onclick="undoRemoveArtikel(${index}, ${JSON.stringify(JSON.stringify(entfernterArtikel))})" style="background:rgba(255,255,255,0.25); border:none; color:white; border-radius:6px; padding:4px 10px; cursor:pointer; font-size:0.8rem; font-family:'Roboto Condensed',sans-serif; margin-left:4px;">Rückgängig</button>`, 'undo');
    }

    function undoRemoveArtikel(index, artikelJson) {
      const artikel = JSON.parse(artikelJson);
      window.merklisteItems.splice(index, 0, artikel);
      updateArtikelListe();
      const old = document.getElementById('toast-nachricht');
      if (old) old.remove();
      zeigeToast('<i class="bi bi-arrow-counterclockwise"></i> Artikel wiederhergestellt', 'success');
    }

    // Merkliste-Artikel anzeigen (falls vorhanden) - VERBESSERTE VERSION
    function updateArtikelListe() {
      const artikelInhalt = document.getElementById("artikelInhalt");
      
      // Prüfen, ob window.merklisteItems existiert und Artikel vorhanden sind
      if (window.merklisteItems && window.merklisteItems.length > 0) {
        // Artikel-Karten erstellen (neues Design)
        let cardsHtml = '<div class="artikel-karten-container">';
        
        window.merklisteItems.forEach((artikel, index) => {
          cardsHtml += `
            <div class="artikel-karte">
              <div class="artikel-info">
                <div class="artikel-name">${artikel.name || artikel.bezeichnung || 'Unbekannter Artikel'}</div>
                <div class="artikel-details">
                  <p><strong>Artikelnummer:</strong> ${artikel.nummer || artikel.artikelnummer || 'N/A'}</p>
                  <p><strong>Preis:</strong> ${artikel.preis || '0,00 €'}</p>
                </div>
              </div>
              <div class="artikel-aktionen">
                <div class="mengen-steuerung">
                  <label for="menge_${index}">Menge:</label>
                  <input type="number" id="menge_${index}" class="quantity-input" min="1" value="${artikel.menge || 1}">
                </div>
                <div class="grund-steuerung">
                  <label for="grund_${index}">Retourengrund:</label>
                  <select id="grund_${index}" class="artikel-grund">
                    <option value="">-- Grund auswählen --</option>
                    <option value="Artikel passt nicht / falsche Größe">Artikel passt nicht / falsche Größe</option>
                    <option value="Artikel gefällt nicht">Artikel gefällt nicht</option>
                    <option value="Artikel beschädigt / defekt">Artikel beschädigt / defekt</option>
                    <option value="Falscher Artikel geliefert">Falscher Artikel geliefert</option>
                    <option value="Doppelt bestellt">Doppelt bestellt</option>
                    <option value="Neuware / Einlagern">Neuware / Einlagern</option>
                    <option value="Sonstiges">Sonstiges</option>
                  </select>
                </div>
                <button class="entfernen-btn" onclick="removeArtikel(${index})" title="Artikel entfernen">
                  <i class="bi bi-trash"></i> Entfernen
                </button>
              </div>
            </div>`;
        });
        
        cardsHtml += '</div>';
        artikelInhalt.innerHTML = cardsHtml;

        // Event-Listener für Mengen-Änderungen hinzufügen
        window.merklisteItems.forEach((artikel, index) => {
          const mengeInput = document.getElementById(`menge_${index}`);
          if (mengeInput) {
            mengeInput.addEventListener('input', function() {
              window.merklisteItems[index].menge = parseInt(this.value) || 1;
            });
          }
        });

        // Select2 auf die neu erstellten Dropdowns anwenden
        $('.artikel-grund').select2({
            placeholder: "-- Grund auswählen --",
            allowClear: true,
            minimumResultsForSearch: Infinity // Versteckt das Suchfeld
        });

      } else {
        // Keine Artikel vorhanden
        artikelInhalt.innerHTML = '<div class="empty-state">Keine Artikel in der Merkliste gefunden. Sie können unten manuell Artikel hinzufügen.</div>';
      }
    }

    // NEU: Einzelnes manuelles Eingabefeld erstellen
    function createManuelleArtikelField(index) {
      return `
        <div class="manueller-artikel" id="manuellerArtikel_${index}">
          <div class="artikel-header">
            <h4>Artikel ${index + 1}</h4>
            ${index > 0 ? `<button type="button" class="remove-artikel-btn" onclick="removeManuelleArtikelField(${index})">✕</button>` : ''}
          </div>
          <div class="artikel-eingabe-grid">
            <div class="eingabe-feld">
              <label for="manuellerName_${index}">Artikelname:</label>
              <input type="text" id="manuellerName_${index}" placeholder="Artikelname eingeben">
            </div>
            <div class="eingabe-feld">
              <label for="manuelleNummer_${index}">Artikelnummer:</label>
              <input type="text" id="manuelleNummer_${index}" placeholder="Artikelnummer eingeben">
            </div>
            <div class="eingabe-feld">
              <label for="manuelleMenge_${index}">Stückzahl:</label>
              <input type="number" id="manuelleMenge_${index}" min="1" value="1">
            </div>
            <div class="eingabe-feld">
              <label for="manuellerGrund_${index}">Rückgabegrund:</label>
              <select id="manuellerGrund_${index}" class="artikel-grund">
                <option value="">-- Grund auswählen --</option>
                <option value="Artikel passt nicht / falsche Größe">Artikel passt nicht / falsche Größe</option>
                <option value="Artikel gefällt nicht">Artikel gefällt nicht</option>
                <option value="Artikel beschädigt / defekt">Artikel beschädigt / defekt</option>
                <option value="Falscher Artikel geliefert">Falscher Artikel geliefert</option>
                <option value="Doppelt bestellt">Doppelt bestellt</option>
                <option value="Neuware / Einlagern">Neuware / Einlagern</option>
                <option value="Sonstiges">Sonstiges</option>
              </select>
            </div>
          </div>
        </div>`;
    }

    // NEU: Manuelle Artikel-Eingabe initialisieren (immer sichtbar)
    function initManuelleArtikelEingabe() {
      const manuelleArtikelContainer = document.getElementById("manuelleArtikelContainer");
      
      // Erstes Eingabefeld erstellen
      manuelleArtikelCounter = 1;
      manuelleArtikelContainer.innerHTML = createManuelleArtikelField(0);
      
      // Select2 auf das erste Dropdown anwenden
      $(`#manuellerGrund_0`).select2({
          placeholder: "-- Grund auswählen --",
          allowClear: true,
          minimumResultsForSearch: Infinity
      });
    }

    // NEU: Weiteres manuelles Eingabefeld hinzufügen
    function addManuelleArtikelField() {
      const manuelleArtikelContainer = document.getElementById("manuelleArtikelContainer");
      
      // Neues Feld hinzufügen
      const newFieldHtml = createManuelleArtikelField(manuelleArtikelCounter);
      manuelleArtikelContainer.insertAdjacentHTML('beforeend', newFieldHtml);
      
      // Select2 auf das neue Dropdown anwenden
      $(`#manuellerGrund_${manuelleArtikelCounter}`).select2({
          placeholder: "-- Grund auswählen --",
          allowClear: true,
          minimumResultsForSearch: Infinity
      });
      
      manuelleArtikelCounter++;
    }

    // NEU: Manuelles Eingabefeld entfernen
    function removeManuelleArtikelField(index) {
      const fieldToRemove = document.getElementById(`manuellerArtikel_${index}`);
      if (fieldToRemove) {
        fieldToRemove.remove();
        
        // Nummerierung der verbleibenden Felder aktualisieren
        updateManuelleArtikelNummering();
      }
    }

    // NEU: Nummerierung der manuellen Artikel aktualisieren
    function updateManuelleArtikelNummering() {
      const manuelleArtikel = document.querySelectorAll('.manueller-artikel');
      manuelleArtikel.forEach((artikel, index) => {
        const header = artikel.querySelector('h4');
        if (header) {
          header.textContent = `Artikel ${index + 1}`;
        }
      });
    }

    // NEU: Manuell hinzugefügte Artikel zur Merkliste hinzufügen
    function addManuelleArtikel() {
      if (!window.merklisteItems) {
        window.merklisteItems = [];
      }
      
      let hinzugefuegt = 0;
      const manuelleArtikel = document.querySelectorAll('.manueller-artikel');
      
      manuelleArtikel.forEach((artikel, index) => {
        const nameInput = artikel.querySelector(`input[id*="manuellerName"]`);
        const nummerInput = artikel.querySelector(`input[id*="manuelleNummer"]`);
        const mengeInput = artikel.querySelector(`input[id*="manuelleMenge"]`);
        const grundSelect = artikel.querySelector(`select[id*="manuellerGrund"]`);
        
        if (nameInput && nummerInput && mengeInput && grundSelect) {
          const name = nameInput.value.trim();
          const nummer = nummerInput.value.trim();
          const menge = parseInt(mengeInput.value) || 1;
          const grund = grundSelect.value;
          
          // Nur hinzufügen, wenn mindestens Name oder Nummer ausgefüllt ist
          if (name || nummer) {
            const neuerArtikel = {
              name: name || 'Manuell hinzugefügter Artikel',
              nummer: nummer || 'N/A',
              bezeichnung: name || 'Manuell hinzugefügter Artikel',
              artikelnummer: nummer || 'N/A',
              menge: menge,
              preis: '0,00 €',
              grund: grund
            };
            
            window.merklisteItems.push(neuerArtikel);
            hinzugefuegt++;
            
            // Felder nach dem Hinzufügen leeren
            nameInput.value = '';
            nummerInput.value = '';
            mengeInput.value = '1';
            $(grundSelect).val('').trigger('change');
          }
        }
      });
      
if (hinzugefuegt > 0) {
    updateArtikelListe();
    // alert(`${hinzugefuegt} Artikel wurden zur Liste hinzugefügt.`); // <-- Auskommentiert oder gelöscht
} else {
    alert('Bitte füllen Sie mindestens den Namen oder die Artikelnummer für einen Artikel aus.');
}
    }

    // Event-Listener für die Buttons
    document.getElementById('weiterenartikelBtn').addEventListener('click', addManuelleArtikelField);
    document.getElementById('artikelHinzufuegenBtn').addEventListener('click', addManuelleArtikel);

    // Heutiges Datum setzen
    document.getElementById("heute").textContent = new Date().toLocaleDateString('de-DE');

// PDF-Generierungsfunktion (erweitert)
/**
 * Erzeugt einen Retourenschein im EWE-Design als PDF.
 * Finale, polierte Version mit allen Detail-Korrekturen.
 *
 * ANLEITUNG:
 * 1. Ersetzen Sie die alte `generateRetourenscheinPDF`-Funktion durch diese.
 * 2. Passen Sie die `logoUrl`-Variable an, sodass sie auf Ihr Logo zeigt.
 */



// ========================================================================
// ===== NEU: Funktion zum Wiederherstellen der Formulardaten (Schritt 2) =====
// ========================================================================
function restoreFormData() {
    try {
        const savedDataJSON = localStorage.getItem('retourenscheinFormData');
        if (!savedDataJSON) return; // Keine Daten gefunden, nichts tun.

        const savedData = JSON.parse(savedDataJSON);

        // Kundendaten wiederherstellen
        document.getElementById('name').value = savedData.name || '';
        document.getElementById('firma').value = savedData.firma || '';
        document.getElementById('strasse').value = savedData.strasse || '';
        document.getElementById('plz').value = savedData.plz || '';
        document.getElementById('ort').value = savedData.ort || '';
        document.getElementById('land').value = savedData.land || '';
        document.getElementById('email').value = savedData.email || '';
        document.getElementById('telefon').value = savedData.telefon || '';
        document.getElementById('kundennummer').value = savedData.kundennummer || '';

        // Retourendetails wiederherstellen (inkl. Select2-Dropdowns)
        $('#bearbeiterDropdown').val(savedData.bearbeiter).trigger('change');
        document.getElementById('bearbeiterManuell').value = savedData.bearbeiterManuell || '';
        $('#anlieferungDropdown').val(savedData.anlieferung).trigger('change');
        document.getElementById('anlieferungManuell').value = savedData.anlieferungManuell || '';
        document.getElementById('auftragsnummer').value = savedData.auftragsnummer || '';
        document.getElementById('rechnungsnummer').value = savedData.rechnungsnummer || '';
        document.getElementById('reklamationsnummer').value = savedData.reklamationsnummer || '';
        document.getElementById('abholdatum').value = savedData.abholdatum || '';
        document.getElementById('wareneingang_datum').value = savedData.wareneingang_datum || '';

        // Artikel wiederherstellen und die Liste neu zeichnen
        window.merklisteItems = savedData.artikel || [];
        updateArtikelListe(); // Diese Funktion existiert bereits und zeichnet die Artikelliste

        // Bemerkungen & Interne Vermerke (Checkboxes)
        document.getElementById('bemerkungen').value = savedData.bemerkungen || '';
        document.getElementById('checkReklamation').checked = savedData.checkReklamation;
        document.getElementById('checkReparatur').checked = savedData.checkReparatur;
        document.getElementById('checkNeuware').checked = savedData.checkNeuware;
        document.getElementById('checkWeiterleitung').checked = savedData.checkWeiterleitung;
        document.getElementById('weiterleitungAnName').value = savedData.weiterleitungAnName || '';
        document.getElementById('checkRuecksendung').checked = savedData.checkRuecksendung;
        
        // Wichtig: Sichtbarkeit der manuellen Felder korrekt setzen, falls nötig
        if (savedData.bearbeiter === 'manuell') {
            document.getElementById('bearbeiterManuell').style.display = 'block';
        }
        if (savedData.anlieferung === 'Sonstiges') {
            document.getElementById('anlieferungManuell').style.display = 'block';
        }
        if (savedData.checkWeiterleitung) {
            document.getElementById('weiterleitungAnName').style.display = 'block';
        }

        // Nach erfolgreicher Wiederherstellung die Daten löschen
        localStorage.removeItem('retourenscheinFormData');
        
        console.log("Formulardaten erfolgreich aus dem localStorage wiederhergestellt.");

    } catch (error) {
        console.error("Fehler beim Wiederherstellen der Formulardaten:", error);
        localStorage.removeItem('retourenscheinFormData');
    }
}



async function generateRetourenscheinPDF() {
        // ========================================================================
    // ===== DATEN IM LOCALSTORAGE SPEICHERN =====
    // ========================================================================
    try {
        const formData = {
            // Kundendaten
            name: document.getElementById('name').value,
            firma: document.getElementById('firma').value,
            strasse: document.getElementById('strasse').value,
            plz: document.getElementById('plz').value,
            ort: document.getElementById('ort').value,
            land: document.getElementById('land').value,
            email: document.getElementById('email').value,
            telefon: document.getElementById('telefon').value,
            kundennummer: document.getElementById('kundennummer').value,

            // Retourendetails (mit jQuery für Select2)
            bearbeiter: $('#bearbeiterDropdown').val(),
            bearbeiterManuell: document.getElementById('bearbeiterManuell').value,
            anlieferung: $('#anlieferungDropdown').val(),
            anlieferungManuell: document.getElementById('anlieferungManuell').value,
            auftragsnummer: document.getElementById('auftragsnummer').value,
            rechnungsnummer: document.getElementById('rechnungsnummer').value,
            reklamationsnummer: document.getElementById('reklamationsnummer').value,
            abholdatum: document.getElementById('abholdatum').value,
            wareneingang_datum: document.getElementById('wareneingang_datum').value,

            // Artikel (die globale Variable sichern)
            artikel: window.merklisteItems || [],

            // Bemerkungen & Interne Vermerke
            bemerkungen: document.getElementById('bemerkungen').value,
            checkReklamation: document.getElementById('checkReklamation').checked,
            checkReparatur: document.getElementById('checkReparatur').checked,
            checkNeuware: document.getElementById('checkNeuware').checked,
            checkWeiterleitung: document.getElementById('checkWeiterleitung').checked,
            weiterleitungAnName: document.getElementById('weiterleitungAnName').value,
            checkRuecksendung: document.getElementById('checkRuecksendung').checked
        };
        localStorage.setItem('retourenscheinFormData', JSON.stringify(formData));
        console.log('Formulardaten erfolgreich im localStorage gesichert.');
    } catch (error) {
        console.error("Fehler beim Sichern der Formulardaten:", error);
    }
    // ========================================================================
    // ===== ENDE DES SPEICHER-BLOCKS =====
    // ========================================================================

  
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    // --- Hilfsfunktion zum Laden eines Bildes ---
    const loadImage = (url) => new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = () => resolve(img);
        img.onerror = (err) => reject(err);
        img.src = url;
    });

    // --- Globale Einstellungen ---
    const page_margin = 5;
    const page_width = doc.internal.pageSize.getWidth();
    const content_width = page_width - (2 * page_margin);
    const fieldBackgroundColor = [230, 245, 255];

    // --- Hilfsfunktionen zum Zeichnen ---
    const drawTextField = (x, y, label, value, width = 85, height = 6, useBgColor = true, lineHeightFactor = 1.15) => {
        if (useBgColor) {
            doc.setFillColor(...fieldBackgroundColor).rect(x, y + 1, width, height, 'F');
        }
        doc.setFontSize(7).setFont("helvetica", "bold").text(label, x, y);
        doc.setFont("helvetica", "normal").setFontSize(10);
        const textY = y + 5.5;
        doc.text(value || '', x + 1, textY, { maxWidth: width - 2, lineHeightFactor: lineHeightFactor });
        doc.setDrawColor(0).line(x, y + height + 1, x + width, y + height + 1);
    };

    const drawCheckBox = (x, y, label) => {
        doc.setFontSize(10).setFont("helvetica", "normal");
        doc.rect(x, y, 4, 4);
        doc.text(label, x + 6, y + 3.5);
    };

    // ========================================================================
    // ===== DATEN FÜR PDF SAMMELN (ROBUSTE VERSION) =====
    // ========================================================================

    // Hilfsfunktion, um das Datum sicher zu extrahieren und zu formatieren
    const getFormattedDate = (elementId) => {
        const input = document.getElementById(elementId);
        if (!input || !input.value) return '';
        
        // Prüft, ob das Datum bereits im Anzeigeformat "Label: TT.MM.JJJJ" vorliegt
        if (input.value.includes(':')) {
            return input.value.split(': ')[1]; // Extrahiert "TT.MM.JJJJ"
        }
        // Falls das Feld noch im `type="date"`-Zustand ist, wird der ISO-Wert formatiert
        if (input.value.includes('-')) {
            const parts = input.value.split('-');
            return `${parts[2]}.${parts[1]}.${parts[0]}`;
        }
        return ''; // Fallback
    };
    
    // Alle Werte sicher auslesen
    const abholDatumValue = getFormattedDate("abholdatum");
    const wareneingangsdatumValue = getFormattedDate("wareneingang_datum");
    const auftragsnummerValue = document.getElementById("auftragsnummer").value;
    const reklamationsnummerValue = document.getElementById("reklamationsnummer").value;
    const rechnungsnummerValue = document.getElementById("rechnungsnummer").value;
    const kundennummerValue = document.getElementById("kundennummer").value;
    const bearbeiterWert = retourenInputs.bearbeiter.value === "manuell"
        ? retourenInputs.bearbeiterManuell.value
        : retourenInputs.bearbeiter.value;
    const anlieferungWert = retourenInputs.anlieferung.value === "Sonstiges"
        ? retourenInputs.anlieferungManuell.value
        : retourenInputs.anlieferung.value;

    // --- 1. Header ---
    let y = page_margin;
    const logoUrl = 'https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png';
    let logoHeight = 15;
    try {
        const logoImg = await loadImage(logoUrl );
        const logoWidth = 40;
        logoHeight = logoWidth * (logoImg.height / logoImg.width);
        doc.addImage(logoImg, 'PNG', page_width - page_margin - logoWidth, y, logoWidth, logoHeight);
    } catch (error) {
        console.error("Fehler beim Laden des Logos:", error);
        doc.setFontSize(16).setFont("helvetica", "bold").text("EWE ARMATUREN", page_width - page_margin - 50, y + 5);
    }

    doc.setFontSize(30).setFont("helvetica", "bold").text("Retourenschein", page_margin, y + 25);
    const introTextY = Math.max(y + 10, y + logoHeight + 3);
    doc.setFontSize(9).setFont("helvetica", "normal").text("Bitte Retourenschein ausfüllen, als Begleitdokument der Ware beilegen und per E-Mail an den zuständigen EWE-Innendienst schicken.", page_margin, introTextY, { maxWidth: content_width });
    y = introTextY + 5;

    // --- 2. Kunden- und Auftragsdaten ---
    doc.setFontSize(10).setFont("helvetica", "bold").text("Kundenangaben", page_margin + 2, y + 5);
    y += 7;
    const kundenBoxY = y;
    const kundenBoxHeight = 58;
    doc.rect(page_margin, kundenBoxY, content_width, kundenBoxHeight-1);
    const today = new Date().toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
    
    drawTextField(page_margin + 5, kundenBoxY + 5, "Firma", inputs.firma.value, 90, 12); 
            // NEU: Ansprechpartner mit E-Mail und Telefonnummer zusammenführen
        let ansprechpartnerValue = inputs.name.value;
        
        // E-Mail und Telefonnummer auf eine Zeile mit Komma-Trennung
        let contactInfo = [];
        if (inputs.email.value) {
            contactInfo.push(inputs.email.value);
        }
        if (inputs.telefon.value) {
            contactInfo.push(inputs.telefon.value);
        }
        
        if (contactInfo.length > 0) {
            ansprechpartnerValue += "\n" + contactInfo.join(", ");
        }
        
        // NEU: Feld für Ansprechpartner vergrößern (height=12) und lineHeightFactor anpassen
        drawTextField(page_width / 2 + 5, kundenBoxY + 5, "Ansprechpartner", ansprechpartnerValue, 90, 12, true, 1.25);
    drawTextField(page_width / 2 + 5, kundenBoxY + 20.5, "Datum", today, 90);
    drawTextField(page_width / 2 + 5, kundenBoxY + 30, "Bearbeiter", bearbeiterWert, 90);
    drawTextField(page_margin + 5, kundenBoxY + 20.5, "Adresse", inputs.strasse.value, 90);
    drawTextField(page_margin + 5, kundenBoxY + 30, "PLZ / Ort", `${inputs.plz.value} ${inputs.ort.value}`, 90);
    const separatorY = kundenBoxY + 42;
    doc.line(page_margin, separatorY-2, page_width - page_margin, separatorY-2);
    drawTextField(page_margin + 5, separatorY + 3, "Anlieferung", anlieferungWert, 90);
    drawTextField(page_width / 2 + 5, separatorY + 3, "Abholung Datum", abholDatumValue, 90); // <-- KORRIGIERT
    y = kundenBoxY + kundenBoxHeight;

    // --- 3. Artikeltabelle (unverändert) ---
    // ... (Ihr Code für die Artikeltabelle bleibt hier)
    y += 3;
    doc.setFontSize(9).setFont("helvetica", "bold").text("Bitte beachten Sie, dass die Ware ordnungsgemäß sowie transportgerecht zur Abholung verpackt werden muss!", page_margin + 2, y + 5);
    y += 5;
    const tableStartY = y;
    const rowHeight = 10, maxRows = 5, tableHeaderHeight = 7;
    const tableBodyHeight = maxRows * rowHeight;
    const tableTotalHeight = tableHeaderHeight + tableBodyHeight;
    doc.rect(page_margin, tableStartY, content_width, tableTotalHeight);
    doc.text("Menge", page_margin + 3, tableStartY + 5);
    doc.text("Artikelbezeichnung", page_margin + 25, tableStartY + 5);
    doc.text("EWE-Artikelnummer", page_margin + 105, tableStartY + 5);
    doc.text("Art der Rücklieferung", page_margin + 150, tableStartY + 5);
    for (let i = 0; i < maxRows; i++) {
        const rowY = tableStartY + tableHeaderHeight + (i * rowHeight);
        doc.setFillColor(...fieldBackgroundColor).rect(page_margin + 1, rowY + 1, content_width - 2, rowHeight - 1, 'F');
        const item = (window.merklisteItems || [])[i];
        if (item) {
            const menge = document.getElementById(`menge_${i}`)?.value || item.menge || 1;
            let grund = '';
            const grundElement = document.getElementById(`grund_${i}`);
            if (grundElement) {
                grund = grundElement.value;
            } else if (item.grund) {
                grund = item.grund;
            }
            doc.setFont("helvetica", "normal").setFontSize(9);
            doc.text(menge.toString(), page_margin + 3, rowY + 5);
            doc.text(item.name || item.bezeichnung || '', page_margin + 25, rowY + 5, { maxWidth: 75 });
            doc.text(item.nummer || item.artikelnummer || '', page_margin + 105, rowY + 5, { maxWidth: 43 });
            doc.text(grund, page_margin + 150, rowY + 5, { maxWidth: 30 });
        }
        doc.rect(page_margin + content_width - 10, rowY + (rowHeight - 4) / 2, 4, 4);
        if (i < maxRows - 1) doc.line(page_margin, rowY + rowHeight, page_width - page_margin, rowY + rowHeight);
    }
    doc.line(page_margin + 22, tableStartY + tableHeaderHeight, page_margin + 22, tableStartY + tableTotalHeight);
    doc.line(page_margin + 103, tableStartY + tableHeaderHeight, page_margin + 103, tableStartY + tableTotalHeight);
    doc.line(page_margin + 148, tableStartY + tableHeaderHeight, page_margin + 148, tableStartY + tableTotalHeight);
    doc.line(page_margin + content_width - 12, tableStartY + tableHeaderHeight, page_margin + content_width - 12, tableStartY + tableTotalHeight);
    y = tableStartY + tableTotalHeight;


    // --- 4. Interner Vermerk-Block ---
    y += 7;
    const internBoxY = y;
    const internBoxHeight = 29;
    doc.rect(page_margin, internBoxY, content_width, internBoxHeight);
    
    drawTextField(page_margin + 5, internBoxY + 3, "Wareneingangsdatum", wareneingangsdatumValue, 85, 6, true); // <-- KORRIGIERT
    drawTextField(page_margin + 5, internBoxY + 12.5, "Auftragsnummer", auftragsnummerValue, 85, 6, true);
    drawTextField(page_margin + 5, internBoxY + 22, "Reklamationsnummer", reklamationsnummerValue, 85, 6, true);
    
    drawTextField(page_width / 2 + 5, internBoxY + 3, "Kundennummer", kundennummerValue, 85, 6, true);
    drawTextField(page_width / 2 + 5, internBoxY + 12.5, "Bezug zu Rechnungsnummer", rechnungsnummerValue, 85, 6, true);
    drawTextField(page_width / 2 + 5, internBoxY + 22, "Gutschrift", "", 85, 6, true);
    y += internBoxHeight;

    // --- 5. Reklamations-Block (unverändert) ---
    // ... (Ihr Code für den Reklamations-Block bleibt hier)
    y += 5;
    const reklBoxHeight = 22;
    doc.rect(page_margin, y, content_width, reklBoxHeight);

    if (retourenInputs.checkReklamation.checked) {
        doc.setFont("helvetica", "bold").text('X', page_margin + 6, y + 5.5);
    }
    drawCheckBox(page_margin + 5, y + 2, "Reklamation");

    if (retourenInputs.checkNeuware.checked) {
        doc.setFont("helvetica", "bold").text('X', page_margin + 6, y + 12.5);
    }
    drawCheckBox(page_margin + 5, y + 9, "Neuware. Einlagern und zubuchen");

    if (retourenInputs.checkRuecksendung.checked) {
        doc.setFont("helvetica", "bold").text('X', page_margin + 6, y + 19.5);
    }
    drawCheckBox(page_margin + 5, y + 16, "Rücksendung an den Kunden");

    if (retourenInputs.checkReparatur.checked) {
        doc.setFont("helvetica", "bold").text('X', page_width / 2 + 6, y + 5.5);
    }
    drawCheckBox(page_width / 2 + 5, y + 2, "Reparatur - Kostenvoranschlag");

    if (retourenInputs.checkWeiterleitung.checked) {
        doc.setFont("helvetica", "bold").text('X', page_width / 2 + 6, y + 12.5);
        doc.setFont("helvetica", "normal").setFontSize(9).text(retourenInputs.weiterleitungAnName.value, page_width / 2 + 55, y + 12.5, { maxWidth: 35 });
    }
    drawCheckBox(page_width / 2 + 5, y + 9, "Weiterleitung an");
    
    y += reklBoxHeight;


    // --- 6. Notiz-Block (unverändert) ---
    // ... (Ihr Code für den Notiz-Block bleibt hier)
    y += 3;
    
    doc.setFontSize(10).setFont("helvetica", "bold").text("Notizen", page_margin + 2, y + 5);
    y += 7;
    const notizBoxHeight = 20;
    doc.rect(page_margin, y, content_width, notizBoxHeight);
    doc.setFont("helvetica", "normal").setFontSize(9).text(retourenInputs.bemerkungen.value, page_margin + 2, y + 5, { maxWidth: content_width - 4 });

    y += notizBoxHeight;


    // --- 7. Footer (unverändert) ---
    const finalY = doc.internal.pageSize.getHeight() - 4;
    doc.setFontSize(7).setFont("helvetica", "normal");
    doc.text("VK-11 Retourenschein (Stand 10/2025)", page_margin, finalY);
    doc.text("Wilhelm Ewe GmbH & Co. KG - Volkmaroder Straße 19 - 38104 Braunschweig", page_width / 2, finalY, { align: 'center' });
    doc.text("Seite 1 von 1", page_width - page_margin, finalY, { align: 'right' });

    // --- PDF Speichern ---
// NEUER CODE (Retourenschein_Firma_Ansprechpartner_Ort_Datum):

// 1. Alle benötigten Werte aus den Feldern holen.
const firma = document.getElementById("firma").value || "";
const ansprechpartner = document.getElementById("name").value || "";
const ort = document.getElementById("ort").value || "";
const datum = new Date().toISOString().split('T')[0];

// 2. Alle Teile zu einem Array zusammenfügen. "Retourenschein" kommt immer an den Anfang.
//    Leere Teile (falls ein Feld nicht ausgefüllt ist) werden herausgefiltert.
const filenameParts = ["Retourenschein", firma, ansprechpartner, ort, datum].filter(part => part);

// 3. Jeden Teil bereinigen (Sonderzeichen entfernen) und mit "_" verbinden.
const cleanFilename = filenameParts.map(part => 
    part.replace(/[^a-zA-Z0-9äöüÄÖÜß\s]/g, "").trim()
).join("_");

// 4. PDF mit dem neuen, sauberen Dateinamen speichern.
doc.save(`${cleanFilename}.pdf`);

}


// ========================================================================
// ===== NEU: DER EINZIGE UND KORREKTE STARTPUNKT DER SEITE         =====
// ========================================================================

// ========================================================================
// ===== NEU: DER EINZIGE UND KORREKTE STARTPUNKT DER SEITE (Version 2) =====
// ========================================================================

document.addEventListener("DOMContentLoaded", async () => {
  
    // --- SCHRITT 1: Seite mit Standardwerten initialisieren ---

    // Heutiges Datum als Standard in die Datumsfelder eintragen
    const todayGerman = getTodayGermanDate();
    document.getElementById('abholdatum').value = `Abholdatum: ${todayGerman}`;
    document.getElementById('wareneingang_datum').value = `Wareneingangsdatum: ${todayGerman}`;
    
    // Das erste leere Feld für manuelle Artikeleingabe erstellen
    initManuelleArtikelEingabe();
    
    // Versuchen, Artikel aus der Merkliste einer VORHERIGEN Seite zu laden.
    // Dies überschreibt die leere Artikelliste, falls Daten vorhanden sind.
    ladeMerklisteAusLocalStorage();
    
    // jQuery-abhängige Dropdowns initialisieren
    $(document).ready(function() {
        $('#bearbeiterDropdown').select2({ placeholder: "-- Bearbeiter auswählen --", allowClear: true });
        $('#anlieferungDropdown').select2({ placeholder: "-- Anlieferung auswählen --", allowClear: true });
    });

    // --- SCHRITT 2: Versuchen, die Standardwerte mit gespeicherten Daten zu überschreiben ---
    restoreFormData();

    // --- SCHRITT 3: Kundendatenbank laden (Envelope Encryption) ---
    loadKundenDatenbank();

    // --- SCHRITT 4: PLZ-Feld Event-Listener fuer manuelle Eingabe ---
    document.getElementById('plz').addEventListener('input', function() {
        if (this.value.length >= 4) {
            showKundenByPLZ(this.value.trim());
        } else {
            const container = document.getElementById('kundenErgebnisse');
            if (container) { container.innerHTML = ''; container.style.display = 'none'; }
        }
    });

    // --- SCHRITT 4b: PLZ-Feld auch bei Fokus Dropdown anzeigen ---
    document.getElementById('plz').addEventListener('focus', function() {
        if (this.value.trim().length >= 4) showKundenByPLZ(this.value.trim());
    });

    // --- SCHRITT 5: Kunde-speichern Event-Listener ---
    document.getElementById('kundenSpeichernBtn').addEventListener('click', saveKundeToSupabase);
    document.getElementById('name').addEventListener('input', updateSpeichernButton);

});



  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBN4cAc4nq9je0of0cb_0wEUb1yCz54r7k&libraries=places&callback=initGooglePlaces" async defer></script>
    <section class="form-section-container" style="text-align: center; box-shadow: none; border: none; background: none;">
  <button onclick="generateRetourenscheinPDF()" class="btn btn-primary">
    <i class="bi bi-file-earmark-pdf"></i> PDF erzeugen
  </button>
</body>
</html>
