<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retourenschein PDF Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="retourenschein.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- PapaParse-Bibliothek für die CSV-Verarbeitung -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  
  <!-- jQuery (wird von Select2 benötigt) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>
<body>
  <header id="header">
    <div class="header-left">
      <img src="https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png" alt="EWE Logo">
    </div>
    <div class="header-content">
      <h1>Retourenschein</h1>
      <div class="header-date" id="heute"></div>
    </div>
    <div class="header-right">
      <div class="buttons">
        <button onclick="generateRetourenscheinPDF()">PDF erzeugen</button>
      </div>
    </div>
  </header>

  <!-- Kundenauswahl -->
  <section class="search-container">
    <select id="kundenDropdown">
      <option value="">-- Kunde auswählen --</option>
      <!-- Kundenoptionen werden dynamisch per JavaScript geladen -->
    </select>
  </section>

  <!-- Kundendaten -->
  <section id="kundenDetails" class="search-container">
    <input type="text" id="name" placeholder="Name">
    <input type="text" id="firma" placeholder="Firma">
    <input type="text" id="strasse" placeholder="Straße">
    <input type="text" id="plz" placeholder="PLZ">
    <input type="text" id="ort" placeholder="Ort">
    <input type="text" id="land" placeholder="Land">
    <input type="text" id="email" placeholder="E-Mail">
    <input type="text" id="telefon" placeholder="Telefon">
  </section>

  <!-- Neue Felder für Retourenschein -->
  <section id="retourenDetails" class="search-container">
    <h3>Retourendetails</h3>
    
    <!-- Bearbeiter Dropdown -->
    <select id="bearbeiterDropdown">
      <option value="">-- Bearbeiter auswählen --</option>
      <option value="Rafael Furtwängler">Rafael Furtwängler</option>
      <option value="Christof Münster">Christof Münster</option>
      <option value="Sascha Heusel">Sascha Heusel</option>
      <option value="Bernhard Kneissl">Bernhard Kneissl</option>
      <option value="Christopher-Sean Haus">Christopher-Sean Haus</option>
      <option value="Sascha Barkowsky">Sascha Barkowsky</option>
      <option value="Volker Kottwitz">Volker Kottwitz</option>
      <option value="Volker Oesterwind">Volker Oesterwind</option>
      <option value="Thomas Schönfüß">Thomas Schönfüß</option>
      <option value="Thomas Wendt">Thomas Wendt</option>
      <option value="Harald Natzke">Harald Natzke</option>
      <option value="Lukas Pfeil">Lukas Pfeil</option>
      <option value="Nancy Ullbricht">Nancy Ullbricht</option>
      <option value="Heiner Birkholz">Heiner Birkholz</option>
      <option value="Helmut Wölfel">Helmut Wölfel</option>
      <option value="manuell">-- Manuelle Eingabe --</option>
    </select>
    
    <!-- Manuelles Bearbeiter-Eingabefeld (initial versteckt) -->
    <input type="text" id="bearbeiterManuell" placeholder="Bearbeiter (manuell)" style="display: none;">
    
    <!-- Anlieferung Dropdown -->
    <select id="anlieferungDropdown">
      <option value="">-- Anlieferung auswählen --</option>
      <option value="PKW Außendienst">PKW Außendienst</option>
      <option value="EWE-LW">EWE-LW</option>
      <option value="Paketdienst">Paketdienst</option>
      <option value="Spedition">Spedition</option>
      <option value="Sonstiges">Sonstiges</option>
    </select>
    
    <!-- Abholdatum mit Vor/Zurück-Pfeilen -->
    <div id="abholdatumContainer">
      <label for="abholdatum">Abholdatum:</label>
      <div class="date-picker-container">
        <button type="button" id="datumZurueck" class="date-arrow">◀</button>
        <input type="date" id="abholdatum">
        <button type="button" id="datumVor" class="date-arrow">▶</button>
      </div>
    </div>
  </section>

  <!-- Artikel aus Merkliste (wird dynamisch gefüllt) -->
  <section id="artikelListe" class="search-container">
    <h3>Artikel zur Rücksendung</h3>
    <div id="artikelInhalt">
      <p>Keine Artikel in der Merkliste gefunden. Bitte verwende den PDF-Viewer, um Artikel zur Merkliste hinzuzufügen.</p>
    </div>
  </section>

  <script>
    // Referenzen auf die HTML-Elemente
    const dropdown = document.getElementById("kundenDropdown");
    const inputs = {
      name: document.getElementById("name"),
      firma: document.getElementById("firma"),
      telefon: document.getElementById("telefon"),
      email: document.getElementById("email"),
      strasse: document.getElementById("strasse"),
      ort: document.getElementById("ort"),
      plz: document.getElementById("plz"),
      land: document.getElementById("land")
    };

    // Neue Felder
    const retourenInputs = {
      bearbeiter: document.getElementById("bearbeiterDropdown"),
      bearbeiterManuell: document.getElementById("bearbeiterManuell"),
      anlieferung: document.getElementById("anlieferungDropdown"),
      abholdatum: document.getElementById("abholdatum")
    };

    // Variable, um die geladenen Kundendaten zu speichern
    let kunden = [];

    // CSV-Datei laden und verarbeiten
    fetch("https://volkerkottwitz.github.io/Konfig/Konfigurator/anewstar/Retourenschein/kundenstamm.csv")
      .then(response => {
        if (!response.ok) {
          throw new Error("Netzwerkantwort war nicht in Ordnung.");
        }
        return response.text();
      })
      .then(csvText => {
        // PapaParse verwenden, um den CSV-Text zu parsen
        const results = Papa.parse(csvText, {
          header: true,          // Die erste Zeile als Spaltenüberschrift verwenden
          skipEmptyLines: true,  // Leere Zeilen überspringen
          bom: true              // Das BOM-Zeichen am Dateianfang ignorieren (wichtig!)
        });
        kunden = results.data;

        // Das Dropdown-Menü mit den geladenen Daten füllen
        kunden.forEach((kunde, index) => {
          // Label erstellen: "Name – Firma" oder nur "Firma", wenn kein Name vorhanden ist
          const label = kunde.Name ? `${kunde.Name.trim()} – ${kunde.Firma.trim()}` : kunde.Firma.trim();
          const opt = document.createElement("option");
          opt.value = index; // Den Array-Index als Wert verwenden
          opt.textContent = label;
          dropdown.appendChild(opt);
        });

        // Option für manuelle Eingabe am Ende hinzufügen
        const manualOpt = document.createElement("option");
        manualOpt.value = "manuell";
        manualOpt.textContent = "-- Manuelle Eingabe --";
        dropdown.appendChild(manualOpt);

        // Select2 initialisieren
        $(document).ready(function() {
            $('#kundenDropdown').select2({
                placeholder: "-- Kunde auswählen --",
                allowClear: true
            });
            
            // Auch für Bearbeiter-Dropdown
            $('#bearbeiterDropdown').select2({
                placeholder: "-- Bearbeiter auswählen --",
                allowClear: true
            });
            
            // Und für Anlieferung-Dropdown
            $('#anlieferungDropdown').select2({
                placeholder: "-- Anlieferung auswählen --",
                allowClear: true
            });
        });
      })
      .catch(error => {
        console.error("Fehler beim Laden oder Verarbeiten der CSV-Datei:", error);
        // Fallback, falls das Laden fehlschlägt
        const manualOpt = document.createElement("option");
        manualOpt.value = "manuell";
        manualOpt.textContent = "-- Manuelle Eingabe (Fehler beim Laden der Kundenliste) --";
        dropdown.appendChild(manualOpt);
      });

    // Event-Listener für das Kunden-Dropdown-Menü
    $('#kundenDropdown').on('change', function () {
      const selectedIndex = this.value;

      // Felder leeren bei "Kunde auswählen" oder "Manuelle Eingabe"
      if (selectedIndex === "" || selectedIndex === "manuell") {
        Object.values(inputs).forEach(input => (input.value = ""));
        return;
      }

      // Den ausgewählten Kunden aus dem Array holen
      const kunde = kunden[selectedIndex];
      if (!kunde) return;

      // Die Adresse in ihre Bestandteile aufteilen
      const adresseTeile = kunde.Adresse ? kunde.Adresse.split(",").map(x => x.trim()) : ["", "", "", ""];
      
      // Die Formularfelder mit den Kundendaten füllen
      inputs.name.value = kunde.Name || "";
      inputs.firma.value = kunde.Firma || "";
      inputs.telefon.value = kunde.Telefon || "";
      inputs.email.value = kunde['E-Mail'] || ""; // Zugriff mit Klammern wegen des Bindestrichs
      inputs.strasse.value = adresseTeile[0] || "";
      inputs.ort.value = adresseTeile[1] || "";
      inputs.plz.value = adresseTeile[2] || "";
      inputs.land.value = adresseTeile[3] || "";
    });

    // Event-Listener für Bearbeiter-Dropdown
    $('#bearbeiterDropdown').on('change', function () {
      const selectedValue = this.value;
      const manuellesEingabefeld = retourenInputs.bearbeiterManuell;
      
      if (selectedValue === "manuell") {
        manuellesEingabefeld.style.display = "block";
        manuellesEingabefeld.focus();
      } else {
        manuellesEingabefeld.style.display = "none";
        manuellesEingabefeld.value = "";
      }
    });

    // Datepicker-Funktionalität
    function initializeDatePicker() {
      const abholdatumInput = retourenInputs.abholdatum;
      const datumZurueckBtn = document.getElementById("datumZurueck");
      const datumVorBtn = document.getElementById("datumVor");
      
      // Aktuelles Datum als Standard setzen
      const heute = new Date();
      abholdatumInput.value = heute.toISOString().split('T')[0];
      
      // Event-Listener für Vor/Zurück-Buttons
      datumZurueckBtn.addEventListener('click', function() {
        const currentDate = new Date(abholdatumInput.value);
        currentDate.setDate(currentDate.getDate() - 1);
        abholdatumInput.value = currentDate.toISOString().split('T')[0];
      });
      
      datumVorBtn.addEventListener('click', function() {
        const currentDate = new Date(abholdatumInput.value);
        currentDate.setDate(currentDate.getDate() + 1);
        abholdatumInput.value = currentDate.toISOString().split('T')[0];
      });
    }

    // Merkliste aus localStorage laden
    function ladeMerklisteAusLocalStorage() {
      try {
        const merklisteData = localStorage.getItem('merklisteForRetourenschein');
        if (merklisteData) {
          const merkliste = JSON.parse(merklisteData);
          
          // Merkliste als globale Variable setzen
          window.merklisteItems = merkliste.map(item => ({
            nummer: item.nummer || item.artikelnummer || '',
            name: item.name || item.bezeichnung || 'Unbekannter Artikel',
            bezeichnung: item.name || item.bezeichnung || 'Unbekannter Artikel',
            artikelnummer: item.nummer || item.artikelnummer || '',
            menge: item.menge || 1,
            preis: item.preis || '0,00 €'
          }));
          
          // Artikel-Liste sofort aktualisieren
          updateArtikelListe();
          
          // LocalStorage nach dem Laden löschen (optional)
          localStorage.removeItem('merklisteForRetourenschein');
          
          console.log('Merkliste erfolgreich geladen:', merkliste.length, 'Artikel');
        }
      } catch (error) {
        console.error('Fehler beim Laden der Merkliste:', error);
      }
    }

    // Merkliste-Artikel anzeigen (falls vorhanden)
    function updateArtikelListe() {
      const artikelInhalt = document.getElementById("artikelInhalt");
      
      // Prüfen, ob window.merklisteItems existiert (aus viewer-final.js)
      if (window.merklisteItems && window.merklisteItems.length > 0) {
        // Desktop-Tabelle erstellen
        let tableHtml = '<table class="artikel-tabelle">';
        tableHtml += '<thead><tr><th>Artikelnummer</th><th>Bezeichnung</th><th>Menge</th><th>Retourengrund</th></tr></thead>';
        tableHtml += '<tbody>';
        
        window.merklisteItems.forEach((artikel, index) => {
          tableHtml += `<tr>
            <td>${artikel.nummer || artikel.artikelnummer || 'N/A'}</td>
            <td>${artikel.name || artikel.bezeichnung || 'N/A'}</td>
            <td><input type="number" value="${artikel.menge || 1}" min="1" id="menge_${index}" class="artikel-menge"></td>
            <td>
              <select id="grund_${index}" class="artikel-grund">
                <option value="">-- Grund auswählen --</option>
                <option value="Artikel passt nicht / falsche Größe">Artikel passt nicht / falsche Größe</option>
                <option value="Artikel gefällt nicht">Artikel gefällt nicht</option>
                <option value="Artikel beschädigt / defekt">Artikel beschädigt / defekt</option>
                <option value="Falscher Artikel geliefert">Falscher Artikel geliefert</option>
                <option value="Doppelt bestellt">Doppelt bestellt</option>
                <option value="Sonstiges">Sonstiges</option>
              </select>
            </td>
          </tr>`;
        });
        
        tableHtml += '</tbody></table>';

        // Mobile-Karten erstellen
        let cardsHtml = '<div class="artikel-karten">';
        
        window.merklisteItems.forEach((artikel, index) => {
          cardsHtml += `<div class="artikel-karte">
            <div class="artikel-karte-zeile">
              <span class="artikel-karte-label">Artikelnummer:</span>
              <span class="artikel-karte-wert">${artikel.nummer || artikel.artikelnummer || 'N/A'}</span>
            </div>
            <div class="artikel-karte-zeile">
              <span class="artikel-karte-label">Bezeichnung:</span>
              <span class="artikel-karte-wert">${artikel.name || artikel.bezeichnung || 'N/A'}</span>
            </div>
            <div class="artikel-karte-zeile">
              <span class="artikel-karte-label">Menge:</span>
              <input type="number" value="${artikel.menge || 1}" min="1" id="menge_mobile_${index}" class="artikel-menge">
            </div>
            <div class="artikel-karte-zeile">
              <span class="artikel-karte-label">Retourengrund:</span>
              <select id="grund_mobile_${index}" class="artikel-grund">
                <option value="">-- Grund auswählen --</option>
                <option value="Artikel passt nicht / falsche Größe">Artikel passt nicht / falsche Größe</option>
                <option value="Artikel gefällt nicht">Artikel gefällt nicht</option>
                <option value="Artikel beschädigt / defekt">Artikel beschädigt / defekt</option>
                <option value="Falscher Artikel geliefert">Falscher Artikel geliefert</option>
                <option value="Doppelt bestellt">Doppelt bestellt</option>
                <option value="Sonstiges">Sonstiges</option>
              </select>
            </div>
          </div>`;
        });
        
        cardsHtml += '</div>';

        // Beide Versionen in den Container einfügen
        artikelInhalt.innerHTML = tableHtml + cardsHtml;

        // Event-Listener für Synchronisation zwischen Desktop und Mobile hinzufügen
        window.merklisteItems.forEach((artikel, index) => {
          // Menge synchronisieren
          const mengeDesktop = document.getElementById(`menge_${index}`);
          const mengeMobile = document.getElementById(`menge_mobile_${index}`);
          
          if (mengeDesktop && mengeMobile) {
            mengeDesktop.addEventListener('input', function() {
              mengeMobile.value = this.value;
            });
            mengeMobile.addEventListener('input', function() {
              mengeDesktop.value = this.value;
            });
          }

          // Grund synchronisieren
          const grundDesktop = document.getElementById(`grund_${index}`);
          const grundMobile = document.getElementById(`grund_mobile_${index}`);
          
          if (grundDesktop && grundMobile) {
            grundDesktop.addEventListener('change', function() {
              grundMobile.value = this.value;
            });
            grundMobile.addEventListener('change', function() {
              grundDesktop.value = this.value;
            });
          }
        });

      } else {
        artikelInhalt.innerHTML = '<p>Keine Artikel in der Merkliste gefunden. Bitte verwende den PDF-Viewer, um Artikel zur Merkliste hinzuzufügen.</p>';
      }
    }

    // Heutiges Datum setzen
    document.getElementById("heute").textContent = new Date().toLocaleDateString('de-DE');

    // Initialisierung
    document.addEventListener('DOMContentLoaded', function() {
      initializeDatePicker();
      ladeMerklisteAusLocalStorage(); // Merkliste aus localStorage laden
      updateArtikelListe();
      
      // Periodisch prüfen, ob neue Artikel hinzugefügt wurden
      setInterval(updateArtikelListe, 2000);
    });

    // PDF-Generierungsfunktion (erweitert)
/**
 * Erzeugt einen Retourenschein im EWE-Design als PDF.
 * Diese Funktion baut das Layout mit Linien und präzise positioniertem Text nach.
 *

/**
 * Erzeugt einen Retourenschein im EWE-Design als PDF.
 * Finale, vollständige Version mit allen Blöcken, inklusive des internen Vermerk-Blocks.
 *
 * ANLEITUNG:
 * 1. Ersetzen Sie die alte `generateRetourenscheinPDF`-Funktion durch diese.
 * 2. Passen Sie die `logoUrl`-Variable an, sodass sie auf Ihr Logo zeigt.
 */
/**
 * Erzeugt einen Retourenschein im EWE-Design als PDF.
 * Finale, polierte Version mit allen Detail-Anpassungen.
 *
 * ANLEITUNG:
 * 1. Ersetzen Sie die alte `generateRetourenscheinPDF`-Funktion durch diese.
 * 2. Passen Sie die `logoUrl`-Variable an, sodass sie auf Ihr Logo zeigt.
 */
/**
 * Erzeugt einen Retourenschein im EWE-Design als PDF.
 * Finale, polierte Version mit allen Detail-Korrekturen.
 *
 * ANLEITUNG:
 * 1. Ersetzen Sie die alte `generateRetourenscheinPDF`-Funktion durch diese.
 * 2. Passen Sie die `logoUrl`-Variable an, sodass sie auf Ihr Logo zeigt.
 */
async function generateRetourenscheinPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    // --- Hilfsfunktion zum Laden eines Bildes ---
    const loadImage = (url) => new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = () => resolve(img);
        img.onerror = (err) => reject(err);
        img.src = url;
    });

    // --- Globale Einstellungen ---
    const page_margin = 10;
    const page_width = doc.internal.pageSize.getWidth();
    const content_width = page_width - (2 * page_margin);
    const fieldBackgroundColor = [230, 245, 255];

    // --- Hilfsfunktionen zum Zeichnen ---
    const drawTextField = (x, y, label, value, width = 85, height = 6) => {
        doc.setFillColor(...fieldBackgroundColor).rect(x, y + 1, width, height, 'F');
        doc.setFontSize(7).setFont("helvetica", "bold").text(label, x, y);
        doc.setFont("helvetica", "normal").setFontSize(10);
        doc.text(value || '', x + 1, y + 5.5, { maxWidth: width - 2, lineHeightFactor: 1.15 });
        doc.setDrawColor(0).line(x, y + height + 1, x + width, y + height + 1);
    };

    const drawCheckBox = (x, y, label) => {
        doc.setFontSize(10).setFont("helvetica", "normal");
        doc.rect(x, y, 4, 4);
        doc.text(label, x + 6, y + 3.5);
    };

    // --- 1. Header ---
    let y = page_margin;
    const logoUrl = 'logo.png'; // <-- HIER DEN PFAD ZUM LOGO ANPASSEN
    let logoHeight = 15;
    try {
        const logoImg = await loadImage(logoUrl);
        const logoWidth = 40;
        logoHeight = logoWidth * (logoImg.height / logoImg.width);
        doc.addImage(logoImg, 'PNG', page_width - page_margin - logoWidth, y, logoWidth, logoHeight);
    } catch (error) {
        console.error("Fehler beim Laden des Logos:", error);
        doc.setFontSize(16).setFont("helvetica", "bold").text("EWE ARMATUREN", page_width - page_margin - 50, y + 5);
    }

    doc.setFontSize(16).setFont("helvetica", "bold").text("Retourenschein", page_margin, y + 5);
    const introTextY = Math.max(y + 10, y + logoHeight + 3);
    doc.setFontSize(9).setFont("helvetica", "normal").text("Bitte Retourenschein ausfüllen, als Begleitdokument der Ware beilegen und per E-Mail an den zuständigen EWE-Innendienst schicken.", page_margin, introTextY, { maxWidth: content_width });
    y = introTextY + 10;

    // --- 2. Kunden- und Auftragsdaten ---
    doc.setFillColor(240, 240, 240).rect(page_margin, y, content_width, 7, 'F');
    doc.setFontSize(10).setFont("helvetica", "bold").text("Kundenangaben", page_margin + 2, y + 5);
    y += 7;
    const kundenBoxY = y;
    const kundenBoxHeight = 58;
    doc.rect(page_margin, kundenBoxY, content_width, kundenBoxHeight);
    const today = new Date().toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const abholDatum = retourenInputs.abholdatum.value ? new Date(retourenInputs.abholdatum.value).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
    const firma = inputs.firma.value ? `${inputs.firma.value}\n` : '';
    const nameValue = `${firma}${inputs.name.value}`;
    drawTextField(page_margin + 5, kundenBoxY + 5, "Name", nameValue, 85, 12);
    drawTextField(page_width / 2 + 5, kundenBoxY + 5, "Datum", today);
    const bearbeiterWert = retourenInputs.bearbeiter.value === "manuell" ? retourenInputs.bearbeiterManuell.value : retourenInputs.bearbeiter.value;
    drawTextField(page_width / 2 + 5, kundenBoxY + 15, "Bearbeiter", bearbeiterWert);
    drawTextField(page_margin + 5, kundenBoxY + 20.5, "Adresse", inputs.strasse.value);
    drawTextField(page_margin + 5, kundenBoxY + 30, "PLZ / Ort", `${inputs.plz.value} ${inputs.ort.value}`);
    const separatorY = kundenBoxY + 42;
    doc.line(page_margin, separatorY, page_width - page_margin, separatorY);
    drawTextField(page_margin + 5, separatorY + 3, "Anlieferung", retourenInputs.anlieferung.value);
    drawTextField(page_width / 2 + 5, separatorY + 3, "Abholung Datum", abholDatum);
    y = kundenBoxY + kundenBoxHeight;

    // --- 3. Artikeltabelle ---
    y += 3;
    doc.setFillColor(240, 240, 240).rect(page_margin, y, content_width, 7, 'F');
    doc.setFontSize(9).setFont("helvetica", "bold").text("Bitte beachten Sie, dass die Ware ordnungsgemäß sowie transportgerecht zur Abholung verpackt werden muss!", page_margin + 2, y + 5);
    y += 7;
    const tableStartY = y;
    const rowHeight = 10, maxRows = 5, tableHeaderHeight = 7;
    const tableBodyHeight = maxRows * rowHeight;
    const tableTotalHeight = tableHeaderHeight + tableBodyHeight;
    doc.rect(page_margin, tableStartY, content_width, tableTotalHeight);
    doc.setFillColor(240, 240, 240).rect(page_margin, tableStartY, content_width, tableHeaderHeight, 'F');
    doc.text("Menge", page_margin + 3, tableStartY + 5);
    doc.text("Artikelbezeichnung", page_margin + 25, tableStartY + 5);
    doc.text("EWE-Artikelnummer", page_margin + 105, tableStartY + 5);
    doc.text("Art der Rücklieferung", page_margin + 150, tableStartY + 5);
    for (let i = 0; i < maxRows; i++) {
        const rowY = tableStartY + tableHeaderHeight + (i * rowHeight);
        doc.setFillColor(...fieldBackgroundColor).rect(page_margin + 1, rowY + 1, content_width - 2, rowHeight - 1, 'F');
        const item = (window.merklisteItems || [])[i];
        if (item) {
            const menge = (document.getElementById(`menge_${i}`) || document.getElementById(`menge_mobile_${i}`))?.value || item.menge || 1;
            const grund = (document.getElementById(`grund_${i}`) || document.getElementById(`grund_mobile_${i}`))?.value || '';
            doc.setFont("helvetica", "normal").setFontSize(9);
            doc.text(menge.toString(), page_margin + 3, rowY + 6);
            doc.text(item.name || item.bezeichnung || '', page_margin + 25, rowY + 6, { maxWidth: 78 });
            doc.text(item.nummer || item.artikelnummer || '', page_margin + 105, rowY + 6, { maxWidth: 43 });
            doc.text(grund, page_margin + 150, rowY + 6, { maxWidth: 30 });
        }
        doc.rect(page_margin + content_width - 10, rowY + (rowHeight - 4) / 2, 4, 4);
        // KORREKTUR: Unterste Linie wird jetzt korrekt gezeichnet
        if (i < maxRows - 1) doc.line(page_margin, rowY + rowHeight, page_width - page_margin, rowY + rowHeight);
    }
    doc.line(page_margin + 22, tableStartY + tableHeaderHeight, page_margin + 22, tableStartY + tableTotalHeight);
    doc.line(page_margin + 103, tableStartY + tableHeaderHeight, page_margin + 103, tableStartY + tableTotalHeight);
    // KORREKTUR: Vertikale Linie beginnt erst UNTER dem Header
    doc.line(page_margin + 148, tableStartY + tableHeaderHeight, page_margin + 148, tableStartY + tableTotalHeight);
    doc.line(page_margin + content_width - 12, tableStartY, page_margin + content_width - 12, tableStartY + tableTotalHeight);
    y = tableStartY + tableTotalHeight;

    // --- 4. Interner Vermerk-Block ---
    y += 3;
    const internBoxY = y;
    const internBoxHeight = 28;
    doc.rect(page_margin, internBoxY, content_width, internBoxHeight);
    // KORREKTUR: Y-Positionen der Labels für saubere Ausrichtung final angepasst
    drawTextField(page_margin + 5, internBoxY + 3, "Wareneingangsdatum", "");
    drawTextField(page_margin + 5, internBoxY + 11.5, "Auftragsnummer", "");
    drawTextField(page_margin + 5, internBoxY + 20, "Reklamationsnummer", "");
    drawTextField(page_width / 2 + 5, internBoxY + 3, "Kundennummer", "");
    drawTextField(page_width / 2 + 5, internBoxY + 11.5, "Bezug zu Rechnungsnummer", "");
    drawTextField(page_width / 2 + 5, internBoxY + 20, "Gutschrift", "");
    y += internBoxHeight;

    // --- 5. Reklamations-Block ---
    y += 3;
    const reklBoxHeight = 22;
    doc.rect(page_margin, y, content_width, reklBoxHeight);
    // KORREKTUR: Checkboxen für vertikale Zentrierung neu positioniert
    const reklCenterY = y + reklBoxHeight / 2;
    drawCheckBox(page_margin + 5, reklCenterY - 7, "Reklamation");
    drawCheckBox(page_margin + 5, reklCenterY, "Neuware. Einlagern und zubuchen");
    drawCheckBox(page_margin + 5, reklCenterY + 7, "Rücksendung an den Kunden");
    drawCheckBox(page_width / 2 + 5, reklCenterY - 7, "Reparatur - Kostenvoranschlag");
    drawCheckBox(page_width / 2 + 5, reklCenterY, "Weiterleitung an");
    y += reklBoxHeight;

    // --- 6. Notiz-Block ---
    y += 3;
    doc.setFillColor(240, 240, 240).rect(page_margin, y, content_width, 7, 'F');
    doc.setFontSize(10).setFont("helvetica", "bold").text("Notizen", page_margin + 2, y + 5);
    y += 7;
    const notizBoxHeight = 20;
    doc.rect(page_margin, y, content_width, notizBoxHeight);

    // --- 7. Footer ---
    const finalY = doc.internal.pageSize.getHeight() - 7;
    doc.setFontSize(7).setFont("helvetica", "normal");
    doc.text("VK-11 Retourenschein (Stand 05/2020)", page_margin, finalY);
    doc.text("Wilhelm Ewe GmbH & Co. KG - Volkmaroder Straße 19 - 38104 Braunschweig", page_width / 2, finalY, { align: 'center' });
    doc.text("Seite 1 von 1", page_width - page_margin, finalY, { align: 'right' });

    // --- PDF Speichern ---
    const filename = `Retourenschein_${inputs.name.value.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(filename);
}
  </script>
</body>
</html>

