<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bericht erstellen</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="interneAnfrage.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>

    /* ================================================================== */
    /* ===== BASIS-STILE & LAYOUT ======================================= */
    /* ================================================================== */
    .form-section-container {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin: 25px auto;
      background-color: #fdfdfd;
      max-width: 900px;
    }
    .form-section-container h3 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 25px;
      padding-bottom: 10px;
      color: #00a1e1;
      font-size: 1.3em;
    }
    .centered-form-layout {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    .centered-form-layout > * {
      width: 100%;
      max-width: 500px;
    }

    /* F√úGEN SIE DIESEN BLOCK ZU IHREM CSS HINZU */
/* (Ein guter Platz ist direkt vor der .search-input-group Regel) */

/* ================================================================== */
/* ===== KUNDENSUCHE (AUFGER√ÑUMT) =================================== */
/* ================================================================== */

/* NEU: Diese Regel ist der entscheidende Fix */
.search-wrapper {
    position: relative;
}

/* Gruppe f√ºr Suchfeld und Mikrofon-Button */
.search-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
}

    /* Das Suchfeld selbst (alle Regeln an einem Ort) */
    #kundenSuche {
        flex-grow: 1; /* W√§chst, um den Platz zu f√ºllen */
        height: 48px;
        padding: 12px 20px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 25px !important; /* Wichtig, um externe Stile zu √ºberschreiben */
        box-sizing: border-box;
        transition: all 0.2s ease-in-out;
    }
    #kundenSuche:focus {
        outline: none;
        border-color: #00a1e1;
        box-shadow: 0 0 0 3px rgba(0, 161, 225, 0.25);
    }

    /* Die schwebende Ergebnisliste */
    #suchErgebnisse {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background-color: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        max-height: 300px;
        overflow-y: auto;
    }
    .ergebnis-item {
        padding: 12px 20px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    .ergebnis-item:last-child { border-bottom: none; }
    .ergebnis-item:hover { background-color: #f0f8ff; }
    .ergebnis-item.active { background-color: #e6f7ff; }
    .ergebnis-item.best-match { background-color: #e0ffe0; font-weight: bold; }
    .ergebnis-item.no-results { cursor: default; color: #888; }
    .ergebnis-item.no-results:hover { background-color: white; }
    .search-highlight {
      background-color: rgba(0, 0, 0, 0.2);
      font-weight: bold;
      border-radius: 3px;
      padding: 0 2px;
    }

    /* ================================================================== */
    /* ===== ICON-BUTTONS & TELEFON-GRUPPE ============================== */
    /* ================================================================== */

    /* Allgemeiner Stil f√ºr Icon-Buttons (Mikrofon & Telefon) */
    .icon-button {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0; /* Verhindert, dass der Button schrumpft */
        width: 48px;
        height: 48px;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 50%; /* Runder Button */
        font-size: 1.5rem;
        color: #555;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .icon-button:hover {
        background-color: #007bff;
        color: white;
        transform: scale(1.05);
    }
    #speech-search-button.is-listening {
        background-color: #dc3545;
        color: white;
    }

    /* Gruppe f√ºr Telefonnummer und Anruf-Button */
    .phone-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .phone-group input {
        flex-grow: 1;
    }

    /* ================================================================== */
    /* ===== SPRACHEINGABE-SEKTIONEN ==================================== */
    /* ================================================================== */
    #spracheingabe-container, #aufgaben-container {
        text-align: center;
    }
    #bericht-text, #aufgaben-text {
        width: 100%;
        height: 200px;
        margin-top: 1rem;
        padding: 0.5rem;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }
    #aufgaben-text { height: 120px; }
    .aufnahme-button {
        margin-top: 1rem;
        padding: 0.8rem 1.5rem;
        font-size: 1rem;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        background-color: #28a745;
        color: white;
        transition: background-color 0.3s;
    }
    .aufnahme-button:hover { background-color: #218838; }
    .aufnahme-button.recording { background-color: #dc3545; }
    .aufnahme-status {
        margin-top: 1rem;
        color: #666;
        min-height: 20px;
    }


  </style>
</head>
<body>
  <header id="header">
    <div class="header-left">
      <img src="https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png" alt="Firmenlogo">
    </div>
    <div class="header-content">
      <input type="text" id="mainTitleInput" value="Besuchsbericht" class="editable-title">
      <div class="header-date" id="heute"></div>
    </div>
    <div class="header-right">
      <div class="buttons">
        <button onclick="window.close( )" class="btn btn-secondary">üîô Zur√ºck</button>
        <button onclick="generateBerichtPDF()" class="btn btn-primary">Bericht als PDF</button>
      </div>
    </div>
  </header>

  <section class="form-section-container">
    <h3>Kundendaten</h3>
    <div id="kundenDetails" class="centered-form-layout">
<!-- ERSETZEN SIE DEN ALTEN .search-wrapper HIERMIT -->

<div class="search-wrapper">
  <div class="search-input-group">
    <input type="text" id="kundenSuche" placeholder="Lade Kundenliste..." disabled>
    <button id="speech-search-button" class="icon-button" title="Suche per Sprache">üé§</button>
  </div>
  <div id="suchErgebnisse" style="display: none;"></div>
</div>

 
</div>
      <input type="text" id="name" placeholder="Name">
      <input type="text" id="firma" placeholder="Firma">
      <input type="text" id="strasse" placeholder="Stra√üe">
      <input type="text" id="plz" placeholder="PLZ">
      <input type="text" id="ort" placeholder="Ort">
      <input type="text" id="land" placeholder="Land">
      <input type="text" id="email" placeholder="E-Mail">
      <div class="phone-group">
  <input type="text" id="telefon" placeholder="Telefon">
  <button id="call-button" class="icon-button" title="Kunden anrufen" style="display: none;">üìû</button>
</div>
    </div>
  </section>

  <section class="form-section-container">
    <h3>Bearbeitung</h3>
    <div class="centered-form-layout">
      <select id="sachbearbeiterDropdown">
        <option value="">-- Innendienst ausw√§hlen --</option>
        <option value="Denise Otto">Denise Otto</option>
        <option value="Sascha Heusel">Sascha Heusel</option>
        <option value="Nadine Suhr">Nadine Suhr</option>
        <option value="Nils Vokuhl">Nils Vokuhl</option>
        <option value="Claudia Batke">Claudia Batke</option>
        <option value="Karsten Walter">Karsten Walter</option>
        <option value="manuell">-- Manuelle Eingabe --</option>
      </select>
      <input type="text" id="sachbearbeiterManuell" placeholder="Sachbearbeiter (manuell)" style="display: none;">
      <select id="aussendienstDropdown">
        <option value="">-- Au√üendienstmitarbeiter ausw√§hlen --</option>
        <option value="Rafael Furtw√§ngler">Rafael Furtw√§ngler</option>
        <option value="Christof M√ºnster">Christof M√ºnster</option>
        <option value="Sascha Heusel">Sascha Heusel</option>
        <option value="Bernhard Kneissl">Bernhard Kneissl</option>
        <option value="Christopher-Sean Haus">Christopher-Sean Haus</option>
        <option value="Sascha Barkowsky">Sascha Barkowsky</option>
        <option value="Volker Kottwitz">Volker Kottwitz</option>
        <option value="Volker Oesterwind">Volker Oesterwind</option>
        <option value="Thomas Sch√∂nf√º√ü">Thomas Sch√∂nf√º√ü</option>
        <option value="Thomas Wendt">Thomas Wendt</option>
        <option value="Harald Natzke">Harald Natzke</option>
        <option value="Lukas Pfeil">Lukas Pfeil</option>
        <option value="Nancy Ullbricht">Nancy Ullbricht</option>
        <option value="Heiner Birkholz">Heiner Birkholz</option>
        <option value="Helmut W√∂lfel">Helmut W√∂lfel</option>
        <option value="manuell">-- Manuelle Eingabe --</option>
      </select>
      <input type="text" id="aussendienstManuell" placeholder="Au√üendienstmitarbeiter (manuell)" style="display: none;">
    </div>
  </section>

  <section id="spracheingabe-container">
    <h3>Berichtsinhalt per Sprache eingeben</h3>
    <p>Klicken Sie auf "Aufnahme starten" und diktieren Sie Ihren Bericht.</p>
    <button id="aufnahme-button-bericht" class="aufnahme-button">Aufnahme starten</button>
    <textarea id="bericht-text" placeholder="Ihr diktierter Bericht erscheint hier..."></textarea>
    <div id="aufnahme-status-bericht" class="aufnahme-status"></div>
  </section>

  <section id="aufgaben-container">
    <h3>Zu erledigende Aufgaben</h3>
    <p>Diktieren Sie hier die Aufgaben, die sich aus dem Gespr√§ch ergeben haben.</p>
    <button id="aufnahme-button-aufgaben" class="aufnahme-button">Aufnahme starten</button>
    <textarea id="aufgaben-text" placeholder="Ihre diktierten Aufgaben erscheinen hier..."></textarea>
    <div id="aufnahme-status-aufgaben" class="aufnahme-status"></div>
  </section>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>


  <script>
    let kunden = [];
    let fuse; // NEUE ZEILE

// ========================================================================
// ===== NEU: ANGEPASSTER STARTPUNKT DER SEITE                      =====
// ========================================================================

document.addEventListener("DOMContentLoaded", async () => {
    // Diese Funktionen sind unabh√§ngig und k√∂nnen sofort ausgef√ºhrt werden.
    displayCurrentDate();
    initializeDropdowns();
    initializeSpeechRecognition();
    initializeSpeechSearch();
    initializePhoneLink();

    try {
        // 1. Starte den Lade- und Schutzprozess.
        // Die Funktion h√§lt hier an, bis die Daten geladen sind (oder eine Umleitung stattfindet).
        await loadProtectedData();

        // 2. Wenn der Code hier ankommt, war alles erfolgreich.
        // Die globale Variable 'kunden' ist jetzt gef√ºllt.
        console.log(`Schutzpr√ºfung bestanden. ${kunden.length} Kunden geladen.`);

        // 3. Aktiviere jetzt die Teile der Seite, die von den Kundendaten abh√§ngen.
        const kundenSucheInput = document.getElementById('kundenSuche');
        kundenSucheInput.disabled = false;
        kundenSucheInput.placeholder = "üîç Kunde, Firma, PLZ oder Ort suchen...";
        
        // Die Such-Listener k√∂nnen jetzt sicher initialisiert werden.
        initializeCustomerSearchListeners();

    } catch (error) {
        // Dieser Block wird nur bei wirklich unerwarteten Fehlern ausgef√ºhrt,
        // da die typischen Fehler (falsches Passwort etc.) schon in loadProtectedData() behandelt werden.
        console.error("Ein schwerwiegender Fehler ist beim Seitenaufbau aufgetreten:", error);
        document.body.innerHTML = "<h2>Ein kritischer Fehler ist aufgetreten. Bitte laden Sie die Seite neu.</h2>";
    }
});

    function displayCurrentDate() {
      const today = new Date();
      const options = { year: "numeric", month: "long", day: "numeric" };
      document.getElementById("heute").textContent = today.toLocaleDateString("de-DE", options);
    }

    function initializeDropdowns() {
      $("#sachbearbeiterDropdown").select2({ placeholder: "-- Innendienst ausw√§hlen --", allowClear: true });
      $("#aussendienstDropdown").select2({ placeholder: "-- Au√üendienstmitarbeiter ausw√§hlen --", allowClear: true });
      $("#sachbearbeiterDropdown").on("change", function () { handleManualInput(this, document.getElementById("sachbearbeiterManuell")); });
      $("#aussendienstDropdown").on("change", function () { handleManualInput(this, document.getElementById("aussendienstManuell")); });
    }
    
    function initializeSpeechRecognition() {
        setupSpeechRecognition('aufnahme-button-bericht', 'bericht-text', 'aufnahme-status-bericht');
        setupSpeechRecognition('aufnahme-button-aufgaben', 'aufgaben-text', 'aufnahme-status-aufgaben');
    }

    function handleManualInput(dropdown, manualInput) {
      manualInput.style.display = dropdown.value === "manuell" ? "block" : "none";
      if (dropdown.value === "manuell") manualInput.focus(); else manualInput.value = "";
    }


    // F√úGEN SIE DIESE NEUE FUNKTION HINZU

function initializeSpeechSearch() {
    const searchButton = document.getElementById('speech-search-button');
    const searchInput = document.getElementById('kundenSuche');
    if (!searchButton) return;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        searchButton.style.display = 'none';
        return;
    }
    const recognition = new SpeechRecognition();
    recognition.lang = 'de-DE';
    recognition.continuous = false;
    recognition.interimResults = false;

    searchButton.addEventListener('click', () => {
        if (searchInput.disabled) {
            alert("Bitte warten Sie, bis die Kundendaten geladen sind.");
            return;
        }
        recognition.start();
    });

    recognition.onstart = () => {
        searchButton.classList.add('is-listening');
        searchInput.placeholder = 'H√∂re zu...';
    };
    recognition.onend = () => {
        searchButton.classList.remove('is-listening');
        searchInput.placeholder = 'üîç Kunde, Firma, PLZ oder Ort suchen...';
    };
    recognition.onerror = (event) => {
        alert('Fehler bei der Spracherkennung: ' + event.error);
    };
    recognition.onresult = (event) => {
        // Wichtig: Hier wird KEIN Punkt hinzugef√ºgt.
        const suchtext = event.results[0][0].transcript;
        searchInput.value = suchtext;

        // L√∂st die Suche aus
        const inputEvent = new Event('input', { bubbles: true });
        searchInput.dispatchEvent(inputEvent);
    };
}


// F√úGEN SIE DIESE NEUE FUNKTION ZU IHREM SCRIPT HINZU

function initializePhoneLink() {
    const phoneInput = document.getElementById('telefon');
    const callButton = document.getElementById('call-button');

    // Diese Funktion wird aufgerufen, wenn sich der Inhalt des Telefonfeldes √§ndert
    const updateCallButton = () => {
        const phoneNumber = phoneInput.value.trim();
        if (phoneNumber) {
            callButton.style.display = 'flex'; // Button anzeigen
        } else {
            callButton.style.display = 'none'; // Button ausblenden
        }
    };

    // Event-Listener, der bei jeder √Ñnderung im Feld pr√ºft, ob der Button angezeigt werden soll
    phoneInput.addEventListener('input', updateCallButton);

    // Event-Listener f√ºr den Klick auf den Anruf-Button
    callButton.addEventListener('click', () => {
        let phoneNumber = phoneInput.value.trim();
        // Bereinigt die Nummer von Leerzeichen, Klammern etc. und f√ºgt das "tel:"-Pr√§fix hinzu
        let telLink = 'tel:' + phoneNumber.replace(/[\s\(\)\-\/]/g, '');
        
        // √ñffnet den Link (auf dem Handy die Telefon-App, auf dem Desktop z.B. Teams, Skype etc.)
        window.location.href = telLink;
    });

    // Wir m√ºssen auch daf√ºr sorgen, dass der Button erscheint, wenn ein Kunde ausgew√§hlt wird.
    // Dazu erweitern wir die Funktion, die die Felder f√ºllt.
    // Wir machen das, indem wir das 'input'-Event manuell ausl√∂sen.
    const originalSetzenFunktion = (kunde) => {
        // ... (die Logik zum Setzen der Felder)
        document.getElementById("telefon").value = kunde.Telefon || "";
        // ...
        
        // Manuell das Event ausl√∂sen, damit der Anruf-Button erscheint
        phoneInput.dispatchEvent(new Event('input')); 
    };
    
    // Wir m√ºssen die 'click'-Funktion in 'initializeCustomerSearchListeners' anpassen,
    // damit sie diese Logik verwendet.
}


// ========================================================================
// ===== NEU: UNIVERSALER DATENSCHUTZ- & LADE-CODE                  =====
// ========================================================================

// Die exakte decryptData-Funktion, die in jeder Datei ben√∂tigt wird
async function decryptData(encryptedArrayBuffer, password) {
    const ITERATIONS = 480000, SALT_SIZE_BYTES = 16, NONCE_SIZE_BYTES = 12;
    const salt = encryptedArrayBuffer.slice(0, SALT_SIZE_BYTES);
    const nonce = encryptedArrayBuffer.slice(SALT_SIZE_BYTES, SALT_SIZE_BYTES + NONCE_SIZE_BYTES);
    const data = encryptedArrayBuffer.slice(SALT_SIZE_BYTES + NONCE_SIZE_BYTES);
    const passwordKey = await window.crypto.subtle.importKey('raw', new TextEncoder().encode(password), { name: 'PBKDF2' }, false, ['deriveKey']);
    const aesKey = await window.crypto.subtle.deriveKey({ name: 'PBKDF2', salt: salt, iterations: ITERATIONS, hash: 'SHA-256' }, passwordKey, { name: 'AES-GCM', length: 256 }, true, ['decrypt']);
    const decryptedData = await window.crypto.subtle.decrypt({ name: 'AES-GCM', iv: nonce }, aesKey, data);
    return new TextDecoder().decode(decryptedData);
}

/**
 * Pr√ºft die Authentifizierung, l√§dt und entschl√ºsselt die Kundendaten.
 * Leitet bei fehlender Authentifizierung zur Login-Seite um.
 * Gibt bei Erfolg die entschl√ºsselten und geparsten Kundendaten zur√ºck.
 */
// ========================================================================
// ===== KORRIGIERTE VERSION F√úR DATEIEN IN EINEM UNTERORDNER         =====
// ========================================================================

async function loadProtectedData() {
    // Holt das Passwort aus dem Speicher
    const password = sessionStorage.getItem('customerDataPassword');

    // Pr√ºft, ob ein Passwort vorhanden ist
    if (!password) {
        // WENN NEIN: Leite zum Login im HAUPTORDNER um.
        // Das ist die korrigierte Zeile mit "../"
        window.location.href = '../authentifizierung.html';
        return new Promise(() => {}); 
    }

    // WENN JA: Lade und entschl√ºssele die Daten
    try {
        const kundenSucheInput = document.getElementById('kundenSuche');
        if(kundenSucheInput) kundenSucheInput.placeholder = "Entschl√ºssele Kundendaten...";

        const encryptedFilePath = 'https://volkerkottwitz.github.io/Konfig/Konfigurator/anewstar/Retourenschein/kundenstamm.enc';
        const response = await fetch(encryptedFilePath + '?t=' + new Date( ).getTime());
        
        if (!response.ok) throw new Error('Kundendatei nicht gefunden.');
        
        const encryptedArrayBuffer = await response.arrayBuffer();
        const decryptedCsvText = await decryptData(encryptedArrayBuffer, password);
        
        const parsedData = Papa.parse(decryptedCsvText, { header: true, skipEmptyLines: true, bom: true }).data;
        kunden = parsedData;

                // ========================================================
        // NEUER BLOCK: Fuse.js wird hier initialisiert
        // ========================================================
        const options = {
          keys: ['Name', 'Firma', 'Adresse'], // Felder, die durchsucht werden sollen
          includeScore: true,       // Wichtig, um die Qualit√§t des Treffers zu bewerten
          threshold: 0.4,           // Wie unscharf gesucht wird (0.0 = exakt, 1.0 = alles)
          ignoreLocation: true,     // Sucht im gesamten Text, nicht nur am Anfang
        };
        fuse = new Fuse(kunden, options);
        // ============================================
        
        return kunden;

    } catch (error) {
        // Falls bei der Entschl√ºsselung ein Fehler passiert
        sessionStorage.removeItem('customerDataPassword');
        alert("Fehler bei der Datenentschl√ºsselung. Sie werden zur erneuten Anmeldung weitergeleitet.");
        // Leite auch hier korrekt zum Login im HAUPTORDNER um.
        // Das ist die zweite korrigierte Zeile mit "../"
        window.location.href = '../authentifizierung.html';
        return new Promise(() => {});
    }
}


    async function decryptData(encryptedArrayBuffer, password) {
        const ITERATIONS = 480000, SALT_SIZE_BYTES = 16, NONCE_SIZE_BYTES = 12;
        const salt = encryptedArrayBuffer.slice(0, SALT_SIZE_BYTES);
        const nonce = encryptedArrayBuffer.slice(SALT_SIZE_BYTES, SALT_SIZE_BYTES + NONCE_SIZE_BYTES);
        const data = encryptedArrayBuffer.slice(SALT_SIZE_BYTES + NONCE_SIZE_BYTES);
        const passwordKey = await window.crypto.subtle.importKey('raw', new TextEncoder().encode(password), { name: 'PBKDF2' }, false, ['deriveKey']);
        const aesKey = await window.crypto.subtle.deriveKey({ name: 'PBKDF2', salt: salt, iterations: ITERATIONS, hash: 'SHA-256' }, passwordKey, { name: 'AES-GCM', length: 256 }, true, ['decrypt']);
        const decryptedData = await window.crypto.subtle.decrypt({ name: 'AES-GCM', iv: nonce }, aesKey, data);
        return new TextDecoder().decode(decryptedData);
    }

// ERSETZEN SIE DIE GESAMTE FUNKTION "initializeCustomerSearchListeners" HIERMIT

// ERSETZEN SIE DIE GESAMTE FUNKTION "initializeCustomerSearchListeners" HIERMIT

// ERSETZEN SIE DIE GESAMTE FUNKTION "initializeCustomerSearchListeners" HIERMIT

function initializeCustomerSearchListeners() {
    const kundenSucheInput = document.getElementById('kundenSuche');
    const suchErgebnisseContainer = document.getElementById('suchErgebnisse');
    let activeResultIndex = -1;

    // Diese Funktion ist daf√ºr verantwortlich, die Ergebnisbox zu f√ºllen und anzuzeigen.
    function zeigeSuchErgebnisse(treffer, suchbegriffe, fuseErgebnisse) {
        if (!treffer || treffer.length === 0) {
            suchErgebnisseContainer.innerHTML = '<div class="ergebnis-item no-results">Keine Treffer gefunden</div>';
        } else {
            suchErgebnisseContainer.innerHTML = treffer.map((kunde, index) => {
                const originalIndex = kunden.indexOf(kunde);
                const adresseTeile = kunde.Adresse ? kunde.Adresse.split(",").map(x => x.trim()) : [];
                const ort = adresseTeile[1] || '';
                const plz = adresseTeile[2] || '';
                let label = `${kunde.Name ? kunde.Name.trim() + ' ‚Äì ' : ''}${kunde.Firma ? kunde.Firma.trim() : ''}${(plz || ort) ? ` (${plz} ${ort})` : ''}`;
                
                suchbegriffe.forEach(term => {
                    if (term) { // Sicherheitspr√ºfung
                        label = label.replace(new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), match => `<span class="search-highlight">${match}</span>`);
                    }
                });

                let itemClass = 'ergebnis-item';
                if (index === 0 && fuseErgebnisse && fuseErgebnisse[0] && fuseErgebnisse[0].score < 0.1) {
                    itemClass += ' best-match';
                }

                return `<div class="${itemClass}" data-index="${originalIndex}">${label}</div>`;
            }).join('');
        }
        // Diese Zeile macht die Box sichtbar.
        suchErgebnisseContainer.style.display = 'block';
    }

    // Listener f√ºr die Texteingabe (per Tippen oder Sprache)
    kundenSucheInput.addEventListener('input', function() {
        activeResultIndex = -1;
        const suchbegriff = this.value;

        if (suchbegriff.length < 2) { // Zur√ºck auf 2 Zeichen f√ºr bessere Reaktionsf√§higkeit
            suchErgebnisseContainer.style.display = 'none';
            return;
        }

        const suchTokens = suchbegriff.split(' ').filter(token => token.length > 0);
        const erweiterteSuche = suchTokens.map(token => ({
            $or: [ { Name: token }, { Firma: token }, { Adresse: token } ]
        }));

        const fuseErgebnisse = fuse.search({ $and: erweiterteSuche });
        const treffer = fuseErgebnisse.map(ergebnis => ergebnis.item);

        zeigeSuchErgebnisse(treffer, suchTokens, fuseErgebnisse);
    });

    // Listener f√ºr die Pfeiltasten-Navigation
    kundenSucheInput.addEventListener('keydown', function(e) {
        const ergebnisse = suchErgebnisseContainer.querySelectorAll('.ergebnis-item:not(.no-results)');
        if (ergebnisse.length === 0) return;
        
        function updateActiveResult(ergebnisse) {
            ergebnisse.forEach(item => item.classList.remove('active'));
            if (activeResultIndex > -1) {
                const activeItem = ergebnisse[activeResultIndex];
                activeItem.classList.add('active');
                activeItem.scrollIntoView({ block: 'nearest' });
            }
        }

        switch (e.key) {
            case 'ArrowDown': e.preventDefault(); activeResultIndex = (activeResultIndex + 1) % ergebnisse.length; updateActiveResult(ergebnisse); break;
            case 'ArrowUp': e.preventDefault(); activeResultIndex = (activeResultIndex - 1 + ergebnisse.length) % ergebnisse.length; updateActiveResult(ergebnisse); break;
            case 'Enter': e.preventDefault(); if (activeResultIndex > -1) ergebnisse[activeResultIndex].click(); else if (ergebnisse.length === 1) ergebnisse[0].click(); break;
            case 'Escape': suchErgebnisseContainer.style.display = 'none'; break;
        }
    });

    // Listener f√ºr das Klicken auf ein Suchergebnis
    suchErgebnisseContainer.addEventListener('click', function(e) {
        const ergebnisItem = e.target.closest('.ergebnis-item');
        if (ergebnisItem && ergebnisItem.dataset.index) {
            const kunde = kunden[parseInt(ergebnisItem.dataset.index)];
            
            document.getElementById("name").value = kunde.Name || "";
            document.getElementById("firma").value = kunde.Firma || "";
            
            const adresseTeile = kunde.Adresse ? kunde.Adresse.split(",").map(x => x.trim()) : ["", "", "", ""];
            document.getElementById("strasse").value = adresseTeile[0] || "";
            document.getElementById("ort").value = adresseTeile[1] || "";
            document.getElementById("plz").value = adresseTeile[2] || "";
            document.getElementById("land").value = adresseTeile[3] || "";
            
            document.getElementById("email").value = kunde["E-Mail"] || "";
            
            const telefonInput = document.getElementById("telefon");
            telefonInput.value = kunde.Telefon || "";
            // L√∂st das 'input'-Event aus, damit der Anruf-Button erscheint
            telefonInput.dispatchEvent(new Event('input'));

            kundenSucheInput.value = '';
            suchErgebnisseContainer.style.display = 'none';
        }
    });

    // Listener, um die Ergebnisliste auszublenden, wenn man daneben klickt
    document.addEventListener('click', function(e) {
        if (!kundenSucheInput.contains(e.target) && !suchErgebnisseContainer.contains(e.target)) {
            suchErgebnisseContainer.style.display = 'none';
        }
    });
}



    function setupSpeechRecognition(buttonId, textId, statusId) {
        const aufnahmeButton = document.getElementById(buttonId);
        const zielTextarea = document.getElementById(textId);
        const statusDiv = document.getElementById(statusId);
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            aufnahmeButton.disabled = true;
            statusDiv.textContent = 'Browser unterst√ºtzt Web Speech API nicht.';
            return;
        }
        const recognition = new SpeechRecognition();
        recognition.lang = 'de-DE';
        recognition.continuous = true;
        recognition.interimResults = false;
        aufnahmeButton.addEventListener('click', () => { if (aufnahmeButton.textContent.includes('starten')) recognition.start(); else recognition.stop(); });
        recognition.onstart = () => { aufnahmeButton.textContent = 'Aufnahme stoppen'; aufnahmeButton.classList.add('recording'); statusDiv.textContent = 'H√∂re zu...'; };
        recognition.onend = () => { aufnahmeButton.textContent = 'Aufnahme starten'; aufnahmeButton.classList.remove('recording'); statusDiv.textContent = 'Aufnahme beendet.'; };
        recognition.onerror = (event) => { statusDiv.textContent = 'Fehler: ' + event.error; };
        recognition.onresult = (event) => {
            let transkript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) transkript += event.results[i][0].transcript.trim() + '. ';
            }
            zielTextarea.value += transkript;
        };

    }

        // =================================================================
    // ===== HILFSFUNKTIONEN (HIER WURDE DIE FEHLENDE FUNKTION ERG√ÑNZT) =====
    // =================================================================

    function getSachbearbeiterValue() {
      const dropdown = document.getElementById("sachbearbeiterDropdown");
      const manualInput = document.getElementById("sachbearbeiterManuell");
      return dropdown.value === "manuell" ? manualInput.value || "" : dropdown.value || "";
    }
    
    function getAussendienstmitarbeiterValue() {
      const dropdown = document.getElementById("aussendienstDropdown");
      const manualInput = document.getElementById("aussendienstManuell");
      return dropdown.value === "manuell" ? manualInput.value || "" : dropdown.value || "";
    }

    // HIER IST DIE FEHLENDE FUNKTION:
    function loadImageAsBase64(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          resolve(canvas.toDataURL("image/png"));
        };
        img.onerror = reject;
        img.src = url;
      });
    }


    // --- Angepasste PDF-Generierungsfunktion ---
   // =================================================================
    // ===== PDF-GENERIERUNGSFUNKTION (MIT KORREKTUREN) =====
    // =================================================================

    async function generateBerichtPDF() {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const logoImg = await loadImageAsBase64("https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png" ).catch(() => null);
            
            const margin = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let yPosition = margin;

            function addPageHeader() {
                // KORREKTUR 1: Logo-Dimensionen angepasst (Breite 40, H√∂he 15)
                if (logoImg) doc.addImage(logoImg, "PNG", margin, margin, 40, 30, undefined, 'FAST');
                
                const heute = new Date();
                const datumString = heute.toLocaleDateString("de-DE", { year: "numeric", month: "long", day: "numeric" });
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(datumString, pageWidth - margin, margin + 10, { align: "right" });
                const berichtsNummer = `BER-${heute.toISOString().slice(0, 10).replace(/-/g, '')}-${heute.toTimeString().slice(0, 5).replace(':', '')}`;
                doc.text(`Berichts-Nr: ${berichtsNummer}`, pageWidth - margin, margin + 20, { align: "right" });
            }

            function checkPageBreak(neededSpace) {
                if (yPosition + neededSpace > pageHeight - margin) {
                    doc.addPage();
                    yPosition = margin;
                    addPageHeader();
                    yPosition += 30; // Platz f√ºr Header auf neuer Seite
                }
            }

            addPageHeader();
            yPosition += 40; // Etwas weniger Platz nach dem Header

            const mainTitle = document.getElementById("mainTitleInput").value || "Bericht";
            doc.setFontSize(20);
            doc.setTextColor(0);
            doc.setFont("helvetica", "bold");
            doc.text(mainTitle.toUpperCase(), pageWidth / 2, yPosition, { align: "center" });
            yPosition += 20;

            function drawSection(title, data) {
                checkPageBreak(20 + data.length * 6);
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(0, 161, 225);
                doc.text(title, margin, yPosition);
                yPosition += 10;
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0);
                data.forEach(item => {
                    const splitItem = doc.splitTextToSize(item, pageWidth - 2 * margin - 35); // Textumbruch f√ºr lange Werte
                    doc.text(splitItem, margin, yPosition);
                    yPosition += splitItem.length * 5;
                });
                yPosition += 5; // Etwas weniger Abstand nach der Sektion
            }

            // KORREKTUR 2: Reihenfolge ge√§ndert (Kunde zuerst)
            drawSection("KUNDE", [
                `${document.getElementById("firma").value || 'N/A'}`,
                `${document.getElementById("name").value || 'N/A'}`,
                `${document.getElementById("strasse").value || 'N/A'}`,
                `${document.getElementById("ort").value} ${document.getElementById("plz").value}`,
                `${document.getElementById("email").value || 'N/A'}`,
                `${document.getElementById("telefon").value || 'N/A'}`
            ]);

            drawSection("BEARBEITUNG", [
                `Innendienst: ${getSachbearbeiterValue() || 'N/A'}`,
                `Ausgestellt von: ${getAussendienstmitarbeiterValue() || 'N/A'}`
            ]);

            const berichtInhalt = document.getElementById('bericht-text').value;
            if (berichtInhalt.trim()) {
                checkPageBreak(30);
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(0, 161, 225);
                doc.text("BERICHTSINHALT", margin, yPosition);
                yPosition += 10;
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0);
                const splitBericht = doc.splitTextToSize(berichtInhalt, pageWidth - 2 * margin);
                checkPageBreak(splitBericht.length * 5);
                doc.text(splitBericht, margin, yPosition);
                yPosition += splitBericht.length * 5 + 10;
            }

            const aufgabenInhalt = document.getElementById('aufgaben-text').value;
            if (aufgabenInhalt.trim()) {
                checkPageBreak(30);
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(0, 161, 225);
                doc.text("ZU ERLEDIGENDE AUFGABEN", margin, yPosition);
                yPosition += 10;
                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0);
                const splitAufgaben = doc.splitTextToSize(aufgabenInhalt, pageWidth - 2 * margin);
                checkPageBreak(splitAufgaben.length * 5);
                doc.text(splitAufgaben, margin, yPosition);
            }

            const firmaName = (document.getElementById("firma").value || "Bericht").replace(/[^a-zA-Z0-9]/g, "-");
            const datumForFilename = new Date().toISOString().split('T')[0];
            doc.save(`${firmaName}_${datumForFilename}.pdf`);

        } catch (error) {
            console.error("Fehler bei der PDF-Erstellung:", error);
            alert("Fehler bei der PDF-Erstellung. Bitte Konsole pr√ºfen: " + error.message);
        }
    }
  </script>

  <section class="form-section-container" style="text-align: center; box-shadow: none; border: none; background: none;">
  <button onclick="generateBerichtPDF()" class="btn btn-primary" style="padding: 15px 30px; font-size: 1.2rem;">
    Bericht als PDF
  </button>
</section>

</body>
</html>
