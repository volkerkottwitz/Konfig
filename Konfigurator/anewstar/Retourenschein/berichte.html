<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bericht erstellen</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="interneAnfrage.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    /* ===================================================================== */
    /* ===== BERICHTE.HTML - FINALES, VEREINHEITLICHTES CSS (v1.2) ===== */
    /* ===================================================================== */

    /* --- 1. Grundlegende Layout-Stile (aus berichte.html) --- */
    .form-section-container { border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin: 25px auto; background-color: #fdfdfd; max-width: 900px; }
    .form-section-container h3 { text-align: center; margin-top: 0; margin-bottom: 25px; padding-bottom: 10px; color: #00a1e1; font-size: 1.3em; }
    .centered-form-layout { display: flex; flex-direction: column; align-items: center; gap: 15px; }
    .centered-form-layout > * { width: 100%; max-width: 500px; }

    /* --- 2. Suchergebnisse & Highlight (aus berichte.html) --- */
    .search-wrapper { position: relative; }
    #suchErgebnisse { position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; background-color: white; border: 1px solid #ddd; border-radius: 0 0 8px 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); max-height: 300px; overflow-y: auto; }
    .ergebnis-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #eee; }
    .ergebnis-item:last-child { border-bottom: none; }
    .ergebnis-item:hover { background-color: #f0f8ff; }
    .ergebnis-item.active { background-color: #e6f7ff; }
    .search-highlight { background-color: rgba(0, 0, 0, 0.2); font-weight: bold; border-radius: 3px; padding: 0 2px; }

    /* --- 3. NEU: EINHEITLICHE STILE F√úR ALLE FORMULARFELDER (aus retourenschein.html) --- */
    .centered-form-layout input[type="text"],
    .centered-form-layout input[type="tel"],
    .centered-form-layout .select2-container,
    #bericht-text, 
    #aufgaben-text {
        height: 45px;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 0 20px;
        font-size: 16px;
        box-sizing: border-box;
        transition: all 0.2s ease-in-out;
        width: 100%;
        max-width: 500px;
        font-family: 'Roboto', sans-serif;
        color: #333;
        background-color: white;
    }

    /* --- 4. NEU: DER "NUKLEARE RESET" F√úR SELECT2-DROPDOWNS (aus retourenschein.html) --- */
    .select2-container--default .select2-selection--single { background-color: transparent !important; border: none !important; border-radius: 0 !important; padding: 0 !important; height: auto !important; }
    .centered-form-layout .select2-container { display: flex !important; align-items: center !important; position: relative; }
    .centered-form-layout .select2-container .select2-selection__rendered { padding: 0 !important; color: #333 !important; margin-top: 1px; }
    .centered-form-layout .select2-container--default .select2-selection__arrow { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); height: auto !important; width: auto !important; }
    .select2-container *:focus { outline: none !important; }

    /* --- 5. NEU: EINHEITLICHER FOKUS-EFFEKT (aus retourenschein.html) --- */
    .centered-form-layout input[type="text"]:focus,
    .centered-form-layout input[type="tel"]:focus,
    .centered-form-layout .select2-container.select2-container--open,
    .centered-form-layout .select2-container:focus-within,
    #bericht-text:focus,
    #aufgaben-text:focus {
        outline: none !important;
        border-color: #00a1e1 !important;
        box-shadow: 0 0 0 3px rgba(0, 161, 225, 0.25) !important;
    }

    /* --- 6. SPEZIELLE LAYOUT-GRUPPEN (aus berichte.html, angepasst) --- */
    .search-input-group, .phone-group, .form-row {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        max-width: 500px;
    }
    .search-input-group input, .phone-group input, .form-row input {
        flex-grow: 1;
    }
    .form-row #plz { flex: 1; }
    .form-row #ort { flex: 2; }

    /* --- 7. ICON-BUTTONS (aus berichte.html, angepasst) --- */
    .icon-button {
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
        width: 45px; /* H√∂he an Felder angepasst */
        height: 45px; /* H√∂he an Felder angepasst */
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 50%;
        font-size: 1.4rem;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .icon-button:hover { background-color: #007bff; color: white; }
    #speech-search-button.is-listening { background-color: #dc3545; color: white; }

    /* --- 8. SPRACHEINGABE-SEKTIONEN (NEU & VERBESSERT) --- */

    /* Stellt sicher, dass die Beschreibungstexte zentriert sind */
    .centered-form-layout p {
        text-align: center;
        margin-bottom: 10px;
        color: #666;
    }

    /* Vereinheitlicht das Design der Textareas mit den anderen Feldern */
    #bericht-text, 
    #aufgaben-text {
        height: 200px; /* H√∂he f√ºr das gro√üe Textfeld */
        padding: 15px 20px; /* Mehr Innenabstand f√ºr Text */
        line-height: 1.5; /* Besserer Zeilenabstand */
        /* Die Breite wird bereits durch .centered-form-layout > * gesetzt */
        max-width: 700px
    }
    #aufgaben-text { 
        height: 120px; /* Kleinere H√∂he f√ºr das Aufgabenfeld */
    }

    /* Stile f√ºr die Aufnahme-Buttons */
    .aufnahme-button {
        padding: 10px 25px;
        font-size: 1rem;
        cursor: pointer;
        border: none;
        border-radius: 8px; /* Gleicher Radius wie die Felder */
        background-color: #28a745; /* Gr√ºn f√ºr "Start" */
        color: white;
        transition: background-color 0.3s;
        /* Wir geben dem Button eine feste, aber nicht zu breite Gr√∂√üe */
        width: 100%;
        max-width: 250px; 
    }
    .aufnahme-button:hover { 
        background-color: #218838; 
    }
    .aufnahme-button.recording { 
        background-color: #dc3545; /* Rot f√ºr "Recording" */
    }

    /* Status-Text unter dem Button */
    .aufnahme-status {
        color: #665;
        min-height: 20px;
        margin-top: -5px; /* R√ºcken wir etwas n√§her an den Button */
        margin-bottom: 5px;
    }

    /* --- 9. GLOBALE HELFER & MOBILE OPTIMIERUNG --- */
    ::selection { background-color: #00a1e1; color: #ffffff; }

    @media (max-width: 768px) {
      /* Sorgt f√ºr mehr seitlichen Abstand auf kleinen Bildschirmen */
      .form-section-container, #spracheingabe-container, #aufgaben-container { 
        margin-left: 10px; 
        margin-right: 10px; 
      }

      /* ===== HIER SIND DIE NEUEN REGELN ===== */

      /* 1. Stapelt die Elemente in den Layout-Gruppen untereinander */
      .search-input-group, 
      .phone-group, 
      .form-row {
        flex-direction: column; /* √Ñndert die Ausrichtung von nebeneinander zu untereinander */
        gap: 15px; /* Beh√§lt einen sch√∂nen Abstand zwischen den gestapelten Elementen bei */
      }

      /* 2. Sorgt daf√ºr, dass die runden Icon-Buttons zentriert und nicht zu gro√ü sind */
      .search-input-group .icon-button,
      .phone-group .icon-button {
        width: 60px;  /* Gibt dem Button eine feste, gut klickbare Gr√∂√üe */
        height: 60px;
        font-size: 1.8rem;
        align-self: center; /* Zentriert den Button horizontal */
      }
    }

   
</style>

</head>
<body>
  <header id="header">
    <div class="header-left">
      <img src="https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png" alt="Firmenlogo">
    </div>
    <div class="header-content">
      <input type="text" id="mainTitleInput" value="Besuchsbericht" class="editable-title">
      <div class="header-date" id="heute"></div>
    </div>
    <div class="header-right">
      <div class="buttons">
        <button onclick="window.close( )" class="btn btn-secondary">üîô Zur√ºck</button>
        <button onclick="generateBerichtPDF()" class="btn btn-primary">Bericht als PDF</button>
      </div>
    </div>
  </header>

  <section class="form-section-container">
    <h3>Kundendaten</h3>
<!-- ======================================================= -->
<!-- ===== NEU: Logisches, einspaltiges Adress-Layout    ===== -->
<!-- ======================================================= -->
<div id="kundenDetails" class="centered-form-layout">

    <!-- Suchleiste bleibt oben -->
    <div class="search-wrapper">
        <div class="search-input-group">
            <!-- Hinzugef√ºgt: autocomplete="new-password" -->
            <input type="text" id="kundenSuche" placeholder="Lade Kundenliste..." disabled autocomplete="new-password">
            <button id="speech-search-button" class="icon-button" title="Suche per Sprache">üé§</button>
        </div>
        <div id="suchErgebnisse" style="display: none;"></div>
    </div>

    <!-- Neue, logische Reihenfolge der Felder -->
    <!-- Hinzugef√ºgt: autocomplete="new-password" -->
    <input type="text" id="firma" placeholder="Firma" autocomplete="new-password">
    <input type="text" id="name" placeholder="Ansprechpartner" autocomplete="new-password">

    <!-- Das Stra√üen-Feld steht f√ºr sich allein und braucht keinen extra Container -->
    <input type="text" id="strasse" placeholder="Stra√üe und Hausnummer" autocomplete="new-password">

    <!-- NUR die Felder, die nebeneinander sollen, kommen in einen form-row Container -->
    <div class="form-row">
        <input type="text" id="plz" placeholder="PLZ" autocomplete="new-password">
        <input type="text" id="ort" placeholder="Ort" autocomplete="new-password">
    </div>

    
    <!-- Hinzugef√ºgt: autocomplete="new-password" -->
    <input type="text" id="land" placeholder="Land" autocomplete="new-password">
    <input type="text" id="email" placeholder="E-Mail" autocomplete="new-password">

    <!-- Telefon-Gruppe bleibt unver√§ndert -->
    <div class="phone-group">
        <!-- Hinzugef√ºgt: autocomplete="new-password" -->
        <input type="text" id="telefon" placeholder="Telefon" autocomplete="new-password">
        <button id="call-button" class="icon-button" title="Kunden anrufen" style="display: none;">üìû</button>
    </div>

    <!-- Hinzugef√ºgt: autocomplete="new-password" -->
    <input type="text" id="kundennummer" placeholder="Kundennummer (optional)" autocomplete="new-password">
</div>


</div>

  </section>

  <section class="form-section-container">
    <h3>Bearbeitung</h3>
    <div class="centered-form-layout">
      <select id="sachbearbeiterDropdown">
        <option value="">-- Innendienst ausw√§hlen --</option>
        <option value="Denise Otto">Denise Otto</option>
        <option value="Sascha Heusel">Sascha Heusel</option>
        <option value="Nadine Suhr">Nadine Suhr</option>
        <option value="Diana Kahlert">Diana Kahlert</option>
        <option value="Nils Vokuhl">Nils Vokuhl</option>
        <option value="Claudia Batke">Claudia Batke</option>
        <option value="Karsten Walter">Karsten Walter</option>
        <option value="manuell">-- Manuelle Eingabe --</option>
      </select>
      <input type="text" id="sachbearbeiterManuell" placeholder="Sachbearbeiter (manuell)" style="display: none;">
      <select id="aussendienstDropdown">
        <option value="">-- Au√üendienst ausw√§hlen --</option>
        <option value="Rafael Furtw√§ngler">Rafael Furtw√§ngler</option>
        <option value="Christof M√ºnster">Christof M√ºnster</option>
        <option value="Sascha Heusel">Sascha Heusel</option>
        <option value="Bernhard Kneissl">Bernhard Kneissl</option>
        <option value="Christopher-Sean Haus">Christopher-Sean Haus</option>
        <option value="Sascha Barkowsky">Sascha Barkowsky</option>
        <option value="Volker Kottwitz">Volker Kottwitz</option>
        <option value="Volker Oesterwind">Volker Oesterwind</option>
        <option value="Thomas Sch√∂nf√º√ü">Thomas Sch√∂nf√º√ü</option>
        <option value="Thomas Wendt">Thomas Wendt</option>
        <option value="Harald Natzke">Harald Natzke</option>
        <option value="Lukas Pfeil">Lukas Pfeil</option>
        <option value="Nancy Ullbricht">Nancy Ullbricht</option>
        <option value="Heiner Birkholz">Heiner Birkholz</option>
        <option value="Helmut W√∂lfel">Helmut W√∂lfel</option>
        <option value="manuell">-- Manuelle Eingabe --</option>
      </select>
      <input type="text" id="aussendienstManuell" placeholder="Au√üendienstmitarbeiter (manuell)" style="display: none;">
    </div>
  </section>

  <!-- ================================================================== -->
  <!-- ===== NEUE, VERBESSERTE SPRACHEINGABE-SEKTIONEN (im Kasten-Design) ===== -->
  <!-- ================================================================== -->

  <!-- Sektion 1: Berichtsinhalt -->
  <section class="form-section-container">
    <h3>Berichtsinhalt per Sprache eingeben</h3>
    <div class="centered-form-layout">
      <p style="text-align: center; margin-bottom: 10px;">Klicken Sie auf "Aufnahme starten" und diktieren Sie Ihren Bericht.</p>
      <button id="aufnahme-button-bericht" class="aufnahme-button">Aufnahme starten</button>
      <div id="aufnahme-status-bericht" class="aufnahme-status"></div>
      <textarea id="bericht-text" placeholder="Ihr diktierter Bericht erscheint hier..."></textarea>
    </div>
  </section>

  <!-- Sektion 2: Aufgaben -->
  <section class="form-section-container">
    <h3>Zu erledigende Aufgaben</h3>
    <div class="centered-form-layout">
      <p style="text-align: center; margin-bottom: 10px;">Diktieren Sie hier die Aufgaben, die sich aus dem Gespr√§ch ergeben haben.</p>
      <button id="aufnahme-button-aufgaben" class="aufnahme-button">Aufnahme starten</button>
      <div id="aufnahme-status-aufgaben" class="aufnahme-status"></div>
      <textarea id="aufgaben-text" placeholder="Ihre diktierten Aufgaben erscheinen hier..."></textarea>
    </div>
  </section>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>


  <script>
    let kunden = [];
    let fuse; // NEUE ZEILE

// ========================================================================
// ===== NEU: ANGEPASSTER STARTPUNKT DER SEITE                      =====
// ========================================================================

document.addEventListener("DOMContentLoaded", async () => {
    // Diese Funktionen sind unabh√§ngig und k√∂nnen sofort ausgef√ºhrt werden.
    displayCurrentDate();
    initializeDropdowns();
    initializeSpeechRecognition();
    initializeSpeechSearch();
    initializePhoneLink();

    try {
        // 1. Starte den Lade- und Schutzprozess und warte auf das Ergebnis.
        const isLoginSuccessful = await loadProtectedData();

        // 2. Wenn der Login erfolgreich war, aktiviere die abh√§ngigen Funktionen.
        if (isLoginSuccessful) {
            console.log(`Schutzpr√ºfung bestanden. ${kunden.length} Kunden geladen.`);

            // Elemente holen
            const kundenSucheInput = document.getElementById('kundenSuche');
            const speechButton = document.getElementById('speech-search-button');

            // Suchfeld aktivieren
            kundenSucheInput.disabled = false;
            kundenSucheInput.placeholder = "üîç Kunde, Firma, PLZ oder Ort suchen...";
            
            // Mikrofon-Button aktivieren
            if (speechButton) {
                speechButton.disabled = false;
                speechButton.style.cursor = 'pointer';
                speechButton.style.opacity = '1';
            }

            kundenSucheInput.focus();
            
            // Die Such-Listener k√∂nnen jetzt sicher initialisiert werden.
            initializeCustomerSearchListeners();
        }

    } catch (error) {
        // Dieser Block wird nur bei wirklich unerwarteten Fehlern ausgef√ºhrt,
        // da die typischen Fehler (falsches Passwort etc.) schon in loadProtectedData() behandelt werden.
        console.error("Ein schwerwiegender Fehler ist beim Seitenaufbau aufgetreten:", error);
        document.body.innerHTML = "<h2>Ein kritischer Fehler ist aufgetreten. Bitte laden Sie die Seite neu.</h2>";
    }
});

    function displayCurrentDate() {
      const today = new Date();
      const options = { year: "numeric", month: "long", day: "numeric" };
      document.getElementById("heute").textContent = today.toLocaleDateString("de-DE", options);
    }

    function initializeDropdowns() {
      $("#sachbearbeiterDropdown").select2({ placeholder: "-- Innendienst ausw√§hlen --", allowClear: true });
      $("#aussendienstDropdown").select2({ placeholder: "-- Au√üendienst ausw√§hlen --", allowClear: true });
      $("#sachbearbeiterDropdown").on("change", function () { handleManualInput(this, document.getElementById("sachbearbeiterManuell")); });
      $("#aussendienstDropdown").on("change", function () { handleManualInput(this, document.getElementById("aussendienstManuell")); });
    }
    
    function initializeSpeechRecognition() {
        setupSpeechRecognition('aufnahme-button-bericht', 'bericht-text', 'aufnahme-status-bericht');
        setupSpeechRecognition('aufnahme-button-aufgaben', 'aufgaben-text', 'aufnahme-status-aufgaben');
    }

    function handleManualInput(dropdown, manualInput) {
      manualInput.style.display = dropdown.value === "manuell" ? "block" : "none";
      if (dropdown.value === "manuell") manualInput.focus(); else manualInput.value = "";
    }


    // F√úGEN SIE DIESE NEUE FUNKTION HINZU

function initializeSpeechSearch() {
    const searchButton = document.getElementById('speech-search-button');
    const searchInput = document.getElementById('kundenSuche');
    if (!searchButton) return;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        searchButton.style.display = 'none';
        return;
    }
    const recognition = new SpeechRecognition();
    recognition.lang = 'de-DE';
    recognition.continuous = false;
    recognition.interimResults = false;

    searchButton.addEventListener('click', () => {
        if (searchInput.disabled) {
            alert("Bitte warten Sie, bis die Kundendaten geladen sind.");
            return;
        }
        recognition.start();
    });

    recognition.onstart = () => {
        searchButton.classList.add('is-listening');
        searchInput.placeholder = 'H√∂re zu...';
    };
    recognition.onend = () => {
        searchButton.classList.remove('is-listening');
        searchInput.placeholder = 'üîç Kunde, Firma, PLZ oder Ort suchen...';
    };
    recognition.onerror = (event) => {
        alert('Fehler bei der Spracherkennung: ' + event.error);
    };
    recognition.onresult = (event) => {
        // Wichtig: Hier wird KEIN Punkt hinzugef√ºgt.
        const suchtext = event.results[0][0].transcript;
        searchInput.value = suchtext;

        // L√∂st die Suche aus
        const inputEvent = new Event('input', { bubbles: true });
        searchInput.dispatchEvent(inputEvent);
    };
}


// F√úGEN SIE DIESE NEUE FUNKTION ZU IHREM SCRIPT HINZU

function initializePhoneLink() {
    const phoneInput = document.getElementById('telefon');
    const callButton = document.getElementById('call-button');

    // Diese Funktion wird aufgerufen, wenn sich der Inhalt des Telefonfeldes √§ndert
    const updateCallButton = () => {
        const phoneNumber = phoneInput.value.trim();
        if (phoneNumber) {
            callButton.style.display = 'flex'; // Button anzeigen
        } else {
            callButton.style.display = 'none'; // Button ausblenden
        }
    };

    // Event-Listener, der bei jeder √Ñnderung im Feld pr√ºft, ob der Button angezeigt werden soll
    phoneInput.addEventListener('input', updateCallButton);

    // Event-Listener f√ºr den Klick auf den Anruf-Button
    callButton.addEventListener('click', () => {
        let phoneNumber = phoneInput.value.trim();
        // Bereinigt die Nummer von Leerzeichen, Klammern etc. und f√ºgt das "tel:"-Pr√§fix hinzu
        let telLink = 'tel:' + phoneNumber.replace(/[\s\(\)\-\/]/g, '');
        
        // √ñffnet den Link (auf dem Handy die Telefon-App, auf dem Desktop z.B. Teams, Skype etc.)
        window.location.href = telLink;
    });

    // Wir m√ºssen auch daf√ºr sorgen, dass der Button erscheint, wenn ein Kunde ausgew√§hlt wird.
    // Dazu erweitern wir die Funktion, die die Felder f√ºllt.
    // Wir machen das, indem wir das 'input'-Event manuell ausl√∂sen.
    const originalSetzenFunktion = (kunde) => {
        // ... (die Logik zum Setzen der Felder)
        document.getElementById("telefon").value = kunde.Telefon || "";
        // ...
        
        // Manuell das Event ausl√∂sen, damit der Anruf-Button erscheint
        phoneInput.dispatchEvent(new Event('input')); 
    };
    
    // Wir m√ºssen die 'click'-Funktion in 'initializeCustomerSearchListeners' anpassen,
    // damit sie diese Logik verwendet.
}


// ========================================================================
// ===== FINALE, PASSIVE LADE-LOGIK F√úR DIESE SEITE                 =====
// ========================================================================

// ========================================================================
// ===== ANGEPASSTE VERSION: UNIVERSALER DATENSCHUTZ- & LADE-CODE     =====
// ========================================================================

async function loadProtectedData() {
    // 1. Versuche, das Passwort aus dem aktuellen localStorage zu lesen
    let password = localStorage.getItem('customerDataPassword');

    // 2. Wenn nicht gefunden, pr√ºfe, ob es im URL-Hash √ºbergeben wurde
    if (!password && window.location.hash.includes('password=')) {
        const urlHash = window.location.hash.substring(1);
        const params = new URLSearchParams(urlHash);
        password = params.get('password');
        
        if (password) {
            localStorage.setItem('customerDataPassword', password);
            history.replaceState(null, '', window.location.pathname + window.location.search);
        }
    }

// Hilfsfunktion, um Suchfeld UND Mikrofon zu deaktivieren
function disableSearch(message) {
    const kundenSucheInput = document.getElementById('kundenSuche');
    const speechButton = document.getElementById('speech-search-button'); // Mikrofon-Button holen

    if (kundenSucheInput) {
        kundenSucheInput.disabled = true;
        kundenSucheInput.placeholder = message;
    }
    if (speechButton) {
        speechButton.disabled = true; // Button deaktivieren
        speechButton.style.cursor = 'not-allowed'; // Mauszeiger √§ndern
        speechButton.style.opacity = '0.5'; // Visuell ausgrauen
    }
}

    // 3. FINALE PR√úFUNG: Wenn wir jetzt immer noch kein Passwort haben...
    if (!password) {
        console.log("Kein Passwort gefunden. Kundensuche wird deaktiviert.");
        disableSearch("F√ºr Kundensuche bitte anmelden");
        return false; // <-- WICHTIG: Signal f√ºr Fehlschlag zur√ºckgeben
    }

    // 4. Wenn wir hier ankommen, haben wir ein Passwort. Lade und entschl√ºssele die Daten.
    try {
        const kundenSucheInput = document.getElementById('kundenSuche');
        if(kundenSucheInput) kundenSucheInput.placeholder = "Entschl√ºssele Kundendaten...";

        const encryptedFilePath = 'https://volkerkottwitz.github.io/Konfig/Konfigurator/anewstar/Retourenschein/kundenstamm.enc';
        const response = await fetch(encryptedFilePath + '?t=' + new Date( ).getTime());
        
        if (!response.ok) throw new Error('Kundendatei nicht gefunden.');
        
        const encryptedArrayBuffer = await response.arrayBuffer();
        const decryptedCsvText = await decryptData(encryptedArrayBuffer, password);
        
        kunden = Papa.parse(decryptedCsvText, { header: true, skipEmptyLines: true, bom: true }).data;
        
        const options = { keys: ['Name', 'Firma', 'Adresse'], includeScore: true, threshold: 0.4, ignoreLocation: true };
        fuse = new Fuse(kunden, options);
        
        return true; // <-- WICHTIG: Signal f√ºr Erfolg zur√ºckgeben

    } catch (error) {
        console.error("Fehler bei der Datenentschl√ºsselung:", error);
        localStorage.removeItem('customerDataPassword');
        disableSearch("Anmeldung fehlgeschlagen. Bitte neu anmelden.");
        return false; // <-- WICHTIG: Signal f√ºr Fehlschlag zur√ºckgeben
    }
}


// Die exakte decryptData-Funktion, die in jeder Datei ben√∂tigt wird
async function decryptData(encryptedArrayBuffer, password) {
    const ITERATIONS = 480000, SALT_SIZE_BYTES = 16, NONCE_SIZE_BYTES = 12;
    const salt = encryptedArrayBuffer.slice(0, SALT_SIZE_BYTES);
    const nonce = encryptedArrayBuffer.slice(SALT_SIZE_BYTES, SALT_SIZE_BYTES + NONCE_SIZE_BYTES);
    const data = encryptedArrayBuffer.slice(SALT_SIZE_BYTES + NONCE_SIZE_BYTES);
    const passwordKey = await window.crypto.subtle.importKey('raw', new TextEncoder().encode(password), { name: 'PBKDF2' }, false, ['deriveKey']);
    const aesKey = await window.crypto.subtle.deriveKey({ name: 'PBKDF2', salt: salt, iterations: ITERATIONS, hash: 'SHA-256' }, passwordKey, { name: 'AES-GCM', length: 256 }, true, ['decrypt']);
    const decryptedData = await window.crypto.subtle.decrypt({ name: 'AES-GCM', iv: nonce }, aesKey, data);
    return new TextDecoder().decode(decryptedData);
}



// ERSETZEN SIE DIE GESAMTE FUNKTION "initializeCustomerSearchListeners" HIERMIT

// ===== FINALE, PERFORMANTE SUCHFUNKTION MIT DEBOUNCING =====

function initializeCustomerSearchListeners() {
    const kundenSucheInput = document.getElementById('kundenSuche');
    const suchErgebnisseContainer = document.getElementById('suchErgebnisse');
    let activeResultIndex = -1;
    let debounceTimer; // Timer f√ºr das Debouncing

    // --- HILFSFUNKTIONEN ---

    function updateActiveResult(ergebnisse) {
        // ... (Diese Funktion bleibt unver√§ndert)
        ergebnisse.forEach(item => item.classList.remove('active'));
        if (activeResultIndex > -1) {
            const activeItem = ergebnisse[activeResultIndex];
            activeItem.classList.add('active');
            activeItem.scrollIntoView({ block: 'nearest' });
        }
    }

    function zeigeSuchErgebnisse(treffer, suchbegriffe, fuseErgebnisse) {
        // ... (Diese Funktion bleibt unver√§ndert)
        if (!treffer || treffer.length === 0) {
            suchErgebnisseContainer.innerHTML = '<div class="ergebnis-item no-results">Keine Treffer gefunden</div>';
        } else {
            suchErgebnisseContainer.innerHTML = treffer.map((kunde, index) => {
                const originalIndex = kunden.indexOf(kunde);
                const adresseTeile = kunde.Adresse ? kunde.Adresse.split(",").map(x => x.trim()) : [];
                const ort = adresseTeile[1] || '';
                const plz = adresseTeile[2] || '';
                let label = `${kunde.Name ? kunde.Name.trim() + ' ‚Äì ' : ''}${kunde.Firma ? kunde.Firma.trim() : ''}${(plz || ort) ? ` (${plz} ${ort})` : ''}`;
                
                suchbegriffe.forEach(term => {
                    if (term) {
                        label = label.replace(new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), match => `<span class="search-highlight">${match}</span>`);
                    }
                });

                let itemClass = 'ergebnis-item';
                if (index === 0 && fuseErgebnisse && fuseErgebnisse[0] && fuseErgebnisse[0].score < 0.1) {
                    itemClass += ' best-match';
                }

                return `<div class="${itemClass}" data-index="${originalIndex}">${label}</div>`;
            }).join('');
        }
        suchErgebnisseContainer.style.display = 'block';
    }

    // --- EVENT-LISTENER MIT DEBOUNCING ---

    kundenSucheInput.addEventListener('input', function() {
        // L√∂sche den alten Timer bei jeder neuen Eingabe
        clearTimeout(debounceTimer);
        
        const suchbegriff = this.value;

        // Starte einen neuen Timer
        debounceTimer = setTimeout(() => {
            activeResultIndex = -1;
            if (suchbegriff.length < 2) {
                suchErgebnisseContainer.style.display = 'none';
                return;
            }
            const suchTokens = suchbegriff.split(' ').filter(token => token.length > 0);
            const erweiterteSuche = suchTokens.map(token => ({ $or: [ { Name: token }, { Firma: token }, { Adresse: token } ] }));
            const fuseErgebnisse = fuse.search({ $and: erweiterteSuche });
            const treffer = fuseErgebnisse.map(ergebnis => ergebnis.item);
            zeigeSuchErgebnisse(treffer, suchTokens, fuseErgebnisse);
        }, 300); // Warte 300 Millisekunden nach der letzten Eingabe
    });

    // Die anderen Listener bleiben unver√§ndert
    kundenSucheInput.addEventListener('keydown', function(e) {
        const ergebnisse = suchErgebnisseContainer.querySelectorAll('.ergebnis-item:not(.no-results)');
        if (ergebnisse.length === 0) return;
        
        switch (e.key) {
            case 'ArrowDown': e.preventDefault(); activeResultIndex = (activeResultIndex + 1) % ergebnisse.length; updateActiveResult(ergebnisse); break;
            case 'ArrowUp': e.preventDefault(); activeResultIndex = (activeResultIndex - 1 + ergebnisse.length) % ergebnisse.length; updateActiveResult(ergebnisse); break;
            case 'Enter': e.preventDefault(); if (activeResultIndex > -1) ergebnisse[activeResultIndex].click(); else if (ergebnisse.length === 1) ergebnisse[0].click(); break;
            case 'Escape': suchErgebnisseContainer.style.display = 'none'; break;
        }
    });

suchErgebnisseContainer.addEventListener('click', function(e) {
    const ergebnisItem = e.target.closest('.ergebnis-item');
    if (ergebnisItem && ergebnisItem.dataset.index) {
        const kunde = kunden[parseInt(ergebnisItem.dataset.index)];
        
        // Bestehende Felder bef√ºllen (unver√§ndert)
        document.getElementById("name").value = kunde.Name || "";
        document.getElementById("firma").value = kunde.Firma || "";
        const adresseTeile = kunde.Adresse ? kunde.Adresse.split(",").map(x => x.trim()) : ["", "", "", ""];
        document.getElementById("strasse").value = adresseTeile[0] || "";
        // ===== HIER IST DIE KORREKTUR =====
        // Wir weisen die Daten jetzt den korrekten Feldern zu
        document.getElementById("plz").value = adresseTeile[1] || ""; // PLZ kommt in das PLZ-Feld
        document.getElementById("ort").value = adresseTeile[2] || ""; // Ort kommt in das Ort-Feld
        document.getElementById("land").value = adresseTeile[3] || "";
        document.getElementById("email").value = kunde["E-Mail"] || "";
        const telefonInput = document.getElementById("telefon");
        telefonInput.value = kunde.Telefon || "";
        telefonInput.dispatchEvent(new Event('input'));

        // ===== NEU: Kundennummer in das unsichtbare Feld eintragen =====
        document.getElementById("kundennummer").value = kunde.Kundennummer || "";

        // Rest der Funktion (unver√§ndert)
        kundenSucheInput.value = '';
        suchErgebnisseContainer.style.display = 'none';
    }
});


    document.addEventListener('click', function(e) {
        // ... (Dieser Block bleibt unver√§ndert)
        if (!kundenSucheInput.contains(e.target) && !suchErgebnisseContainer.contains(e.target)) {
            suchErgebnisseContainer.style.display = 'none';
        }
    });
}



    function setupSpeechRecognition(buttonId, textId, statusId) {
        const aufnahmeButton = document.getElementById(buttonId);
        const zielTextarea = document.getElementById(textId);
        const statusDiv = document.getElementById(statusId);
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            aufnahmeButton.disabled = true;
            statusDiv.textContent = 'Browser unterst√ºtzt Web Speech API nicht.';
            return;
        }
        const recognition = new SpeechRecognition();
        recognition.lang = 'de-DE';
        recognition.continuous = true;
        recognition.interimResults = false;
        aufnahmeButton.addEventListener('click', () => { if (aufnahmeButton.textContent.includes('starten')) recognition.start(); else recognition.stop(); });
        recognition.onstart = () => { aufnahmeButton.textContent = 'Aufnahme stoppen'; aufnahmeButton.classList.add('recording'); statusDiv.textContent = 'H√∂re zu...'; };
        recognition.onend = () => { aufnahmeButton.textContent = 'Aufnahme starten'; aufnahmeButton.classList.remove('recording'); statusDiv.textContent = 'Aufnahme beendet.'; };
        recognition.onerror = (event) => { statusDiv.textContent = 'Fehler: ' + event.error; };
        recognition.onresult = (event) => {
            let transkript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) transkript += event.results[i][0].transcript.trim() + '. ';
            }
            zielTextarea.value += transkript;
        };

    }

        // =================================================================
    // ===== HILFSFUNKTIONEN (HIER WURDE DIE FEHLENDE FUNKTION ERG√ÑNZT) =====
    // =================================================================

    function getSachbearbeiterValue() {
      const dropdown = document.getElementById("sachbearbeiterDropdown");
      const manualInput = document.getElementById("sachbearbeiterManuell");
      return dropdown.value === "manuell" ? manualInput.value || "" : dropdown.value || "";
    }
    
    function getAussendienstmitarbeiterValue() {
      const dropdown = document.getElementById("aussendienstDropdown");
      const manualInput = document.getElementById("aussendienstManuell");
      return dropdown.value === "manuell" ? manualInput.value || "" : dropdown.value || "";
    }

    // HIER IST DIE FEHLENDE FUNKTION:
    function loadImageAsBase64(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          resolve(canvas.toDataURL("image/png"));
        };
        img.onerror = reject;
        img.src = url;
      });
    }


    // --- Angepasste PDF-Generierungsfunktion ---
   // =================================================================
    // ===== PDF-GENERIERUNGSFUNKTION (MIT KORREKTUREN) =====
    // =================================================================

async function generateBerichtPDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const logoImg = await loadImageAsBase64("https://volkerkottwitz.github.io/Konfig/Konfigurator/images/logo.png"  ).catch(() => null);
        
        const margin = 20;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        let yPosition = margin;

        function addPageHeader() {
            if (logoImg) doc.addImage(logoImg, "PNG", margin, margin, 40, 30, undefined, 'FAST');
            
            const heute = new Date();
            const datumString = heute.toLocaleDateString("de-DE", { year: "numeric", month: "long", day: "numeric" });
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(datumString, pageWidth - margin, margin + 10, { align: "right" });
            const berichtsNummer = `BER-${heute.toISOString().slice(0, 10).replace(/-/g, '')}-${heute.toTimeString().slice(0, 5).replace(':', '')}`;
            doc.text(`Berichts-Nr: ${berichtsNummer}`, pageWidth - margin, margin + 20, { align: "right" });
        }

        function checkPageBreak(neededSpace) {
            if (yPosition + neededSpace > pageHeight - margin) {
                doc.addPage();
                yPosition = margin;
                addPageHeader();
                yPosition += 30;
            }
        }

        addPageHeader();
        yPosition += 40;

        const mainTitle = document.getElementById("mainTitleInput").value || "Bericht";
        doc.setFontSize(20);
        doc.setTextColor(0);
        doc.setFont("helvetica", "bold");
        doc.text(mainTitle.toUpperCase(), pageWidth / 2, yPosition, { align: "center" });
        yPosition += 20;

        function drawSection(title, data) {
            checkPageBreak(20 + data.length * 6);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(0, 161, 225);
            doc.text(title, margin, yPosition);
            yPosition += 10;
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(0);
            data.forEach(item => {
                const splitItem = doc.splitTextToSize(item, pageWidth - 2 * margin); // Breite f√ºr den Textumbruch angepasst
                doc.text(splitItem, margin, yPosition);
                yPosition += splitItem.length * 5 + 1; // Zeilenabstand angepasst
            });
            yPosition += 5;
        }

        // ===== HIER IST DIE FINALE √ÑNDERUNG INTEGRIERT =====
        
        // 1. Kundennummer aus dem unsichtbaren Feld lesen
        const kundennummerValue = document.getElementById("kundennummer").value;

        // 2. Array f√ºr die Kundendaten vorbereiten
        const kundenDatenArray = [
            `Firma: ${document.getElementById("firma").value || 'N/A'}`,
            `Ansprechpartner: ${document.getElementById("name").value || 'N/A'}`
        ];

        // 3. Kundennummer nur hinzuf√ºgen, wenn sie vorhanden ist
        if (kundennummerValue) {
            kundenDatenArray.push(`Kundennummer: ${kundennummerValue}`);
        }

        // 4. Restliche Kundendaten hinzuf√ºgen
        kundenDatenArray.push(
            `Adresse: ${document.getElementById("strasse").value || 'N/A'}, ${document.getElementById("plz").value} ${document.getElementById("ort").value}`,
            `E-Mail: ${document.getElementById("email").value || 'N/A'}`,
            `Telefon: ${document.getElementById("telefon").value || 'N/A'}`
        );

        // 5. Die "KUNDE"-Sektion mit dem vollst√§ndigen Array zeichnen
        drawSection("KUNDE", kundenDatenArray);

        // =======================================================

        drawSection("BEARBEITUNG", [
            `Innendienst: ${getSachbearbeiterValue() || 'N/A'}`,
            `Ausgestellt von: ${getAussendienstmitarbeiterValue() || 'N/A'}`
        ]);

        const berichtInhalt = document.getElementById('bericht-text').value;
        if (berichtInhalt.trim()) {
            checkPageBreak(30);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(0, 161, 225);
            doc.text("BERICHTSINHALT", margin, yPosition);
            yPosition += 10;
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(0);
            const splitBericht = doc.splitTextToSize(berichtInhalt, pageWidth - 2 * margin);
            checkPageBreak(splitBericht.length * 6); // Angepasster Platzbedarf
            doc.text(splitBericht, margin, yPosition);
            yPosition += splitBericht.length * 6 + 10;
        }

        const aufgabenInhalt = document.getElementById('aufgaben-text').value;
        if (aufgabenInhalt.trim()) {
            checkPageBreak(30);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(0, 161, 225);
            doc.text("ZU ERLEDIGENDE AUFGABEN", margin, yPosition);
            yPosition += 10;
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(0);
            const splitAufgaben = doc.splitTextToSize(aufgabenInhalt, pageWidth - 2 * margin);
            checkPageBreak(splitAufgaben.length * 6); // Angepasster Platzbedarf
            doc.text(splitAufgaben, margin, yPosition);
        }

        const firmaName = (document.getElementById("firma").value || "Bericht").replace(/[^a-zA-Z0-9]/g, "-");
        const datumForFilename = new Date().toISOString().split('T')[0];
        doc.save(`${firmaName}_${datumForFilename}.pdf`);

    } catch (error) {
        console.error("Fehler bei der PDF-Erstellung:", error);
        alert("Fehler bei der PDF-Erstellung. Bitte Konsole pr√ºfen: " + error.message);
    }
}

  </script>

  <section class="form-section-container" style="text-align: center; box-shadow: none; border: none; background: none;">
  <button onclick="generateBerichtPDF()" class="btn btn-primary" style="padding: 15px 30px; font-size: 1.2rem;">
    Bericht als PDF
  </button>
</section>

</body>
</html>
