<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Codex Humanus 1-3 durchsuchen</title>
    <link rel="manifest" href="manifest1.json">
    <link rel="apple-touch-icon" href="images/codexhumanus.png">
    <link rel="icon" href="images/codexhumanus.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

   <style>
    /* ======================================== */
    /*         1. GRUNDEINSTELLUNGEN            */
    /* ======================================== */
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed&display=swap' );

    * {
        font-family: 'Roboto Condensed', Arial, sans-serif;
        box-sizing: border-box; /* Wichtig f√ºr konsistentes Layout */
    }

    body {
        margin: 0;
        background-color: #f8f9fa;
        overflow: hidden; /* Verhindert Scrollen des gesamten Body */
    }

    /* ======================================== */
    /*         2. HEADER & STEUERUNG            */
    /* ======================================== */
    #header {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        background-color: #d2d2d4;
        color: white;
        border-bottom: 2px solid #ddd;
    }

    #header img {
        height: 80px;
        margin-right: 15px;
    }

    #header h1 {
        font-size: 20px;
        margin-right: 15px;
    }

    .search-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        padding: 15px;
        flex-wrap: wrap;
    }

    input[type="text"] {
        padding: 10px 18px;
        font-size: 16px;
        border: 1px solid #ced4da;
        border-radius: 25px;
        width: 200px;
    }

    button {
        background-color: #8B6F47;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 30px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    button:hover { background-color: #6F5536; }
    button:disabled { background-color: #c0b8ab; cursor: not-allowed; }

    .navigation-buttons, .zoom-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 10px;
    }

    /* ======================================== */
    /*       3. INFO & LADEBALKEN               */
    /* ======================================== */
    #infoSection {
        margin-top: 10px;
        color: #333;
        font-size: 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }

    #progressBar {
        width: 60%;
        height: 6px;
        background-color: #e0e0e0;
        border-radius: 2px;
        overflow: hidden;
    }

    #progressFill {
        height: 100%;
        background-color: #8B6F47;
        width: 0%;
        transition: width 0.4s ease;
    }

    #search-progress-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        display: none; justify-content: center; align-items: center;
        z-index: 9999; flex-direction: column;
    }
    .progress-container { position: relative; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    .progress-logo { width: 60px; height: 60px; animation: spin 1.5s linear infinite; position: relative; top: 45px; }
    .progress-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .progress-ring__background, .progress-ring__circle { fill: transparent; stroke-width: 8; }
    .progress-ring__background { stroke: #e0e0e0; }
    .progress-ring__circle { stroke: #8B6F47; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.2s linear; }
    #progress-text { margin-top: 70px; font-size: 16px; color: #333; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* ======================================== */
    /*         4. PDF-ANZEIGE (NEU)             */
    /* ======================================== */

    #pdfContainer {
        position: absolute;
        top: 280px; /* H√∂he von Header, Suche, etc. anpassen */
        bottom: 0;
        left: 0;
        right: 0;
        overflow: auto; /* Erm√∂glicht Panning (Verschieben) im Zoom-Modus */
        -webkit-overflow-scrolling: touch; /* Fl√ºssigeres Scrollen auf iOS */
    }

    #pdfViewer {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        transform-origin: 0 0;
    }

    #pdfViewer canvas {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: transform 0.3s ease-out;
    }

    /* ======================================== */
    /*         5. MOBILE ANPASSUNGEN            */
    /* ======================================== */
    @media screen and (max-width: 768px) {
        #header { padding: 5px 10px; }
        #header img { height: 60px; }
        #header h1 { font-size: 18px; }
        .search-container { padding: 10px; }
        input[type="text"] { width: 150px; }
        .zoom-buttons { display: none; }

        #pdfContainer {
            top: 240px; /* H√∂he an mobilen Header anpassen */
        }
    }
   </style>
</head>

<body>
    <div id="header">
        <a id="pdfLink" href="https://volkerkottwitz.github.io/Konfig/Konfigurator/anewstarisborn/CodexHumanus/images/Codex_Humanus_Band_1-3.pdf" target="_blank" rel="noopener">
            <img src="images/codexhumanus.png" alt="Codex Logo">
        </a>
        <h1>DUOVIEWER</h1>
        <div class="buttons">
            <button onclick="openInfo( )">üìù Info</button>
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="searchBox" placeholder="Suchbegriff 1">
        <input type="text" id="searchBox2" placeholder="Suchbegriff 2 (optional)">
        <button onclick="searchPDF()">üîç Suche</button>
        <button onclick="printCurrentPage()">üñ®Ô∏è</button>
    </div>

    <div id="search-progress-overlay">
        <div class="progress-container">
            <svg class="progress-ring" width="100" height="100">
                <circle class="progress-ring__background" r="45" cx="50" cy="50"/>
                <circle class="progress-ring__circle" r="45" cx="50" cy="50"/>
            </svg>
            <img src="images/codexhumanus.png" class="progress-logo" alt="Sucht...">
            <span id="progress-text"></span>
        </div>
    </div>

    <div id="infoSection">
        <div id="searchInfo"></div>
        <div id="currentMatchInfo"></div>
        <div id="progressBar"><div id="progressFill"></div></div>
    </div>

    <div class="navigation-buttons">
        <button id="prev-page">‚óÄ PDF</button>
        <button onclick="prevMatch()">‚¨Ö üéØ</button>
        <button onclick="nextMatch()">üéØ ‚û°</button>
        <button id="next-page">PDF ‚ñ∂</button>
    </div>

    <div id="page-navigation" style="display: flex; justify-content: center; gap: 10px; padding: 10px;">
        <span id="page-info"></span>
    </div>

    <div class="zoom-buttons">
        <button onclick="zoomOut()">üîç -</button>
        <button onclick="zoomIn()">üîç +</button>
    </div>

    <div id="pdfContainer">
        <div id="pdfViewer"></div>
    </div>

    <div id="infoModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
        <div style="background:white; padding:25px 30px; border-radius:10px; max-width:400px; text-align:center; font-family: Arial, sans-serif;">
            <h2>Information</h2>
            <p>Diese Anwendung wurde f√ºr meine Frau <strong>und alle Freundinnen von meiner Frau</strong> entwickelt.</p>
            <p>Ich hoffe dieses Programm <strong>hilft ein wenig.</strong>.</p>
            <button onclick="closeInfo()" style="margin-top:15px; padding:8px 16px; border:none; background-color:#927851; color:white; border-radius:5px;">Schlie√üen</button>
        </div>
    </div>

<script>
// ===================================================================
//   1. GLOBALE VARIABLEN & KONFIGURATION
// ===================================================================
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

const url = "https://volkerkottwitz.github.io/Konfig/Konfigurator/anewstarisborn/CodexHumanus/images/Codex_Humanus_Band_1-3.pdf";
let pdfDoc = null;
let currentPage = 1;
let isAnimating = false;
let matchPages = new Set( );
let searchText = "";
let secondSearchText = "";

let zoomScale = 1.0;
let isZoomed = false;
let isPanning = false;
let panStart = { x: 0, y: 0 };

const pdfContainer = document.getElementById('pdfContainer');
const pdfViewer = document.getElementById('pdfViewer');

// ===================================================================
//   2. INITIALISIERUNG
// ===================================================================
pdfjsLib.getDocument(url).promise.then(pdf => {
    pdfDoc = pdf;
    renderPage(currentPage);
    updateUiAfterNavigation();
}).catch(err => {
    console.error("Fehler beim Laden des PDFs:", err);
    alert("Fehler beim Laden des PDFs.");
});

// ===================================================================
//   3. HAUPTFUNKTION: SEITENANZEIGE (renderPage)
// ===================================================================
function renderPage(num) {
    if (!pdfDoc) return;
    isAnimating = true;

    pdfDoc.getPage(num).then(page => {
        const baseScale = window.devicePixelRatio || 1;
        const viewport = page.getViewport({ scale: baseScale });

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        canvas.style.width = "100%";
        canvas.style.height = "100%";

        pdfViewer.innerHTML = '';
        pdfViewer.appendChild(canvas);

        const renderContext = { canvasContext: ctx, viewport: viewport };
        page.render(renderContext).promise.then(() => {
            if (matchPages.has(num)) {
                highlightMatches(page, canvas, page.getViewport({ scale: baseScale }));
            }
            isAnimating = false;
            resetZoomAndPan();
        });
    });
}

// ===================================================================
//   4. NAVIGATION & INTERAKTIONEN
// ===================================================================
function goToPage(num) {
    if (isAnimating || num < 1 || (pdfDoc && num > pdfDoc.numPages)) return;
    currentPage = num;
    renderPage(currentPage);
    updateUiAfterNavigation();
}

document.getElementById("prev-page").addEventListener("click", () => goToPage(currentPage - 1));
document.getElementById("next-page").addEventListener("click", () => goToPage(currentPage + 1));

function prevMatch() {
    if (matchPages.size === 0) return;
    const pages = [...matchPages];
    const currentIndex = pages.indexOf(currentPage);
    if (currentIndex > 0) goToPage(pages[currentIndex - 1]);
}

function nextMatch() {
    if (matchPages.size === 0) return;
    const pages = [...matchPages];
    const currentIndex = pages.indexOf(currentPage);
    if (currentIndex < pages.length - 1) goToPage(pages[currentIndex + 1]);
}

// ===================================================================
//   5. SUCHE & HERVORHEBUNG
// ===================================================================
function normalizeQuotes(text) {
    return text
        .replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g, '"')
        .replace(/[\u2018\u2019\u201A\u201B\u2032\u2035]/g, "'");
}

async function searchPDF() {
    const overlay = document.getElementById('search-progress-overlay');
    const circle = document.querySelector('.progress-ring__circle');
    const progressText = document.getElementById('progress-text');
    const radius = circle.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;

    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    circle.style.strokeDashoffset = circumference;
    progressText.textContent = "Suche wird vorbereitet...";
    overlay.style.display = 'flex';

    searchText = normalizeQuotes(document.getElementById("searchBox").value.trim());
    secondSearchText = normalizeQuotes(document.getElementById("searchBox2").value.trim());
    matchPages.clear();

    if (!searchText) {
        overlay.style.display = 'none';
        return alert("Bitte mindestens den ersten Suchbegriff eingeben.");
    }

    const numPages = pdfDoc.numPages;
    for (let pageNum = 1; pageNum <= numPages; pageNum++) {
        const page = await pdfDoc.getPage(pageNum);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(" ").toLowerCase();
        const normalizedPageText = normalizeQuotes(pageText);

        const hasFirst = normalizedPageText.includes(searchText.toLowerCase());
        const hasSecond = secondSearchText ? normalizedPageText.includes(secondSearchText.toLowerCase()) : true;
        if (hasFirst && hasSecond) matchPages.add(pageNum);

        const progress = pageNum / numPages;
        const offset = circumference - progress * circumference;
        circle.style.strokeDashoffset = offset;
        progressText.textContent = `Durchsuche Seite ${pageNum} von ${numPages}... (${Math.round(progress * 100)}%)`;
    }

    overlay.style.display = 'none';

    if (matchPages.size > 0) {
        goToPage([...matchPages][0]);
        document.getElementById("searchInfo").textContent = `üîç ${matchPages.size} Seite(n) mit Treffern gefunden.`;
    } else {
        document.getElementById("searchInfo").textContent = "‚ùå Keine Treffer gefunden.";
        document.getElementById("currentMatchInfo").textContent = "";
        document.getElementById("progressFill").style.width = "0%";
    }
}

function highlightMatches(page, canvas, viewport) {
    const searchTextLower = searchText.toLowerCase();
    const secondSearchTextLower = secondSearchText ? secondSearchText.toLowerCase() : null;
    const highlightColor = "rgba(255, 255, 0, 0.4)";

    page.getTextContent().then(textContent => {
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = highlightColor;

        const textLayer = new pdfjsLib.TextLayerBuilder({
            textLayerDiv: document.createElement('div'),
            pageIndex: page.pageIndex,
            viewport: viewport
        });
        textLayer.setTextContent(textContent);
        textLayer.render();

        textContent.items.forEach((item, i) => {
            const itemTextLower = normalizeQuotes(item.str.toLowerCase());
            const firstMatch = searchTextLower && itemTextLower.includes(searchTextLower);
            const secondMatch = secondSearchTextLower && itemTextLower.includes(secondSearchTextLower);

            if (firstMatch || secondMatch) {
                const itemDiv = textLayer.textLayerDiv.children[i];
                if (itemDiv) {
                    const left = parseFloat(itemDiv.style.left);
                    const top = parseFloat(itemDiv.style.top);
                    const width = parseFloat(itemDiv.style.width);
                    const height = parseFloat(itemDiv.style.height);
                    ctx.fillRect(left, top, width, height);
                }
            }
        });
    });
}

// ===================================================================
//   6. GESTENSTEUERUNG (ZOOM, PAN, SWIPE)
// ===================================================================
let initialDistance = 0;
let swipeStartX = 0;
let swipeDistX = 0;
let isSwiping = false;

pdfContainer.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
        e.preventDefault();
        isSwiping = false;
        initialDistance = getDistance(e.touches);
    } else if (e.touches.length === 1) {
        if (isZoomed) {
            e.preventDefault();
            isPanning = true;
            panStart.x = e.touches[0].clientX + pdfContainer.scrollLeft;
            panStart.y = e.touches[0].clientY + pdfContainer.scrollTop;
        } else {
            isSwiping = true;
            swipeStartX = e.touches[0].clientX;
            swipeDistX = 0;
            pdfViewer.style.transition = 'none';
        }
    }
}, { passive: false });

pdfContainer.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2) {
        e.preventDefault();
        const currentDistance = getDistance(e.touches);
        const newScale = zoomScale * (currentDistance / initialDistance);
        setZoom(newScale, { x: e.touches[0].clientX, y: e.touches[0].clientY });
        initialDistance = currentDistance;
    } else if (isPanning) {
        e.preventDefault();
        pdfContainer.scrollLeft = panStart.x - e.touches[0].clientX;
        pdfContainer.scrollTop = panStart.y - e.touches[0].clientY;
    } else if (isSwiping) {
        swipeDistX = e.touches[0].clientX - swipeStartX;
        if ((currentPage === 1 && swipeDistX > 0) || (currentPage === pdfDoc.numPages && swipeDistX < 0)) {
            swipeDistX /= 3;
        }
        pdfViewer.style.transform = `translateX(${swipeDistX}px)`;
    }
}, { passive: false });

pdfContainer.addEventListener('touchend', (e) => {
    isPanning = false;
    if (e.touches.length < 2) initialDistance = 0;

    if (isSwiping) {
        isSwiping = false;
        const threshold = pdfContainer.clientWidth / 4;
        pdfViewer.style.transition = 'transform 0.3s ease-out';
        if (swipeDistX < -threshold && currentPage < pdfDoc.numPages) {
            goToPage(currentPage + 1);
        } else if (swipeDistX > threshold && currentPage > 1) {
            goToPage(currentPage - 1);
        } else {
            pdfViewer.style.transform = 'translateX(0)';
        }
    }
});

function getDistance(touches) {
    const dx = touches[0].clientX - touches[1].clientX;
    const dy = touches[0].clientY - touches[1].clientY;
    return Math.sqrt(dx * dx + dy * dy);
}

function setZoom(newScale) {
    zoomScale = Math.max(1, Math.min(newScale, 5));
    isZoomed = zoomScale > 1;
    pdfViewer.style.transform = `scale(${zoomScale})`;
}

function resetZoomAndPan() {
    zoomScale = 1.0;
    isZoomed = false;
    pdfViewer.style.transform = 'scale(1) translateX(0)';
    pdfContainer.scrollLeft = 0;
    pdfContainer.scrollTop = 0;
}

function zoomIn() { setZoom(zoomScale + 0.25); }
function zoomOut() { setZoom(zoomScale - 0.25); }

// ===================================================================
//   7. UI- & HILFSFUNKTIONEN
// ===================================================================
function updateUiAfterNavigation() {
    document.getElementById("prev-page").disabled = (currentPage <= 1);
    document.getElementById("next-page").disabled = (pdfDoc && currentPage >= pdfDoc.numPages);
    document.getElementById("page-info").textContent = `Seite ${currentPage} von ${pdfDoc ? pdfDoc.numPages : '...'}`;
    updatePdfLink();
    if (matchPages.size > 0) {
        updateCurrentMatchInfo();
        updateProgressBar();
    }
}

function updateCurrentMatchInfo() {
    if (matchPages.size === 0) {
        document.getElementById("currentMatchInfo").textContent = "";
        return;
    }
    const pages = [...matchPages];
    const index = pages.indexOf(currentPage);
    document.getElementById("currentMatchInfo").textContent = `üìÑ Treffer ${index + 1} von ${pages.length}`;
}

function updateProgressBar() {
    if (matchPages.size === 0) {
        document.getElementById("progressFill").style.width = "0%";
        return;
    }
    const pages = [...matchPages];
    const index = pages.indexOf(currentPage) + 1;
    const percent = (index / pages.length) * 100;
    document.getElementById("progressFill").style.width = `${percent}%`;
}

function updatePdfLink() {
    const link = document.getElementById('pdfLink');
    if (link) {
        const baseUrl = "https://volkerkottwitz.github.io/Konfig/Konfigurator/anewstarisborn/CodexHumanus/images/Codex_Humanus_Band_1-3.pdf";
        link.href = `${baseUrl}#page=${currentPage}`;
    }
}

function printCurrentPage( ) {
    if (!pdfDoc) return;
    pdfDoc.getPage(currentPage).then(page => {
        const printScale = 2.0;
        const viewport = page.getViewport({ scale: printScale });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const renderContext = { canvasContext: ctx, viewport: viewport };
        page.render(renderContext).promise.then(() => {
            const dataUrl = canvas.toDataURL();
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html><html lang="de"><head><meta charset="UTF-8"><title>Druckansicht - Seite ${currentPage}</title>
                <style>
                    body { margin: 0; text-align: center; background-color: #f8f9fa; }
                    .print-header { padding: 15px; background-color: #d2d2d4; border-bottom: 1px solid #ccc; display: flex; justify-content: center; align-items: center; gap: 15px; }
                    .print-header button { padding: 8px 15px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; }
                    img { max-width: 100%; height: auto; margin-top: 20px; }
                    @media print { .print-header { display: none; } img { margin-top: 0; } @page { margin: 0; size: auto; } }
                </style></head><body>
                <div class="print-header">
                    <img src="images/codexhumanus.png" alt="Logo" style="height: 40px;">
                    <button onclick="window.print()">üñ®Ô∏è Jetzt drucken</button>
                    <button onclick="window.close()">‚ùå Schlie√üen</button>
                </div>
                <img src="${dataUrl}" alt="PDF Seite ${currentPage}"></body></html>`);
            printWindow.document.close();
        });
    });
}

document.getElementById("searchBox").addEventListener("keydown", e => { if (e.key === "Enter") searchPDF(); });
document.getElementById("searchBox2").addEventListener("keydown", e => { if (e.key === "Enter") searchPDF(); });

function openInfo() { document.getElementById('infoModal').style.display = 'flex'; }
function closeInfo() { document.getElementById('infoModal').style.display = 'none'; }
</script>

</body>
</html>
